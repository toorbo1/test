<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkGold - Платформа для заработка</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
.scroll-container,html{scroll-behavior:smooth}*,body{box-sizing:border-box;margin:0}.btn,.task-tab{font-weight:600}.btn,.exchange-card,.logo,.nav-item,.stat-card,.task-tab,.tasks-btn{cursor:pointer}.admin-search-results,.btn,.exchange-card,.header,.nav-item,.post-promo,.stat-card,.task-tab,.withdraw-hero{text-align:center}.modal,.ripple,.upload-placeholder,body::before{pointer-events:none}.task-card,.tasks-grid{box-sizing:border-box!important}.admin-badge,.task-availability,.task-difficulty{text-transform:uppercase}*,body{margin:0}:root,[data-theme=light]{--accent:#6366f1;--accent-hover:#4f46e5;--purple-gradient:linear-gradient(135deg, #8b5cf6, #7c3aed);--blue-gradient:linear-gradient(135deg, #3b82f6, #2563eb);--teal-gradient:linear-gradient(135deg, #0ea5e9, #0369a1);--success:#10b981;--error:#ef4444;--warning:#f59e0b}.task-card,.tasks-grid{visibility:visible!important}.verification-user-info{display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:15px;background:var(--bg-secondary);border-radius:12px;border-left:4px solid var(--accent)}.verification-avatar{background:var(--purple-gradient);display:flex;align-items:center;justify-content:center;flex-shrink:0}.admin-search-input,.verification-item{background:var(--card-bg);border:1px solid var(--border)}.action-arrow,.admin-task-time,.verification-task,.verification-task-title{color:var(--text-secondary)}.verification-price{color:var(--gold);margin-left:auto}.admin-search-input,body{color:var(--text-primary)}.tasks-button-container,.verification-screenshot{margin:20px 0;text-align:center}.verification-modal-screenshot{max-width:100%;max-height:400px;object-fit:contain;box-shadow:0 4px 15px rgba(0,0,0,.2)}.verification-item:hover{box-shadow:0 4px 12px rgba(0,0,0,.1);border-color:var(--accent)}.admin-search-container{position:relative;margin-bottom:16px}.admin-search-clear,.admin-search-icon,.search-icon{position:absolute;top:50%;transform:translateY(-50%)}.admin-search-input{width:100%;border-radius:14px;padding:12px 16px 12px 45px;font-size:14px;transition:.3s}.admin-search-clear,.admin-search-results,.nav-icon,.nav-label,.upload-placeholder{color:var(--text-secondary)}.admin-search-icon,.search-icon{left:16px;color:var(--text-secondary)}.admin-search-results{margin-top:10px;font-size:12px}.admin-search-clear{right:12px;background:0 0;border:none;cursor:pointer;font-size:18px;padding:0;width:20px;height:20px;display:flex;align-items:center;justify-content:center}.task-header,.task-price{z-index:5;position:relative}.bottom-nav,.card{border-radius:16px}.admin-search-clear:hover{color:var(--error)}.task-availability{background:var(--accent);max-width:80px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap}.task-header{display:flex;justify-content:space-between;align-items:flex-start}.task- title{flex:1;margin-right:30px}.task-price{background:var(--gold-gradient)!important;flex-shrink:0!important}.task-card-with-image .task-availability{top:48px;right:65px;background:rgba(82,48,255,.7);backdrop-filter:blur(10px)}.main-content,.task-card,.task-card *,.task-description,.task-title,body,html{max-width:100%!important}.bottom-nav{position:fixed;bottom:10px;left:10px;right:10px;padding:6px 8px;display:flex;justify-content:space-around;box-shadow:0 -6px 25px rgba(0,0,0,.4);border:1px solid var(--border);z-index:1000;backdrop-filter:blur(20px);height:65px}.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px}.nav-icon{display:flex;align-items:center;justify-content:center;height:24px}.nav-icon img{width:40px;height:40px;object-fit:contain;opacity:.7;transition:.3s}.nav-label{line-height:2}.nav-item.active .nav-icon img{opacity:1;filter:none}body,html{width:100%!important;overflow-x:hidden!important;position:relative}.task-card{margin:0 0 12px!important}@media (max-width:480px){.task-availability{top:8px;right:8px;font-size:9px;padding:3px 6px;max-width:70px}.task-title{margin-right:50px}.main-content,body{padding:8px 8px 80px!important}.card,.task-card{width:100%!important;margin-left:0!important;margin-right:0!important}.nav-icon img{width:35px;height:35px}}@media (max-width:360px){.bottom-nav{height:60px;padding:4px 6px}.nav-item{padding:3px 4px}.nav-icon img{width:35px;height:35px}.nav-label{font-size:9px}.main-content,body{padding:6px 6px 75px!important}}.admin-input,.btn,.search-input,.task-btn{white-space:nowrap!important;max-width:100%!important;box-sizing:border-box!important}.task-description,.task-title{word-break:break-word!important;overflow-wrap:break-word!important;hyphens:auto!important}@media (max-width:768px){.page,.tab-content{overflow-anchor:none}body{-webkit-overflow-scrolling:touch}*{transform:none!important;transition:none!important;animation:none!important}.card,.task-card{backdrop-filter:none!important;box-shadow:0 2px 8px rgba(0,0,0,.1)!important}.card,.modal-content,.task-card{backdrop-filter:none!important;-webkit-backdrop-filter:none!important}}.about-content,.about-feature,.admin-section,.admin-task-item,.card,.chat-item,.confirmation-modal-content,.exchange-card,.level-progress,.modal-content,.post-item,.post-promo,.prices-content,.profile-action,.profile-stat,.referral-system,.stat-card,.task-card,.task-modal-content,.verification-item,.verification-modal-content,.withdraw-operation{background:rgba(20,20,40,.7)!important;backdrop-filter:blur(20px) saturate(180%)!important;-webkit-backdrop-filter:blur(20px) saturate(180%)!important;border:1px solid rgba(255,255,255,.125)!important;position:relative;z-index:1;box-shadow:0 25px 50px -12px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.1),inset 0 -1px 0 rgba(0,0,0,.2),0 0 0 1px rgba(255,255,255,.05),0 15px 35px -10px rgba(0,0,0,.3)!important;transform:translateY(0) scale(1);transition:.4s cubic-bezier(.25, .46, .45, .94)}.bottom-nav{background:rgba(25,25,50,.8)!important;backdrop-filter:blur(25px) saturate(200%)!important;-webkit-backdrop-filter:blur(25px) saturate(200%)!important;border:1px solid rgba(255,255,255,.15)!important;box-shadow:0 -20px 40px rgba(0,0,0,.3),0 -5px 15px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.1),0 0 20px rgba(99,102,241,.1)!important}.modal{background:rgba(5,5,16,.85)!important;backdrop-filter:blur(15px)!important;-webkit-backdrop-filter:blur(15px)!important}.modal-content{box-shadow:0 50px 100px -20px rgba(0,0,0,.6),0 30px 60px -30px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.1),0 0 0 1px rgba(255,255,255,.05),0 0 50px rgba(99,102,241,.1)!important;transform:translateY(20px) scale(.95);opacity:0}.modal.active .modal-content{transform:translateY(0) scale(1);opacity:1;transform:scale(1)}.hero-banner{background:rgba(26,26,58,.6)!important;backdrop-filter:blur(15px)!important;-webkit-backdrop-filter:blur(15px)!important;box-shadow:0 20px 40px rgba(0,0,0,.3),0 10px 25px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.1),0 0 30px rgba(99,102,241,.15)!important}.admin-btn,.admin-chat-send,.btn,.chat-send,.confirmation-btn,.copy-btn,.prices-btn,.profile-btn,.support-btn,.task-btn,.tasks-btn,.upload-btn,.withdraw-btn{background:rgba(99,102,241,.8)!important;backdrop-filter:blur(10px)!important;-webkit-backdrop-filter:blur(10px)!important;border:1px solid rgba(255,255,255,.2)!important;box-shadow:0 8px 20px rgba(234,99,241,.3),0 4px 10px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.2),0 0 0 1px rgba(255,255,255,.1)!important;transform:translateY(0);transition:.3s cubic-bezier(.25, .46, .45, .94)}.admin-btn:hover,.btn:hover,.task-btn:hover{transform:translateY(-3px)!important;box-shadow:0 12px 25px rgba(99,102,241,.4),0 6px 15px rgba(0,0,0,.25),inset 0 1px 0 rgba(255,255,255,.25),0 0 0 1px rgba(255,255,255,.15)!important}.btn-primary{background:linear-gradient(135deg,rgba(255,215,0,.8),rgba(55,255,0,.8))!important;backdrop-filter:blur(15px)!important;-webkit-backdrop-filter:blur(15px)!important;box-shadow:0 8px 20px rgba(255,215,0,.4),0 4px 10px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.3),0 0 0 1px rgba(255,255,255,.15)!important}.admin-chat-input,.admin-input,.admin-textarea,.chat-input input,.search-input{background:rgba(30,30,60,.6)!important;backdrop-filter:blur(10px)!important;-webkit-backdrop-filter:blur(10px)!important;border:1px solid rgba(255,255,255,.1)!important;box-shadow:0 4px 15px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05),0 0 0 1px rgba(255,255,255,.05)!important;transition:.3s}.admin-input:focus,.chat-input input:focus,.search-input:focus{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.25),inset 0 1px 0 rgba(255,255,255,.1),0 0 0 1px rgba(99,102,241,.3)!important}.notification{background:rgba(99,102,241,.9)!important;backdrop-filter:blur(20px)!important;-webkit-backdrop-filter:blur(20px)!important;border:1px solid rgba(255,255,255,.2)!important;box-shadow:0 20px 40px rgba(0,0,0,.3),0 10px 25px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.2),0 0 20px rgba(99,102,241,.3)!important}@keyframes floatIn{from{opacity:0;transform:translateX(100%) translateY(20px) scale(.9)}to{opacity:1;transform:translateX(0) translateY(0) scale(1)}}.stat-card{transform:translateY(0) scale(1)}.stat-card:hover{transform:translateY(-10px) scale(1.05)!important}.stat-card.balance-card{background:linear-gradient(135deg,#8a5cf6,rgba(124,58,237,.7),rgba(109,40,217,.7))!important;box-shadow:0 20px 40px rgba(139,92,246,.3),0 10px 25px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.2),0 0 20px rgba(139,92,246,.2)!important}.stat-card.support-card{background:linear-gradient(135deg,#0ea4e9,rgba(3,105,161,.7),#075985)!important;box-shadow:0 20px 40px rgba(14,165,233,.3),0 10px 25px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.2),0 0 20px rgba(14,165,233,.2)!important}.exchange-card{background:linear-gradient(135deg,#ffd900,#ffb700)!important;box-shadow:0 20px 40px rgba(255,215,0,.3),0 10px 25px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.3),0 0 20px rgba(255,215,0,.2)!important}.message{backdrop-filter:blur(15px)!important;-webkit-backdrop-filter:blur(15px)!important;transform:translateY(0);transition:.3s}*,.page,.tab-content{transition:.4s cubic-bezier(.25, .46, .45, .94)}.message:hover{transform:translateY(-2px)}.message-admin{background:rgba(30,30,60,.7)!important;box-shadow:0 8px 20px rgba(0,0,0,.2),0 4px 10px rgba(0,0,0,.1)!important}.message-user{background:rgba(99,102,241,.7)!important;box-shadow:0 8px 20px rgba(99,102,241,.3),0 4px 10px rgba(0,0,0,.1)!important}.admin-section,.card,.profile-stat,.task-card{animation:.8s cubic-bezier(.34,1.56,.64,1) forwards glassFloatIn}@keyframes glassFloatIn{from{opacity:0;transform:translateY(30px) scale(.9);backdrop-filter:blur(0px);box-shadow:0 0 0 transparent}to{opacity:1;transform:translateY(0) scale(1);backdrop-filter:blur(20px);box-shadow:0 25px 50px -12px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.1),inset 0 -1px 0 rgba(0,0,0,.2),0 0 0 1px rgba(255,255,255,.05),0 15px 35px -10px rgba(0,0,0,.3)}}body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at 20% 20%,rgba(99,102,241,.1) 0,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(139,92,246,.1) 0,transparent 50%),radial-gradient(ellipse at 40% 40%,rgba(14,165,233,.05) 0,transparent 50%);z-index:-1}@media (max-width:768px){.admin-section,.card,.profile-stat,.stat-card,.task-card{backdrop-filter:blur(15px) saturate(160%)!important;-webkit-backdrop-filter:blur(15px) saturate(160%)!important;box-shadow:0 15px 30px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.1),inset 0 -1px 0 rgba(0,0,0,.2),0 0 0 1px rgba(255,255,255,.05)!important}.card:hover,.profile-stat:hover,.task-card:hover{transform:translateY(-4px) scale(1.01)!important}.bottom-nav{backdrop-filter:blur(20px) saturate(180%)!important;-webkit-backdrop-filter:blur(20px) saturate(180%)!important;box-shadow:0 -10px 25px rgba(0,0,0,.25),0 -3px 10px rgba(0,0,0,.15),inset 0 1px 0 rgba(255,255,255,.1)!important}}.card,.modal{backdrop-filter:blur(10px)}@supports not (backdrop-filter:blur(20px)){.admin-section,.card,.profile-stat,.stat-card,.task-card{background:rgba(20,20,40,.95)!important;box-shadow:0 20px 40px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.1)!important}}*{-webkit-overflow-scrolling:touch;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;padding:0;font-family:'Segoe UI',-apple-system,BlinkMacSystemFont,Roboto,Oxygen,Ubuntu,sans-serif;-webkit-tap-highlight-color:transparent;max-width:100%}.card,.modal,.page,.tab-content,.task-card{transform:translateZ(0);backface-visibility:hidden;perspective:1000;will-change:transform,opacity}.page,.tab-content{backface-visibility:hidden;perspective:1000;animation-duration:.4s;animation-fill-mode:both}.btn,.card,.nav-item,.task-btn,.task-card{transition:.3s cubic-bezier(.25, .46, .45, .94)}@keyframes smoothFadeIn{from{opacity:0;transform:translateY(20px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}@keyframes smoothSlideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}.fade-in{animation:.5s cubic-bezier(.25,.46,.45,.94) both smoothFadeIn}.slide-in{animation:.4s cubic-bezier(.25,.46,.45,.94) both smoothSlideIn}.card,.task-card{transform-origin:center}.card:hover,.task-card:hover{transform:translateY(-2px) scale(1.02)}.btn,.nav-item,.task-btn{transform:translateZ(0);position:relative;overflow:hidden}.btn:active,.nav-item:active,.task-btn:active{transform:scale(.96);transition:transform .1s cubic-bezier(.25, .46, .45, .94)}.bottom-nav,.modal-content,.nav-item::after{transition:.3s cubic-bezier(.25, .46, .45, .94)}.ripple{position:absolute;border-radius:50%;background:rgba(255,255,255,.6);transform:scale(0);animation:.6s linear ripple}@keyframes ripple{to{transform:scale(4);opacity:0}}.chat-messages,.modal-content,.smooth-scroll,.tasks-grid{scroll-behavior:smooth;-webkit-overflow-scrolling:touch}.admin-section,.file-input,.page,.page:not(.active),.tab-content,.tab-content:not(.active){display:none}.modal-content{transform:scale(.9)}.nav-item,.nav-item.notification{position:relative}.card::before,.nav-item::after,.stat-card::after{content:'';position:absolute}.nav-item::after{bottom:-2px;left:50%;width:0;height:2px;background:var(--accent);transform:translateX(-50%)}.nav-item.active::after{width:70%}.lazy-load{opacity:0;transform:translateY(20px);transition:.5s cubic-bezier(.25, .46, .45, .94)}.btn,.performance-optimized,.stat-card{transform:translateZ(0)}.lazy-load.loaded{opacity:1;transform:translateY(0)}.performance-optimized{backface-visibility:hidden;perspective:1000px}.scroll-container{overflow:auto;-webkit-overflow-scrolling:touch}.card,.stat-card{padding:16px;position:relative;overflow:hidden}.tg-header{background:var(--bg-primary)!important}:root{--bg-primary:#050510;--bg-secondary:#0a0a1a;--text-primary:#ffffff;--text-secondary:#8b9bda;--card-bg:#0f0f23;--border:#1a1a3a;--shadow:rgba(99, 102, 241, 0.1);--nav-bg:rgba(15, 15, 35, 0.85);--gold:#ffd700;--gold-gradient:linear-gradient(135deg, #ffd700, #ffb700);--card-bg:rgba(20, 20, 40, 0.95);--bg-secondary:rgba(25, 25, 50, 0.9);--border:rgba(99, 102, 241, 0.3);--shadow:rgba(99, 102, 241, 0.15)}body{background:var(--bg-primary);min-height:100vh;padding:12px 12px 100px;line-height:1.6;background-image:radial-gradient(circle at 15% 50%,rgba(99,102,241,.05) 0,transparent 25%),radial-gradient(circle at 85% 30%,rgba(139,92,246,.05) 0,transparent 25%);width:100%}.card{background:var(--card-bg);margin-bottom:12px;border:1px solid var(--border);box-shadow:0 6px 20px rgba(0,0,0,.25)}.card::before{top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent)}.stat-card{border-radius:16px;display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100px;width:48%;flex:1;transition:.4s cubic-bezier(.34, 1.56, .64, 1);border:1px solid rgba(255,255,255,.1);box-shadow:0 6px 20px rgba(0,0,0,.2)}.stat-card::after{top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,rgba(255,255,255,.1) 0,transparent 50%);opacity:0;transition:opacity .3s}.post-item::before,.task-card::before{opacity:.7;top:0;content:'';position:absolute}.exchange-card:hover::before,.stat-card:hover::after{opacity:1}.task-card{background:var(--card-bg)!important;border-radius:16px!important;padding:16px!important;margin-bottom:12px!important;border:1px solid var(--border)!important;box-shadow:0 6px 20px rgba(0,0,0,.25)!important;backdrop-filter:blur(10px)!important;position:relative!important;overflow:hidden!important;width:100%!important;display:block!important;opacity:1!important}.image-upload-area:hover,.post-item:hover{border-color:var(--accent);transform:translateY(-2px)}.image-upload-area.dragover{border-color:var(--accent);background:rgba(99,102,241,.1);transform:scale(1.02)}.upload-placeholder{transition:.3s}.upload-progress{width:100%;height:4px;background:var(--border);border-radius:2px;margin-top:10px;overflow:hidden;display:none}.upload-progress-bar{height:100%;background:var(--accent);border-radius:2px;width:0%;transition:width .3s}.tasks-grid-with-images{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-top:16px}.task-card::before{left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--purple-gradient))}.task-card:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,.3);border-color:var(--accent)}.btn{display:inline-block;background:var(--accent);color:#fff;border:1px solid rgba(255,255,255,.1);padding:12px 20px;border-radius:12px;font-size:14px;transition:.4s cubic-bezier(.34, 1.56, .64, 1);box-shadow:0 4px 12px rgba(99,102,241,.3);position:relative;overflow:hidden}.btn::before,.task-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s}.btn:hover::before{left:100%}.btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(99,102,241,.4)}.btn-primary{background:var(--gold-gradient);box-shadow:0 4px 12px rgba(255,204,0,.4);border:1px solid rgba(255,215,0,.3)}.modal-content,.post-item,.profile-stat{background:var(--card-bg)}.profile-stat{border:1px solid var(--border);box-shadow:0 6px 16px rgba(0,0,0,.15);backdrop-filter:blur(10px);transition:.3s}.profile-stat:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.2)}.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:35px;border:1px solid transparent}.nav-item.active{background:var(--accent);box-shadow:0 0 16px rgba(99,102,241,.4);border:1px solid rgba(255,255,255,.2)}.modal-content{border-radius:18px;padding:20px;width:95%;max-width:400px;border:1px solid var(--border);box-shadow:0 20px 40px rgba(0,0,0,.5);max-height:80vh;overflow-y:auto;backdrop-filter:blur(20px)}.exchange-card,.hero-banner{position:relative;overflow:hidden}.admin-input,.admin-section,.admin-task-item,.post-item,.search-input,.tasks-tabs{backdrop-filter:blur(10px)}.post-item{border:1px solid var(--border);position:relative}.post-item::before{left:0;width:4px;height:100%;background:var(--accent)}.admin-input,.search-input{background:rgba(30,30,60,.8);border:1px solid var(--border);color:var(--text-primary);transition:.3s}.admin-input:focus,.search-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(99,102,241,.1);background:rgba(35,35,70,.9)}.admin-section{background:var(--card-bg);border-radius:14px;padding:16px;margin-bottom:16px;border:1px solid var(--border);box-shadow:0 6px 20px rgba(0,0,0,.15)}.admin-task-item{background:rgba(30,30,60,.8);border-radius:10px;padding:12px;margin-bottom:8px;border:1px solid var(--border);transition:.3s}.admin-task-item:hover{background:rgba(35,35,70,.9);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}.hero-banner{border-radius:16px;margin-bottom:16px;box-shadow:0 8px 30px rgba(0,0,0,.4);height:150px;background:linear-gradient(45deg,#1a1a3a,#252550);border:1px solid var(--border)}.exchange-card{background:var(--gold-gradient);color:#000;border-radius:16px;padding:16px;margin-bottom:12px;box-shadow:0 6px 20px rgba(255,215,0,.3);border:1px solid rgba(255,215,0,.3);transition:.3s}.container,.main-content{overflow-x:hidden!important}.exchange-card::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,rgba(255,255,255,.2) 0,transparent 50%);opacity:0;transition:opacity .3s}.exchange-card:hover{transform:translateY(-3px);box-shadow:0 10px 25px rgba(255,215,0,.4)}.tasks-tabs{display:flex;background:var(--card-bg);border:1px solid var(--border);box-shadow:0 4px 12px rgba(0,0,0,.1)}.task-tab{flex:1;padding:8px 6px;border-radius:10px;font-size:12px;transition:.3s;min-width:70px;border:1px solid transparent;background:var(--bg-secondary);color:var(--text-secondary)}.chat-avatar-small,.notification{align-items:center;color:#fff;display:flex}.task-tab.active{background:var(--accent)!important;color:#fff!important;box-shadow:0 4px 10px rgba(99,102,241,.3)!important;border:1px solid rgba(255,255,255,.2)!important}.notification{position:fixed;top:16px;right:16px;background:var(--accent);padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.4);z-index:10000;gap:10px;max-width:280px;animation:.3s ease-out slideIn;border:1px solid var(--border);backdrop-filter:blur(20px)}.progress-bar{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.05)}.progress-fill{background:var(--gold-gradient);box-shadow:0 0 8px rgba(255,215,0,.3)}.profile-avatar{border:2px solid var(--accent);box-shadow:0 4px 12px rgba(99,102,241,.3)}.chat-avatar-small{width:36px;height:36px;border-radius:50%;background:var(--purple-gradient);justify-content:center;margin-right:10px;font-weight:600;font-size:14px;box-shadow:0 4px 8px rgba(139,92,246,.3);border:2px solid rgba(255,255,255,.2)}.nav-icon,.nav-label{color:var(--text-secondary)}.admin-section,.card,.profile-stat,.task-card{box-shadow:0 6px 20px rgba(0,0,0,.25),0 1px 3px rgba(255,255,255,.05) inset}.stat-card.balance-card{box-shadow:0 6px 20px rgba(139,92,246,.4)}.stat-card.support-card{box-shadow:0 6px 20px rgba(14,165,233,.4)}.admin-task-item:hover,.card:hover,.profile-stat:hover{box-shadow:0 8px 25px rgba(0,0,0,.3),0 0 0 1px rgba(99,102,241,.1)}.nav-icon{font-size:18px;margin-bottom:2px}.nav-label{font-size:10px;font-weight:500}.main-content{width:100%!important}.tab-content{min-height:calc(100vh - 200px);padding-bottom:16px}.page{padding-bottom:90px}.container{max-width:100%!important}.header{margin-bottom:20px;position:relative}.logo{display:inline-flex;align-items:center;justify-content:center;margin-bottom:6px}.logo-text{font-size:24px;font-weight:800;background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent;letter-spacing:-.5px}.logo-icon{width:28px;height:28px;margin-right:8px;border-radius:6px;overflow:hidden}.slogan{font-size:12px;color:var(--text-secondary);font-weight:500;margin-bottom:16px}.video-icon{width:100%;height:100%;object-fit:cover;border-radius:8px}.video-container{width:100px;height:100px;border-radius:8px;overflow:hidden;margin-bottom:8px}.video-medium{width:36px;height:36px}.video-large{width:48px;height:48px}.hero-banner video,.profile-avatar video{width:100%;height:100%;object-fit:cover}.action-icon img,.chat-avatar .video-icon,.theme-slider:before{height:20px;width:20px}.stats-grid{display:flex;gap:10px;margin-bottom:16px;justify-content:space-between}.exchange-icon,.stat-icon{justify-content:center;display:flex}.stat-card:active{transform:scale(.97) translateZ(0)}.balance-card{background:var(--purple-gradient);box-shadow:0 6px 16px rgba(139,92,246,.2)}.support-card{background:var(--teal-gradient);box-shadow:0 6px 16px rgba(14,165,233,.2)}.stat-icon{align-items:center;margin-bottom:8px}.stat-label{font-weight:600;color:rgba(255,255,255,.95);margin-bottom:6px}.back-button,.chat-input input,.post-title{color:var(--text-primary)}.stat-value{line-height:1.2}.exchange-card:active{transform:scale(.98)}.exchange-icon{align-items:center;margin-bottom:10px}.exchange-title,.referral-value{font-size:16px;font-weight:700;margin-bottom:4px}.exchange-text{font-size:12px;opacity:.9;line-height:1.3}.post-promo{background:var(--card-bg);border-radius:16px;padding:16px;border:1px solid var(--border);box-shadow:0 6px 20px rgba(0,0,0,.15)}.post-icon{display:flex;justify-content:center;align-items:center;margin-bottom:12px}.post-description{color:var(--text-secondary);margin-bottom:14px;font-size:12px;line-height:1.4}.btn:active{transform:scale(.95) translateZ(0)}.btn-primary{background:var(--gold-gradient);color:#000;font-weight:700;box-shadow:0 4px 10px rgba(255,204,0,.25)}.btn-full{width:100%}.btn-success,.notification-success{background:var(--success)}.btn-warning,.notification-warning{background:var(--warning)}.btn-error,.notification-error{background:var(--error)}.tasks-btn,.withdraw-hero{background:var(--purple-gradient);color:#fff}.tasks-btn{border:none;padding:12px 16px;border-radius:14px;font-size:14px;font-weight:600;box-shadow:0 6px 16px rgba(139,92,246,.25);display:inline-flex;align-items:center;gap:8px}.tasks-btn:active{transform:scale(.96)}.nav-item{padding:6px 10px;border-radius:12px;flex:1;opacity:.7;transition:.4s cubic-bezier(.34, 1.56, .64, 1)}.nav-item.active{background:var(--accent);opacity:1;box-shadow:0 0 16px rgba(99,102,241,.25);transform:translateY(-2px)}.nav-item.active .nav-icon,.nav-item.active .nav-label{color:#fff}.nav-item.notification::after{content:'';position:absolute;top:4px;right:4px;width:6px;height:6px;background:var(--error);border-radius:50%}.post-content.collapsed::after,.task-description.collapsed::after{content:'';background:linear-gradient(transparent,var(--card-bg))}.withdraw-hero{padding:30px 16px;border-radius:16px;margin-bottom:16px}.modal-close,.withdraw-btn{border:none;cursor:pointer}.withdraw-balance{font-size:48px;font-weight:800;margin:16px 0;text-shadow:0 4px 10px rgba(0,0,0,.3)}.withdraw-subtitle{font-size:14px;opacity:.9;margin-bottom:20px}.withdraw-btn{background:var(--gold-gradient);color:#000;padding:16px 24px;border-radius:14px;font-size:16px;font-weight:700;box-shadow:0 6px 20px rgba(255,215,0,.3);width:100%;max-width:260px;margin:0 auto}.withdraw-btn:active{transform:scale(.95)}.withdraw-form{background:var(--card-bg);border-radius:16px;padding:20px;margin-top:16px;border:1px solid var(--border);display:none}.withdraw-info{background:var(--bg-secondary);border-radius:10px;padding:14px;margin-bottom:16px}.withdraw-history{margin-top:20px}.modal{position:fixed;top:0;left:0;right:0;bottom:0;z-index:2000;display:flex;flex-direction:column;justify-content:center;align-items:center;opacity:0;transition:opacity .4s cubic-bezier(.34, 1.56, .64, 1);padding:16px}.level-title,.modal-header{justify-content:space-between}.admin-chat-window.active,.chat-modal.active,.modal.active,.prices-modal.active,.verification-modal.active{opacity:1;pointer-events:all}.modal-header{display:flex;align-items:flex-start;margin-bottom:16px;position:relative;flex-shrink:0}.modal-title{font-size:18px;font-weight:700;background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent}.modal-close{background:0 0;font-size:22px;color:var(--text-secondary);position:absolute;top:-8px;right:-8px;width:28px;height:28px;border-radius:50%;background:var(--card-bg);display:flex;align-items:center;justify-content:center;flex-shrink:0}.chat-modal,.prices-modal{top:0;left:0;right:0;bottom:0;flex-direction:column;pointer-events:none;transition:opacity .4s cubic-bezier(.34, 1.56, .64, 1);display:flex;z-index:2000;opacity:0}.like-btn:hover,.modal-close:hover,.share-btn:hover{background:var(--bg-secondary);color:var(--text-primary)}.modal-body{margin-bottom:16px;text-align:left}.about-feature,.about-footer,.prices-btn,.prices-title,.profile-btn,.profile-stat,.referral-code,.referral-info,.referral-stat,.referral-title{text-align:center}.balance-amount{font-size:40px;font-weight:800;margin:20px 0;background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent}.chat-name,.profile-btn{font-weight:600;font-size:15px}.profile-btn{background:var(--purple-gradient);color:#fff;border:none;padding:14px 20px;border-radius:12px;cursor:pointer;width:100%;margin-top:16px;box-shadow:0 6px 16px rgba(139,92,246,.25)}.chat-modal{position:fixed;background:rgba(5,5,16,.95)}.chat-header{background:var(--card-bg);padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}.chat-avatar{width:36px;height:36px;border-radius:50%;background:var(--purple-gradient);display:flex;align-items:center;justify-content:center;overflow:hidden}.chat-info,.chat-info-small,.profile-info,.verification-modal-user-info,.verification-user-info{flex:1}.chat-status,.level-info{font-size:12px;color:var(--text-secondary)}.chat-close{background:0 0;border:none;font-size:22px;color:var(--text-secondary);cursor:pointer}.chat-messages{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;max-height:calc(100vh - 120px)}.message{max-width:85%;padding:8px 12px;border-radius:12px;margin-bottom:4px;word-wrap:break-word;overflow-wrap:break-word;white-space:pre-wrap;position:relative;font-size:14px;line-height:1.3}.message-admin{background:var(--card-bg);align-self:flex-start;border-bottom-left-radius:4px}.message-user{background:var(--accent);align-self:flex-end;border-bottom-right-radius:4px}.chat-input{padding:8px 10px;background:var(--card-bg);border-top:1px solid var(--border);display:flex;gap:8px}.chat-input input{flex:1;background:var(--bg-secondary);border:1px solid var(--border);border-radius:16px;padding:10px 14px;font-size:14px}.chat-send{background:var(--accent);border:none;border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;color:#fff;cursor:pointer;font-size:14px}.prices-modal{position:fixed;background:rgba(5,5,16,.95);justify-content:center;align-items:center}.prices-content{background:var(--card-bg);border-radius:16px;padding:20px;width:95%;max-width:380px;border:1px solid var(--border);box-shadow:0 20px 40px rgba(0,0,0,.4)}.prices-title{font-size:18px;font-weight:700;margin-bottom:16px;background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent}.price-grid{display:flex;flex-direction:column;gap:10px;margin-bottom:16px}.price-item{background:var(--bg-secondary);padding:14px;border-radius:12px;display:flex;justify-content:between;align-items:center;border:1px solid var(--border)}.price-time{font-weight:600;flex:1}.price-amount{background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:800;font-size:16px}.prices-btn{background:var(--accent);color:#fff;border:none;padding:14px;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;width:100%}.profile-header{display:flex;align-items:center;margin-bottom:16px;padding:14px;background:var(--card-bg);border-radius:16px;border:1px solid var(--border)}.profile-avatar{width:70px;height:70px;border-radius:50%;overflow:hidden;margin-right:14px;position:relative;border:2px solid var(--accent)}.admin-chat-window,.verification-modal{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none}.profile-name{font-size:18px;font-weight:700;margin-bottom:4px}.profile-id{font-size:12px;color:var(--text-secondary);margin-bottom:6px}.profile-level{display:inline-block;background:var(--purple-gradient);padding:4px 10px;border-radius:10px;font-size:11px;font-weight:600;cursor:pointer}.about-features,.admin-buttons,.profile-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px}.profile-stat{background:var(--card-bg);border-radius:14px;padding:14px;border:1px solid var(--border)}.stat-value{font-size:18px;font-weight:700;margin-bottom:4px;background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent}.level-progress,.profile-action{background:var(--card-bg);padding:14px}.feature-text,.referral-label,.stat-label{font-size:11px;color:var(--text-secondary)}.form-group,.profile-section{margin-bottom:16px}.section-title{font-size:23px;font-weight:700;margin-bottom:20px;margin-top:20px;padding-left:6px;border-left:3px solid var(--accent)}.profile-actions{display:flex;flex-direction:column;gap:10px}.profile-action{display:flex;align-items:center;border-radius:14px;border:1px solid var(--border);cursor:pointer}.action-icon{width:22px;height:22px;margin-right:15px;display:flex;align-items:center;justify-content:center;border-radius:6px}.action-text{flex:1;font-size:14px;font-weight:500}.level-progress{margin-top:16px;border-radius:14px;border:1px solid var(--border)}.level-title{display:flex;margin-bottom:8px}.task-header,.task-meta{justify-content:space-between}.level-name,.verification-user{font-weight:600}.level-count,.verification-modal-task{color:var(--text-secondary);font-size:13px}.progress-bar{height:6px;background:var(--bg-secondary);border-radius:3px;overflow:hidden;margin-bottom:6px}.progress-fill{height:100%;background:var(--gold-gradient);border-radius:3px;width:0%}.referral-system{background:var(--card-bg);border-radius:14px;padding:14px;margin:16px 0;border:1px solid var(--border)}.referral-title{font-size:16px;font-weight:700;margin-bottom:10px}.referral-code{background:var(--bg-secondary);border-radius:10px;padding:10px;margin-bottom:14px;border:1px solid var(--border)}.code-value{font-size:18px;font-weight:700;letter-spacing:2px;margin-bottom:6px;background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent}.copy-btn{background:var(--accent);color:#fff;border:none;padding:8px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;width:100%}.referral-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:14px}.confirmation-buttons,.filters-container,.task-header{display:flex}.referral-stat{background:var(--bg-secondary);border-radius:8px;padding:10px;border:1px solid var(--border)}.referral-info{font-size:12px;color:var(--text-secondary);margin-top:8px}.about-content,.admin-panel{background:var(--card-bg);border-radius:14px;padding:16px;margin-bottom:16px;border:1px solid var(--border)}.about-title,.admin-title{font-size:18px;font-weight:700;margin-bottom:14px;text-align:center;background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent}.about-footer,.about-text{color:var(--text-secondary)}.about-text{font-size:20px;line-height:1.6;margin-bottom:14px}.about-feature{background:var(--bg-secondary);border-radius:10px;padding:10px;border:1px solid var(--border)}.filter-btn,.search-input{background:var(--card-bg)}.feature-icon{font-size:20px;margin-bottom:6px}.about-footer{font-size:11px;margin-top:16px}.tasks-tab{padding-bottom:16px}.search-input{width:100%;border:1px solid var(--border);border-radius:14px;padding:12px 16px 12px 45px;color:var(--text-primary);font-size:14px}.filter-btn{border:1px solid var(--border);color:var(--text-secondary)}.filter-btn.active{background:var(--accent);border-color:var(--accent)}.tasks-grid{grid-template-columns:1fr!important;gap:12px!important;margin:0!important;padding:0!important;overflow:hidden!important}.task-description,.task-title{word-break:break-word!important;overflow-wrap:break-word!important;hyphens:auto!important}.task-card.fade-in{animation:none}.task-header{align-items:flex-start;margin-bottom:12px;gap:10px;width:100%;flex-wrap:wrap}.task-title{font-size:15px!important;line-height:1.3!important;color:var(--text-primary)!important;font-weight:600!important;margin-bottom:8px!important;flex:1;min-width:0}.task-category{color:var(--accent);background:rgba(99,102,241,.1);border-radius:10px;display:inline-block;font-weight:600;border:1px solid rgba(99,102,241,.2);flex-shrink:0}.task-price{font-size:18px!important;font-weight:800!important;background:var(--gold-gradient)!important;-webkit-background-clip:text!important;background-clip:text!important;color:transparent!important;flex-shrink:0!important;white-space:nowrap!important;margin-left:10px}.task-meta{display:flex;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:6px;flex-shrink:0}.task-description{font-size:13px!important;line-height:1.4!important;color:var(--text-secondary)!important;margin-bottom:12px!important}.task-description.collapsed{max-height:50px;overflow:hidden}.task-description.collapsed::after{position:absolute;bottom:0;left:0;right:0;height:25px;pointer-events:none}.read-more-btn{background:var(--accent);align-self:flex-start}.task-footer{display:flex;justify-content:space-between;align-items:center;margin-top:auto;flex-shrink:0;width:100%;padding-top:10px;border-top:1px solid var(--border);flex-wrap:wrap;gap:6px}.task-time{font-size:11px;color:var(--text-secondary);display:flex;align-items:center;gap:4px;font-weight:500;flex-shrink:0}.task-time::before{content:'⏱️';font-size:12px}.task-btn{background:var(--accent)!important;color:#fff!important;border:none!important;padding:8px 14px!important;border-radius:8px!important;font-size:13px!important;font-weight:600!important;cursor:pointer!important;flex-shrink:0!important;transition:.3s!important;box-shadow:0 4px 10px rgba(99,102,241,.25)!important;display:inline-block!important}.task-btn:hover{background:var(--accent-hover);transform:translateY(-2px);box-shadow:0 6px 16px rgba(99,102,241,.35)}.task-btn:active{transform:translateY(0);box-shadow:0 2px 6px rgba(99,102,241,.3)}.task-availability{background:var(--purple-gradient)}@keyframes taskCardAppear{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.task-card{animation:.5s ease-out taskCardAppear}.task-card.completed{border-left:3px solid var(--success);background:linear-gradient(135deg,var(--card-bg),rgba(16,185,129,.05))}.task-card.pending{border-left:3px solid var(--warning);background:linear-gradient(135deg,var(--card-bg),rgba(245,158,11,.05))}.task-progress{width:100%;height:4px;background:var(--bg-secondary);border-radius:2px;margin-bottom:10px;overflow:hidden}.task-modal-description,.task-modal-title{overflow-wrap:break-word;word-wrap:break-word}.task-progress-bar{height:100%;background:var(--accent);border-radius:2px;transition:width .3s}.task-progress-text{font-size:10px;color:var(--text-secondary);text-align:right;margin-top:2px}.task-difficulty{font-weight:700;border-radius:8px;flex-shrink:0}.task-difficulty.легкая,.task-status.completed{background:rgba(16,185,129,.15);color:#10b981;border:1px solid rgba(16,185,129,.3)}.task-difficulty.средняя{background:rgba(245,158,11,.15);color:#f59e0b;border:1px solid rgba(245,158,11,.3)}.task-difficulty.сложная,.task-status.rejected{background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.3)}.no-tasks{padding:20px!important;margin:0!important;min-height:auto!important}.no-tasks-icon{font-size:36px;margin-bottom:12px}.task-modal-content{background:var(--card-bg);border-radius:16px;padding:20px;width:95%;max-width:480px;max-height:80vh;border:1px solid var(--border);box-shadow:0 20px 40px rgba(0,0,0,.4);overflow-y:auto}.task-modal-title{font-size:20px;font-weight:700;margin-bottom:6px;background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent;line-height:1.3;max-width:80%}.task-modal-category{display:inline-block;background:var(--bg-secondary);padding:4px 10px;border-radius:6px;font-size:11px;color:var(--text-secondary);margin-bottom:14px}.task-modal-price{font-size:24px;font-weight:800;margin:16px 0;background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent;text-align:center}.task-modal-description,.task-modal-details{margin-bottom:20px;background:var(--bg-secondary)}.task-modal-description{font-size:14px;color:var(--text-secondary);line-height:1.6;white-space:pre-wrap;padding:14px;border-radius:10px;border-left:3px solid var(--accent)}.task-modal-details{border-radius:10px;padding:16px;border:1px solid var(--border)}.task-detail{display:flex;justify-content:space-between;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,.1)}.task-modal-cancel,.task-modal-start{padding:12px 16px;cursor:pointer;font-size:14px;transition:.3s}.task-detail:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none}.task-detail-label{color:var(--text-secondary);font-weight:500}.task-detail-value,.task-modal-cancel{color:var(--text-primary);font-weight:600}.task-detail-value{text-align:right;max-width:60%;word-wrap:break-word}.task-modal-buttons{display:flex;gap:10px;margin-top:16px;flex-shrink:0}.task-modal-cancel{background:var(--bg-secondary);border:1px solid var(--border);border-radius:10px;flex:1}.task-modal-start{background:var(--accent);color:#fff;border:none;border-radius:10px;flex:1;font-weight:600}.task-modal-cancel:hover,.task-modal-start:hover{transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,.2)}.confirmation-task{background:var(--card-bg);border-radius:14px;padding:14px;border:1px solid var(--border);margin-bottom:14px}.admin-input,.confirmation-no{border:1px solid var(--border)}.confirmation-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.confirmation-price{font-size:16px;font-weight:700;background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent}.confirmation-no,.confirmation-yes{padding:8px;cursor:pointer;font-weight:600}.confirmation-question{font-size:13px;margin-bottom:14px;text-align:center}.confirmation-no{background:var(--bg-secondary);color:var(--text-primary);border-radius:8px;flex:1}.confirmation-yes{background:var(--accent);border:none;border-radius:8px;flex:1}.confirmation-rejected{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);padding:10px;border-radius:8px;margin-top:10px}.confirmation-rejected-text{color:var(--error);font-size:13px;margin-bottom:6px}.admin-btn,.confirmation-support{background:var(--accent);color:#fff;font-weight:600;cursor:pointer}.confirmation-support{border:none;padding:6px 12px;border-radius:6px;font-size:11px;width:100%}.admin-btn{border:none;padding:10px;border-radius:10px;font-size:13px;text-align:center}.admin-form{background:var(--bg-secondary);border-radius:10px;padding:14px;margin-bottom:14px}.admin-input,.admin-textarea{background:var(--card-bg);color:var(--text-primary);margin-bottom:10px;padding:10px;font-size:14px;width:100%}.admin-input{border-radius:8px}.admin-textarea{border:1px solid var(--border);border-radius:8px;min-height:80px;resize:vertical}.admin-submit{background:var(--success);color:#fff;border:none;padding:10px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;width:100%}.admin-task-list{max-height:280px;overflow-y:auto}#admin-posts-section,.page.active,.tab-content.active{display:block}.post{background:var(--card-bg);border-radius:10px;padding:12px;margin-bottom:12px;border-left:3px solid var(--accent)}.task-card.rejected{border-left:3px solid var(--error);background:linear-gradient(135deg,var(--card-bg),rgba(239,68,68,.05))}.task-card.rejected:hover{border-color:var(--error);box-shadow:0 4px 12px rgba(239,68,68,.2)}.rejection-info{background:rgba(239,68,68,.1)!important;border:1px solid rgba(239,68,68,.3)!important;border-radius:8px;padding:10px;margin:10px 0}.support-btn{background:var(--accent)!important;color:#fff!important;border:none!important;padding:8px 12px!important;border-radius:6px!important;font-size:12px!important;font-weight:600!important;cursor:pointer!important;transition:.3s!important}.support-btn:hover{background:var(--accent-hover)!important;transform:translateY(-1px)!important}.post-content{white-space:pre-wrap}.post-meta{font-size:11px;color:var(--text-secondary);border-top:1px solid var(--border);padding-top:8px}.admin-badge{display:inline-block;background:var(--error);margin-left:6px}.admin-admins-list,.admin-chat-list,.admin-chats-container{max-height:350px;overflow-y:auto;margin-top:12px}.chat-last-message,.chat-name-small{overflow:hidden;text-overflow:ellipsis}.chat-item{display:flex;align-items:center;padding:10px;background:var(--bg-secondary);border-radius:10px;margin-bottom:6px;cursor:pointer;border:1px solid var(--border)}.chat-last-message{color:var(--text-secondary);margin-top:2px}.unread-indicator{width:6px;height:6px;background:var(--error);border-radius:50%}.page-header,.verification-modal-header{display:flex;align-items:center;margin-bottom:16px}.page-title{font-size:20px;font-weight:700;background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent}.verification-item{background:var(--card-bg);border:1px solid var(--border)}.verification-header{display:flex;justify-content:space-between;align-items:center}.verification-image{width:100%;border-radius:10px;margin-bottom:10px}.verification-actions{display:flex;gap:10px}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@media (min-width:768px){.about-features,.profile-stats,.referral-stats{grid-template-columns:repeat(4,1fr)}.tasks-grid{grid-template-columns:repeat(2,1fr)}.admin-buttons{grid-template-columns:repeat(3,1fr)}}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}.notification-content{flex:1;font-size:13px;font-weight:500}.notification-close{background:0 0;border:none;color:#fff;font-size:16px;cursor:pointer;padding:0;width:18px;height:18px;display:flex;align-items:center;justify-content:center}.chat-last-message,.chat-time{color:var(--text-secondary);white-space:nowrap}.chat-item:hover,.verification-item:hover{background:var(--bg-secondary);transform:translateY(-2px)}.chat-item.unread{border-left:3px solid var(--error);border-left:3px solid var(--error);background:rgba(239,68,68,.05)}.chat-info-small{flex:1;min-width:0}.action-icon img{object-fit:contain}.chat-name-small{font-weight:600;font-size:13px;margin-bottom:2px;white-space:nowrap}.chat-last-message{font-size:11px;max-width:180px}.chat-meta{display:flex;flex-direction:column;align-items:flex-end;flex-shrink:0}.chat-time{font-size:10px}.unread-badge{background:var(--error);color:#fff;border-radius:8px;padding:2px 5px;font-size:9px;font-weight:600;min-width:16px;text-align:center}.admin-chat-window{background:rgba(5,5,16,.95);z-index:2000;display:flex;flex-direction:column;opacity:0;transition:opacity .3s}.admin-chat-header,.admin-chat-input-container{background:var(--card-bg);background:var(--card-bg)}.admin-chat-header{background:var(--card-bg);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}.admin-chat-user{display:flex;align-items:center;gap:10px}.admin-chat-messages{flex:1;display:flex;flex-direction:column;gap:10px}.admin-chat-input-container{background:var(--card-bg);border-top:1px solid var(--border);display:flex;gap:10px;align-items:center}.admin-chat-input{flex:1;background:var(--bg-secondary);border:1px solid var(--border);border-radius:18px;padding:10px 14px;color:var(--text-primary);font-size:14px}.admin-chat-send{background:var(--accent);border:none;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;color:#fff;cursor:pointer}.message-image{margin-bottom:4px}.message-image img{max-width:100%;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.2)}.message-time{font-size:10px;color:var(--text-secondary);text-align:right;margin-top:3px}.admin-task-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}.admin-task-title{font-weight:600;font-size:14px;flex:1}.admin-task-description{color:var(--text-secondary);font-size:13px;margin-bottom:6px}.admin-task-details{display:flex;gap:8px;font-size:11px;flex-wrap:wrap}.admin-task-price{background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:700}.post-author,.post-date,.screenshot-note p{color:var(--text-secondary)}.admin-task-category{background:var(--bg-secondary);padding:2px 6px;border-radius:4px}.screenshot-note{margin:12px 0;padding:8px;background:var(--bg-secondary);border-radius:6px;border-left:2px solid var(--warning)}.screenshot-note p{margin:0;font-size:11px}@media (max-width:480px){.task-card{padding:10px!important;margin:0 0 10px!important}.task-title{font-size:14px!important}.task-description{font-size:12px!important}.task-price{font-size:16px!important}.task-btn{padding:8px 12px!important;font-size:12px!important}}.task-meta{flex-wrap:wrap!important;gap:4px!important}.task-category,.task-difficulty{font-size:10px!important;padding:3px 6px!important;white-space:nowrap!important}.admin-chat-header{padding:12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}.admin-chat-input-container,.admin-chat-user{gap:8px;align-items:center;display:flex}.admin-chat-messages{flex:1;display:flex;flex-direction:column}.admin-chat-input-container{padding:8px 12px;border-top:1px solid var(--border)}.post-date{opacity:.8}.post-author{display:flex;align-items:center}.admin-badge{background:var(--purple-gradient);color:#fff;padding:2px 5px;border-radius:3px;font-size:9px;font-weight:600}.post-content,.post-title{color:var(--text-primary);overflow-wrap:break-word;word-wrap:break-word}.chat-meta{display:flex;flex-direction:column;align-items:flex-end;gap:3px;min-width:50px}.post-content{line-height:1.5;margin-bottom:10px;white-space:pre-wrap;max-width:100%}.post-title{font-size:16px;font-weight:700;margin-bottom:6px;line-height:1.3}.chat-tab-btn,.read-more-btn{font-size:11px;cursor:pointer}.chat-stats,.chat-tabs,.confirmation-icon,.post-item{margin-bottom:12px}.post-item{background:var(--card-bg);border-radius:14px;padding:16px;border:1px solid var(--border);box-shadow:0 6px 20px rgba(0,0,0,.2);backdrop-filter:blur(10px);animation:.6s ease-out fadeIn;overflow:hidden}.chat-tab-btn.active,.read-more-btn{background:var(--accent);color:#fff}.post-text-container{max-height:none;overflow:visible}.post-content.collapsed{max-height:120px;overflow:hidden;position:relative}.post-content.collapsed::after{position:absolute;bottom:0;left:0;right:0;height:50px;pointer-events:none}.read-more-btn{border:none;padding:6px 12px;border-radius:6px;font-weight:600;margin-top:6px;display:inline-block}.chat-tabs{display:flex;gap:6px;overflow-x:auto;padding-bottom:4px}.chat-tab-btn{background:var(--card-bg);border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--text-secondary);white-space:nowrap;transition:.3s}.chat-tab-btn.active{border-color:var(--accent)}.chat-stats{background:var(--bg-secondary);border-radius:8px;padding:10px;border:1px solid var(--border)}.chat-item.archived{opacity:.7;background:rgba(100,100,100,.1)}.chat-actions{display:flex;gap:4px;margin-left:8px}.chat-action-btn{background:0 0;border:none;padding:4px;border-radius:4px;cursor:pointer;font-size:10px;transition:.3s}.chat-delete-btn{color:var(--error);background:rgba(239,68,68,.1)}.chat-delete-btn:hover{background:rgba(239,68,68,.2)}.chat-archive-btn{color:var(--warning);background:rgba(245,158,11,.1)}.chat-archive-btn:hover{background:rgba(245,158,11,.2)}.chat-restore-btn{color:var(--success);background:rgba(16,185,129,.1)}.chat-restore-btn:hover{background:rgba(16,185,129,.2)}.archived-badge{background:var(--warning);color:#fff;border-radius:4px;padding:1px 3px;font-size:8px;margin-left:4px}.confirmation-modal-content{background:var(--card-bg);border-radius:16px;padding:20px;width:95%;max-width:380px;border:1px solid var(--border);box-shadow:0 20px 40px rgba(0,0,0,.4);text-align:center}.confirmation-icon{font-size:56px}.confirmation-title{font-size:20px;font-weight:700;margin-bottom:12px;background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent}.confirmation-text{font-size:14px;color:var(--text-secondary);margin-bottom:20px;line-height:1.5}.confirmation-buttons{display:flex;gap:10px;margin-bottom:16px}.confirmation-btn{flex:1;padding:12px 16px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;border:none;transition:.3s}.confirmation-yes{background:var(--success);color:#fff}.confirmation-no{background:var(--error);color:#fff}.back-button:hover,.confirmation-cancel{background:var(--bg-secondary)}.confirmation-cancel{color:var(--text-primary);border:1px solid var(--border)}.screenshot-upload{margin:16px 0}.screenshot-preview{max-width:100%;max-height:250px;border-radius:10px;margin:12px 0;display:none}.upload-btn{background:var(--accent);color:#fff;border:none;padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px;margin-bottom:12px}.verification-list{max-height:450px;overflow-y:auto;margin-top:12px}.verification-item{background:var(--card-bg);border-radius:14px;padding:14px;margin-bottom:10px;border:1px solid var(--border);cursor:pointer;transition:.3s}.verification-header{display:flex;align-items:center;margin-bottom:10px}.verification-avatar{width:45px;height:45px;border-radius:50%;background:var(--purple-gradient);display:flex;align-items:center;justify-content:center;margin-right:10px;color:#fff;font-weight:600;font-size:16px}.verification-user-name{font-weight:600;font-size:14px;margin-bottom:3px}.admin-admin-info,.verification-task-title{color:var(--text-secondary);font-size:12px}.verification-price{background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:700;font-size:16px}.verification-time{font-size:11px;color:var(--text-secondary);text-align:right}.verification-modal{background:rgba(5,5,16,.95);z-index:3000;display:flex;flex-direction:column;justify-content:center;align-items:center;opacity:0;transition:opacity .4s cubic-bezier(.34, 1.56, .64, 1);padding:16px}.verification-modal-content{background:var(--card-bg);border-radius:16px;padding:20px;width:95%;max-width:480px;border:1px solid var(--border);box-shadow:0 20px 40px rgba(0,0,0,.4);max-height:80vh;overflow-y:auto}.verification-modal-user{display:flex;align-items:center;flex:1}.verification-modal-avatar{width:50px;height:50px;border-radius:50%;background:var(--purple-gradient);display:flex;align-items:center;justify-content:center;margin-right:12px;color:#fff;font-weight:600;font-size:18px}.verification-modal-user-name{font-weight:600;font-size:16px;margin-bottom:3px}.verification-modal-price{background:var(--gold-gradient);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:700;font-size:20px}.verification-approve,.verification-reject{padding:12px 16px;font-size:14px;cursor:pointer;color:#fff;font-weight:600}.verification-modal-screenshot{width:100%;border-radius:10px;margin:16px 0;box-shadow:0 6px 20px rgba(0,0,0,.3)}.verification-modal-actions{display:flex;gap:10px;margin-top:16px}.verification-approve{background:var(--success);border:none;border-radius:10px;flex:1}.verification-reject{background:var(--error);border:none;border-radius:10px;flex:1}.rejected-task{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3)}.rejected-badge{background:var(--error);color:#fff;padding:3px 6px;border-radius:4px;font-size:10px;font-weight:600;margin-left:6px}.support-btn{background:var(--accent);margin-top:6px}.back-button,.like-btn,.share-btn{background:0 0;transition:.3s;cursor:pointer}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}.pulse{animation:2s infinite pulse}.posts-feed{margin-top:16px}.post-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}.like-btn,.post-author,.share-btn{display:flex;align-items:center;color:var(--text-secondary)}.post-author{font-size:11px;gap:4px}.post-date{font-size:10px;color:var(--text-secondary);white-space:nowrap;margin-left:8px}.post-image{width:100%;border-radius:6px;margin:8px 0;max-height:250px;object-fit:cover}.post-footer{display:flex;justify-content:space-between;align-items:center;padding-top:10px;border-top:1px solid var(--border)}.post-actions{display:flex;gap:12px}.like-btn,.share-btn{border:none;font-size:12px;gap:3px;padding:4px 8px;border-radius:4px}.loading-posts{text-align:center;padding:30px 16px;color:var(--text-secondary)}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.back-button{border:none;color:var(--text-primary);font-size:20px;margin-right:10px;padding:6px;border-radius:6px}.theme-slider:before,input:checked+.theme-slider{background-color:var(--accent)}[data-theme=light]{--bg-primary:#ffffff;--bg-secondary:#f8f9fa;--text-primary:#2d3748;--text-secondary:#4a5568;--card-bg:#ffffff;--border:#e2e8f0;--shadow:rgba(0, 0, 0, 0.1);--nav-bg:rgba(255, 255, 255, 0.95);--gold:#d97706;--gold-gradient:linear-gradient(135deg, #f59e0b, #d97706)}.theme-switch{position:relative;display:inline-block;width:50px;height:28px}.theme-switch input{opacity:0;width:0;height:0}.theme-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--bg-secondary);border:1px solid var(--border);transition:.4s;border-radius:28px}.btn-secondary,.filter-btn{cursor:pointer;transition:.3s}.theme-slider:before{position:absolute;content:"🌙";left:4px;bottom:3px;transition:.4s;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px}input:checked+.theme-slider:before{content:"☀️";transform:translateX(22px)}.admin-chat-messages{flex:1;padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;max-height:calc(100vh - 160px)}.message-text{word-wrap:break-word;overflow-wrap:break-word;white-space:pre-wrap;line-height:1.3;max-width:100%}.admin-admin-item{background:var(--card-bg);border-radius:10px;padding:12px;margin-bottom:8px;border:1px solid var(--border)}.admin-admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}.search-container,.tasks-tabs{margin-bottom:16px;position:relative}.admin-admin-name{font-weight:600;font-size:14px}.admin-admin-actions{display:flex;gap:6px}.tasks-grid,.tasks-tab>div[id$="-tasks"].active{display:block!important;opacity:1!important}.tasks-tab{min-height:400px;position:relative}.tasks-grid{width:100%!important}.tasks-tab .fade-in{animation:none!important;opacity:1!important}.filters-container{display:flex;flex-wrap:nowrap;position:relative;z-index:1}.search-container{z-index:1}.task-card[style*=animation-delay]{animation-delay:0s!important}.tasks-tabs{display:flex;background:var(--card-bg);border-radius:14px;padding:6px;border:1px solid var(--border);overflow-x:auto;white-space:nowrap;z-index:2}#completed-tasks,#confirmation-tasks,#new-tasks,#rejected-tasks{position:relative;transform:none!important;transition:none!important;animation:none!important;height:auto;min-height:auto}.no-tasks{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;width:100%}.tasks-tab>div[id$="-tasks"]{display:none!important;opacity:0!important;transition:opacity .3s!important}.tasks-tab{overflow:visible!important}.loading-spinner{font-size:28px;margin-bottom:12px;animation:1s linear infinite spin}.form-group label{display:block;margin-bottom:6px;font-weight:600;color:var(--text-primary);font-size:13px}.form-row{display:flex;gap:12px;margin-bottom:16px}.form-row .form-group{flex:1;margin-bottom:0}.image-upload-area:hover{border-color:var(--accent);background:rgba(99,102,241,.05)}.upload-placeholder{color:var(--text-secondary);pointer-events:none}.btn-secondary{background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border);padding:10px 16px;border-radius:8px;font-weight:600}.btn-secondary:hover{background:var(--card-bg);border-color:var(--accent)}.task-availability{position:absolute;top:10px;right:10px;background:var(--accent);color:#fff;padding:4px 8px;border-radius:6px;font-size:10px;font-weight:600;z-index:2;box-shadow:0 2px 8px rgba(0,0,0,.3)}#filter-info,.filter-btn{color:var(--text-secondary)}.task-status{font-size:12px;font-weight:600;padding:6px 10px;border-radius:8px;display:inline-flex;align-items:center;gap:4px}.filters-container{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px;scrollbar-width:thin;scrollbar-color:var(--accent) var(--bg-secondary)}.filters-container::-webkit-scrollbar{height:4px}.filters-container::-webkit-scrollbar-track{background:var(--bg-secondary);border-radius:2px}.filters-container::-webkit-scrollbar-thumb{background:var(--accent);border-radius:2px}.filter-btn{background:var(--card-bg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-size:12px;white-space:nowrap;flex-shrink:0}.filter-btn:hover{border-color:var(--accent);color:var(--text-primary);transform:translateY(-1px)}.filter-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 4px 12px rgba(99,102,241,.3)}#filter-info{margin:10px 0;padding:12px;background:var(--bg-secondary);border-radius:10px;font-size:14px;display:flex;justify-content:space-between;align-items:center;border-left:3px solid var(--accent)}
</style>
</head>
<body>

<!-- ЗАМЕНИТЬ этот блок -->
<header class="header fade-in">
    <div class="logo" onclick="showMainTab()">
        <div class="logo-text">LinkGold</div>
    </div>
    <div class="slogan">Монетизируйте вашу активность</div>
</header>

<main class="main-content">
    <!-- Вкладка главной страницы -->
    <div id="main-tab" class="tab-content active">
        <!-- Герой баннер с изображением -->
        <div class="hero-banner fade-in">
            <img src="IMG_4397.png" alt="LinkGold" style="width: 100%; height: 100%; object-fit: cover;">
        </div>

        <!-- Компактные параллельные блоки -->
        <div class="stats-grid fade-in">
            <div class="stat-card balance-card" onclick="showBalanceModal()">
                <div class="stat-icon">
                    <div class="video-container">
                        <img src="curved-stack-money-icon-3d-illustration.png" alt="Баланс" style="width: 100%; height: 100%; object-fit: contain; ">
                    </div>
                </div>
                <div class="stat-label">Баланс</div>
                <div class="stat-value" id="user-balance-main">0 ⭐</div>
            </div>
            
            <div class="stat-card support-card" onclick="openAdminChat()">
                <div class="stat-icon">
                    <div class="video-container">
                        <img src="3d-rendering-ruk-dausih-biznes-koncepciu-udara-kul-no-bg-preview (carve.photos).png" alt="Поддержка" style="width: 100%; height: 100%; object-fit: contain;">
                    </div>
                </div>
                <div class="stat-label">Поддержка</div>
                <div class="stat-value">24/7</div>
            </div>
        </div>

        <!-- Как работает -->
        <div class="exchange-card fade-in" onclick="showHowItWorksPage()">
            <div class="exchange-icon">
                <div class="video-container">
                    <img src="m003t0593_a_bag_with_hand_31aug22-edited-free (carve.photos).png" alt="Как работает" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
            </div>
            <div class="exchange-title">Как работает</div>
            <div class="exchange-text">О заработке и выводе средств</div>
        </div>

        <!-- Размещение поста -->
        <div class="post-promo fade-in">
            <div class="post-icon">
                <div class="video-container video-large">
                    <img src="m011t0430_a_clipboard_30aug22-edited-free (carve.photos).png" alt="Разместить пост" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
            </div>
            <div class="post-title">Разместите пост</div>
            <div class="post-description">Рекламируйте в нашем канале и получайте охват аудитории</div>
            <button class="btn btn-primary btn-full" onclick="showPrices()">Разместить</button>
        </div>

        <!-- Кнопка перехода к заданиям -->
        <div class="tasks-button-container fade-in">
            <button class="tasks-btn" onclick="showTasksTab()">
                Смотреть все задания
            </button>
        </div>

        <!-- Секция постов на главной -->
        <div id="posts-section" class="fade-in" style="display: none; margin-top: 20px;">
            <div class="posts-header">
                <h2 style="color: var(--text-primary); margin-bottom: 25px; text-align: center; font-size: 24px;">📢 Последние новости</h2>
            </div>
            <div id="posts-container">
                <!-- Посты будут загружаться здесь -->
            </div>
        </div>


            
            <!-- Чаты с пользователями -->
            <div id="admin-chats-container" class="admin-chats-container" style="display: none;">
                <button class="chat-photo-btn" onclick="sendPhotoToAdmin()" title="Отправить фото">📷</button>
                <!-- Чаты будут загружаться динамически -->
            </div>
            



            <!-- Проверка заданий -->
            <div id="task-verification" class="admin-form" style="display: none;">
                <h3>Задания на проверке</h3>
                <div id="verification-list">
                    <!-- Задания на проверке будут загружаться динамически -->
                </div>
            </div>
        </div>

        <!-- Лента постов -->
        <div id="posts-section" class="card fade-in" style="display: none;">
            <div class="posts-header">
                <h2>Последние посты</h2>
                <button onclick="loadPosts()" class="refresh-btn">Обновить</button>
            </div>
            <div id="posts-container">
                <div class="loading">Загрузка постов...</div>
            </div>
        </div>
    </div>
    
    <div id="tasks-tab" class="tab-content tasks-tab">
    <div class="tasks-tabs">
        <div class="task-tab active" onclick="showTaskCategory('new')">Новые</div>
        <div class="task-tab" onclick="showTaskCategory('confirmation')">Подтверждение</div>
        <div class="task-tab" onclick="showTaskCategory('completed')">Выполненные</div>
        <div class="task-tab" onclick="showTaskCategory('rejected')">Отклоненные</div>
    </div>
        
        <div class="search-container fade-in">
            <div class="search-icon"></div>
            <input type="text" class="search-input" id="task-search" placeholder="Поиск заданий...">
        </div>
        
        <div class="filters-container fade-in">
    <button class="filter-btn active" data-filter="all" onclick="filterTasks('all')">Все</button>
    <button class="filter-btn" data-filter="social" onclick="filterTasks('social')">Соцсети</button>
    <button class="filter-btn" data-filter="subscribe" onclick="filterTasks('subscribe')">Подписки</button>
    <button class="filter-btn" data-filter="view" onclick="filterTasks('view')">Просмотры</button>
    <button class="filter-btn" data-filter="comment" onclick="filterTasks('comment')">Комментарии</button>
    <button class="filter-btn" data-filter="repost" onclick="filterTasks('repost')">Репосты</button>
</div>

        
          <!-- Новые задания -->
    <div id="new-tasks" class="tasks-grid active" style="display: block;">
        <!-- Задания будут здесь -->
    </div>
    
    <!-- Остальные контейнеры ДОЛЖНЫ быть скрыты -->
    <div id="confirmation-tasks" class="tasks-grid" style="display: none;">
        <!-- ... -->
    </div>
    
    <div id="completed-tasks" class="tasks-grid" style="display: none;">
        <!-- ... -->
    </div>

    <div id="rejected-tasks" class="tasks-grid" style="display: none;">
        <!-- ... -->
    </div>
</div> <!-- Закрытие tasks-tab -->
    
    <!-- Вкладка профиля -->
    <div id="profile-tab" class="tab-content">
        <!-- Заголовок профиля -->
        <div class="profile-header fade-in">
            <div class="profile-avatar">
                <img id="user-photo" src="" alt="Фото профиля" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div class="profile-info">
                <div class="profile-name" id="user-first-name">Имя</div>
                <div class="profile-id">TG: @<span id="user-username">username</span></div>
                <div class="profile-level">Уровень <span id="user-level">0</span></div>
            </div>
        </div>
        
        <!-- Статистика профиля -->
        <div class="profile-stats fade-in">
            <div class="profile-stat">
                <div class="stat-value">0 ⭐</div>
                <div class="stat-label">Баланс</div>
            </div>
            <div class="profile-stat">
                <div class="stat-value">0</div>
                <div class="stat-label">Выполнено</div>
            </div>
            <div class="profile-stat">
                <div class="stat-value">0</div>
                <div class="stat-label">Активных</div>
            </div>
            <div class="profile-stat">
                <div class="stat-value">0%</div>
                <div class="stat-label">Качество</div>
            </div>
        </div>
        
        <!-- Прогресс уровня -->
        <div class="level-progress fade-in">
            <div class="level-title">
                <span class="level-name">Прогресс уровня</span>
                <span class="level-count">Скоро...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="level-progress-bar"></div>
            </div>
            <div class="level-info">
                Скоро...
            </div>
        </div>
        
        <!-- Реферальная система -->
        <div class="referral-system fade-in">
            <div class="referral-title">Реферальная система</div>
            
            <div class="referral-code">
                <div class="referral-label">Ваша реферальная ссылка</div>
                <input type="text" id="referral-link" readonly style="width: 100%; padding: 8px; margin: 8px 0; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); text-align: center;">
                <button class="copy-btn" onclick="copyReferralLink()">Скопировать ссылку</button>
            </div>
            
            <div class="referral-stats">
                <div class="referral-stat">
                    <div class="referral-value" id="ref-invited">0</div>
                    <div class="referral-label">Приглашено</div>
                </div>
                <div class="referral-stat">
                    <div class="referral-value" id="ref-earned">0 ⭐</div>
                    <div class="referral-label">Заработано</div>
                </div>
            </div>
            
            <div class="referral-info">
                Приглашайте друзей и получайте 10% от их заработка!
            </div>
        </div>
        <!-- В секции профиля после реферальной системы -->
<div class="referral-system fade-in">
    <div class="referral-title">🎫 Активация промокода</div>
    
    <div class="referral-code">
        <div class="referral-label">Введите промокод для получения бонуса</div>
        <input type="text" id="promocode-input" 
               style="width: 100%; padding: 12px; margin: 8px 0; background: var(--bg-primary); 
                      border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); 
                      text-align: center; text-transform: uppercase;"
               placeholder="ВВЕДИТЕ ПРОМОКОД" maxlength="20">
        <button class="copy-btn" onclick="activatePromoCode()">Активировать промокод</button>
    </div>
    
    <div id="promocode-message" style="margin-top: 10px; min-height: 20px; font-size: 14px;"></div>
</div>


        <!-- В разделе профиля -->
<div class="profile-actions">
    <div class="profile-action" onclick="showWithdrawPage()">
        <div class="action-icon">
            <img src="Снимок экрана 2025-11-01 203523-Photoroom.png" alt="Вывод средств" style="width: 20px; height: 20px;">
        </div>
        <div class="action-text">Вывод средств</div>
        <div class="action-arrow">›</div>
    </div>
    <div class="profile-action" onclick="showHowItWorksPage()">
        <div class="action-icon">
            <img src="Снимок экрана 2025-11-01 204653-Photoroom.png" alt="Как это работает" style="width: 20px; height: 20px;">
        </div>
        <div class="action-text">Как это работает</div>
        <div class="action-arrow">›</div>
    </div>
    <div class="profile-action" onclick="showAboutPage()">
        <div class="action-icon">
            <img src="Снимок экрана 2025-11-01 204727-Photoroom.png" alt="О приложении" style="width: 20px; height: 20px;">
        </div>
        <div class="action-text">О приложении</div>
        <div class="action-arrow">›</div>
    </div>
</div>


        <!-- Настройки -->
        <div class="profile-section fade-in">
            <div class="section-title">Настройки</div>
            <div class="profile-actions">
              <div class="profile-action" onclick="openAdminChat()">
        <div class="action-icon">
            <img src="Снимок экрана 2025-11-01 204806-Photoroom.png" alt="Поддержка" style="width: 20px; height: 20px;">
        </div>
        <div class="action-text">Поддержка</div>
        <div class="action-arrow">›</div>
    </div>
</div>
        </div>
    </div>


  <div id="admin-tab" class="tab-content">
    <div class="page-header">
        <button class="back-button" onclick="showMainTab()">←</button>
        <div class="page-title">Панель администратора</div>
    </div>


<div class="admin-buttons">
    <button class="admin-btn" onclick="showAdminSection('posts')">📝 Посты</button>
    <button class="admin-btn" onclick="showAdminSection('tasks')">📋 Задания</button>
    <button class="admin-btn" onclick="showAdminVerificationSection()">✅ Проверка</button>
    <button class="admin-btn" onclick="showAdminSection('support')">💬 Поддержка</button>
    <button class="admin-btn" onclick="showAdminSection('payments')">💳 Оплаты</button>
    <button class="admin-btn" onclick="showAdminSection('admins')">👥 Админы</button>
    <button class="admin-btn" onclick="showAdminSection('promocodes')">🎫 Промокоды</button>
</div>

<!-- Секция управления админами -->
<div id="admin-admins-section" class="admin-section" style="display: none;">
    <div class="admin-form">
        <h3>👥 Добавление администраторов</h3>
        <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
            <strong>Только главный администратор (ID: 8036875641) может добавлять других админов</strong>
        </p>
        
        <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <h4 style="color: var(--gold); margin-bottom: 10px;">💡 Как добавить администратора:</h4>
            <ol style="color: var(--text-secondary); font-size: 14px; padding-left: 20px;">
                <li>Попросите пользователя написать боту: <strong>@LinkGoldMoney_bot</strong></li>
                <li>Пользователь должен выполнить команду <strong>/start</strong></li>
                <li>Узнайте его Telegram username (например: <strong>@username</strong>)</li>
                <li>Введите username ниже без символа @</li>
            </ol>
            <div style="margin-top: 10px; padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px;">
                <strong>Примеры правильных username:</strong>
                <div style="font-size: 12px; margin-top: 5px;">
                    • ivanpetrov (без @)<br>
                    • maria_ivanova (без @)<br>
                    • alexsmith123 (без @)
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label>Telegram username пользователя *</label>
            <input type="text" class="admin-input" id="new-admin-username" 
                   placeholder="Введите username без @ (например: ivanpetrov)"
                   style="text-align: center; font-weight: 600;">
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                Только пользователи, которые уже зарегистрированы в боте @LinkGoldMoney_bot
            </div>
        </div>
        
        <button class="admin-submit" onclick="addNewAdmin()" id="add-admin-btn">
            ➕ Добавить администратора
        </button>
        
        <div id="admin-form-message" style="margin-top: 12px; min-height: 20px; font-size: 14px;"></div>
    </div>

    <!-- Список текущих админов -->
    <div style="margin-top: 25px;">
        <h4>📋 Текущие администраторы</h4>
        <div id="admins-list" class="admin-task-list">
            <!-- Список админов будет загружен здесь -->
        </div>
    </div>
</div>

<!-- Секция управления промокодами -->
<div id="admin-promocodes-section" class="admin-section" style="display: none;">
    <div class="admin-form">
        <h3>🎫 Создать промокод</h3>
        
        <div class="form-group">
            <label for="promocode-code">Код промокода *</label>
            <input type="text" id="promocode-code" class="admin-input" 
                   placeholder="Например: WELCOME100" maxlength="20">
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="promocode-max-uses">Макс. использований *</label>
                <input type="number" id="promocode-max-uses" class="admin-input" 
                       value="10" min="1" max="10000">
            </div>
            
            <div class="form-group">
                <label for="promocode-reward">Награда (звезды) *</label>
                <input type="number" id="promocode-reward" class="admin-input" 
                       value="50" min="1" max="100000" step="1">
            </div>
        </div>
        
        <div class="form-group">
            <label for="promocode-expires">Дата истечения (необязательно)</label>
            <input type="datetime-local" id="promocode-expires" class="admin-input">
        </div>
        
        <div id="promocode-form-message" style="margin: 10px 0; min-height: 20px;"></div>
        
        <button id="create-promocode-btn" class="admin-submit" onclick="createPromoCode()">
            🎫 Создать промокод
        </button>
    </div>
    
    <div class="admin-tasks-list" id="promocodes-list">
        <!-- Список промокодов будет здесь -->
    </div>
</div>
  

        
   
        

        

<!-- Секция управления выплатами -->
<div id="admin-payments-section" class="admin-section" style="display: none;">
    <div class="admin-form">
        <h3>💳 Управление выплатами</h3>
        
        <!-- Диагностическая информация -->
        <div style="margin-bottom: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; font-size: 12px;">
                <span>Активные заявки: <strong id="active-withdrawals-count">0</strong></span>
                <span>Всего: <strong id="total-withdrawals-count">0</strong></span>
            </div>
            <div style="margin-top: 8px;">
                <button class="btn btn-primary" onclick="loadWithdrawalRequests()" style="padding: 6px 12px; font-size: 12px;">
                    🔄 Обновить
                </button>
                <button class="btn btn-warning" onclick="createTestWithdrawal()" style="padding: 6px 12px; font-size: 12px; margin-left: 8px;">
                    🧪 Тест
                </button>
            </div>
        </div>
        
        <!-- Список заявок -->
        <div id="withdrawal-requests-list">
            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                <div style="font-size: 48px; margin-bottom: 16px;">💫</div>
                <div>Загрузка заявок...</div>
            </div>
        </div>
    </div>
</div>
<div id="admin-posts-section" class="admin-section" style="display: none;">
    <div class="admin-form">
        <h3>📝 Добавить новый пост</h3>
        <input type="text" class="admin-input" id="admin-post-title" placeholder="Заголовок поста">
        <textarea class="admin-textarea" id="admin-post-content" placeholder="Введите текст поста..."></textarea>
        <button class="admin-submit" onclick="addNewPost()">Опубликовать</button>
    </div>
    
    <div style="margin-top: 25px;">
        <h3>📋 Существующие посты</h3>
        <div id="admin-posts-list">
            <!-- Посты будут загружены здесь -->
        </div>
    </div>
</div>


            <!-- Секция управления заданиями в админке -->
    <div id="admin-tasks-section" class="admin-section" style="display: none;">
        <div class="admin-form">
            <h3>➕ Добавить новое задание</h3>
            
            <!-- Поисковая система для заданий -->
            <div class="admin-search-container">
                <div class="admin-search-icon">🔍</div>
                <input type="text" class="admin-search-input" id="admin-task-search" 
                       placeholder="Поиск по названию, описанию или категории...">
                <button class="admin-search-clear" onclick="clearAdminTaskSearch()" style="display: none;">×</button>
            </div>
            <div class="admin-search-results" id="admin-search-results">
                <!-- Результаты поиска будут здесь -->
            </div>

            <!-- Остальная форма добавления задания -->
            <div class="form-group">
                <label>Название задания *</label>
                <input type="text" class="admin-input" id="admin-task-title" placeholder="Введите название задания">
            </div>
        
        <div class="form-group">
            <label>Описание задания *</label>
            <textarea class="admin-textarea" id="admin-task-description" placeholder="Подробное описание задания" rows="4"></textarea>
        </div>
        
        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label>Цена (в звездах) *</label>
                <input type="number" class="admin-input" id="admin-task-price" placeholder="50">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Категория</label>
                <select class="admin-input" id="admin-task-category">
                    <option value="subscribe">📱 Подписки</option>
                    <option value="view">👀 Просмотры</option>
                    <option value="comment">💬 Комментарии</option>
                    <option value="repost">🔄 Репосты</option>
                    <option value="social">👥 Соцсети</option>
                    <option value="other">📋 Другое</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label>Время выполнения</label>
                <input type="text" class="admin-input" id="admin-task-time" placeholder="5-10 минут">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Сложность</label>
                <select class="admin-input" id="admin-task-difficulty">
                    <option value="Легкая">🟢 Легкая</option>
                    <option value="Средняя">🟡 Средняя</option>
                    <option value="Сложная">🔴 Сложная</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label>Количество исполнителей</label>
            <input type="number" class="admin-input" id="admin-task-people" placeholder="10" value="10">
        </div>
        
        <div class="form-group">
            <label>Ссылка на задание (опционально)</label>
            <input type="url" class="admin-input" id="admin-task-url" placeholder="https://...">
        </div>


        
            <button class="admin-submit" onclick="addTaskWithImage()">
                ✅ Добавить задание
            </button>
        </div>
        
        <!-- Список созданных заданий -->
        <div id="admin-tasks-list-container" style="margin-top: 30px;">
            <h3>📋 Созданные задания</h3>
            <div id="admin-tasks-list">
                <!-- Задания будут загружены здесь -->
            </div>
        </div>
    </div>
            <!-- Проверка заданий -->
            <div id="admin-verification-section" class="admin-section" style="display: none;">
                <h3>Задания на проверке</h3>
                <div id="admin-verification-list">
                    <!-- Задания на проверке будут загружаться динамически -->
                </div>
            </div>

            <!-- Поддержка -->
            <div id="admin-support-section" class="admin-section" style="display: none;">
                <h3>💬 Чаты с пользователями</h3>
                
                <!-- Переключение между активными и архивными чатами -->
                <div class="chat-tabs" style="margin-bottom: 15px;">
                    <button class="chat-tab-btn active" onclick="showChatTab('active')">Активные чаты</button>
                    <button class="chat-tab-btn" onclick="showChatTab('archived')">Архивные чаты</button>
                    <button class="chat-tab-btn" onclick="showChatTab('all')">Все чаты</button>
                </div>
                
                <!-- Статистика чатов -->
                <div class="chat-stats" style="margin-bottom: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; font-size: 12px;">
                        <span>Активные: <strong id="active-chats-count">0</strong></span>
                        <span>Непрочитанные: <strong id="unread-chats-count">0</strong></span>
                        <span>Всего: <strong id="total-chats-count">0</strong></span>
                    </div>
                </div>
                
                <!-- Список активных чатов -->
                <div id="active-chats-list" class="admin-chat-list">
                    <!-- Активные чаты будут загружены здесь -->
                </div>
                
                <!-- Список архивных чатов -->
                <div id="archived-chats-list" class="admin-chat-list" style="display: none;">
                    <!-- Архивные чаты будут загружены здесь -->
                </div>
                
                <!-- Список всех чатов -->
                <div id="all-chats-list" class="admin-chat-list" style="display: none;">
                    <!-- Все чаты будут загружены здесь -->
                </div>
            </div>
        </div>
        
    </div>
 
    <!-- Страница "Как работает" -->
    <div id="how-it-works-page" class="page">
        <div class="page-header">
            <button class="back-button" onclick="showProfileTab()">←</button>
            <div class="page-title">Как работает LinkGold</div>
        </div>

        <div class="card">
            <p class="about-text">LinkGold — это платформа для заработка на выполнении простых заданий и активности в социальных сетях.</p>
            
            <p class="about-text">Основные принципы работы:</p>
            <ul class="about-text" style="padding-left: 20px; margin-bottom: 16px;">
                <li><strong>Выбирайте задания</strong> из доступных </li>
                <li><strong>Выполняйте</strong> их согласно инструкции</li>
                <li><strong>Получайте оплату</strong>после проверки </li>
                <li><strong>Выводите средства</strong></li>
            </ul>
            
            <p class="about-text">Виды заданий:</p>
            <ul class="about-text" style="padding-left: 20px; margin-bottom: 16px;">
                <li>Подписки на каналы и аккаунты</li>
                <li>Просмотры и лайки</li>
                <li>Репосты и комментарии</li>
                <li>Участие в опросах</li>
                <li>И многое другое</li>
            </ul>

            <div class="about-features">
                <div class="about-feature">
                    <div class="feature-icon">🚀</div>
                    <div class="feature-text">Быстрый старт</div>
                </div>
                <div class="about-feature">
                    <div class="feature-icon">💎</div>
                    <div class="feature-text">Честные условия</div>
                </div>
                <div class="about-feature">
                    <div class="feature-icon">🛡️</div>
                    <div class="feature-text">Надежная защита</div>
                </div>
                <div class="about-feature">
                    <div class="feature-icon">📈</div>
                    <div class="feature-text">Постоянный рост</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Страница "О приложении" -->
    <div id="about-page" class="page">
        <div class="page-header">
            <button class="back-button" onclick="showProfileTab()">←</button>
            <div class="page-title">О LinkGold</div>
        </div>

        <div class="card">
            <p class="about-text">LinkGold — это инновационная платформа для заработка, которая позволяет каждому пользователю монетизировать свою активность в интернете. Мы создали удобный и прозрачный сервис, где вы можете выполнять интересные задания и получать за это достойное вознаграждение.</p>
            
            <p class="about-text">Наша миссия — предоставить возможность дополнительного заработка для всех, кто готов проявить активность и выполнять простые задачи. Мы верим, что каждый должен иметь возможность монетизировать свое время и усилия, проведенные в интернете.</p>
            
            <p class="about-text">Мы постоянно работаем над улучшением сервиса, добавляем новые задания и возможности для заработка. Наша команда заботится о каждом пользователе и стремится создать лучшие условия для взаимовыгодного сотрудничества.</p>
            
            <div class="about-footer">
                LinkGold © 2023. Все права защищены.
            </div>
        </div>
    </div>

<!-- Страница вывода средств -->
<div id="withdraw-page" class="page">
    <div class="page-header">
        <button class="back-button" onclick="goBackToProfile()">←</button>
        <div class="page-title">💫 Вывод звезд</div>
    </div>

    <div class="card">
        <!-- Блок с балансом -->
        <div class="withdraw-hero">
            <div class="withdraw-balance" id="withdraw-balance-display">0 ⭐</div>
            <div class="withdraw-subtitle">Ваш текущий баланс</div>
            
            <!-- Информация о минимальном выводе -->
            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--gold); border-radius: 12px; padding: 12px; margin: 16px 0; text-align: center;">
                <div style="font-size: 14px; color: var(--gold); font-weight: 600;">
                    💫 Минимальная сумма вывода: <span style="color: white;">250 ⭐</span>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                    Баланс будет обнулен при выводе
                </div>
            </div>
            
            <button class="withdraw-btn" onclick="requestWithdraw()" id="withdraw-btn">
                Вывести средства
            </button>
        </div>

        <!-- История операций -->
        <div class="withdraw-history">
            <h3 style="margin-bottom: 15px; color: var(--text-primary);">📊 История выводов</h3>
            <div id="withdraw-history-list">
                <!-- История будет загружена здесь -->
            </div>
        </div>
    </div>
</div>

    <!-- Страница "Как это работает" -->
    <div id="how-it-works-page" class="page">
        <div class="page-header">
            <button class="back-button" onclick="goBackToProfile()">←</button>
            <div class="page-title">❓ Как это работает</div>
        </div>

        <div class="card">
            <div class="workflow-steps">
                <div class="workflow-step" style="display: flex; align-items: flex-start; margin-bottom: 25px; padding: 15px; background: var(--bg-secondary); border-radius: 12px;">
                    <div class="step-number" style="background: var(--accent); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0;">1</div>
                    <div>
                        <h4 style="margin-bottom: 8px;">📋 Выбирайте задания</h4>
                        <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">
                            В разделе "Задания" доступны различные активности: подписки, лайки, репосты и другие задания от рекламодателей.
                        </p>
                    </div>
                </div>

                <div class="workflow-step" style="display: flex; align-items: flex-start; margin-bottom: 25px; padding: 15px; background: var(--bg-secondary); border-radius: 12px;">
                    <div class="step-number" style="background: var(--accent); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0;">2</div>
                    <div>
                        <h4 style="margin-bottom: 8px;">⚡ Выполняйте задания</h4>
                        <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">
                            Следуйте инструкциям в каждом задании. Большинство заданий можно выполнить за 2-5 минут.
                        </p>
                    </div>
                </div>

                <div class="workflow-step" style="display: flex; align-items: flex-start; margin-bottom: 25px; padding: 15px; background: var(--bg-secondary); border-radius: 12px;">
                    <div class="step-number" style="background: var(--accent); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0;">3</div>
                    <div>
                        <h4 style="margin-bottom: 8px;">📸 Подтверждайте выполнение</h4>
                        <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">
                            После выполнения задания отправьте скриншот для проверки. Модерация занимает до 24 часов.
                        </p>
                    </div>
                </div>

                <div class="workflow-step" style="display: flex; align-items: flex-start; margin-bottom: 25px; padding: 15px; background: var(--bg-secondary); border-radius: 12px;">
                    <div class="step-number" style="background: var(--accent); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0;">4</div>
                    <div>
                        <h4 style="margin-bottom: 8px;">💳 Выводите деньги</h4>
                        <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">
                            Получайте выплаты на карту, электронные кошельки или криптовалюту. Минимальная сумма вывода - 50 рублей.
                        </p>
                    </div>
                </div>
            </div>

            <div class="faq-section" style="margin-top: 30px;">
                <h4 style="margin-bottom: 15px;">❔ Частые вопросы</h4>
                
                <div class="faq-item" style="margin-bottom: 15px; padding: 15px; background: var(--bg-secondary); border-radius: 12px;">
                    <div class="faq-question" style="font-weight: 600; margin-bottom: 8px;">Сколько времени занимает проверка задания?</div>
                    <div class="faq-answer" style="color: var(--text-secondary); font-size: 14px;">
                        Обычно проверка занимает от 1 до 24 часов. В выходные дни возможно увеличение времени проверки.
                    </div>
                </div>

                <div class="faq-item" style="margin-bottom: 15px; padding: 15px; background: var(--bg-secondary); border-radius: 12px;">
                    <div class="faq-question" style="font-weight: 600; margin-bottom: 8px;">Почему задание может быть отклонено?</div>
                    <div class="faq-answer" style="color: var(--text-secondary); font-size: 14px;">
                        Задание отклоняется если: не выполнены все условия, предоставлен нечеткий скриншот, нарушены правила выполнения.
                    </div>
                </div>

                <div class="faq-item" style="margin-bottom: 15px; padding: 15px; background: var(--bg-secondary); border-radius: 12px;">
                    <div class="faq-question" style="font-weight: 600; margin-bottom: 8px;">Как увеличить свой заработок?</div>
                    <div class="faq-answer" style="color: var(--text-secondary); font-size: 14px;">
                        Регулярно выполняйте задания, приглашайте друзей по реферальной программе, повышайте уровень аккаунта.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Страница "О приложении" -->
    <div id="about-page" class="page">
        <div class="page-header">
            <button class="back-button" onclick="goBackToProfile()">←</button>
            
            <div class="page-title">ℹ️ О приложении</div>
        </div>

        <div class="card">
            <div style="text-align: center; margin-bottom: 25px;">
                <div style="font-size: 48px; margin-bottom: 10px;">💰</div>
                <h2 style="margin-bottom: 10px;">LinkGold</h2>
                <p style="color: var(--text-secondary);">Платформа для заработка на выполнении заданий</p>
            </div>

            <div class="app-info" style="margin-bottom: 25px;">
                <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 15px;">
                    LinkGold — это современная платформа, которая позволяет каждому пользователю монетизировать 
                    свою активность в интернете. Мы создали прозрачную и удобную систему для заработка 
                    на выполнении простых заданий.
                </p>
                
                <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 15px;">
                    Наша миссия — предоставить возможность дополнительного дохода для всех, 
                    кто готов проявить активность и выполнять интересные задачи от рекламодателей.
                </p>
            </div>

            <div class="app-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px; background: var(--gold-gradient); -webkit-background-clip: text; background-clip: text; color: transparent;">10K+</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Пользователей</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px; background: var(--gold-gradient); -webkit-background-clip: text; background-clip: text; color: transparent;">50K+</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Выполненных заданий</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px; background: var(--gold-gradient); -webkit-background-clip: text; background-clip: text; color: transparent;">2M+</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Выплачено рублей</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px; background: var(--gold-gradient); -webkit-background-clip: text; background-clip: text; color: transparent;">99%</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Положительных отзывов</div>
                </div>
            </div>

            <div class="contact-info" style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; text-align: center;">
                <h4 style="margin-bottom: 15px;">📞 Контакты</h4>
                <p style="color: var(--text-secondary); margin-bottom: 10px; font-size: 14px;">
                    По всем вопросам обращайтесь в поддержку через раздел "Поддержка" в вашем профиле
                </p>
                <button class="btn btn-primary" onclick="openAdminChat()" style="margin-top: 10px;">
                    💬 Написать в поддержку
                </button>
            </div>

            <div class="about-footer" style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
                <div style="color: var(--text-secondary); font-size: 12px;">
                    LinkGold © 2024. Все права защищены.<br>
                    Версия 1.0.0
                </div>
            </div>
        </div>
    </div>


</main> 





<!-- Навигация -->
<nav class="bottom-nav">
    <div class="nav-item active" onclick="showMainTab()">
        <div class="nav-icon">
            <img src="10316158-no-bg-preview (carve.photos).png" alt="Главная" style="width: 40px; height: 40px;">
        </div>
        <div class="nav-label">Главная</div>
    </div>
    <div class="nav-item" onclick="showTasksTab()">
        <div class="nav-icon">
            <img src="7645190-no-bg-preview (carve.photos).png" alt="Задания" style="width: 40px; height: 40px;">
        </div>
        <div class="nav-label">Задания</div>
    </div>
    <div class="nav-item" onclick="showProfileTab()">
        <div class="nav-icon">
            <img src="Снимок экрана 2025-10-22 074950-no-bg-preview (carve.photos) .png" alt="Профиль" style="width: 45px; height: 45px;">
        </div>
        <div class="nav-label">Профиль</div>
    </div>
    <div class="nav-item" id="admin-nav-item" onclick="showAdminTab()" style="display: none;">
        <div class="nav-icon">⚙️</div>
        <div class="nav-label">Админ</div>
    </div>
</nav>



<div class="modal" id="prices-modal">
    <div class="prices-content">
        <!-- Добавляем заголовок с кнопкой закрытия -->
        <div class="modal-header">
            <div class="modal-title">💰 Стоимость размещения</div>
            <button class="modal-close" onclick="closeModal('prices-modal')">×</button>
        </div>
        
        <div class="price-grid">
            <div class="price-item">
                <span class="price-time">1 час</span>
                <span class="price-amount">200 ₽</span>
            </div>
            <div class="price-item">
                <span class="price-time">3 часа</span>
                <span class="price-amount">600 ₽</span>
            </div>
            <div class="price-item">
                <span class="price-time">1 день</span>
                <span class="price-amount">4 500 ₽</span>
            </div>
            <div class="price-item">
                <span class="price-time">7 дней</span>
                <span class="price-amount">20 000 ₽</span>
            </div>
        </div>
        <button class="prices-btn" onclick="openAdminChatFromPrices()">
            💬 Написать о рекламе
        </button>
    </div>
</div>

<div class="modal" id="task-modal">
    <div class="modal-content task-modal-content">
        <div class="modal-header">
            <div class="task-modal-title" id="task-modal-title">Название задания</div>
            <button class="modal-close" onclick="closeModal('task-modal')">×</button>
        </div>
        <div class="modal-body">
            <div class="task-modal-category" id="task-modal-category">Категория</div>
            

            
            <div class="task-modal-price" id="task-modal-price">0 ⭐</div>
            <div class="task-modal-description" id="task-modal-description">Описание задания</div>
            
            <div class="task-modal-details">
                <div class="task-detail">
                    <span class="task-detail-label">Время выполнения:</span>
                    <span class="task-detail-value" id="task-modal-time">5 мин</span>
                </div>
                <div class="task-detail">
                    <span class="task-detail-label">Сложность:</span>
                    <span class="task-detail-value" id="task-modal-difficulty">Легкая</span>
                </div>
                <div class="task-detail">
                    <span class="task-detail-label">Осталось:</span>
                    <span class="task-detail-value" id="task-modal-available">15 заданий</span>
                </div>
            </div>
            
            <div class="task-modal-buttons">
                <button class="task-modal-cancel" onclick="closeModal('task-modal')">Отмена</button>
                <button class="task-modal-start" onclick="startTask()">Начать задание</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения выполнения задания -->
<!-- Модальное окно подтверждения выполнения задания -->
<div class="modal" id="confirmation-modal">
    <div class="confirmation-modal-content">
        <div class="confirmation-icon">❓</div>
        <div class="confirmation-title">Подтверждение задания</div>
        <div class="confirmation-text" id="confirmation-task-text">Вы выполнили задание "<span id="confirmation-task-name"></span>"?</div>
        
        <div class="confirmation-buttons">
            <button class="confirmation-btn confirmation-yes" onclick="showScreenshotUpload()">Да, выполнил</button>
            <button class="confirmation-btn confirmation-no" onclick="showCancelConfirmation()">Нет, не выполнил</button>
        </div>
        
        <button class="confirmation-btn confirmation-cancel" onclick="closeModal('confirmation-modal')">Отмена</button>
    </div>
</div>
<!-- Модальное окно отмены подтверждения -->
 <div class="task-detail" id="task-modal-url">
<div class="modal" id="cancel-confirmation-modal">
    <div class="confirmation-modal-content">
        <div class="confirmation-icon">⚠️</div>
        <div class="confirmation-title">Вы уверены?</div>
        <div class="confirmation-text">Вы точно не выполнили это задание?</div>
        
        <div class="confirmation-buttons">
            <button class="confirmation-btn confirmation-no" onclick="cancelTask()">Не выполнил</button>
            <button class="confirmation-btn confirmation-yes" onclick="showScreenshotUpload()">Выполнил</button>
        </div>
        
        <button class="confirmation-btn confirmation-cancel" onclick="closeModal('cancel-confirmation-modal')">Отмена</button>
    </div>
</div>
</div>
<!-- Модальное окно загрузки скриншота -->
 <div class="task-detail" id="task-modal-url">
<div class="modal" id="screenshot-modal">
    <div class="confirmation-modal-content">
        <div class="confirmation-icon">📸</div>
        <div class="confirmation-title">Отправьте скриншот</div>
        <div class="confirmation-text">Загрузите скриншот выполнения задания для проверки администратором</div>
        
        <div class="screenshot-upload">
            <input type="file" id="screenshot-file" class="file-input" accept="image/*">
            <button class="upload-btn" onclick="document.getElementById('screenshot-file').click()">
                📁 Выбрать файл
            </button>
            <img id="screenshot-preview" class="screenshot-preview" alt="Предпросмотр скриншота">
            <div id="file-name" style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;"></div>
        </div>
        
        <div class="confirmation-buttons">
            <button class="confirmation-btn confirmation-cancel" onclick="closeModal('screenshot-modal')">Отмена</button>
            <button class="confirmation-btn confirmation-yes" onclick="submitScreenshot()" id="submit-screenshot-btn" disabled>Отправить на проверку</button>
        </div>
    </div>
</div>
</div>
<!-- Модальное окно проверки задания для админа -->
<div class="modal" id="verification-modal">
    <div class="modal-content verification-modal-content">
        <div class="modal-header">
            <div class="modal-title">✅ Проверка задания</div>
            <button class="modal-close" onclick="closeModal('verification-modal')">×</button>
        </div>
        
        <div class="modal-body">
            <div class="verification-user-info">
                <div class="verification-avatar" id="verification-user-avatar">U</div>
                <div>
                    <div class="verification-user-name" id="verification-user-name">Пользователь</div>
                    <div class="verification-task-title" id="verification-task-title">Задание</div>
                </div>
                <div class="verification-price" id="verification-task-price">0 ⭐</div>
            </div>
            
            <div class="verification-screenshot">
                <div style="margin-bottom: 10px; font-weight: 600;">Скриншот выполнения:</div>
                <img id="verification-screenshot" class="verification-modal-screenshot" alt="Скриншот задания" 
                     style="width: 100%; border-radius: 10px; border: 2px solid var(--border);">
            </div>
            
            <div class="verification-modal-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-error" style="flex: 1;" onclick="rejectVerification()">
                    ❌ Отклонить
                </button>
                <button class="btn btn-success" style="flex: 1;" onclick="approveVerification()">
                    ✅ Одобрить
                </button>
            </div>
            
            <!-- Кнопка удаления проверки -->
            <button class="btn btn-warning" onclick="deleteVerification()" style="margin-top: 10px; width: 100%;">
                🗑️ Удалить проверку
            </button>
        </div>
    </div>
</div>
<div class="chat-modal" id="admin-chat">
    <div class="chat-header">
        <div class="chat-avatar">
            <div class="video-icon">💬</div>
        </div>
        <div class="chat-info">
            <div class="chat-name">Администратор LinkGold</div>
            <div class="chat-status">TG: @linkgold_admin</div>
        </div>
        <button class="chat-close" onclick="closeChat()">×</button>
    </div>
    <div class="chat-messages" id="chat-messages">
        <div class="message message-admin">
            Здравствуйте! Чем могу помочь?
        </div>
    </div>
    <div class="chat-input">
        <input type="text" id="chat-input-field" placeholder="Введите сообщение...">
        <button class="chat-send" onclick="sendMessageToAdmin()">➤</button>
    </div>
</div>


    <script>

  // 🔧 ПОИСКОВАЯ СИСТЕМА ДЛЯ АДМИНСКИХ ЗАДАНИЙ

        let allAdminTasks = []; // Глобальная переменная для хранения всех заданий
        let currentAdminSearchTerm = ''; // Текущий поисковый запрос

        // Инициализация поиска
        function initAdminTaskSearch() {
            const searchInput = document.getElementById('admin-task-search');
            if (searchInput) {
                let searchTimeout;
                
                searchInput.addEventListener('input', function(e) {
                    clearTimeout(searchTimeout);
                    const searchText = e.target.value.trim();
                    
                    searchTimeout = setTimeout(() => {
                        if (searchText.length >= 2 || searchText.length === 0) {
                            searchAdminTasks(searchText);
                        }
                    }, 300);
                });

                // Обработчик клавиши Enter
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchAdminTasks(searchInput.value.trim());
                    }
                });
            }
        }

        // Функция поиска заданий
        async function searchAdminTasks(searchTerm = '') {
            console.log('🔍 Searching admin tasks:', searchTerm);
            
            currentAdminSearchTerm = searchTerm;
            
            // Показываем/скрываем кнопку очистки
            const clearBtn = document.querySelector('.admin-search-clear');
            if (clearBtn) {
                clearBtn.style.display = searchTerm ? 'block' : 'none';
            }

            try {
                if (!currentUser) {
                    showNotification('Пользователь не авторизован', 'error');
                    return;
                }

                // Показываем индикатор загрузки
                const resultsDiv = document.getElementById('admin-search-results');
                if (resultsDiv) {
                    resultsDiv.innerHTML = '<span style="color: var(--warning);">⏳ Ищем задания...</span>';
                }

                // Формируем URL для поиска
                const params = new URLSearchParams();
                params.append('adminId', currentUser.id);
                if (searchTerm) {
                    params.append('search', searchTerm);
                }

                const url = `/api/admin/tasks/search?${params.toString()}`;
                console.log('📡 Search URL:', url);

                const result = await makeRequest(url);
                
                if (result.success) {
                    allAdminTasks = result.tasks || [];
                    displayAdminTasks(allAdminTasks, result.statistics);
                    
                    // Обновляем информацию о результатах
                    updateSearchResultsInfo(searchTerm, allAdminTasks.length);
                    
                } else {
                    throw new Error(result.error || 'Ошибка поиска');
                }

            } catch (error) {
                console.error('❌ Search error:', error);
                const resultsDiv = document.getElementById('admin-search-results');
                if (resultsDiv) {
                    resultsDiv.innerHTML = `<span style="color: var(--error);">❌ Ошибка поиска: ${error.message}</span>`;
                }
                showNotification('Ошибка поиска заданий', 'error');
            }
        }

        // Обновление информации о результатах поиска
        function updateSearchResultsInfo(searchTerm, resultsCount) {
            const resultsDiv = document.getElementById('admin-search-results');
            if (!resultsDiv) return;

            if (!searchTerm) {
                resultsDiv.innerHTML = '';
                return;
            }

            if (resultsCount === 0) {
                resultsDiv.innerHTML = `
                    <span style="color: var(--text-secondary);">
                        🔍 По запросу "<strong>${escapeHtml(searchTerm)}</strong>" ничего не найдено
                    </span>
                `;
            } else {
                resultsDiv.innerHTML = `
                    <span style="color: var(--success);">
                        ✅ Найдено <strong>${resultsCount}</strong> заданий по запросу "<strong>${escapeHtml(searchTerm)}</strong>"
                    </span>
                `;
            }
        }

        // Очистка поиска
        function clearAdminTaskSearch() {
            const searchInput = document.getElementById('admin-task-search');
            if (searchInput) {
                searchInput.value = '';
                searchAdminTasks('');
            }
        }

        // Обновленная функция загрузки админских заданий
async function loadAdminTasks() {
    console.log('🎯 Loading admin tasks...');
    
    if (!currentUser) {
        console.log('❌ No user');
        return;
    }
    
    const container = document.getElementById('admin-tasks-list');
    if (!container) {
        console.log('❌ Container not found');
        return;
    }
    
    // Показываем контейнер заданий
    const tasksContainer = document.getElementById('admin-tasks-list-container');
    if (tasksContainer) {
        tasksContainer.style.display = 'block';
    }
    
    // Показываем загрузку
    container.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div class="loading-spinner">⏳</div>
            <div style="margin-top: 16px;">Загружаем задания админа...</div>
        </div>
    `;
    
    try {
        // Загружаем статистику
        const statsResult = await makeRequest(`/api/admin/tasks-stats?adminId=${currentUser.id}`);
        
        // Загружаем задания
        const tasksResult = await makeRequest(`/api/admin/simple-tasks?adminId=${currentUser.id}`);
        
        console.log('📊 Stats result:', statsResult);
        console.log('📊 Tasks result:', tasksResult);
        
        if (tasksResult.success && statsResult.success) {
            allAdminTasks = tasksResult.tasks || [];
            displayAdminTasks(allAdminTasks, statsResult.statistics);
        } else {
            throw new Error(tasksResult.error || statsResult.error || 'Unknown error');
        }
        
    } catch (error) {
        console.error('💥 Error:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--error);">
                <div style="font-size: 48px; margin-bottom: 16px;">❌</div>
                <div>Ошибка загрузки заданий</div>
                <div style="font-size: 12px; margin-top: 8px;">${error.message}</div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="loadAdminTasks()">
                        🔄 Попробовать снова
                    </button>
                </div>
            </div>
        `;
    }
}

function displayAdminTasks(tasks, stats) {
    const container = document.getElementById('admin-tasks-list');
    if (!container) {
        console.error('❌ Admin tasks container not found!');
        return;
    }
    
    console.log(`🎯 Displaying ${tasks ? tasks.length : 0} admin tasks`);
    
    container.innerHTML = '';
    
    // Показываем расширенную статистику с правильными счетчиками
    if (stats) {
        // Рассчитываем правильные счетчики
        const completedCount = stats.completed_tasks || 0;
        const rejectedCount = stats.rejected_tasks || 0;
        const pendingCount = stats.pending_tasks || 0;
        const activeCount = stats.active_tasks || 0;
        const totalCount = stats.total_tasks || 0;
        
        const statsHTML = `
            <div class="admin-stats" style="margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border);">
                <h4 style="margin-bottom: 10px;">📊 Статистика заданий</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; font-size: 12px;">
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; color: var(--accent);">${totalCount}</div>
                        <div>Всего заданий</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; color: var(--success);">${completedCount}</div>
                        <div>✅ Выполнено</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; color: var(--error);">${rejectedCount}</div>
                        <div>❌ Отклонено</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; color: var(--warning);">${pendingCount}</div>
                        <div>⏳ На проверке</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; color: var(--text-primary);">${activeCount}</div>
                        <div>🟡 В процессе</div>
                    </div>
                </div>
                
                <!-- Дополнительная строка со счетчиками как в требовании -->
                <div style="margin-top: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 5px;">Текущая статистика:</div>
                    <div style="display: flex; justify-content: space-around; font-size: 12px;">
                        <span>✅ ${completedCount} выполнено</span>
                        <span>❌ ${rejectedCount} отклонено</span>
                        <span>⏳ ${pendingCount} на проверке</span>
                        <span>🟡 ${activeCount} в процессе</span>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML = statsHTML;
    }
    
    if (!tasks || tasks.length === 0) {
        container.innerHTML += `
            <div class="no-tasks" style="text-align: center; padding: 40px 20px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border);">
                <div style="font-size: 48px; margin-bottom: 16px;">📝</div>
                <div style="font-size: 18px; margin-bottom: 8px;">Нет созданных заданий</div>
                <div style="font-size: 14px; color: var(--text-secondary);">
                    Создайте первое задание используя форму выше
                </div>
                <button class="btn btn-primary" onclick="debugAdminTasks()" style="margin-top: 16px;">
                    🐛 Диагностика
                </button>
            </div>
        `;
        return;
    }
    
    // Добавляем фильтры
    const filterHTML = `
        <div class="task-filter" style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <label style="font-weight: 600; color: var(--text-primary);">Фильтр:</label>
            <select id="admin-task-filter" onchange="filterAdminTasks()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                <option value="all">Все задания</option>
                <option value="active">Только активные</option>
                <option value="completed">Только завершенные</option>
                <option value="my">Мои задания</option>
            </select>
            <button onclick="loadAdminTasks()" class="btn btn-primary" style="padding: 8px 12px; font-size: 12px;">
                🔄 Обновить
            </button>
            ${currentAdminSearchTerm ? `
                <button onclick="clearAdminTaskSearch()" class="btn btn-warning" style="padding: 8px 12px; font-size: 12px;">
                    🗑️ Очистить поиск
                </button>
            ` : ''}
        </div>
    `;
    container.innerHTML += filterHTML;
    
    const tasksContainer = document.createElement('div');
    tasksContainer.id = 'admin-tasks-container';
    container.appendChild(tasksContainer);
    
    // Сохраняем задачи для фильтрации
    window.currentAdminTasks = tasks;
    
    // Отображаем все задания
    renderAdminTasks(tasks);
}
        // Инициализация поиска при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            initAdminTaskSearch();
        });

        // 🔧 ЭКСПОРТ ФУНКЦИЙ
        window.searchAdminTasks = searchAdminTasks;
        window.clearAdminTaskSearch = clearAdminTaskSearch;
        window.initAdminTaskSearch = initAdminTaskSearch;

// 🔧 ФУНКЦИИ ДЛЯ ПРОКРУТКИ К НАЧАЛУ СТРАНИЦЫ
function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// 🔧 ОБНОВЛЕННЫЕ ФУНКЦИИ ПОКАЗА СТРАНИЦ С ПРОКРУТКОЙ
function showWithdrawPage() {
    hideAllTabs();
    document.getElementById('withdraw-page').classList.add('active');
    
    // Обновляем баланс на странице вывода
    updateWithdrawPage();
    loadWithdrawHistory();
    
    // Прокручиваем к началу
    setTimeout(scrollToTop, 100);
}

function showHowItWorksPage() {
    hideAllTabs();
    document.getElementById('how-it-works-page').classList.add('active');
    
    // Прокручиваем к началу
    setTimeout(scrollToTop, 100);
}

function showAboutPage() {
    hideAllTabs();
    document.getElementById('about-page').classList.add('active');
    
    // Прокручиваем к началу
    setTimeout(scrollToTop, 100);
}

function goBackToProfile() {
    showProfileTab();
    
    // Прокручиваем к началу профиля
    setTimeout(scrollToTop, 100);
}

// 🔧 ОБНОВЛЕННАЯ ФУНКЦИЯ ПОКАЗА ПРОФИЛЯ
function showProfileTab() {
    hideAllTabs();
    document.getElementById('profile-tab').classList.add('active');
    updateNavState('profile');
    
    // Синхронизируем данные при каждом открытии профиля
    setTimeout(() => {
        updateUserData();
        syncUserProfile();
        
        // Прокручиваем к началу
        scrollToTop();
    }, 100);
}

// 🔧 ДОБАВЛЕНИЕ ПРОКРУТКИ К СУЩЕСТВУЮЩИМ ФУНКЦИЯМ
function showMainTab() {
    hideAllTabs();
    document.getElementById('main-tab').classList.add('active');
    updateNavState('main');
    
    // Прокручиваем к началу
    setTimeout(scrollToTop, 100);
}

function showTasksTab() {
    console.log('🎯 ПЕРЕХОД НА ВКЛАДКУ ЗАДАНИЙ');
    
    hideAllTabs();
    const tasksTab = document.getElementById('tasks-tab');
    if (tasksTab) {
        tasksTab.classList.add('active');
    }
    
    updateNavState('tasks');
    
    // Применяем исправления для мобильных
    setTimeout(fixMobileLayout, 100);
    
    // Активируем вкладку "Новые" и прокручиваем к началу
    setTimeout(() => {
        showTaskCategory('new');
        scrollToTop();
    }, 150);
}

function showAdminTab() {
    const isMainAdmin = parseInt(currentUser?.id) === ADMIN_ID;
    const isRegularAdmin = currentUser?.is_admin === true;
    
    if (!currentUser || (!isMainAdmin && !isRegularAdmin)) {
        showNotification('Доступ запрещен!', 'error');
        return;
    }
    
    hideAllTabs();
    document.getElementById('admin-tab').classList.add('active');
    updateNavState('admin');
    
    // Сбрасываем панель при каждом открытии
    resetAdminPanel();
    
    // Показываем секцию постов по умолчанию
    showAdminSection('posts');
    
    // Прокручиваем к началу
    setTimeout(scrollToTop, 100);
    
    // Если главный админ, загружаем список админов заранее
    if (isMainAdmin) {
        setTimeout(() => {
            loadAdminsList();
        }, 500);
    }
}

// 🔧 ОБНОВЛЕННЫЕ ФУНКЦИИ ДЛЯ КНОПОК В ПРОФИЛЕ
// В разделе профиля после реферальной системы
document.querySelectorAll('.profile-action').forEach(action => {
    action.addEventListener('click', function() {
        // Добавляем небольшую задержку для плавности
        setTimeout(scrollToTop, 50);
    });
});

// 🔧 ФИКС ДЛЯ МОБИЛЬНЫХ УСТРОЙСТВ
function fixMobileScroll() {
    // Предотвращаем непредсказуемое поведение скролла на мобильных
    if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
    }
    
    // Принудительная прокрутка к началу при загрузке страницы
    window.addEventListener('load', function() {
        setTimeout(scrollToTop, 100);
    });
}

// Инициализация фикса прокрутки
fixMobileScroll();

        // 🚀 ОПТИМИЗАЦИИ ПРОИЗВОДИТЕЛЬНОСТИ
class PerformanceOptimizer {
    constructor() {
        this.lazyLoadObserver = null;
        this.init();
    }
    
    init() {
        this.setupLazyLoading();
        this.debounceScrollEvents();
        this.optimizeAnimations();
    }
    
    // Ленивая загрузка изображений
    setupLazyLoading() {
        if ('IntersectionObserver' in window) {
            this.lazyLoadObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        this.lazyLoadObserver.unobserve(img);
                    }
                });
            });
            
            document.querySelectorAll('img[data-src]').forEach(img => {
                this.lazyLoadObserver.observe(img);
            });
        }
    }
    
    // Дебаунс скролла
    debounceScrollEvents() {
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                // Оптимизированные операции при скролле
            }, 100);
        }, { passive: true });
    }
    
    // Оптимизация анимаций
    optimizeAnimations() {
        // Принудительное аппаратное ускорение
        const elements = document.querySelectorAll('.card, .task-card');
        elements.forEach(el => {
            el.style.transform = 'translateZ(0)';
        });
    }
}

// Инициализация при загрузке
new PerformanceOptimizer();
        // 🔧 КОНФИГУРАЦИЯ
        console.log('🌐 Current URL:', window.location.href);
        const API_BASE_URL = window.location.origin;
        console.log('🔗 API Base URL:', API_BASE_URL);
        
        const tg = window.Telegram.WebApp;
        const ADMIN_ID = 8036875641;

     // 🔧 ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
let currentUser = null;
let currentChatId = null;
let currentAdminChat = null;
let selectedTaskId = null;
let allTasks = [];
let chatUpdateInterval = null;
let currentUserTaskId = null;
let currentVerificationId = null;
let currentTaskImage = null; // ← ДОБАВЬТЕ ЭТУ СТРОКУ

// Функции для работы с загрузкой изображений
// 🔧 ИСПРАВЛЕННАЯ СИСТЕМА УРОВНЕЙ БЕЗ БОНУСОВ
const LEVEL_SYSTEM = {
    1: { tasksRequired: 10, name: "Новичок" },
    2: { tasksRequired: 20, name: "Ученик" },
    3: { tasksRequired: 30, name: "Опытный" },
    4: { tasksRequired: 40, name: "Профессионал" },
    5: { tasksRequired: 50, name: "Эксперт" },
    6: { tasksRequired: 60, name: "Мастер" },
    7: { tasksRequired: 70, name: "Гуру" },
    8: { tasksRequired: 80, name: "Легенда" },
    9: { tasksRequired: 90, name: "Император" },
    10: { tasksRequired: 100, name: "Бог заданий" }
};

// 🔧 ИСПРАВЛЕННАЯ ФУНКЦИЯ РАСЧЕТА УРОВНЯ БЕЗ БОНУСОВ
function calculateUserLevel(completedTasks) {
    let currentLevel = 1;
    let tasksForCurrentLevel = 0;
    let tasksForNextLevel = LEVEL_SYSTEM[1].tasksRequired;
    let progressPercentage = 0;
    
    // Находим текущий уровень
    for (let level = 1; level <= Object.keys(LEVEL_SYSTEM).length; level++) {
        if (completedTasks >= LEVEL_SYSTEM[level].tasksRequired) {
            currentLevel = level;
        } else {
            break;
        }
    }
    

    
    // Находим текущий уровень
    for (let level = 1; level <= Object.keys(LEVEL_SYSTEM).length; level++) {
        if (completedTasks >= LEVEL_SYSTEM[level].tasksRequired) {
            currentLevel = level;
        } else {
            break;
        }
    }
    
    // Расчет прогресса для текущего уровня
    const currentLevelRequirement = LEVEL_SYSTEM[currentLevel].tasksRequired;
    
    if (currentLevel < Object.keys(LEVEL_SYSTEM).length) {
        const nextLevelRequirement = LEVEL_SYSTEM[currentLevel + 1].tasksRequired;
        const tasksForCurrentLevel = completedTasks - currentLevelRequirement;
        const totalTasksForNextLevel = nextLevelRequirement - currentLevelRequirement;
        
        progressPercentage = Math.min(100, Math.round((tasksForCurrentLevel / totalTasksForNextLevel) * 100));
    } else {
        // Максимальный уровень достигнут
        progressPercentage = 100;
    }
    
    return {
        level: currentLevel,
        levelName: LEVEL_SYSTEM[currentLevel].name,
        completedTasks: completedTasks,
        progressPercentage: progressPercentage,
        isMaxLevel: currentLevel === Object.keys(LEVEL_SYSTEM).length
    };
}

function previewTaskImage(input) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    const preview = document.getElementById('task-image-preview');
    const placeholder = document.querySelector('.upload-placeholder');
    
    // Сохраняем файл в глобальную переменную
    currentTaskImage = file;
    
    // Проверка типа файла
    if (!file.type.startsWith('image/')) {
        showNotification('Пожалуйста, выберите изображение', 'error');
        currentTaskImage = null;
        return;
    }
    
    // Проверка размера файла
    if (file.size > 5 * 1024 * 1024) {
        showNotification('Размер изображения не должен превышать 5MB', 'error');
        currentTaskImage = null;
        return;
    }
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        if (placeholder) {
            placeholder.style.display = 'none';
        }
    };
    
    reader.onerror = function() {
        showNotification('Ошибка при загрузке изображения', 'error');
        currentTaskImage = null;
    };
    
    reader.readAsDataURL(file);
}
// Инициализация при загрузке страницы
// Инициализация при загрузке страницы
// Убедитесь, что код выполняется после загрузки DOM
document.addEventListener('DOMContentLoaded', function() {
    console.log('✅ DOM loaded, initializing promocodes...');
    initializePromocodes();
});

function initializePromocodes() {
    // Проверяем существование элементов
    const elements = [
        'promocode-code',
        'promocode-max-uses', 
        'promocode-reward',
        'promocode-expires',
        'promocode-form-message',
        'create-promocode-btn'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        console.log(`🔍 ${id}:`, element ? 'FOUND' : 'NOT FOUND');
    });
}

async function makeRequest(endpoint, options = {}) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 секунд
    
    try {
        let url;
        if (endpoint.startsWith('http')) {
            url = endpoint;
        } else if (endpoint.startsWith('/api')) {
            url = API_BASE_URL + endpoint;
        } else {
            url = API_BASE_URL + '/api' + (endpoint.startsWith('/') ? endpoint : '/' + endpoint);
        }
        
        console.log(`🚀 Making ${options.method || 'GET'} request to: ${url}`);
        
        const response = await fetch(url, {
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            signal: controller.signal,
            ...options
        });

        clearTimeout(timeoutId);

        // Более детальная обработка HTTP статусов
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`❌ HTTP ${response.status}: ${errorText}`);
            
            if (response.status === 403) {
                throw new Error('Доступ запрещен. У вас недостаточно прав.');
            } else if (response.status === 404) {
                throw new Error('не найден.');
            } else if (response.status === 500) {
                throw new Error('Внутренняя ошибка сервера.');
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        }

        const data = await response.json();
        console.log('📨 Response received:', data);
        return data;
        
    } catch (error) {
        clearTimeout(timeoutId);
        console.error('💥 Request failed:', error);
        
        if (error.name === 'AbortError') {
            throw new Error('Таймаут запроса. Сервер не отвежает.');
        } else if (error.name === 'TypeError') {
            throw new Error('Проблема с сетью. Проверьте подключение к интернету.');
        } else {
            throw error;
        }
    }
}
// Функция для диагностики endpoint'ов
async function debugAdminEndpoints() {
    console.log('🔍 Debugging admin endpoints...');
    
    try {
        // Проверяем базовый health endpoint
        const health = await makeRequest('/api/health');
        console.log('✅ Health endpoint:', health);
        
        // Проверяем endpoint добавления админа
        const testData = {
            adminId: currentUser.id,
            username: 'testuser'
        };
        
        console.log('🧪 Testing admin endpoint with:', testData);
        
        // Просто проверяем доступность endpoint'а
        const response = await fetch(API_BASE_URL + '/api/admin/add-admin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(testData)
        });
        
        console.log('📡 Endpoint response status:', response.status);
        console.log('📡 Endpoint response ok:', response.ok);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
    } catch (error) {
        console.error('❌ Endpoint debug failed:', error);
    }
}



// Функция для тестирования endpoint'ов
async function testEndpoints() {
    if (!currentUser || parseInt(currentUser.id) !== ADMIN_ID) return;
    
    try {
        console.log('🧪 Testing endpoints...');
        
        // Тестируем базовый endpoint
        const health = await makeRequest('/health');
        console.log('✅ Health endpoint:', health);
        
        // Тестируем debug endpoints
        const debug = await makeRequest('/debug/endpoints');
        console.log('✅ Debug endpoints:', debug);
        
        // Тестируем admins-list endpoint
        const admins = await makeRequest(`/admin/admins-list?adminId=${currentUser.id}`);
        console.log('✅ Admins list endpoint:', admins);
        
    } catch (error) {
        console.error('❌ Endpoint test failed:', error);
    }
}

// Вызов для тестирования
setTimeout(() => {
    if (currentUser && parseInt(currentUser.id) === ADMIN_ID) {
        testEndpoints();
    }
}, 5000);
        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing LinkGold app...');
            
            if (typeof tg !== 'undefined') {
                tg.expand();
                tg.ready();
                initializeTelegramUser();
            } else {
                console.log('Telegram Web App context not available');
                initializeTestUser();
            }
        });

async function initializeTelegramUser() {
    try {
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            const tgUser = tg.initDataUnsafe.user;
            
            currentUser = {
                id: tgUser.id,
                firstName: tgUser.first_name || 'Пользователь',
                lastName: tgUser.last_name || '',
                username: tgUser.username || `user_${tgUser.id}`,
                photoUrl: tgUser.photo_url || '',
                isAdmin: parseInt(tgUser.id) === ADMIN_ID
            };
            
            // Простая аутентификация без реферального кода (он обрабатывается в боте)
            try {
                const authResult = await makeRequest('/user/auth', {
                    method: 'POST',
                    body: JSON.stringify({
                        user: currentUser
                    })
                });
                
                if (authResult.success) {
                    Object.assign(currentUser, authResult.user);
                }
            } catch (authError) {
                console.log('Auth endpoint not available, continuing with basic user data');
            }
            
            initializeApp();
        } else {
            console.log('Telegram user data not available');
            initializeTestUser();
        }
    } catch (error) {
        console.error('Error initializing Telegram user:', error);
        initializeTestUser();
    }
}

function debugWithdrawalSystem() {
    console.log('🐛 DEBUG Withdrawal System:');
    console.log('- currentUser:', currentUser); // ← исправлено на английское
    console.log('- isAdmin:', currentUser?.is_admin);
    
    // Проверьте, загружаются ли запросы
    loadWithdrawalRequests().then(() => {
        console.log('✅ Withdrawal requests loaded');
    }).catch(error => {
        console.error('❌ Error loading withdrawal requests:', error);
    });
}
// 🔧 ФУНКЦИЯ ДЛЯ ОБНОВЛЕНИЯ ИНТЕРФЕЙСА ПРОВЕРКИ
function updateVerificationInterface() {
    if (document.getElementById('admin-verification-section').style.display === 'block') {
        loadTaskVerifications();
    }
}

// Автоматическое обновление списка проверки каждые 30 секунд
setInterval(updateVerificationInterface, 30000);
// Вызовите для тестирования
// setTimeout(debugWithdrawalSystem, 3000);
// 📝 Функции для админов (без админ-панели)
async function addNewPostAsAdmin() {
    if (!currentUser) return;
    
    const title = prompt('Введите заголовок поста:');
    if (!title) return;
    
    const content = prompt('Введите содержание поста:');
    if (!content) return;
    
    // Проверяем права
    const isAdmin = await checkAdminAccess(currentUser.id);
    if (!isAdmin) {
        showNotification('Только администратор может публиковать посты!', 'error');
        return;
    }
    
    try {
        const result = await makeRequest('/posts', {
            method: 'POST',
            body: JSON.stringify({
                title: title,
                content: content,
                author: currentUser.firstName,
                authorId: currentUser.id
            })
        });

        if (result.success) {
            showNotification('Пост успешно опубликован!', 'success');
            loadMainPagePosts();
        } else {
            showNotification('Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error adding post:', error);
        showNotification('Ошибка публикации поста', 'error');
    }
}

// 🗑️ Удаление поста
async function deletePostAsAdmin(postId) {
    if (!currentUser) return;
    
    if (!confirm('Удалить этот пост?')) return;
    
    // Проверяем права
    const isAdmin = await checkAdminAccess(currentUser.id);
    if (!isAdmin) {
        showNotification('Только администратор может удалять посты!', 'error');
        return;
    }
    
    try {
        const result = await makeRequest(`/posts/${postId}`, {
            method: 'DELETE',
            body: JSON.stringify({ authorId: currentUser.id })
        });

        if (result.success) {
            showNotification('Пост успешно удален!', 'success');
            loadMainPagePosts();
        } else {
            showNotification('Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error deleting post:', error);
        showNotification('Ошибка удаления поста', 'error');
    }
}

// 📋 Создание задания
async function addTaskAsAdmin() {
    if (!currentUser) return;
    
    const title = prompt('Введите название задания:');
    if (!title) return;
    
    const description = prompt('Введите описание задания:');
    if (!description) return;
    
    const price = prompt('Введите цену задания (в рублях):');
    if (!price) return;
    
    // Проверяем права
    const isAdmin = await checkAdminAccess(currentUser.id);
    if (!isAdmin) {
        showNotification('Только администратор может создавать задания!', 'error');
        return;
    }
    
    try {
        const result = await makeRequest('/tasks', {
            method: 'POST',
            body: JSON.stringify({
                title: title,
                description: description,
                price: parseFloat(price),
                created_by: currentUser.id
            })
        });

        if (result.success) {
            showNotification('Задание успешно создано!', 'success');
            loadTasks();
        } else {
            showNotification('Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error adding task:', error);
        showNotification('Ошибка создания задания', 'error');
    }
}

// 🗑️ Удаление задания
async function deleteTaskAsAdmin(taskId) {
    if (!currentUser) return;
    
    if (!confirm('Удалить это задание?')) return;
    
    // Проверяем права
    const isAdmin = await checkAdminAccess(currentUser.id);
    if (!isAdmin) {
        showNotification('Только администратор может удалять задания!', 'error');
        return;
    }
    
    try {
        const result = await makeRequest(`/tasks/${taskId}`, {
            method: 'DELETE',
            body: JSON.stringify({ adminId: currentUser.id })
        });

        if (result.success) {
            showNotification('Задание успешно удалено!', 'success');
            loadTasks();
        } else {
            showNotification('Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error deleting task:', error);
        showNotification('Ошибка удаления задания', 'error');
    }
}

// ✅ Проверка заданий (для админов)
async function loadTaskVerificationsForAdmin() {
    if (!currentUser) return;
    
    // Проверяем права
    const isAdmin = await checkAdminAccess(currentUser.id);
    if (!isAdmin) return;
    
    try {
        const result = await makeRequest(`/admin/task-verifications?adminId=${currentUser.id}`);
        if (result.success) {
            showVerificationsModal(result.verifications);
        }
    } catch (error) {
        console.error('Error loading verifications:', error);
    }
}

// 🎨 Модальное окно проверки заданий

function showVerificationsModal(verifications) {
    let modalHTML = `
        <div class="modal active" id="verifications-modal">
            <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <div class="modal-header">
                    <div class="modal-title">✅ Проверка заданий</div>
                    <button class="modal-close" onclick="closeModal('verifications-modal')">×</button>
                </div>
                <div class="modal-body">
    `;
    
    if (!verifications || verifications.length === 0) {
        modalHTML += ``;
    } else {
        verifications.forEach(verification => {
            modalHTML += `
                <div class="verification-item" style="margin-bottom: 16px; padding: 16px; border: 1px solid var(--border); border-radius: 12px;">
                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 12px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${verification.user_name}</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">${verification.task_title}</div>
                        </div>
                        <div style="font-weight: 700; color: var(--gold);">${verification.task_price} ⭐</div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <img src="${verification.screenshot_url}" alt="Скриншот" style="width: 100%; border-radius: 8px;">
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-success" style="flex: 1;" onclick="approveVerification(${verification.id})">✅ Одобрить</button>
                        <button class="btn btn-error" style="flex: 1;" onclick="rejectVerification(${verification.id})">❌ Отклонить</button>
                    </div>
                </div>
            `;
        });
    }
    
    modalHTML += `
                </div>
            </div>
        </div>
    `;
    
    // Добавляем модальное окно в DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}
// Оптимизация изображений
function optimizeImages() {
    const images = document.querySelectorAll('img');
    images.forEach(img => {
        // Добавляем lazy loading
        img.loading = 'lazy';
        
        // Оптимизируем размер
        if (img.width > 300) {
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
        }
    });
}

// Сжатие изображений перед загрузкой
function compressImage(file, maxSize = 50000) {
    return new Promise((resolve) => {
        if (file.size <= maxSize) {
            resolve(file);
            return;
        }
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = () => {
            const scale = Math.sqrt(maxSize / file.size);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(resolve, 'image/jpeg', 0.7);
        };
        
        img.src = URL.createObjectURL(file);
    });
}
// Эффективное обновление DOM
class DOMOptimizer {
    constructor() {
        this.updateQueue = [];
        this.batchTimeout = null;
    }
    
    // Батчинг обновлений
    batchUpdate(callback) {
        this.updateQueue.push(callback);
        
        if (!this.batchTimeout) {
            this.batchTimeout = setTimeout(() => {
                this.flushUpdates();
            }, 16); // Один кадр
        }
    }
    
    flushUpdates() {
        const fragment = document.createDocumentFragment();
        
        this.updateQueue.forEach(callback => {
            callback(fragment);
        });
        
        // Единое обновление DOM
        document.getElementById('tasks-container').appendChild(fragment);
        
        this.updateQueue = [];
        this.batchTimeout = null;
    }
    
    // Эффективное создание элементов
    createElement(tag, attributes = {}) {
        const element = document.createElement(tag);
        Object.keys(attributes).forEach(key => {
            element[key] = attributes[key];
        });
        return element;
    }
}
// Кэширование запросов
const apiCache = new Map();

async function cachedRequest(url, options = {}) {
    const cacheKey = JSON.stringify({ url, options });
    
    if (apiCache.has(cacheKey)) {
        return apiCache.get(cacheKey);
    }
    
    const response = await fetch(url, options);
    const data = await response.json();
    
    // Кэшируем на 30 секунд
    apiCache.set(cacheKey, data);
    setTimeout(() => apiCache.delete(cacheKey), 30000);
    
    return data;
}

// Мемоизация тяжелых функций
function memoize(fn) {
    const cache = new Map();
    return function(...args) {
        const key = JSON.stringify(args);
        if (cache.has(key)) return cache.get(key);
        
        const result = fn.apply(this, args);
        cache.set(key, result);
        return result;
    };
}
// Критическая загрузка по приоритету
class PriorityLoader {
    constructor() {
        this.priorityQueue = [];
    }
    
    addCritical(resource, priority = 0) {
        this.priorityQueue.push({ resource, priority });
        this.priorityQueue.sort((a, b) => b.priority - a.priority);
    }
    
    async load() {
        for (const item of this.priorityQueue) {
            await this.loadResource(item.resource);
        }
    }
    
    async loadResource(resource) {
        if (resource.type === 'script') {
            await this.loadScript(resource.url);
        } else if (resource.type === 'data') {
            await this.loadData(resource.url);
        }
    }
}
// 💬 Админ-чат с пользователями
async function openAdminSupportChat() {
    if (!currentUser) return;
    
    // Проверяем права
    const isAdmin = await checkAdminAccess(currentUser.id);
    if (!isAdmin) {
        showNotification('Только администратор может отвечать в чате!', 'error');
        return;
    }
    
    try {
        const result = await makeRequest(`/support/chats?adminId=${currentUser.id}`);
        if (result.success) {
            showAdminChatsModal(result.chats);
        }
    } catch (error) {
        console.error('Error loading admin chats:', error);
    }
}

// 🎨 Модальное окно чатов для админа
function showAdminChatsModal(chats) {
    let modalHTML = `
        <div class="modal active" id="admin-chats-modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <div class="modal-title">💬 Чаты с пользователями</div>
                    <button class="modal-close" onclick="closeModal('admin-chats-modal')">×</button>
                </div>
                <div class="modal-body">
    `;
    
    if (!chats || chats.length === 0) {
        modalHTML += `
            <div style="text-align: center; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 16px;">💬</div>
                <div>Нет активных чатов</div>
            </div>
        `;
    } else {
        chats.forEach(chat => {
            modalHTML += `
                <div class="chat-item" style="display: flex; align-items: center; padding: 12px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 8px; cursor: pointer;" onclick="openChatWithUser(${chat.id})">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--purple-gradient); display: flex; align-items: center; justify-content: center; margin-right: 12px; color: white; font-weight: 600;">
                        ${chat.user_name ? chat.user_name.charAt(0).toUpperCase() : 'U'}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${chat.user_name}</div>
                        <div style="color: var(--text-secondary); font-size: 12px;">${chat.last_message || 'Нет сообщений'}</div>
                    </div>
                </div>
            `;
        });
    }
    
    modalHTML += `
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// 🔧 Обновление интерфейса для админов
function updateAdminInterface() {
    if (!currentUser) return;
    
    // Проверяем права асинхронно и обновляем интерфейс
    checkAdminAccess(currentUser.id).then(isAdmin => {
        if (isAdmin) {
            // Добавляем кнопки для админов в главную страницу
            addAdminButtonsToMainPage();
        }
    });
}

// 🎨 Добавление кнопок админа на главную страницу
function addAdminButtonsToMainPage() {
    // Проверяем, не добавлены ли кнопки уже
    if (document.getElementById('admin-buttons-container')) return;
    
    const adminButtonsHTML = `
        <div id="admin-buttons-container" class="card fade-in" style="margin-top: 20px;">
            <h3 style="margin-bottom: 16px; text-align: center;">⚙️ Панель администратора</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button class="btn btn-primary" onclick="addNewPostAsAdmin()">📝 Добавить пост</button>
                <button class="btn btn-primary" onclick="addTaskAsAdmin()">📋 Добавить задание</button>
                <button class="btn btn-warning" onclick="loadTaskVerificationsForAdmin()">✅ Проверить задания</button>
                <button class="btn btn-success" onclick="openAdminSupportChat()">💬 Ответить в чатах</button>
            </div>
        </div>
    `;
    
    const mainTab = document.getElementById('main-tab');
    if (mainTab) {
        mainTab.insertAdjacentHTML('beforeend', adminButtonsHTML);
    }
}



// Функция проверки прав администратора
async function isUserAdmin(userId) {
    try {
        const result = await pool.query(
            'SELECT is_admin FROM user_profiles WHERE user_id = $1',
            [userId]
        );
        
        if (result.rows.length > 0) {
            return result.rows[0].is_admin === true || parseInt(userId) === ADMIN_ID;
        }
        return parseInt(userId) === ADMIN_ID;
    } catch (error) {
        return parseInt(userId) === ADMIN_ID;
    }
}

// Создание поста - для всех админов
app.post('/api/posts', async (req, res) => {
    const { title, content, author, authorId } = req.body;
    
    if (!title || !content || !author) {
        return res.status(400).json({
            success: false,
            error: 'Заполните все поля'
        });
    }
    
    // ✅ ПРАВИЛЬНАЯ ПРОВЕРКА - все админы могут создавать посты
    const userIsAdmin = await isUserAdmin(authorId);
    if (!userIsAdmin) {
        return res.status(403).json({
            success: false,
            error: 'Только администратор может публиковать посты!'
        });
    }
    
    try {
        const result = await pool.query(`
            INSERT INTO posts (title, content, author, author_id) 
            VALUES ($1, $2, $3, $4)
            RETURNING *
        `, [title, content, author, authorId]);
        
        res.json({
            success: true,
            message: 'Пост успешно опубликован!',
            post: result.rows[0]
        });
    } catch (error) {
        console.error('Create post error:', error);
        res.status(500).json({
            success: false,
            error: 'Ошибка базы данных'
        });
    }
});

// 🔧 ФУНКЦИЯ ДЛЯ ДИАГНОСТИКИ ПРОБЛЕМЫ С ЗАГРУЗКОЙ
function debugTasksLoading() {
    console.log('🔍 ДИАГНОСТИКА ЗАГРУЗКИ ЗАДАНИЙ:');
    
    const tasksTab = document.getElementById('tasks-tab');
    const newTasksContainer = document.getElementById('new-tasks');
    const activeTasksContainer = document.querySelector('#new-tasks.active');
    
    console.log('- tasks-tab exists:', !!tasksTab);
    console.log('- tasks-tab active:', tasksTab?.classList.contains('active'));
    console.log('- new-tasks container exists:', !!newTasksContainer);
    console.log('- new-tasks container active:', !!activeTasksContainer);
    console.log('- new-tasks display:', newTasksContainer?.style.display);
    console.log('- currentUser exists:', !!currentUser);
    console.log('- allTasks count:', allTasks?.length || 0);
    
    // Проверяем видимость контейнера
    if (newTasksContainer) {
        const rect = newTasksContainer.getBoundingClientRect();
        console.log('- new-tasks visible:', rect.width > 0 && rect.height > 0);
    }
}
// 🔍 Функция проверки прав администратора
async function checkUserIsAdmin(userId) {
    try {
        const result = await makeRequest(`/user/${userId}`);
        if (result.success) {
            return result.profile.is_admin === true || parseInt(userId) === ADMIN_ID;
        }
        return false;
    } catch (error) {
        console.error('Admin check error:', error);
        return false;
    }
}
// 🔧 ФУНКЦИЯ ФИЛЬТРАЦИИ ЗАДАНИЙ ПО КАТЕГОРИЯМ
function filterTasks(category) {
    console.log('🎯 Filtering tasks by category:', category);
    
    // Обновляем активную кнопку
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Получаем текущий поисковый запрос
    const searchText = document.getElementById('task-search').value.trim();
    
    // Загружаем задания с фильтром
    loadTasks(searchText, category);
}

async function loadTasks(search = '', category = 'all') {
    try {
        console.log('🎯 START loadTasks with filter:', { 
            search, 
            category, 
            userId: currentUser?.id,
            hasUser: !!currentUser
        });

        if (!currentUser) {
            console.log('❌ No current user, aborting loadTasks');
            showNotification('Пользователь не авторизован', 'error');
            return;
        }

        const newTasksContainer = document.getElementById('new-tasks');
        if (!newTasksContainer) {
            console.log('❌ new-tasks container not found');
            return;
        }

        // Показываем индикатор загрузки
        newTasksContainer.innerHTML = `
            <div class="no-tasks" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <div class="loading-spinner">⏳</div>
                <div style="margin-top: 16px;">Загружаем задания...</div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                    ID: ${currentUser.id}
                </div>
            </div>
        `;

        // Формируем URL с правильными параметрами
        const params = new URLSearchParams();
        params.append('userId', currentUser.id);
        if (search) params.append('search', search);
        if (category && category !== 'all') params.append('category', category);
        
        const url = `/api/tasks?${params.toString()}`;
        console.log('📡 Request URL:', url);

        const response = await fetch(API_BASE_URL + url);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('📨 Server response:', result);

        if (result.success) {
            allTasks = result.tasks || [];
            console.log (`✅ Loaded ${allTasks.length} tasks:`, allTasks.map(t => ({id: t.id, title: t.title})));
            
            // 🔥 ВАЖНО: Теперь сервер сам фильтрует отклоненные задания
            // Просто отображаем то, что пришло с сервера
            displayTasks(allTasks, 'new');
            
        } else {
            throw new Error(result.error || 'Unknown server error');
        }

    } catch (error) {
        console.error('💥 loadTasks error:', error);
        
        const newTasksContainer = document.getElementById('new-tasks');
        if (newTasksContainer) {
            newTasksContainer.innerHTML = `
                <div class="no-tasks" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div style="font-size: 48px; margin-bottom: 16px;">❌</div>
                    <div>Ошибка загрузки заданий</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin: 8px 0;">
                        ${error.message}
                    </div>
                    <button class="btn btn-primary" onclick="loadTasks()" style="margin-top: 16px;">
                        Попробовать снова
                    </button>
                </div>
            `;
        }
        
        showNotification(`Ошибка загрузки заданий: ${error.message}`, 'error');
    }
}

// 🔧 НОВАЯ ФУНКЦИЯ: Получение активных заданий пользователя
async function getUserActiveTasks() {
    if (!currentUser) return [];
    
    try {
        const response = await fetch(`${API_BASE_URL}/api/user/${currentUser.id}/tasks/active-ids`);
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                return result.taskIds || [];
            }
        }
    } catch (error) {
        console.error('Error getting user active tasks:', error);
    }
    
    return [];
}
// 🔧 ФУНКЦИЯ ОТОБРАЖЕНИЯ ОТФИЛЬТРОВАННЫХ ЗАДАНИЙ
function displayFilteredTasks(tasks, category, search) {
    const container = document.getElementById('new-tasks');
    if (!container) {
        console.error('❌ Container not found');
        return;
    }
    
    container.innerHTML = '';
    
    // Фильтруем задачи если нужно (на сервере уже отфильтровано, но для надежности)
    let filteredTasks = tasks;
    
    if (search) {
        const searchLower = search.toLowerCase();
        filteredTasks = tasks.filter(task => 
            task.title.toLowerCase().includes(searchLower) ||
            task.description.toLowerCase().includes(searchLower) ||
            (task.category && task.category.toLowerCase().includes(searchLower))
        );
    }
    
    if (!filteredTasks || filteredTasks.length === 0) {
        let message = 'Заданий не найдено';
        if (search && category !== 'all') {
            message = `Нет заданий в категории "${getCategoryDisplayName(category)}" по запросу "${search}"`;
        } else if (search) {
            message = `Нет заданий по запросу "${search}"`;
        } else if (category !== 'all') {
            message = `Нет заданий в категории "${getCategoryDisplayName(category)}"`;
        }
        
        container.innerHTML = `
            <div class="no-tasks" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 16px;">🔍</div>
                <div style="font-size: 18px; margin-bottom: 8px;">${message}</div>
                <div style="font-size: 14px; color: var(--text-secondary);">
                    Попробуйте изменить поисковый запрос или выбрать другую категорию
                </div>
                <button class="btn btn-primary" onclick="clearFilters()" style="margin-top: 16px;">
                    Сбросить фильтры
                </button>
            </div>
        `;
        return;
    }
    
    console.log(`🎨 Rendering ${filteredTasks.length} filtered tasks...`);
    
    filteredTasks.forEach((task, index) => {
        const taskElement = createTaskCardWithImage(task, 'new', index);
        container.appendChild(taskElement);
    });
    
    // Показываем информацию о фильтрах
    showFilterInfo(category, search, filteredTasks.length);
}

// 🔧 ФУНКЦИЯ ДЛЯ ОТОБРАЖЕНИЯ ИНФОРМАЦИИ О ФИЛЬТРАХ
function showFilterInfo(category, search, count) {
    // Создаем или обновляем элемент информации о фильтрах
    let filterInfo = document.getElementById('filter-info');
    if (!filterInfo) {
        filterInfo = document.createElement('div');
        filterInfo.id = 'filter-info';
        filterInfo.style.cssText = `
            margin: 10px 0;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        `;
        
        const container = document.getElementById('new-tasks');
        if (container) {
            container.parentNode.insertBefore(filterInfo, container);
        }
    }
    
    let filterText = '';
    if (category !== 'all' && search) {
        filterText = `Категория: ${getCategoryDisplayName(category)} • Поиск: "${search}"`;
    } else if (category !== 'all') {
        filterText = `Категория: ${getCategoryDisplayName(category)}`;
    } else if (search) {
        filterText = `Поиск: "${search}"`;
    } else {
        filterText = 'Все задания';
    }
    
    filterInfo.innerHTML = `
        <span>${filterText} • Найдено: ${count}</span>
        ${(category !== 'all' || search) ? `
            <button class="btn btn-secondary" onclick="clearFilters()" style="padding: 4px 8px; font-size: 12px;">
                ✕ Сбросить
            </button>
        ` : ''}
    `;
}

// 🔧 ФУНКЦИЯ СБРОСА ФИЛЬТРОВ
function clearFilters() {
    console.log('🔄 Clearing all filters');
    
    // Сбрасываем поле поиска
    const searchInput = document.getElementById('task-search');
    if (searchInput) {
        searchInput.value = '';
    }
    
    // Сбрасываем кнопки категорий
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
    
    // Удаляем информацию о фильтрах
    const filterInfo = document.getElementById('filter-info');
    if (filterInfo) {
        filterInfo.remove();
    }
    
    // Загружаем все задания
    loadTasks();
}

// 🔧 ФУНКЦИЯ ДЛЯ ПОЛУЧЕНИЯ ОТОБРАЖАЕМОГО ИМЕНИ КАТЕГОРИИ
function getCategoryDisplayName(category) {
    const categoryMap = {
        'all': 'Все',
        'social': 'Соцсети',
        'subscribe': 'Подписки',
        'view': 'Просмотры',
        'comment': 'Комментарии',
        'repost': 'Репосты',
        'other': 'Другое'
    };
    
    return categoryMap[category] || category;
}

// 🔧 ОБНОВЛЕННАЯ ИНИЦИАЛИЗАЦИЯ ПОИСКА
function initializeSearch() {
    const searchInput = document.getElementById('task-search');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const searchText = e.target.value.trim();
            
            searchTimeout = setTimeout(() => {
                const activeFilter = document.querySelector('.filter-btn.active');
                const filter = activeFilter ? activeFilter.getAttribute('data-filter') : 'all';
                
                loadTasks(searchText, filter);
            }, 300);
        });
    }
    
    // Обработчики для кнопок фильтров уже установлены через onclick
    console.log('✅ Search and filters initialized');
}

// 🔧 ОБНОВЛЕННАЯ ФУНКЦИЯ ПОКАЗА КАТЕГОРИИ ЗАДАНИЙ
function showTaskCategory(category) {
    console.log('🔄 Switching to category:', category);
    
    // Скрываем все вкладки
    const tabs = document.querySelectorAll('.task-tab');
    const containers = document.querySelectorAll('.tasks-grid');
    
    tabs.forEach(tab => tab.classList.remove('active'));
    containers.forEach(container => {
        container.classList.remove('active');
        container.style.display = 'none';
    });
    
    // Активируем выбранную вкладку
    const activeTab = Array.from(tabs).find(tab => 
        tab.textContent.toLowerCase().includes(getCategoryName(category))
    );
    if (activeTab) {
        activeTab.classList.add('active');
    }
    
    // Показываем выбранный контейнер
    const targetContainer = document.getElementById(`${category}-tasks`);
    if (targetContainer) {
        targetContainer.classList.add('active');
        targetContainer.style.display = 'block';
        console.log(`✅ Контейнер ${category}-tasks показан`);
        
        // Сбрасываем фильтры при переключении категорий
        if (category === 'new') {
            // Для новых заданий загружаем с текущими фильтрами
            const searchText = document.getElementById('task-search').value.trim();
            const activeFilter = document.querySelector('.filter-btn.active');
            const filter = activeFilter ? activeFilter.getAttribute('data-filter') : 'all';
            
            loadTasks(searchText, filter);
        } else {
            // Для других категорий просто загружаем задания
            loadTasksForCategory(category);
        }
    } else {
        console.error(`❌ Контейнер ${category}-tasks не найден`);
    }
}

// 🔧 ЭКСПОРТ ФУНКЦИЙ
window.filterTasks = filterTasks;
window.clearFilters = clearFilters;
window.loadTasks = loadTasks;

// 📝 Функция создания поста (для всех админов)
async function addNewPostAsAdmin() {
    if (!currentUser) {
        showNotification('Пользователь не авторизован', 'error');
        return;
    }
    
    // ✅ ПРАВИЛЬНАЯ ПРОВЕРКА
    const isAdmin = await checkUserIsAdmin(currentUser.id);
    if (!isAdmin) {
        showNotification('Только администратор может публиковать посты!', 'error');
        return;
    }
    
    const title = prompt('Введите заголовок поста:');
    if (!title) return;
    
    const content = prompt('Введите содержание поста:');
    if (!content) return;
    
    try {
        const result = await makeRequest('/posts', {
            method: 'POST',
            body: JSON.stringify({
                title: title,
                content: content,
                author: currentUser.firstName,
                authorId: currentUser.id
            })
        });

        if (result.success) {
            showNotification('Пост успешно опубликован!', 'success');
            loadMainPagePosts();
        } else {
            showNotification('Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error adding post:', error);
        showNotification('Ошибка публикации поста', 'error');
    }
}
// Ленивая загрузка для изображений
document.addEventListener('DOMContentLoaded', function() {
  const lazyImages = [].slice.call(document.querySelectorAll('img[data-src]'));
  
  if ('IntersectionObserver' in window) {
    let lazyImageObserver = new IntersectionObserver(function(entries, observer) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          let lazyImage = entry.target;
          lazyImage.src = lazyImage.dataset.src;
          lazyImage.classList.remove('lazy');
          lazyImageObserver.unobserve(lazyImage);
        }
      });
    });

    lazyImages.forEach(function(lazyImage) {
      lazyImageObserver.observe(lazyImage);
    });
  }
});
// Вместо сложной анимации - простая
function simpleShowTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.style.display = 'none';
  });
  document.getElementById(tabId).style.display = 'block';
}

// Оптимизированная загрузка данных
async function loadEssentialData() {
  // Загружайте только необходимое
  try {
    const [userData, tasks] = await Promise.all([
      fetch('/api/user-data').then(r => r.json()),
      fetch('/api/essential-tasks').then(r => r.json())
    ]);
    return { userData, tasks };
  } catch (error) {
    console.error('Load error:', error);
  }
}
// 📋 Функция создания задания (для всех админов)
async function addTaskAsAdmin() {
    if (!currentUser) {
        showNotification('Пользователь не авторизован', 'error');
        return;
    }
    
    // ✅ ПРАВИЛЬНАЯ ПРОВЕРКА
    const isAdmin = await checkUserIsAdmin(currentUser.id);
    if (!isAdmin) {
        showNotification('Только администратор может создавать задания!', 'error');
        return;
    }
    
    const title = prompt('Введите название задания:');
    if (!title) return;
    
    const description = prompt('Введите описание задания:');
    if (!description) return;
    
    const price = prompt('Введите цену задания (в рублях):');
    if (!price) return;
    
    try {
        const result = await makeRequest('/tasks', {
            method: 'POST',
            body: JSON.stringify({
                title: title,
                description: description,
                price: parseFloat(price),
                created_by: currentUser.id
            })
        });

        if (result.success) {
            showNotification('Задание успешно создано!', 'success');
            loadTasks();
        } else {
            showNotification('Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error adding task:', error);
        showNotification('Ошибка создания задания', 'error');
    }
}

// Функция для отладки прав администратора
function debugAdminRights() {
    console.log('🐛 DEBUG Admin Rights:');
    console.log('- Current User:', currentUser);
    console.log('- ADMIN_ID:', ADMIN_ID);
    console.log('- is_admin:', currentUser?.is_admin);
    console.log('- isMainAdmin:', currentUser?.id === ADMIN_ID.toString());
    console.log('- Admin Nav Visible:', document.getElementById('admin-nav-item')?.style.display);
    console.log('- Admin Panel Visible:', document.getElementById('admin-panel')?.style.display);
}

// Вызов для отладки (можно убрать после тестирования)
setTimeout(debugAdminRights, 2000);



        // Функция для кнопки повторной попытки
        function showRetryButton() {
            const retryBtn = document.createElement('button');
            retryBtn.textContent = '🔄 Попробовать снова';
            retryBtn.className = 'btn btn-primary';
            retryBtn.style.margin = '20px auto';
            retryBtn.style.display = 'block';
            retryBtn.onclick = function() {
                retryBtn.remove();
                initializeApp();
            };
            
            document.body.appendChild(retryBtn);
        }

       // 🔧 ОБНОВЛЕННОЕ АВТООБНОВЛЕНИЕ ДАННЫХ
function startUserDataAutoUpdate() {
    setInterval(async () => {
        if (currentUser) {
            try {
                const result = await makeRequest(`/user/${currentUser.id}`);
                if (result.success) {
                    // Сохраняем старые данные для сравнения
                    const oldLevel = currentUser.level;
                    const oldTasksCompleted = currentUser.tasks_completed;
                    
                    // Обновляем текущего пользователя
                    currentUser = { ...currentUser, ...result.profile };
                    
                    // Обновляем отображение
                    displayUserProfile();
                    updateLevelProgress(); // Важно: обновляем прогресс уровня
                    
                    console.log('✅ Данные пользователя автообновлены');
                }
            } catch (error) {
                console.error('Ошибка автообновления данных пользователя:', error);
            }
        }
    }, 30000);
}

        // Обновление данных пользователя
        async function updateUserData() {
            if (!currentUser) return;
            
            try {
                const result = await makeRequest(`/user/${currentUser.id}`);
                if (result.success) {
                    // Обновляем текущего пользователя
                    currentUser = { ...currentUser, ...result.profile };
                    
                    // Обновляем отображение во всех местах
                    displayUserProfile();
                    
                    console.log('✅ Данные пользователя обновлены:', currentUser.balance);
                }
            } catch (error) {
                console.error('Ошибка обновления данных пользователя:', error);
            }
        }

        // 🔧 ОБНОВЛЕННАЯ ФУНКЦИЯ ОТОБРАЖЕНИЯ ПРОФИЛЯ
function displayUserProfile() {
    if (!currentUser) return;

    // Обновляем основную информацию
    const firstNameElement = document.getElementById('user-first-name');
    const usernameElement = document.getElementById('user-username');
    const levelElement = document.getElementById('user-level');
    const balanceElement = document.getElementById('user-balance-main');
    
    if (firstNameElement) {
        const fullName = currentUser.lastName ? 
            `${currentUser.firstName} ${currentUser.lastName}` : 
            currentUser.firstName;
        firstNameElement.textContent = fullName;
    }
    
    if (usernameElement) usernameElement.textContent = currentUser.username || 'username';
    if (levelElement) levelElement.textContent = currentUser.level || 1;
    
    // Обновляем баланс во всех местах
    const userBalance = currentUser.balance || 0;
    if (balanceElement) balanceElement.textContent = `${userBalance} ⭐`;
    
    // Обновляем аватар
    const userPhotoElement = document.getElementById('user-photo');
    if (userPhotoElement && currentUser.photoUrl) {
        userPhotoElement.src = currentUser.photoUrl;
        userPhotoElement.alt = 'Фото профиля';
        userPhotoElement.style.display = 'block';
    } else if (userPhotoElement) {
        // Показываем инициал если нет фото
        userPhotoElement.style.display = 'flex';
        userPhotoElement.style.alignItems = 'center';
        userPhotoElement.style.justifyContent = 'center';
        userPhotoElement.style.backgroundColor = '#6366f1';
        userPhotoElement.style.color = 'white';
        userPhotoElement.style.fontWeight = 'bold';
        userPhotoElement.style.borderRadius = '50%';
        userPhotoElement.textContent = currentUser.firstName ? currentUser.firstName.charAt(0).toUpperCase() : 'U';
    }
    
    // Обновляем статистику и прогресс
    updateProfileStats();
    updateReferralSystem();
    updateLevelProgress(); // ← ВАЖНО: вызываем обновление прогресса уровня
}

function updateProfileStats() {
    if (!currentUser) return;
    
    const stats = document.querySelectorAll('.profile-stat .stat-value');
    if (stats.length >= 4) {
        // Баланс
        stats[0].textContent = `${currentUser.balance || 0} ⭐`;
        // Выполнено заданий
        stats[1].textContent = currentUser.tasks_completed || 0;
        // Активные задания (нужно получать с сервера)
        stats[2].textContent = currentUser.active_tasks || 0;
        // Качество (нужно рассчитывать)
        stats[3].textContent = `${calculateQualityRate() || 0}%`;
    }
}

// Функция расчета качества выполнения заданий
function calculateQualityRate() {
    if (!currentUser) return 0;
    
    const completed = currentUser.tasks_completed || 0;
    const rejected = currentUser.tasks_rejected || 0;
    const total = completed + rejected;
    
    if (total === 0) return 0;
    
    return Math.round((completed / total) * 100);
}

// Функция для получения активных заданий
async function updateActiveTasksCount() {
    if (!currentUser) return;
    
    try {
        const result = await makeRequest(`/user/${currentUser.id}/tasks/active-count`);
        if (result.success) {
            currentUser.active_tasks = result.count;
            updateProfileStats();
        }
    } catch (error) {
        console.error('Error loading active tasks count:', error);
    }
}

function updateReferralSystem() {
    if (!currentUser) return;
    
    // Генерируем правильную реферальную ссылку
    const referralCode = currentUser.referral_code || `ref_${currentUser.id}`;
    const referralLink = `https://t.me/LinkGoldMoney_bot?start=${referralCode}`;
    
    const referralInput = document.getElementById('referral-link');
    if (referralInput) referralInput.value = referralLink;
    
    const refInvited = document.getElementById('ref-invited');
    const refEarned = document.getElementById('ref-earned');
    
    if (refInvited) refInvited.textContent = currentUser.referral_count || 0;
    if (refEarned) refEarned.textContent = `${currentUser.referral_earned || 0} ⭐`;
    
    // 🔥 ИСПРАВЛЕНИЕ: Обновляем текст с правильными бонусами
    const referralInfo = document.querySelector('.referral-info');
    if (referralInfo) {
        referralInfo.innerHTML = `
            🎁 Вы получаете: <strong>10⭐</strong> за друга<br>
            🎁 Друг получает: <strong>5⭐</strong> при регистрации<br><br>
            🔗 Просто отправьте другу эту ссылку в Telegram
        `;
    }
}
// Получение детальной информации о рефералах
app.get('/api/user/:userId/referrals/detailed', async (req, res) => {
    const userId = req.params.userId;
    
    try {
        const result = await pool.query(`
            SELECT 
                u.user_id,
                u.first_name,
                u.username,
                u.created_at,
                u.balance as friend_balance,
                CASE 
                    WHEN u.is_first_login = false THEN 'active'
                    ELSE 'pending'
                END as status
            FROM user_profiles u
            WHERE u.referred_by = $1
            ORDER BY u.created_at DESC
        `, [userId]);
        
        res.json({
            success: true,
            referrals: result.rows
        });
    } catch (error) {
        console.error('Get detailed referrals error:', error);
        res.status(500).json({
            success: false,
            error: 'Database error: ' + error.message
        });
    }
});
function updateLevelProgress() {
    if (!currentUser) return;
    
    const completedTasks = currentUser.tasks_completed || 0;
    const levelInfo = calculateUserLevel(completedTasks);
    
    console.log('📊 Level progress calculation:', {
        completedTasks,
        level: levelInfo.level,
        percentage: levelInfo.progressPercentage
    });
    
    const progressBar = document.getElementById('level-progress-bar');
    const levelCount = document.querySelector('.level-count');
    const levelInfoText = document.querySelector('.level-info');
    
    if (progressBar) {
        progressBar.style.width = `${levelInfo.progressPercentage}%`;
    }
    
    if (levelCount) {
        if (levelInfo.isMaxLevel) {
            levelCount.textContent = "Макс. уровень!";
        } else {
            const nextLevelRequirement = LEVEL_SYSTEM[levelInfo.level + 1].tasksRequired;
            const tasksNeeded = nextLevelRequirement - completedTasks;
            levelCount.textContent = `${completedTasks}/${nextLevelRequirement}`;
        }
    }
    
    if (levelInfoText) {
        if (levelInfo.isMaxLevel) {
            levelInfoText.innerHTML = `🎉 Поздравляем! Вы достигли максимального уровня!`;
        } else {
            const nextLevelRequirement = LEVEL_SYSTEM[levelInfo.level + 1].tasksRequired;
            const tasksNeeded = nextLevelRequirement - completedTasks;
            levelInfoText.innerHTML = 
                `Уровень <strong>${levelInfo.levelName}</strong> • ` +
                `До следующего уровня: <strong>${tasksNeeded}</strong> заданий`;
        }
    }
}
// 🔧 ФУНКЦИЯ ДЛЯ СИНХРОНИЗАЦИИ ПРОФИЛЯ С TELEGRAM
async function syncUserProfile() {
    if (!currentUser || !window.Telegram?.WebApp) return;
    
    try {
        const tg = window.Telegram.WebApp;
        const tgUser = tg.initDataUnsafe?.user;
        
        if (tgUser) {
            // Обновляем данные пользователя из Telegram
            const updatedUser = {
                ...currentUser,
                firstName: tgUser.first_name || currentUser.firstName,
                lastName: tgUser.last_name || currentUser.lastName,
                username: tgUser.username || currentUser.username,
                photoUrl: tgUser.photo_url || currentUser.photoUrl
            };
            
            // Сохраняем обновленные данные
            currentUser = updatedUser;
            
            // Обновляем интерфейс
            displayUserProfile();
            
            console.log('✅ Профиль синхронизирован с Telegram');
        }
    } catch (error) {
        console.error('❌ Ошибка синхронизации профиля:', error);
    }
}
        // Проверка прав администратора
// Проверка прав администратора
// Проверка прав администратора - ОБНОВЛЕННАЯ ВЕРСИЯ
// Проверка прав администратора - ОБНОВЛЕННАЯ ВЕРСИЯ
function checkAdminRights() {
    const adminNavItem = document.getElementById('admin-nav-item');
    
    const isMainAdmin = parseInt(currentUser?.id) === ADMIN_ID;
    const isRegularAdmin = currentUser?.is_admin === true;
    
    if (currentUser && (isMainAdmin || isRegularAdmin)) {
        if (adminNavItem) {
            adminNavItem.style.display = 'flex';
            console.log('✅ Admin nav item shown - user is admin');
        }
    } else {
        if (adminNavItem) {
            adminNavItem.style.display = 'none';
            console.log('❌ Admin nav item hidden - user is not admin');
        }
    }
}
// В функции инициализации админ-панели добавьте:
if (parseInt(currentUser.id) === ADMIN_ID) {
    // Показываем кнопку управления админами только главному админу
    const adminButtons = document.querySelector('.admin-buttons');
    if (adminButtons) {
        adminButtons.innerHTML += `
            <button class="admin-btn" onclick="showAdminSection('admins')">👥 Админы</button>
        `;
    }
}
// Обновите функцию инициализации приложения



function showTaskCategory(category) {
    console.log('🔄 Переключение на категорию:', category);
    
    // Скрываем все вкладки
    const tabs = document.querySelectorAll('.task-tab');
    const containers = document.querySelectorAll('.tasks-grid');
    
    tabs.forEach(tab => tab.classList.remove('active'));
    containers.forEach(container => {
        container.classList.remove('active');
        container.style.display = 'none';
    });
    
    // Активируем выбранную вкладку
    const activeTab = Array.from(tabs).find(tab => 
        tab.textContent.toLowerCase().includes(getCategoryName(category))
    );
    if (activeTab) {
        activeTab.classList.add('active');
    }
    
    // Показываем выбранный контейнер
    const targetContainer = document.getElementById(`${category}-tasks`);
    if (targetContainer) {
        targetContainer.classList.add('active');
        targetContainer.style.display = 'block';
        console.log(`✅ Контейнер ${category}-tasks показан`);
        
        // Загружаем данные для категории
        loadTasksForCategory(category);
    } else {
        console.error(`❌ Контейнер ${category}-tasks не найден`);
    }
}
function getCategoryName(category) {
    const names = {
        'new': 'новые',
        'confirmation': 'подтверждение', 
        'completed': 'выполненные',
        'rejected': 'отклоненные'
    };
    return names[category] || category;
}


async function loadTasksForCategory(category) {
    try {
        console.log(`🔄 Загружаем задания для категории: ${category} для пользователя:`, currentUser?.id);
        
        if (!currentUser) {
            console.log('❌ Пользователь не авторизован');
            return;
        }

        let endpoint = '';
        let params = new URLSearchParams();
        
        switch(category) {
            case 'new':
                endpoint = '/api/tasks';
                params.append('userId', currentUser.id);
                break;
            case 'confirmation':
                endpoint = `/api/user/${currentUser.id}/tasks/active`;
                break;
            case 'completed':
                endpoint = `/api/user/${currentUser.id}/tasks?status=completed`;
                break;
            case 'rejected':
                endpoint = `/api/user/${currentUser.id}/tasks?status=rejected`;
                break;
        }
        
        const url = endpoint + (params.toString() ? `?${params.toString()}` : '');
        console.log('📡 Request URL:', url);

        const result = await makeRequest(url);
        
        if (result.success) {
            displayTasksForCategory(result.tasks || [], category);
        } else {
            console.error(`❌ Ошибка загрузки ${category} заданий:`, result.error);
            showNotification(`Ошибка загрузки ${category} заданий`, 'error');
        }
    } catch (error) {
        console.error(`❌ Ошибка загрузки ${category} заданий:`, error);
        showNotification(`Ошибка загрузки ${category} заданий`, 'error');
    }
}
function displayTasksForCategory(tasks, category) {
    const container = document.getElementById(`${category}-tasks`);
    if (!container) {
        console.error(`❌ Контейнер ${category}-tasks не найден`);
        return;
    }
    
    container.innerHTML = '';
    
    if (!tasks || tasks.length === 0) {
        let message = '';
        switch(category) {
            case 'new':
                message = 'Новых заданий пока нет';
                break;
            case 'confirmation':
                message = 'Нет заданий на подтверждении';
                break;
            case 'completed':
                message = 'Нет выполненных заданий';
                break;
            case 'rejected':
                message = 'Нет отклоненных заданий';
                break;
        }
        
        container.innerHTML = `
            <div class="no-tasks" style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; margin-bottom: 16px;">📝</div>
                <div style="font-size: 18px; margin-bottom: 8px;">${message}</div>
                <div style="font-size: 14px; color: var(--text-secondary);">
                    ${category === 'new' ? 'Новые задания появятся позже' : 'Следите за обновлениями'}
                </div>
            </div>
        `;
        return;
    }
    
    console.log(`🎯 Отображаем ${tasks.length} заданий в категории ${category}`);
    
    tasks.forEach((task, index) => {
        const taskElement = createTaskCardWithImage(task, category, index);
        container.appendChild(taskElement);
    });
}
        // 🔧 ФУНКЦИЯ СОЗДАНИЯ ЭЛЕМЕНТА ЗАДАНИЯ
        function createTaskElement(task, category, index) {
            const taskElement = document.createElement('div');
            taskElement.className = 'task-card';
            taskElement.style.animationDelay = `${index * 0.1}s`;
            
            // Форматируем данные в зависимости от категории
            let taskHTML = '';
            
            switch(category) {
                case 'new':
                    taskHTML = createNewTaskHTML(task);
                    break;
                case 'confirmation':
                    taskHTML = createConfirmationTaskHTML(task);
                    break;
                case 'completed':
                    taskHTML = createCompletedTaskHTML(task);
                    break;
                case 'rejected':
                    taskHTML = createRejectedTaskHTML(task);
                    break;
            }
            
            taskElement.innerHTML = taskHTML;
            
            // Добавляем обработчики событий
            if (category === 'new') {
                taskElement.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('task-btn')) {
                        openTaskModal(task.id);
                    }
                });
            }
            
            return taskElement;
        }


// 🚀 ОПТИМИЗАЦИИ ДЛЯ ПЛАВНОСТИ И ОТЗЫВЧИВОСТИ

// 🔧 ФУНКЦИЯ ДЛЯ ПЛАВНЫХ ПЕРЕХОДОВ МЕЖДУ СТРАНИЦАМИ
function smoothShowTab(tabId) {
    return new Promise((resolve) => {
        // Скрываем все вкладки
        const allTabs = document.querySelectorAll('.tab-content, .page');
        
        // Анимация скрытия текущей активной вкладки
        const activeTab = document.querySelector('.tab-content.active, .page.active');
        if (activeTab) {
            activeTab.style.opacity = '0';
            activeTab.style.transform = 'translateY(10px)';
            
            setTimeout(() => {
                activeTab.classList.remove('active');
                
                // Показываем новую вкладку
                const targetTab = document.getElementById(tabId);
                if (targetTab) {
                    targetTab.classList.add('active');
                    
                    // Запускаем анимацию появления
                    requestAnimationFrame(() => {
                        targetTab.style.opacity = '0';
                        targetTab.style.transform = 'translateY(-10px)';
                        
                        requestAnimationFrame(() => {
                            targetTab.style.transition = 'all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                            targetTab.style.opacity = '1';
                            targetTab.style.transform = 'translateY(0)';
                            
                            setTimeout(() => {
                                targetTab.style.transition = '';
                                resolve();
                            }, 400);
                        });
                    });
                }
            }, 50);
        }
    });
}

// 🔧 УЛУЧШЕННАЯ ФУНКЦИЯ ПЕРЕКЛЮЧЕНИЯ ВКЛАДОК
function enhancedShowTab(tabId) {
    // Используем requestAnimationFrame для плавности
    requestAnimationFrame(() => {
        hideAllTabs();
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            targetTab.classList.add('active');
            updateNavState(tabId.replace('-tab', ''));
            
            // Запускаем микро-задержку для браузера
            setTimeout(() => {
                // Принудительный reflow для запуска анимации
                targetTab.offsetHeight;
            }, 10);
        }
    });
}

// 🔧 ПЛАВНОЕ ОТКРЫТИЕ/ЗАКРЫТИЕ МОДАЛЬНЫХ ОКОН
function smoothOpenModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    modal.style.display = 'flex';
    
    requestAnimationFrame(() => {
        modal.classList.add('active');
    });
}

function smoothCloseModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    modal.classList.remove('active');
    
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

// 🌊 ФУНКЦИЯ ДЛЯ RIPPLE ЭФФЕКТА
function createRipple(event) {
    const button = event.currentTarget;
    const circle = document.createElement('span');
    const diameter = Math.max(button.clientWidth, button.clientHeight);
    const radius = diameter / 2;
    
    const rect = button.getBoundingClientRect();
    
    circle.style.width = circle.style.height = `${diameter}px`;
    circle.style.left = `${event.clientX - rect.left - radius}px`;
    circle.style.top = `${event.clientY - rect.top - radius}px`;
    circle.classList.add('ripple');
    
    const ripple = button.getElementsByClassName('ripple')[0];
    if (ripple) {
        ripple.remove();
    }
    
    button.appendChild(circle);
}

// 🔧 ДОБАВЛЕНИЕ RIPPLE ЭФФЕКТА КО ВСЕМ КНОПКАМ
function initializeRippleEffects() {
    const buttons = document.querySelectorAll('.btn, .task-btn, .nav-item');
    buttons.forEach(button => {
        button.addEventListener('click', createRipple);
    });
}

// 🚀 ОПТИМИЗАЦИЯ ПРОКРУТКИ
function smoothScrollTo(element, duration = 500) {
    const target = typeof element === 'string' ? document.querySelector(element) : element;
    if (!target) return;
    
    const targetPosition = target.getBoundingClientRect().top + window.pageYOffset;
    const startPosition = window.pageYOffset;
    const distance = targetPosition - startPosition;
    let startTime = null;
    
    function animation(currentTime) {
        if (startTime === null) startTime = currentTime;
        const timeElapsed = currentTime - startTime;
        const run = easeInOutQuad(timeElapsed, startPosition, distance, duration);
        window.scrollTo(0, run);
        if (timeElapsed < duration) requestAnimationFrame(animation);
    }
    
    function easeInOutQuad(t, b, c, d) {
        t /= d/2;
        if (t < 1) return c/2*t*t + b;
        t--;
        return -c/2 * (t*(t-2) - 1) + b;
    }
    
    requestAnimationFrame(animation);
}

// 🔧 ПРЕДЗАГРУЗКА РЕСУРСОВ ДЛЯ БОЛЕЕ ПЛАВНЫХ ПЕРЕХОДОВ
function preloadResources() {
    // Предзагрузка важных изображений
    const imagesToPreload = [
        'free-icon-home-7102764.png',
        'free-icon-task-list-4173330.png',
        'free-icon-profile-4042565.png'
    ];
    
    imagesToPreload.forEach(src => {
        const img = new Image();
        img.src = src;
    });
}

// 🎯 ОПТИМИЗАЦИЯ АНИМАЦИЙ С ИСПОЛЬЗОВАНИЕМ WILL-CHANGE
function optimizeAnimations() {
    const animatedElements = document.querySelectorAll('.task-card, .card, .modal-content');
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.willChange = 'transform, opacity';
            } else {
                // Освобождаем ресурсы когда элемент не виден
                setTimeout(() => {
                    entry.target.style.willChange = 'auto';
                }, 300);
            }
        });
    });
    
    animatedElements.forEach(el => observer.observe(el));
}

// 🔧 ФУНКЦИЯ ДЛЯ ОТЛОЖЕННОЙ ЗАГРУЗКИ НЕКРИТИЧНЫХ РЕСУРСОВ
function lazyLoadImages() {
    const lazyImages = document.querySelectorAll('img[data-src]');
    
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.remove('lazy-load');
                img.classList.add('loaded');
                imageObserver.unobserve(img);
            }
        });
    });
    
    lazyImages.forEach(img => imageObserver.observe(img));
}

// 🚀 ОБНОВЛЕННЫЕ ФУНКЦИИ НАВИГАЦИИ С АНИМАЦИЯМИ
function smoothShowMainTab() {
    smoothShowTab('main-tab');
}

function smoothShowTasksTab() {
    smoothShowTab('tasks-tab').then(() => {
        // Дополнительные действия после перехода
        loadTasksForCategory('new');
    });
}

function smoothShowProfileTab() {
    smoothShowTab('profile-tab');
}

function smoothShowAdminTab() {
    smoothShowTab('admin-tab');
}

// 🔧 ОБНОВЛЕНИЕ СУЩЕСТВУЮЩИХ ФУНКЦИЙ ДЛЯ ПЛАВНОСТИ
// Переопределяем существующие функции навигации
window.showMainTab = smoothShowMainTab;
window.showTasksTab = smoothShowTasksTab;
window.showProfileTab = smoothShowProfileTab;
window.showAdminTab = smoothShowAdminTab;

// Обновляем функции модальных окон
window.openTaskModal = function(taskId) {
    // ... существующий код ...
    smoothOpenModal('task-modal');
};

window.closeModal = function(modalId) {
    smoothCloseModal(modalId);
};

// 🎯 ИНИЦИАЛИЗАЦИЯ ОПТИМИЗАЦИЙ ПРИ ЗАГРУЗКЕ
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация ripple эффектов
    initializeRippleEffects();
    
    // Оптимизация анимаций
    optimizeAnimations();
    
    // Ленивая загрузка изображений
    lazyLoadImages();
    
    // Предзагрузка ресурсов
    preloadResources();
    
    // Оптимизация для тач-устройств
    if ('ontouchstart' in window) {
        document.body.classList.add('touch-device');
    }
    
    console.log('🚀 Smooth animations initialized');
});

// 🔧 ДОПОЛНИТЕЛЬНЫЕ ОПТИМИЗАЦИИ ДЛЯ ПРОИЗВОДИТЕЛЬНОСТИ
// Дебаунс для частых операций
function debounce(func, wait, immediate) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            timeout = null;
            if (!immediate) func(...args);
        };
        const callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func(...args);
    };
}

// Троттлинг для скролла и ресайза
function throttle(func, limit) {
    let inThrottle;
    return function(...args) {
        if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    }
}

// Применяем оптимизации к обработчикам
window.addEventListener('scroll', throttle(function() {
    // Оптимизированные операции при скролле
}, 100));

window.addEventListener('resize', debounce(function() {
    // Оптимизированные операции при ресайзе
}, 250));

// 🔧 ФИКС ДЛЯ iOS SMOOTH SCROLL
if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
    document.body.style['-webkit-overflow-scrolling'] = 'touch';
}

// 🔧 HTML ДЛЯ НОВЫХ ЗАДАНИЙ - ОБНОВЛЕННАЯ ВЕРСИЯ
function createNewTaskHTML(task) {
    const categoryDisplay = formatCategory(task.category);
    const shortDescription = task.description.length > 120 
        ? task.description.substring(0, 120) + '...' 
        : task.description;
    
    const peopleRequired = task.people_required || 1;
    const completedCount = task.completed_count || 0;
    const availableTasks = Math.max(0, peopleRequired - completedCount);
    
    // 🔥 ОТОБРАЖАЕМ ПРОГРЕСС ВЫПОЛНЕНИЯ
    const progressPercentage = Math.min(100, (completedCount / peopleRequired) * 100);
    
    return `
        ${availableTasks > 0 ? `<div class="task-availability">${availableTasks} осталось</div>` : ''}
        
        <div class="task-header">
            <div class="task-title">${escapeHtml(task.title)}</div>
            <div class="task-price">${task.price} ⭐</div>
        </div>
        
        <div class="task-meta">
            <div class="task-category">${categoryDisplay}</div>
            ${task.difficulty ? `<div class="task-difficulty ${task.difficulty.toLowerCase()}">${task.difficulty}</div>` : ''}
        </div>
        
        <div class="task-description">${escapeHtml(shortDescription)}</div>
        
        <!-- 🔥 ПРОГРЕСС-БАР ВЫПОЛНЕНИЯ ЗАДАНИЯ -->
        <div class="task-progress-container" style="margin: 10px 0;">
            <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">
                <span>Выполнено: ${completedCount}/${peopleRequired}</span>
                <span>${Math.round(progressPercentage)}%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${progressPercentage}%"></div>
            </div>
        </div>
        
        <div class="task-footer">
            <div class="task-time">${task.time_to_complete || '5-10 минут'}</div>
            <button class="task-btn" onclick="event.stopPropagation(); openTaskModal(${task.id})">
                Начать задание
            </button>
        </div>
    `;
}

        // 🔧 HTML ДЛЯ ЗАДАНИЙ НА ПОДТВЕРЖДЕНИИ
        function createConfirmationTaskHTML(task) {
            return `
                <div class="task-header">
                    <div style="flex: 1;">
                        <div class="task-title">${escapeHtml(task.title)}</div>
                        <div class="task-category">${task.category || 'Общее'}</div>
                    </div>
                    <div class="task-price">${task.price} ⭐</div>
                </div>
                <div class="task-description">${escapeHtml(task.description)}</div>
                <div class="task-footer">
                    <div class="task-time">Ожидает подтверждения</div>
                    <button class="task-btn" onclick="event.stopPropagation(); showTaskConfirmation(${task.id}, '${escapeHtml(task.title)}')">
                        Подтвердить выполнение
                    </button>
                </div>
            `;
        }

        // 🔧 HTML ДЛЯ ВЫПОЛНЕННЫХ ЗАДАНИЙ
        function createCompletedTaskHTML(task) {
            return `
                <div class="task-header">
                    <div style="flex: 1;">
                        <div class="task-title">${escapeHtml(task.title)}</div>
                        <div class="task-category">${task.category || 'Общее'}</div>
                    </div>
                    <div class="task-price">${task.price} ⭐</div>
                </div>
                <div class="task-description">${escapeHtml(task.description)}</div>
                <div class="task-footer">
                    <div class="task-time">Выполнено</div>
                    <div class="task-status completed">✅</div>
                </div>
            `;
        }

     // В index.html - обновим функцию создания карточки отклоненного задания
function createRejectedTaskHTML(task) {
    return `
        <div class="task-header">
            <div style="flex: 1;">
                <div class="task-title">${escapeHtml(task.title)}</div>
                <div class="task-category">${task.category || 'Общее'}</div>
            </div>
            <div class="task-price">${task.price} ⭐</div>
        </div>
        <div class="task-description">${escapeHtml(task.description)}</div>
        
        <!-- Блок с информацией об отклонении -->
        <div class="rejection-info" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 10px; margin: 10px 0;">
            <div style="color: var(--error); font-size: 12px; font-weight: 600; margin-bottom: 5px;">
                ❌ Задание отклонено администратором
            </div>
            <div style="color: var(--text-secondary); font-size: 11px;">
                Если вы считаете, что это ошибка, напишите в поддержку
            </div>
        </div>
        
        <div class="task-footer">
            <div class="task-time">Отклонено</div>
            <button class="support-btn" onclick="openAdminChat()" style="background: var(--accent); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">
                Написать в поддержку
            </button>
        </div>
    `;
}
// В index.html - добавим функцию для открытия чата с контекстом задания
function openSupportChatForTask(task) {
    // Сохраняем информацию о задании для поддержки
    const taskInfo = {
        id: task.id,
        title: task.title,
        price: task.price,
        category: task.category
    };
    
    // Можно сохранить в localStorage или глобальную переменную
    localStorage.setItem('supportTaskContext', JSON.stringify(taskInfo));
    
    // Открываем чат поддержки
    openAdminChat();
    
    // Автоматически добавляем информацию о задании в первое сообщение
    setTimeout(() => {
        const chatInput = document.getElementById('chat-input-field');
        if (chatInput) {
            chatInput.placeholder = `Вопрос по отклоненному заданию: "${task.title}"...`;
        }
    }, 500);
}

// Обновим функцию открытия чата для обработки контекста задания
async function openAdminChat() {
    if (!currentUser) {
        showNotification('Пользователь не авторизован', 'error');
        return;
    }
    
    try {
        console.log('👤 User opening support chat, ID:', currentUser.id);
        
        // Получаем или создаем чат для пользователя
        const chatResult = await makeRequest(`/support/user-chat/${currentUser.id}`);
        
        if (chatResult.success) {
            currentChatId = chatResult.chat.id;
            console.log('✅ Chat ID:', currentChatId);
            
            // Проверяем есть ли контекст задания
            const taskContext = localStorage.getItem('supportTaskContext');
            if (taskContext) {
                const taskInfo = JSON.parse(taskContext);
                
                // Добавляем автоматическое сообщение о задании
                const autoMessage = `Здравствуйте! У меня вопрос по отклоненному заданию: "${taskInfo.title}" (${taskInfo.price}⭐). `;
                const chatInput = document.getElementById('chat-input-field');
                if (chatInput) {
                    chatInput.value = autoMessage;
                }
                
                // Очищаем контекст после использования
                localStorage.removeItem('supportTaskContext');
            }
            
            // Загружаем сообщения
            try {
                const messagesResult = await makeRequest(`/support/chats/${currentChatId}/messages`);
                if (messagesResult.success) {
                    displayChatMessages(messagesResult.messages);
                }
            } catch (messagesError) {
                console.log('No messages yet or error loading messages:', messagesError);
                // Показываем пустой чат с приветствием
                displayChatMessages([]);
            }
            
            // Показываем чат
            document.getElementById('admin-chat').classList.add('active');
            
        } else {
            throw new Error(chatResult.error || 'Failed to create chat');
        }
    } catch (error) {
        console.error('❌ Error opening user chat:', error);
        showNotification('Ошибка открытия чата: ' + error.message, 'error');
    }
}

        // 🔧 ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ СТРАНИЦЫ
        document.addEventListener('DOMContentLoaded', function() {
            // Гарантируем, что изначально показаны новые задания
            setTimeout(() => {
                const newTasksContainer = document.getElementById('new-tasks');
                if (newTasksContainer) {
                    newTasksContainer.classList.add('active');
                    newTasksContainer.style.display = 'block';
                }
                
                // Загружаем новые задания
                loadTasksForCategory('new');
            }, 500);
        });

        // 🔧 ЭКСПОРТ ФУНКЦИЙ
        window.showTaskCategory = showTaskCategory;
        window.loadTasksForCategory = loadTasksForCategory;
        window.displayTasksForCategory = displayTasksForCategory;

// Функция для диагностики подтверждения заданий
function debugTaskConfirmation() {
   
    
    // Проверяем текущие данные
    console.log('- currentUser:', currentUser);
    console.log('- currentUserTaskId:', currentUserTaskId);
    
    // Проверяем модальные окна
    console.log('- confirmation-modal:', document.getElementById('confirmation-modal'));
    console.log('- screenshot-modal:', document.getElementById('screenshot-modal'));
    
    // Проверяем загружены ли задания пользователя
    loadUserTasksForCategory('active').then(() => {
        console.log('✅ Active tasks loaded for debugging');
    });
}

// Временно добавьте кнопку для тестирования
function addConfirmationDebugButton() {
    const debugBtn = document.createElement('button');
    debugBtn.textContent = '🐛 Debug Confirmation';
    debugBtn.style.position = 'fixed';
    debugBtn.style.top = '200px';
    debugBtn.style.right = '10px';
    debugBtn.style.zIndex = '10000';
    debugBtn.style.padding = '10px';
    debugBtn.style.background = 'orange';
    debugBtn.style.color = 'white';
    debugBtn.style.border = 'none';
    debugBtn.style.borderRadius = '5px';
    debugBtn.style.fontSize = '12px';
    debugBtn.onclick = debugTaskConfirmation;
    document.body.appendChild(debugBtn);
}

// Вызовите при загрузке
setTimeout(addConfirmationDebugButton, 3000);

// Добавьте кнопку для тестирования
function addConfirmationDebugButton() {
    const debugBtn = document.createElement('button');
    debugBtn.textContent = '🐛 Debug Confirmation';
    debugBtn.style.position = 'fixed';
    debugBtn.style.top = '200px';
    debugBtn.style.right = '10px';
    debugBtn.style.zIndex = '10000';
    debugBtn.style.padding = '10px';
    debugBtn.style.background = 'orange';
    debugBtn.style.color = 'white';
    debugBtn.style.border = 'none';
    debugBtn.style.borderRadius = '5px';
    debugBtn.style.fontSize = '12px';
    debugBtn.onclick = debugTaskConfirmation;
    document.body.appendChild(debugBtn);
}

// Вызовите при загрузке
setTimeout(addConfirmationDebugButton, 3000);

function checkAdminPanelLoaded() {
    const adminTasksSection = document.getElementById('admin-tasks-section');
    const addTaskButton = document.querySelector('#admin-tasks-section .admin-submit');
    
    console.log('🔍 Checking admin panel:');
    console.log('- Admin tasks section:', !!adminTasksSection);
    console.log('- Add task button:', !!addTaskButton);
    
    if (adminTasksSection && addTaskButton) {
        console.log('✅ Admin panel is properly loaded');
    } else {
        console.log('❌ Admin panel elements missing');
        // Перезагружаем админ-панель через 1 секунду
        setTimeout(() => {
            showAdminSection('tasks');
        }, 1000);
    }
}

// 🔧 РАСШИРЕННАЯ ДИАГНОСТИКА АДМИН-ПАНЕЛИ
function debugAdminPanelFull() {
    console.log('🔍 FULL ADMIN PANEL DEBUG:');
    
    // 1. Проверяем структуру DOM
    console.log('1. DOM STRUCTURE:');
    const adminTab = document.getElementById('admin-tab');
    console.log('- admin-tab:', adminTab);
    console.log('- admin-tab active:', adminTab?.classList.contains('active'));
    
    // 2. Проверяем все секции
    console.log('2. ADMIN SECTIONS:');
    const sections = ['posts', 'tasks', 'verification', 'support', 'payments', 'admins'];
    sections.forEach(section => {
        const sectionEl = document.getElementById(`admin-${section}-section`);
        console.log(`- admin-${section}-section:`, sectionEl);
        console.log(`  display: ${sectionEl?.style.display}`);
        console.log(`  classList: ${sectionEl?.classList}`);
    });
    
    // 3. Проверяем кнопки
    console.log('3. ADMIN BUTTONS:');
    const buttons = document.querySelectorAll('.admin-btn');
    buttons.forEach((btn, index) => {
        console.log(`- Button ${index}:`, btn.textContent);
        console.log(`  onclick:`, btn.getAttribute('onclick'));
    });
    
    // 4. Проверяем текущего пользователя
    console.log('4. CURRENT USER:');
    console.log('- currentUser:', currentUser);
    console.log('- isAdmin:', currentUser?.is_admin);
    console.log('- isMainAdmin:', parseInt(currentUser?.id) === ADMIN_ID);
}


// 🔧 АВАРИЙНОЕ ИСПРАВЛЕНИЕ АДМИН-ПАНЕЛИ
function emergencyFixAdminPanel() {
    console.log('🔧 Applying emergency fixes...');
    
    // 1. Гарантируем что админ-панель существует
    let adminTab = document.getElementById('admin-tab');
    if (!adminTab) {
        console.log('❌ Admin tab not found, creating...');
        adminTab = document.createElement('div');
        adminTab.id = 'admin-tab';
        adminTab.className = 'tab-content';
        document.querySelector('.main-content').appendChild(adminTab);
    }
    
    // 2. Гарантируем что секция заданий существует
    let tasksSection = document.getElementById('admin-tasks-section');
    if (!tasksSection) {
        console.log('❌ Tasks section not found, creating...');
        tasksSection = document.createElement('div');
        tasksSection.id = 'admin-tasks-section';
        tasksSection.className = 'admin-section';
        tasksSection.style.display = 'none';
        adminTab.appendChild(tasksSection);
        
        // Добавляем базовое содержимое
        tasksSection.innerHTML = `
            <div class="admin-form">
                <h3>➕ Добавить новое задание (EMERGENCY)</h3>
                <p>Секция была восстановлена аварийно</p>
                <button class="admin-submit" onclick="testAddTask()">✅ Тестовая кнопка</button>
            </div>
        `;
    }
    
    // 3. Принудительно показываем секцию
    tasksSection.style.display = 'block';
    tasksSection.style.opacity = '1';
    tasksSection.style.visibility = 'visible';
    
    console.log('✅ Emergency fixes applied');
}
// В секции админ-панели добавьте:
function addTestButtons() {
    const testDiv = document.createElement('div');
    testDiv.innerHTML = `
        <div style="margin: 20px 0; padding: 15px; background: var(--bg-secondary); border-radius: 10px;">
            <h4>🧪 Тестирование endpoints</h4>
            <button onclick="testAdminEndpoints()" class="btn btn-primary" style="margin: 5px;">
                Тест endpoints
            </button>
            <button onclick="testSimpleAdd()" class="btn btn-warning" style="margin: 5px;">
                Простой тест
            </button>
            <button onclick="checkServerHealth()" class="btn btn-success" style="margin: 5px;">
                Проверить сервер
            </button>
        </div>
    `;
    
    const adminSection = document.getElementById('admin-admins-section');
    if (adminSection) {
        adminSection.appendChild(testDiv);
    }
}

// Функции для тестирования
async function testAdminEndpoints() {
    console.log('🧪 Testing admin endpoints...');
    
    try {
        // Проверяем health
        const health = await makeRequest('/api/health');
        console.log('✅ Health:', health);
        
        // Проверяем debug endpoint
        const debug = await makeRequest('/api/admin/debug');
        console.log('✅ Debug:', debug);
        
        // Проверяем endpoints check
        const endpoints = await makeRequest('/api/admin/endpoints-check');
        console.log('✅ Endpoints:', endpoints);
        
        showNotification('Тестирование завершено - проверьте консоль', 'success');
        
    } catch (error) {
        console.error('❌ Test failed:', error);
        showNotification('Ошибка тестирования: ' + error.message, 'error');
    }
}

async function testSimpleAdd() {
    console.log('🧪 Testing simple add...');
    
    try {
        const result = await makeRequest('/api/admin/test-add', {
            method: 'POST',
            body: JSON.stringify({
                adminId: currentUser.id,
                username: 'testuser'
            })
        });
        
        console.log('✅ Simple test result:', result);
        showNotification('Простой тест пройден!', 'success');
        
    } catch (error) {
        console.error('❌ Simple test failed:', error);
        showNotification('Простой тест не пройден: ' + error.message, 'error');
    }
}

async function checkServerHealth() {
    console.log('🔍 Checking server health...');
    
    try {
        const response = await fetch(API_BASE_URL + '/api/health');
        console.log('📊 Server response:', {
            status: response.status,
            ok: response.ok,
            url: response.url
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('✅ Server health:', data);
            showNotification('Сервер работает нормально', 'success');
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
        
    } catch (error) {
        console.error('❌ Server health check failed:', error);
        showNotification('Проблема с сервером: ' + error.message, 'error');
    }
}

// Вызовите при инициализации
setTimeout(addTestButtons, 2000);


// 🔧 ФУНКЦИЯ ДЛЯ ПРИНУДИТЕЛЬНОГО ИСПРАВЛЕНИЯ LAYOUT
function fixTasksLayout() {
    const tasksTab = document.getElementById('tasks-tab');
    if (!tasksTab) return;
    
    // Принудительно устанавливаем высоту
    tasksTab.style.minHeight = '500px';
    
    // Обновляем все контейнеры заданий
    const containers = ['new-tasks', 'confirmation-tasks', 'completed-tasks', 'rejected-tasks'];
    containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            container.style.position = 'relative';
            container.style.minHeight = '300px';
            // Убираем все transition
            container.style.transition = 'none';
        }
    });
    
    console.log('✅ Tasks layout fixed');
}
function showTasksTab() {
    console.log('🎯 ПЕРЕХОД НА ВКЛАДКУ ЗАДАНИЙ');
    
    // 1. Скрываем все вкладки
    hideAllTabs();
    
    // 2. Показываем вкладку заданий
    const tasksTab = document.getElementById('tasks-tab');
    if (tasksTab) {
        tasksTab.classList.add('active');
        console.log('✅ Вкладка заданий активирована');
    }
    
    // 3. Обновляем навигацию
    updateNavState('tasks');
    
    // 4. Инициализируем вкладки заданий
    setTimeout(() => {
        initializeTaskTabs();
    }, 50);
}
function initializeTaskTabHandlers() {
    // Обработчики для кнопок категорий
    const taskTabs = document.querySelectorAll('.task-tab');
    taskTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const category = getCategoryFromTab(this.textContent);
            if (category) {
                showTaskCategory(category);
            }
        });
    });
}

function getCategoryFromTab(tabText) {
    const text = tabText.toLowerCase();
    if (text.includes('новые')) return 'new';
    if (text.includes('подтверждение')) return 'confirmation';
    if (text.includes('выполненные')) return 'completed';
    if (text.includes('отклоненные')) return 'rejected';
    return null;
}
function showTasksTab() {
    console.log('🎯 ПЕРЕХОД НА ВКЛАДКУ ЗАДАНИЙ - НАЧАЛО');
    
    // 1. Скрываем все вкладки
    hideAllTabs();
    
    // 2. Показываем вкладку заданий
    const tasksTab = document.getElementById('tasks-tab');
    if (tasksTab) {
        tasksTab.classList.add('active');
        console.log('✅ Вкладка заданий активирована');
    }
    
    // 3. Обновляем навигацию
    updateNavState('tasks');
    
    // 4. Сразу активируем вкладку "Новые"
    setTimeout(() => {
        console.log('🔄 Активируем вкладку "Новые"');
        
        // Сбрасываем все активные вкладки
        document.querySelectorAll('.task-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Скрываем все контейнеры
        const containers = ['new-tasks', 'confirmation-tasks', 'completed-tasks', 'rejected-tasks'];
        containers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                container.style.display = 'none';
                container.classList.remove('active');
            }
        });
        
        // Активируем вкладку "Новые"
        const newTab = document.querySelector('.task-tab:nth-child(1)');
        const newContainer = document.getElementById('new-tasks');
        
        if (newTab && newContainer) {
            newTab.classList.add('active');
            newContainer.style.display = 'block';
            newContainer.classList.add('active');
            console.log('✅ Вкладка "Новые" активирована');
            
            // НЕМЕДЛЕННО загружаем задания
            console.log('🚀 НЕМЕДЛЕННАЯ ЗАГРУЗКА ЗАДАНИЙ');
            loadTasks();
        }
        
        // Диагностика
        debugTasksLoading();
        
    }, 50); // Уменьшаем задержку
}
// 🔧 ИСПРАВЛЕННАЯ ФУНКЦИЯ ЗАГРУЗКИ ЗАДАНИЙ
async function loadTasks(search = '', category = 'all') {
    try {
        console.log('🎯 START loadTasks:', { 
            search, 
            category, 
            userId: currentUser?.id,
            hasUser: !!currentUser
        });

        // Проверяем авторизацию
        if (!currentUser) {
            console.log('❌ No current user, aborting loadTasks');
            showNotification('Пользователь не авторизован', 'error');
            return;
        }

        const newTasksContainer = document.getElementById('new-tasks');
        
        if (!newTasksContainer) {
            console.log('❌ new-tasks container not found');
            return;
        }

        // Показываем индикатор загрузки
        newTasksContainer.innerHTML = `
            <div class="no-tasks" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <div class="loading-spinner">⏳</div>
                <div style="margin-top: 16px;">Загружаем задания...</div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                    ID: ${currentUser.id}
                </div>
            </div>
        `;

        // Формируем URL с правильными параметрами
        const params = new URLSearchParams();
        params.append('userId', currentUser.id);
        if (search) params.append('search', search);
        if (category && category !== 'all') params.append('category', category);
        
        const url = `/api/tasks?${params.toString()}`;
        console.log('📡 Request URL:', url);

        // Выполняем запрос
        const response = await fetch(API_BASE_URL + url);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('📨 Server response:', result);

        if (result.success) {
            allTasks = result.tasks || [];
            console.log(`✅ Loaded ${allTasks.length} tasks:`, allTasks);
            
            // Отображаем задания
            displayTasks(allTasks, 'new');
            
        } else {
            throw new Error(result.error || 'Unknown server error');
        }

    } catch (error) {
        console.error('💥 loadTasks error:', error);
        
        const newTasksContainer = document.getElementById('new-tasks');
        if (newTasksContainer) {
            newTasksContainer.innerHTML = `
                <div class="no-tasks" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div style="font-size: 48px; margin-bottom: 16px;">❌</div>
                    <div>Ошибка загрузки заданий</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin: 8px 0;">
                        ${error.message}
                    </div>
                    <button class="btn btn-primary" onclick="loadTasks()" style="margin-top: 16px;">
                        Попробовать снова
                    </button>
                </div>
            `;
        }
        
        showNotification(`Ошибка загрузки заданий: ${error.message}`, 'error');
    }
}


// 🔧 ФУНКЦИЯ ДЛЯ АВТОМАТИЧЕСКОГО ОБНОВЛЕНИЯ ИНТЕРФЕЙСА
function updateTaskInterfaces() {
    if (document.getElementById('tasks-tab').classList.contains('active')) {
        const activeCategory = document.querySelector('.task-tab.active');
        if (activeCategory) {
            const category = getActiveCategoryName(activeCategory);
            if (category === 'new') {
                // Принудительно обновляем новые задания
                loadTasks();
            } else {
                loadTasksForCategory(category);
            }
        }
    }
}

// Запускаем обновление каждые 30 секунд
setInterval(updateTaskInterfaces, 30000);

// Также обновляем при возвращении на вкладку
function showTasksTab() {
    console.log('🎯 ПЕРЕХОД НА ВКЛАДКУ ЗАДАНИЙ');
    
    hideAllTabs();
    const tasksTab = document.getElementById('tasks-tab');
    if (tasksTab) {
        tasksTab.classList.add('active');
        console.log('✅ Вкладка заданий активирована');
    }
    
    updateNavState('tasks');
    
    // Применяем исправления для мобильных
    setTimeout(fixMobileLayout, 100);
    
    // Активируем вкладку "Новые" и ОБНОВЛЯЕМ данные
    setTimeout(() => {
        showTaskCategory('new');
        // Принудительное обновление данных
        loadTasks();
    }, 150);
}

function getActiveCategoryName(activeTab) {
    const text = activeTab.textContent.toLowerCase();
    if (text.includes('новые')) return 'new';
    if (text.includes('подтверждение')) return 'confirmation';
    if (text.includes('выполненные')) return 'completed';
    if (text.includes('отклоненные')) return 'rejected';
    return 'new';
}


function displayTasks(tasks, category) {
    console.log(`🎯 START displayTasks: ${tasks?.length} tasks for ${category}`);
    
    const container = document.getElementById(category + '-tasks');
    if (!container) {
        console.error('❌ Container not found:', category + '-tasks');
        return;
    }

    console.log('📦 Container found, clearing...');
    container.innerHTML = '';

    if (!tasks || tasks.length === 0) {
        console.log('📭 No tasks to display');
        container.innerHTML = `
            <div class="no-tasks" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 16px;">📝</div>
                <div style="font-size: 18px; margin-bottom: 8px;">Заданий пока нет</div>
                <div style="font-size: 14px; color: var(--text-secondary);">
                    Новые задания появятся позже<br>
                    <small>Следите за обновлениями</small>
                </div>
            </div>
        `;
        return;
    }

    console.log(`🎨 Rendering ${tasks.length} tasks...`);
    
    tasks.forEach((task, index) => {
        console.log(`📋 Task ${index}:`, task);
        
        const taskElement = createTaskCardWithImage(task, category, index);
        container.appendChild(taskElement);
    });
    
    console.log('✅ Tasks displayed successfully');
}
// 🔧 КНОПКА ЭКСТРЕННОГО ИСПРАВЛЕНИЯ ДЛЯ ТЕСТИРОВАНИЯ
function addMobileFixButton() {
    const fixBtn = document.createElement('button');
    fixBtn.textContent = '📱 FIX MOBILE';
    fixBtn.style.position = 'fixed';
    fixBtn.style.top = '120px';
    fixBtn.style.right = '10px';
    fixBtn.style.zIndex = '10000';
    fixBtn.style.padding = '10px';
    fixBtn.style.background = 'green';
    fixBtn.style.color = 'white';
    fixBtn.style.border = 'none';
    fixBtn.style.borderRadius = '5px';
    fixBtn.style.fontSize = '12px';
    
    fixBtn.onclick = function() {
        console.log('🚨 APPLYING MOBILE FIXES');
        emergencyMobileFix();
    };
    
    document.body.appendChild(fixBtn);
}

function emergencyMobileFix() {
    // Принудительно сбрасываем все возможные проблемы
    document.querySelectorAll('*').forEach(el => {
        el.style.maxWidth = '100%';
        el.style.boxSizing = 'border-box';
    });
    
    document.body.style.overflowX = 'hidden';
    document.documentElement.style.overflowX = 'hidden';
    
    console.log('✅ Emergency mobile fixes applied');
}

// Добавляем кнопку при загрузке
setTimeout(addMobileFixButton, 2000);
// 🔧 ФУНКЦИЯ ФОРМАТИРОВАНИЯ КАТЕГОРИИ
function formatCategory(category) {
    const categoryMap = {
        'social': '👥 Соцсети',
        'subscribe': '📱 Подписки', 
        'view': '👀 Просмотры',
        'comment': '💬 Комментарии',
        'repost': '🔄 Репосты',
        'general': '📋 Общее',
        'other': '🎯 Другое'
    };
    
    return categoryMap[category] || category;
}
async function initializeApp() {
    console.log('🎮 Initializing LinkGold app...');

    // Применяем исправления layout сразу
    fixLayoutIssues();

    // 🔥 ПРИНУДИТЕЛЬНАЯ ЗАГРУЗКА ЗАДАНИЙ ПРИ СТАРТЕ
    console.log('🚀 FORCE loading tasks on app start...');
    setTimeout(() => {
        if (currentUser) {
            console.log('👤 User authenticated, loading tasks...');
            loadTasksForCategory('new');
        } else {
            console.log('❌ No user for task loading');
        }
    }, 1000);

    // Остальной код инициализации...
    initializeTaskTabHandlers();

    
    // Проверяем соединение с API
    try {
        console.log('🔍 Testing API connection...');
        const health = await makeRequest('/api/health');
        console.log('✅ API connection successful:', health);

        
    } catch (error) {
        console.error('❌ API connection failed:', error);
        showNotification('❌ Не удалось подключиться', 'error');
        showRetryButton();
        return;
    }
    
    // Принудительно обновляем права администратора
    await refreshAdminRights();
    
    // Настраиваем админ-панель
    setupAdminPanel();
    
    // Инициализируем приложение
    displayUserProfile();
    checkAdminRights();
    loadMainPagePosts();
    
    // 🔥 ВАЖНО: ЗАГРУЖАЕМ ЗАДАНИЯ ПРИ ЗАПУСКЕ ПРИЛОЖЕНИЯ
    console.log('🚀 Pre-loading tasks on app start...');
    loadTasks();
    
    initializeSearch();
    loadUserTasks();
    
    // Запускаем автообновление данных
    startUserDataAutoUpdate();
    
    // Если пользователь админ, загружаем админ-данные
    if (currentUser && (currentUser.is_admin || parseInt(currentUser.id) === ADMIN_ID)) {
        loadAdminChats();
        loadAdminTasks();
        loadTaskVerifications();
        
        // Если это главный админ, загружаем список админов
        if (parseInt(currentUser.id) === ADMIN_ID) {
            setTimeout(() => {
                loadAdminsList();
            }, 500);
        }
    }
    
    // Повторно применяем исправления после загрузки контента
    setTimeout(fixLayoutIssues, 2000);
     // Сначала синхронизируем профиль с Telegram
    await syncUserProfile();

    // Затем инициализируем приложение
    displayUserProfile();
    checkAdminRights();
    loadMainPagePosts();
    checkPageVisibility()
    // Загружаем задания
    loadTasks();
     // Обновляем статистику профиля
    updateProfileStats();
    updateActiveTasksCount();
    
    // Запускаем автообновление данных
    startUserDataAutoUpdate();

    console.log('🎉 App initialized successfully');
        // Запускаем периодическое обновление
    setInterval(updateActiveTasksCount, 30000);
}

function checkPageVisibility() {
    const adminTab = document.getElementById('admin-tab');
    if (!adminTab.classList.contains('active')) {
        resetAdminPanel();
    }
}
async function loadUserTasksForCategory(status) {
    if (!currentUser) return;
    
    try {
        console.log(`🔄 Loading user tasks for category: ${status}`);
        
        let endpoint = '';
        switch(status) {
            case 'active':
                endpoint = `/api/user/${currentUser.id}/tasks/active`;
                break;
            case 'completed':
                endpoint = `/api/user/${currentUser.id}/tasks?status=completed`;
                break;
            case 'rejected':
                endpoint = `/api/user/${currentUser.id}/tasks?status=rejected`;
                break;
            default:
                return;
        }
        
        const result = await makeRequest(endpoint);
        
        if (result.success) {
            // Для заданий на подтверждение используем user_task_id
            const tasksWithCorrectId = result.tasks.map(task => ({
                ...task,
                id: task.id // это user_task_id для заданий на подтверждение
            }));
            
            displayUserTasksForCategory(tasksWithCorrectId, status);
        } else {
            console.error('❌ Error loading user tasks:', result.error);
        }
    } catch (error) {
        console.error(`❌ Error loading ${status} tasks:`, error);
    }
}
// 🔧 ФУНКЦИЯ ДЛЯ ПРИНУДИТЕЛЬНОГО ИСПРАВЛЕНИЯ LAYOUT
function fixLayoutIssues() {
    console.log('🔧 Applying layout fixes...');
    
    // Принудительно устанавливаем правильные размеры
    const elements = document.querySelectorAll('*');
    elements.forEach(el => {
        el.style.maxWidth = '100%';
        el.style.boxSizing = 'border-box';
    });
    
    // Особое внимание контейнерам заданий
    const tasksGrid = document.querySelector('.tasks-grid');
    if (tasksGrid) {
        tasksGrid.style.width = '100%';
        tasksGrid.style.margin = '0';
        tasksGrid.style.padding = '0';
        tasksGrid.style.overflow = 'hidden';
    }
    
    // Исправляем все карточки заданий
    const taskCards = document.querySelectorAll('.task-card');
    taskCards.forEach(card => {
        card.style.width = '100%';
        card.style.maxWidth = '100%';
        card.style.boxSizing = 'border-box';
        card.style.margin = '0 0 12px 0';
        card.style.overflow = 'hidden';
    });
    
    // Предотвращаем горизонтальную прокрутку
    document.body.style.overflowX = 'hidden';
    document.documentElement.style.overflowX = 'hidden';
    
    console.log('✅ Layout fixes applied');
}

// 🔧 ФУНКЦИЯ ДЛЯ ОБНОВЛЕНИЯ РАЗМЕРОВ ПРИ ИЗМЕНЕНИИ ЭКРАНА
function updateLayoutOnResize() {
    fixLayoutIssues();
}

// Вызываем при загрузке и изменении размера
document.addEventListener('DOMContentLoaded', fixLayoutIssues);
window.addEventListener('resize', updateLayoutOnResize);
window.addEventListener('orientationchange', updateLayoutOnResize);

// Также вызываем при переключении вкладок
function showTasksTab() {
    console.log('🎯 ПЕРЕХОД НА ВКЛАДКУ ЗАДАНИЙ');
    
    hideAllTabs();
    const tasksTab = document.getElementById('tasks-tab');
    if (tasksTab) {
        tasksTab.classList.add('active');
    }
    
    updateNavState('tasks');
    
    // Применяем исправления для мобильных
    setTimeout(fixLayoutIssues, 100);
    
    // Активируем вкладку "Новые"
    setTimeout(() => {
        showTaskCategory('new');
    }, 150);
}

function displayUserTasksForCategory(tasks, status) {
    let container = null;
    
    switch(status) {
        case 'active':
            container = document.getElementById('confirmation-tasks');
            break;
        case 'completed':
            container = document.getElementById('completed-tasks');
            break;
        case 'rejected':
            container = document.getElementById('rejected-tasks');
            break;
    }
    
    if (!container) {
        console.error(`❌ Container not found for status: ${status}`);
        return;
    }
    
    container.innerHTML = '';

    if (!tasks || tasks.length === 0) {
        let message = '';
        switch(status) {
            case 'active':
                message = 'Нет заданий на подтверждение';
                break;
            case 'completed':
                message = 'Нет выполненных заданий';
                break;
            case 'rejected':
                message = 'Нет отклоненных заданий';
                break;
        }
        
        container.innerHTML = `
            <div class="no-tasks" style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; margin-bottom: 16px;">📝</div>
                <div style="font-size: 18px; margin-bottom: 8px;">${message}</div>
                <div style="font-size: 14px; color: var(--text-secondary);">
                    ${status === 'active' ? 'Выполненные задания появятся здесь' : 'Следите за обновлениями'}
                </div>
            </div>
        `;
        return;
    }

    console.log(`🎯 Displaying ${tasks.length} tasks for ${status} category`);
    
    tasks.forEach((task, index) => {
        const taskElement = createTaskCardWithImage(task, status, index);
        container.appendChild(taskElement);
    });
}

        // Обновленная функция загрузки заданий пользователя
        async function loadUserTasks() {
            if (!currentUser) return;
            
            try {
                // Загружаем активные задания (на подтверждение)
                const activeResult = await makeRequest(`/user/${currentUser.id}/tasks?status=active`);
                if (activeResult.success) {
                    displayUserTasksForCategory(activeResult.tasks, 'active');
                }
                
                // Загружаем выполненные задания
                const completedResult = await makeRequest(`/user/${currentUser.id}/tasks?status=completed`);
                if (completedResult.success) {
                    displayUserTasksForCategory(completedResult.tasks, 'completed');
                }
                
                // Загружаем отклоненные задания
                const rejectedResult = await makeRequest(`/user/${currentUser.id}/tasks?status=rejected`);
                if (rejectedResult.success) {
                    displayUserTasksForCategory(rejectedResult.tasks, 'rejected');
                }
                
            } catch (error) {
                console.error('Error loading user tasks:', error);
            }
        }

   // В index.html - обновите функцию инициализации поиска
function initializeSearch() {
    const searchInput = document.getElementById('task-search');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const searchText = e.target.value.trim();
            
            searchTimeout = setTimeout(() => {
                if (searchText.length >= 2 || searchText.length === 0) {
                    // Передаем userId при поиске
                    loadTasks(searchText, getActiveFilter());
                }
            }, 300);
        });
    }
    
    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const filter = this.getAttribute('data-filter');
            // Передаем userId при фильтрации
            loadTasks('', filter);
            
            filterButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

// В index.html - добавьте вспомогательную функцию
function getActiveFilter() {
    const activeFilter = document.querySelector('.filter-btn.active');
    return activeFilter ? activeFilter.getAttribute('data-filter') : 'all';
}

function getTabIndex(category) {
    switch(category) {
        case 'new': return 1;
        case 'confirmation': return 2;
        case 'completed': return 3;
        case 'rejected': return 4;
        default: return 1;
    }
}




function openTaskModal(taskId) {
    console.log('📖 Opening task modal for task:', taskId);
    console.log('📋 All available tasks:', allTasks);
    
    selectedTaskId = taskId;
    
    const task = allTasks.find(t => t.id === taskId);
    if (task) {
        console.log('✅ Task found:', task);
        
        // Обновляем модальное окно
        document.getElementById('task-modal-title').textContent = task.title;
        document.getElementById('task-modal-category').textContent = task.category || 'Общее';
        document.getElementById('task-modal-price').textContent = `${task.price} ⭐`;
        document.getElementById('task-modal-description').textContent = task.description;
        
        // 🔧 ИСПРАВЛЕНИЕ: Правильное отображение изображения в модальном окне
        const modalImageContainer = document.getElementById('task-modal-image-container');
        if (modalImageContainer) {
            if (task.image_url) {
                modalImageContainer.innerHTML = `
                    <div class="task-image-placeholder">
                        <div style="text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 8px;">📋</div>
                            <div style="font-size: 12px;">Описание задания</div>
                        </div>
                    </div>
                `;
            } else {
                modalImageContainer.innerHTML = `
                    <div class="task-image-placeholder" style="aspect-ratio: 16/9;">
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 32px; margin-bottom: 8px;">📋</div>
                            <div>Описание задания</div>
                        </div>
                    </div>
                `;
            }
        }
        
        document.getElementById('task-modal-time').textContent = task.time_to_complete || '5 минут';
        document.getElementById('task-modal-difficulty').textContent = task.difficulty || 'Легкая';
        
        const peopleRequired = task.people_required || 1;
        const completedCount = task.completed_count || 0;
        const availableTasks = Math.max(0, peopleRequired - completedCount);
        document.getElementById('task-modal-available').textContent = `${availableTasks} заданий`;
        
        // 🔧 ДОБАВЛЕНО: Обработка ссылки на задание
        const taskUrl = task.task_url;
        const startButton = document.querySelector('.task-modal-start');
        
        if (taskUrl && taskUrl.startsWith('http')) {
            // Если есть валидная ссылка, меняем поведение кнопки
            startButton.textContent = '🔗 Перейти к заданию';
            startButton.onclick = function() {
                console.log('🔗 Opening task URL:', taskUrl);
                // Открываем ссылку в новом окне/вкладке
                window.open(taskUrl, '_blank');
                // Закрываем модальное окно
                closeModal('task-modal');
                // Также можно автоматически начать задание
                startTask();
            };
        } else {
            // Стандартное поведение - просто начать задание
            startButton.textContent = 'Начать задание';
            startButton.onclick = startTask;
        }
        
        document.getElementById('task-modal').classList.add('active');
        console.log('✅ Task modal opened successfully');
    } else {
        console.error('❌ Task not found in allTasks array');
        console.error('❌ Available task IDs:', allTasks.map(t => t.id));
        showNotification('Ошибка: задание не найдено. Попробуйте обновить список заданий.', 'error');
        
        // Автоматически перезагружаем задания
        setTimeout(() => {
            loadTasks();
        }, 2000);
    }
}
// Функция для исправления URL изображений в существующих заданиях
async function fixExistingTaskImages() {
    try {
        console.log('🔧 Fixing existing task images...');
        
        // Получаем все задания с изображениями
        const tasks = await pool.query(`
            SELECT id, image_url FROM tasks 
            WHERE image_url IS NOT NULL AND image_url != ''
        `);
        
        let fixedCount = 0;
        
        for (const task of tasks.rows) {
            if (task.image_url && !task.image_url.startsWith('http')) {
                // Исправляем URL
                const correctedUrl = `${APP_URL}${task.image_url}`;
                await pool.query(
                    'UPDATE tasks SET image_url = $1 WHERE id = $2',
                    [correctedUrl, task.id]
                );
                fixedCount++;
                console.log(`✅ Fixed image URL for task ${task.id}: ${correctedUrl}`);
            }
        }
        
        console.log(`✅ Fixed ${fixedCount} task images`);
    } catch (error) {
        console.error('❌ Error fixing task images:', error);
    }
}

// Вызовите эту функцию при запуске сервера
fixExistingTaskImages();

function showTaskConfirmation(userTaskId, taskName) {
    console.log('🔍 Confirming task:', { userTaskId, taskName });
    
    if (!userTaskId) {
        showNotification('Ошибка: ID задания не найден', 'error');
        return;
    }
    
    // Проверяем, что userTaskId - число
    const numericTaskId = parseInt(userTaskId);
    if (isNaN(numericTaskId)) {
        showNotification('Ошибка: неверный ID задания', 'error');
        return;
    }
    
    currentUserTaskId = numericTaskId;
    
    // Обновляем модальное окно
    const taskNameElement = document.getElementById('confirmation-task-name');
    const taskTextElement = document.getElementById('confirmation-task-text');
    
    if (taskNameElement) {
        taskNameElement.textContent = taskName;
    }
    
    if (taskTextElement) {
        taskTextElement.textContent = `Вы выполнили задание "${taskName}"?`;
    }
    
    // Показываем модальное окно
    const confirmationModal = document.getElementById('confirmation-modal');
    if (confirmationModal) {
        confirmationModal.classList.add('active');
        console.log('✅ Confirmation modal opened for task:', taskName);
    } else {
        console.error('❌ Confirmation modal not found');
        showNotification('Ошибка: модальное окно не найдено', 'error');
    }
}
        // Функции для системы проверки заданий
function showScreenshotUpload() {
    closeModal('confirmation-modal');
    closeModal('cancel-confirmation-modal');
    
    // Сброс формы
    document.getElementById('screenshot-file').value = '';
    document.getElementById('screenshot-preview').style.display = 'none';
    document.getElementById('file-name').textContent = '';
    
    // 🔥 ВАЖНО: Сбрасываем состояние кнопки
    const submitBtn = document.getElementById('submit-screenshot-btn');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Отправить на проверку';
    }
            
            // Настройка обработчика файла
            document.getElementById('screenshot-file').onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('file-name').textContent = file.name;
                    document.getElementById('submit-screenshot-btn').disabled = false;
                    
                    // Показать превью
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('screenshot-preview');
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            document.getElementById('screenshot-modal').classList.add('active');
        }

        function showCancelConfirmation() {
            closeModal('confirmation-modal');
            document.getElementById('cancel-confirmation-modal').classList.add('active');
        }

        async function submitScreenshot() {
    const fileInput = document.getElementById('screenshot-file');
    if (!fileInput.files[0]) {
        showNotification('Выберите файл скриншота', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('screenshot', fileInput.files[0]);
    formData.append('userId', currentUser.id);

    try {
        const response = await fetch(`${API_BASE_URL}/api/user/tasks/${currentUserTaskId}/submit`, {
            method: 'POST',
            body: formData
            // Не устанавливаем Content-Type, браузер сам установит с boundary
        });

        const result = await response.json();

        if (result.success) {
            showNotification('Скриншот отправлен на проверку!', 'success');
            closeModal('screenshot-modal');
            loadUserTasks();
        } else {
            showNotification('Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error submitting screenshot:', error);
        showNotification('Ошибка отправки скриншота', 'error');
    }
}

// Обновите функцию отмены задания
async function cancelTask() {
    if (!currentUserTaskId) return;

    try {
        const result = await makeRequest(`/user/tasks/${currentUserTaskId}/cancel`, {
            method: 'POST',
            body: JSON.stringify({
                userId: currentUser.id
            })
        });

        if (result.success) {
            showNotification('Задание отменено', 'success');
            closeModal('cancel-confirmation-modal');
            
            // НЕМЕДЛЕННО обновляем списки
            setTimeout(() => {
                loadTasks(); // Возвращаем задание в новые
                loadUserTasks(); // Убираем из активных
            }, 500);
            
        } else {
            showNotification('Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error cancelling task:', error);
        showNotification('Ошибка отмены задания', 'error');
    }
}
// 🔧 ОБНОВЛЕННАЯ ФУНКЦИЯ ЗАГРУЗКИ ПРОВЕРОК
async function loadTaskVerifications() {
    if (!currentUser) return;

    try {
        console.log('🔄 Loading task verifications...');
        const result = await makeRequest(`/api/admin/task-verifications?adminId=${currentUser.id}`);
        
        console.log('📨 Verifications response:', result);
        
        if (result.success) {
            console.log(`✅ Loaded ${result.verifications?.length || 0} verifications`);
            displayTaskVerifications(result.verifications);
        } else {
            console.error('❌ Failed to load verifications:', result.error);
        }
    } catch (error) {
        console.error('❌ Error loading task verifications:', error);
    }
}
function debugVerificationClick() {
    console.log('🔍 Debug verification click:');
    
    const verificationItems = document.querySelectorAll('.verification-item');
    console.log(`Found ${verificationItems.length} verification items`);
    
    verificationItems.forEach((item, index) => {
        console.log(`Item ${index}:`, {
            hasClickListener: !!item.onclick,
            textContent: item.textContent
        });
    });
}

// Вызовите через несколько секунд после загрузки
setTimeout(debugVerificationClick, 3000);

function displayTaskVerifications(verifications) {
    const container = document.getElementById('admin-verification-list');
    if (!container) return;

    container.innerHTML = '';

    if (!verifications || verifications.length === 0) {
        container.innerHTML = `
            <div class="no-tasks" style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; margin-bottom: 16px;">✅</div>
                <div>Нет заданий на проверке</div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">
                    Новые задания появятся здесь после отправки пользователями
                </div>
            </div>
        `;
        return;
    }

    verifications.forEach(verification => {
        const verificationElement = document.createElement('div');
        verificationElement.className = 'verification-item';
        verificationElement.style.cssText = `
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        `;
        verificationElement.onmouseover = function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        };
        verificationElement.onmouseout = function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        };

        // ОБРАБОТЧИК КЛИКА - ОТКРЫВАЕМ МОДАЛЬНОЕ ОКНО
        verificationElement.onclick = () => openVerificationModal(verification);

        const userAvatar = verification.user_name ? verification.user_name.charAt(0).toUpperCase() : 'U';
        const submissionTime = formatPostDate(verification.submitted_at);

        verificationElement.innerHTML = `
            <div class="verification-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="verification-avatar" style="width: 40px; height: 40px; border-radius: 50%; background: var(--purple-gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                        ${userAvatar}
                    </div>
                    <div class="verification-user-info">
                        <div class="verification-user-name" style="font-weight: 600; margin-bottom: 4px;">
                            ${verification.user_name}
                            ${verification.username ? `(@${verification.username})` : ''}
                        </div>
                        <div class="verification-task-title" style="color: var(--text-secondary); font-size: 14px;">
                            ${verification.task_title}
                        </div>
                    </div>
                </div>
                <div class="verification-price" style="font-size: 18px; font-weight: 700; color: var(--gold);">
                    ${verification.task_price} ⭐
                </div>
            </div>
            <div class="verification-time" style="color: var(--text-secondary); font-size: 12px;">
                Отправлено: ${submissionTime}
            </div>
            
            <!-- Индикатор нового задания -->
            <div style="margin-top: 10px; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border-left: 3px solid var(--accent);">
                <div style="font-size: 12px; color: var(--accent); font-weight: 600;">
                    📸 Нажмите для просмотра скриншота и проверки
                </div>
            </div>
        `;

        container.appendChild(verificationElement);
    });
}

// Показать секцию промокодов
function showPromocodesSection() {
    showAdminSection('promocodes');
    loadPromocodesList();
}

async function createPromoCode() {
    try {
        console.log('🎫 START: createPromoCode');
        
        if (!currentUser) {
            throw new Error('Пользователь не авторизован');
        }
        
        if (parseInt(currentUser.id) !== ADMIN_ID) {
            throw new Error('Только главный администратор может создавать промокоды!');
        }
        
        // ПРОВЕРКА СУЩЕСТВОВАНИЯ ЭЛЕМЕНТОВ
        const codeInput = document.getElementById('promocode-code');
        const maxUsesInput = document.getElementById('promocode-max-uses');
        const rewardInput = document.getElementById('promocode-reward');
        const expiresInput = document.getElementById('promocode-expires');
        const messageDiv = document.getElementById('promocode-form-message');
        const submitBtn = document.getElementById('create-promocode-btn');
        
        // ПРОВЕРЯЕМ ВСЕ ЭЛЕМЕНТЫ
        if (!codeInput || !maxUsesInput || !rewardInput || !messageDiv || !submitBtn) {
            console.error('❌ Missing form elements:', {
                codeInput: !!codeInput,
                maxUsesInput: !!maxUsesInput,
                rewardInput: !!rewardInput,
                messageDiv: !!messageDiv,
                submitBtn: !!submitBtn
            });
            throw new Error('Элементы формы не найдены. Обновите страницу.');
        }
        
        // ПОЛУЧАЕМ ЗНАЧЕНИЯ С ПРОВЕРКОЙ
        const code = codeInput?.value?.trim().toUpperCase() || '';
        const maxUses = maxUsesInput?.value ? parseInt(maxUsesInput.value) : 0;
        const reward = rewardInput?.value ? parseFloat(rewardInput.value) : 0;
        const expiresAt = expiresInput?.value ? new Date(expiresInput.value).toISOString() : null;
        
        console.log('📊 Form data:', { code, maxUses, reward, expiresAt });
        
        // Валидация
        if (!code) {
            throw new Error('Введите код промокода!');
        }
        
        if (!/^[A-Z0-9]+$/.test(code)) {
            throw new Error('Код должен содержать только латинские буквы и цифры!');
        }
        
        if (code.length < 3 || code.length > 20) {
            throw new Error('Длина кода должна быть от 3 до 20 символов!');
        }
        
        if (!maxUses || maxUses < 1 || maxUses > 10000) {
            throw new Error('Введите корректное количество активаций (1-10000)!');
        }
        
        if (!reward || reward < 1 || reward > 100000) {
            throw new Error('Введите корректную награду (1-100000 звезд)!');
        }
        
        // Показываем загрузку
        submitBtn.disabled = true;
        submitBtn.textContent = 'Создаем...';
        showMessage('⏳ Создаем промокод...', 'loading', messageDiv);
        
        console.log('📤 Sending request to server...');
        
        const result = await makeRequest('/api/admin/promocodes/create', {
            method: 'POST',
            body: JSON.stringify({
                adminId: currentUser.id,
                code: code,
                maxUses: maxUses,
                reward: reward,
                expiresAt: expiresAt
            })
        });
        
        console.log('📨 Server response:', result);
        
        if (result.success) {
            showMessage(`✅ ${result.message}`, 'success', messageDiv);
            
            // Очищаем форму
            codeInput.value = '';
            maxUsesInput.value = '10';
            rewardInput.value = '50';
            expiresInput.value = '';
            
            // Обновляем список промокодов
            loadPromocodesList();
            
        } else {
            throw new Error(result.error || 'Неизвестная ошибка сервера');
        }
        
    } catch (error) {
        console.error('❌ createPromoCode error:', error);
        const messageDiv = document.getElementById('promocode-form-message');
        showMessage(`❌ Ошибка: ${error.message}`, 'error', messageDiv);
        showNotification(`Ошибка создания промокода: ${error.message}`, 'error');
    } finally {
        // Восстанавливаем кнопку в любом случае
        const submitBtn = document.getElementById('create-promocode-btn');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = '🎫 Создать промокод';
        }
    }
}
function showMessage(text, type, container) {
    if (!container) return;
    
    const colors = {
        success: 'var(--success)',
        error: 'var(--error)',
        loading: 'var(--warning)',
        info: 'var(--text-primary)'
    };
    
    container.innerHTML = `<span style="color: ${colors[type] || colors.info};">${text}</span>`;
}
// Тестовый endpoint для проверки промокодов
// Тестовый endpoint для проверки промокодов
app.get('/api/admin/promocodes/test', async (req, res) => {
    try {
        // Проверяем соединение с базой данных
        await pool.query('SELECT 1');
        
        // Проверяем существование таблицы
        const tableCheck = await pool.query(`
            SELECT EXISTS (
                SELECT FROM information_schema.tables 
                WHERE table_name = 'promocodes'
            ) as table_exists
        `);
        
        // Проверяем количество промокодов
        const countResult = await pool.query('SELECT COUNT(*) FROM promocodes');
        
        res.json({
            success: true,
            message: 'Promocodes system test',
            database: 'Connected',
            table_exists: tableCheck.rows[0].table_exists,
            promocodes_count: parseInt(countResult.rows[0].count),
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        console.error('Promocodes test error:', error);
        res.status(500).json({
            success: false,
            error: error.message
        });
    }
});
// Загрузка списка промокодов
async function loadPromocodesList() {
    if (!currentUser || parseInt(currentUser.id) !== ADMIN_ID) return;
    
    try {
        const result = await makeRequest(`/api/admin/promocodes/list?adminId=${currentUser.id}`);
        
        if (result.success) {
            displayPromocodesList(result.promocodes);
        } else {
            console.error('Error loading promocodes:', result.error);
        }
    } catch (error) {
        console.error('Load promocodes error:', error);
    }
}

function displayPromocodesList(promocodes) {
    const container = document.getElementById('promocodes-list');
    if (!container) {
        console.error('❌ Promocodes list container not found');
        return;
    }
    
    container.innerHTML = '';
    

    console.log(`🎨 Displaying ${promocodes.length} promocodes`);
    
    promocodes.forEach(promo => {
        const promoElement = document.createElement('div');
        promoElement.className = 'admin-task-item';
        
        const usedCount = promo.used_count || 0;
        const isExpired = promo.expires_at && new Date(promo.expires_at) < new Date();
        const isFullyUsed = usedCount >= promo.max_uses;
        const status = isExpired ? 'expired' : (isFullyUsed ? 'used' : 'active');
        
        const statusColors = {
            active: 'var(--success)',
            used: 'var(--warning)',
            expired: 'var(--error)'
        };
        
        const statusTexts = {
            active: 'Активен',
            used: 'Использован',
            expired: 'Просрочен'
        };
        
        promoElement.innerHTML = `
            <div class="admin-task-header">
                <div class="admin-task-title">
                    <span style="font-size: 18px; font-weight: 800; color: var(--gold);">${promo.code}</span>
                    <span style="color: ${statusColors[status]}; font-size: 12px; margin-left: 10px;">
                        ${statusTexts[status]}
                    </span>
                </div>
                <div class="admin-task-actions">
                    <button class="admin-task-delete" onclick="deactivatePromoCode('${promo.code}')">
                        🗑️ Удалить
                    </button>
                </div>
            </div>
            <div class="admin-task-description">
                <div>🎁 Награда: <strong>${promo.reward} ⭐</strong></div>
                <div>👥 Использовано: <strong>${usedCount}/${promo.max_uses}</strong></div>
                <div>📅 Создан: ${new Date(promo.created_at).toLocaleDateString('ru-RU')}</div>
                ${promo.expires_at ? `
                    <div>⏰ Истекает: ${new Date(promo.expires_at).toLocaleDateString('ru-RU')}</div>
                ` : ''}
            </div>
        `;
        
            promocodes.forEach(promo => {
        const promoElement = createPromocodeElement(promo);
        container.appendChild(promoElement);
    });
    });
}

// Деактивация промокода
async function deactivatePromoCode(code) {
    if (!confirm(`Удалить промокод ${code}?`)) return;
    
    if (!currentUser || parseInt(currentUser.id) !== ADMIN_ID) {
        showNotification('Только главный администратор может удалять промокоды!', 'error');
        return;
    }
    
    try {
        const result = await makeRequest('/api/admin/promocodes/deactivate', {
            method: 'POST',
            body: JSON.stringify({
                adminId: currentUser.id,
                code: code
            })
        });
        
        if (result.success) {
            showNotification(result.message, 'success');
            loadPromocodesList();
        } else {
            showNotification('Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Deactivate promocode error:', error);
        showNotification('Ошибка удаления промокода', 'error');
    }
}

// 🔧 ИСПРАВЛЕННАЯ ФУНКЦИЯ АКТИВАЦИИ ПРОМОКОДА
async function activatePromoCode() {
    const input = document.getElementById('promocode-input');
    const messageDiv = document.getElementById('promocode-message');
    const code = input.value.trim().toUpperCase();
    
    if (!code) {
        messageDiv.innerHTML = '<span style="color: var(--error);">❌ Введите промокод!</span>';
        return;
    }
    
    if (!currentUser) {
        messageDiv.innerHTML = '<span style="color: var(--error);">❌ Пользователь не авторизован!</span>';
        return;
    }
    
    messageDiv.innerHTML = '<span style="color: var(--warning);">⏳ Активируем промокод...</span>';
    input.disabled = true;
    
    try {
        const result = await makeRequest('/api/promocodes/activate', {
            method: 'POST',
            body: JSON.stringify({
                userId: currentUser.id,
                code: code
            })
        });
        
        if (result.success) {
            messageDiv.innerHTML = `<span style="color: var(--success);">✅ ${result.message}</span>`;
            input.value = '';
            
            // Обновляем баланс пользователя
            await updateUserData();
            
            // 🔥 ИСПРАВЛЕНИЕ: используем reward из ответа сервера
            if (result.reward) {
                showPromocodeSuccessAnimation(result.reward);
            }
            
        } else {
            messageDiv.innerHTML = `<span style="color: var(--error);">❌ ${result.error}</span>`;
        }
        
    } catch (error) {
        console.error('❌ Activate promocode error:', error);
        messageDiv.innerHTML = `<span style="color: var(--error);">❌ Ошибка: ${error.message}</span>`;
    } finally {
        input.disabled = false;
    }
}

// Экспорт функций
window.showPromocodesSection = showPromocodesSection;
window.createPromoCode = createPromoCode;
window.activatePromoCode = activatePromoCode;
window.deactivatePromoCode = deactivatePromoCode;


// В функции openVerificationModal обновите HTML:
// В функции openVerificationModal обновите HTML:
function openVerificationModal(verification) {
    console.log('📖 Opening verification modal:', verification);
    
    if (!verification) {
        console.error('❌ No verification data provided');
        showNotification('Ошибка: данные проверки не получены', 'error');
        return;
    }
    
    currentVerificationId = verification.id;

    // Обновляем информацию о пользователе
    const userAvatar = document.getElementById('verification-user-avatar');
    const userName = document.getElementById('verification-user-name');
    const taskTitle = document.getElementById('verification-task-title');
    const taskPrice = document.getElementById('verification-task-price');
    const screenshot = document.getElementById('verification-screenshot');
    
    if (userAvatar) {
        userAvatar.textContent = verification.user_name ? 
            verification.user_name.charAt(0).toUpperCase() : 'U';
    }
    
    if (userName) {
        userName.textContent = verification.user_name || 'Пользователь';
    }
    
    if (taskTitle) {
        taskTitle.textContent = verification.task_title || 'Задание';
    }
    
    if (taskPrice) {
        taskPrice.textContent = `${verification.task_price || 0} ⭐`;
    }
    
    if (screenshot && verification.screenshot_url) {
        screenshot.src = verification.screenshot_url;
        screenshot.onerror = function() {
            console.error('❌ Failed to load screenshot');
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjMWExYTNhIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM4YjlkZGEiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K';
            showNotification('Не удалось загрузить скриншот', 'warning');
        };
        screenshot.style.display = 'block';
    } else {
        console.error('❌ No screenshot URL provided');
        if (screenshot) {
            screenshot.style.display = 'none';
        }
    }

    // Показываем модальное окно
    const modal = document.getElementById('verification-modal');
    if (modal) {
        modal.classList.add('active');
        console.log('✅ Verification modal opened');
    } else {
        console.error('❌ Verification modal not found');
        showNotification('Ошибка: модальное окно не найдено', 'error');
    }
}

// 🔒 ФУНКЦИЯ ДЛЯ БЛОКИРОВКИ КНОПКИ ОТПРАВКИ
function setupSingleSubmission() {
    const submitBtn = document.getElementById('submit-screenshot-btn');
    if (submitBtn) {
        let isSubmitting = false;
        
        // Сохраняем оригинальный обработчик
        const originalOnclick = submitBtn.onclick;
        
        submitBtn.onclick = function(event) {
            if (isSubmitting) {
                event.preventDefault();
                event.stopPropagation();
                showNotification('⏳ Задание уже отправляется...', 'warning');
                return false;
            }
            
            isSubmitting = true;
            submitBtn.disabled = true;
            submitBtn.textContent = '⏳ Отправляем...';
            
            // Вызываем оригинальную функцию
            if (originalOnclick) {
                const result = originalOnclick.call(this, event);
                
                // Восстанавливаем кнопку через 5 секунд на всякий случай
                setTimeout(() => {
                    isSubmitting = false;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Отправить на проверку';
                }, 5000);
                
                return result;
            }
        };
    }
}

// Инициализируем при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    setupSingleSubmission();
});

// Также обновите функцию submitScreenshot для восстановления кнопки
async function submitScreenshot() {
    const fileInput = document.getElementById('screenshot-file');
    const submitBtn = document.getElementById('submit-screenshot-btn');
    
    if (!fileInput.files[0]) {
        showNotification('Выберите файл скриншота', 'error');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('screenshot', fileInput.files[0]);
        formData.append('userId', currentUser.id);

        const response = await fetch(`${API_BASE_URL}/api/user/tasks/${currentUserTaskId}/submit`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            showNotification('Скриншот отправлен на проверку!', 'success');
            closeModal('screenshot-modal');
            loadUserTasks();
        } else {
            showNotification('Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error submitting screenshot:', error);
        showNotification('Ошибка отправки скриншота', 'error');
    } finally {
        // 🔥 ВАЖНО: Всегда восстанавливаем кнопку
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Отправить на проверку';
        }
    }
}
// 🗑️ ФУНКЦИЯ ДЛЯ УДАЛЕНИЯ ПРОВЕРКИ
async function deleteVerification() {
    if (!currentVerificationId) {
        showNotification('❌ ID проверки не найден', 'error');
        return;
    }

    if (!confirm('Вы уверены, что хотите удалить эту проверку?\n\nЗадание вернется пользователю для повторной отправки скриншота.')) {
        return;
    }

    try {
        console.log(`🗑️ Deleting verification:`, {
            verificationId: currentVerificationId,
            adminId: currentUser.id
        });

        const result = await makeRequest(`/api/admin/task-verifications/${currentVerificationId}/delete`, {
            method: 'POST',
            body: JSON.stringify({
                adminId: currentUser.id
            })
        });

        console.log('📨 Delete verification response:', result);

        if (result.success) {
            showNotification('✅ Проверка удалена! Задание возвращено пользователю.', 'success');
            
            // Закрываем модальное окно
            closeModal('verification-modal');
            
            // Обновляем списки
            setTimeout(() => {
                loadTaskVerifications();
                console.log('✅ Списки обновлены после удаления проверки');
            }, 500);
            
        } else {
            throw new Error(result.error || 'Неизвестная ошибка сервера');
        }

    } catch (error) {
        console.error('❌ Delete verification error:', error);
        
        let errorMessage = 'Ошибка при удалении проверки';
        if (error.message.includes('Failed to fetch')) {
            errorMessage = '❌ Проблема с соединением. Проверьте интернет.';
        } else if (error.message.includes('404')) {
            errorMessage = '❌ Проверка не найдена.';
        } else if (error.message.includes('403')) {
            errorMessage = '❌ Доступ запрещен.';
        }
        
        showNotification(errorMessage, 'error');
    }
}

// 🔧 ИСПРАВЛЕННАЯ ФУНКЦИЯ ОДОБРЕНИЯ ЗАДАНИЯ
async function approveVerification() {
    if (!currentVerificationId) {
        showNotification('❌ ID верификации не найден', 'error');
        return;
    }

    if (!currentUser) {
        showNotification('❌ Пользователь не авторизован', 'error');
        return;
    }

    try {
        console.log(`🔄 Начинаем одобрение верификации:`, {
            verificationId: currentVerificationId,
            adminId: currentUser.id
        });

        // Показываем индикатор загрузки
        const approveBtn = document.querySelector('.verification-approve');
        if (approveBtn) {
            approveBtn.disabled = true;
            approveBtn.textContent = 'Одобряем...';
        }

        // 🔧 ИСПРАВЛЕНИЕ: Правильный endpoint и обработка ошибок
        const result = await makeRequest(`/api/admin/task-verifications/${currentVerificationId}/approve`, {
            method: 'POST',
            body: JSON.stringify({
                adminId: currentUser.id
            })
        });

        console.log('📨 Ответ сервера при одобрении:', result);

        if (result.success) {
            let message = `✅ Задание одобрено! Пользователь получил ${result.amountAdded || result.task_price}⭐`;
            
            if (result.taskRemoved || result.taskCompleted) {
                message += "\n\n🎯 Задание автоматически удалено - достигнут лимит исполнителей!";
            }
            
            showNotification(message, 'success');
            
            // 🔥 ВАЖНОЕ ИСПРАВЛЕНИЕ: Закрываем модальное окно ДО обновления данных
            closeModal('verification-modal');
            
            // 🔥 ОБНОВЛЯЕМ ДАННЫЕ ПОСЛЕ ЗАКРЫТИЯ МОДАЛЬНОГО ОКНА
            setTimeout(() => {
                // Обновляем все списки
                loadTaskVerifications(); // Обновляем список проверки
                loadAdminTasks(); // Обновляем задания админа
                updateUserData(); // Обновляем данные пользователя
                
                console.log('✅ Интерфейс успешно обновлен после одобрения задания');
            }, 500);
            
        } else {
            throw new Error(result.error || 'Неизвестная ошибка сервера');
        }

    } catch (error) {
        console.error('❌ Сетевая ошибка при одобрении:', error);
        
        let errorMessage = 'Сетевая ошибка при одобрении задания';
        if (error.message.includes('Failed to fetch')) {
            errorMessage = '❌ Проблема с соединением. Проверьте интернет и попробуйте снова.';
        } else if (error.message.includes('404')) {
            errorMessage = '❌ не найден. Сообщите администратору.';
        } else if (error.message.includes('403')) {
            errorMessage = '❌ Доступ запрещен. У вас нет прав администратора.';
        } else if (error.message.includes('500')) {
            errorMessage = '❌ Ошибка сервера. Попробуйте позже.';
        }
        
        showNotification(errorMessage, 'error');
        
        // Восстанавливаем кнопку
        const approveBtn = document.querySelector('.verification-approve');
        if (approveBtn) {
            approveBtn.disabled = false;
            approveBtn.textContent = '✅ Одобрить';
        }
    }
}

// Функция для диагностики проблемы
async function debugApprovalIssue() {
    console.log('🔍 Диагностика проблемы одобрения:');
    
    if (!currentVerificationId) {
        console.log('❌ currentVerificationId не установлен');
        return;
    }
    
    if (!currentUser) {
        console.log('❌ currentUser не установлен');
        return;
    }
    
    console.log('📊 Данные для запроса:', {
        verificationId: currentVerificationId,
        adminId: currentUser.id,
        API_BASE_URL: API_BASE_URL
    });
    
    // Проверяем доступность endpoint'а
    try {
        const testResponse = await fetch(`${API_BASE_URL}/api/health`);
        console.log('✅ Сервер доступен:', testResponse.status);
    } catch (error) {
        console.error('❌ Сервер недоступен:', error);
    }
}

// Временно добавьте кнопку для диагностики
function addApprovalDebugButton() {
    const debugBtn = document.createElement('button');
    debugBtn.textContent = '🐛 Debug Approval';
    debugBtn.style.position = 'fixed';
    debugBtn.style.top = '300px';
    debugBtn.style.right = '10px';
    debugBtn.style.zIndex = '10000';
    debugBtn.style.padding = '10px';
    debugBtn.style.background = 'orange';
    debugBtn.style.color = 'white';
    debugBtn.style.border = 'none';
    debugBtn.style.borderRadius = '5px';
    debugBtn.style.fontSize = '12px';
    debugBtn.onclick = debugApprovalIssue;
    document.body.appendChild(debugBtn);
}

setTimeout(addApprovalDebugButton, 3000);

addDebugButton();
// В функции rejectVerification добавьте обновление списка заданий
// 🔧 ИСПРАВЛЕННАЯ ФУНКЦИЯ ОТКЛОНЕНИЯ ЗАДАНИЯ
async function rejectVerification() {
    if (!currentVerificationId) return;

    try {
        // 🔧 ИСПРАВЛЕНИЕ: Правильный endpoint с /api/
        const result = await makeRequest(`/api/admin/task-verifications/${currentVerificationId}/reject`, {
            method: 'POST',
            body: JSON.stringify({
                adminId: currentUser.id
            })
        });

        if (result.success) {
            showNotification('Задание отклонено', 'success');
            closeModal('verification-modal');
            loadTaskVerifications();
            
            // 🔥 ДОБАВЛЕНО: Автоматически обновляем список заданий
            setTimeout(() => {
                loadTasks(); // Обновляем новые задания
                loadUserTasks(); // Обновляем задания пользователя
            }, 500);
            
        } else {
            showNotification('Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error rejecting verification:', error);
        showNotification('Ошибка отклонения задания', 'error');
    }
}

        // 🔧 АДМИН-ФУНКЦИИ
        async function addNewPost() {
            const title = document.getElementById('admin-post-title').value;
            const content = document.getElementById('admin-post-content').value;
            
            if (!title || !content) {
                showNotification('Заполните заголовок и содержание поста!', 'error');
                return;
            }
            
            if (!currentUser.isAdmin || parseInt(currentUser.id) !== ADMIN_ID) {
                showNotification('Только администратор может публиковать посты!', 'error');
                return;
            }
            
            try {
                const result = await makeRequest('/posts', {
                    method: 'POST',
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        author: currentUser.firstName,
                        authorId: currentUser.id
                    })
                });

                if (result.success) {
                    showNotification('Пост успешно опубликован!', 'success');
                    document.getElementById('admin-post-title').value = '';
                    document.getElementById('admin-post-content').value = '';
                    loadMainPagePosts();
                } else {
                    showNotification('Ошибка: ' + result.error, 'error');
                }
                
            } catch (error) {
                console.error('Error adding post:', error);
                showNotification('Ошибка соединения: ' + error.message, 'error');
            }
        }

async function addTask() {
    console.log('🎯 Starting add task function...');
    
    try {
        // Получаем значения из формы
        const taskData = {
            title: document.getElementById('admin-task-title').value.trim(),
            description: document.getElementById('admin-task-description').value.trim(),
            price: document.getElementById('admin-task-price').value,
            category: document.getElementById('admin-task-category').value,
            time_to_complete: document.getElementById('admin-task-time').value || '5-10 минут',
            difficulty: document.getElementById('admin-task-difficulty').value,
            people_required: document.getElementById('admin-task-people').value || 1,
            task_url: document.getElementById('admin-task-url').value || '',
            created_by: currentUser.id
        };

        console.log('📋 Form data collected:', taskData);

        // Валидация
        if (!taskData.title.trim()) {
            showNotification('Введите название задания!', 'error');
            return;
        }
        if (!taskData.description.trim()) {
            showNotification('Введите описание задания!', 'error');
            return;
        }
        if (!taskData.price) {
            showNotification('Введите цену задания!', 'error');
            return;
        }

        const price = parseFloat(taskData.price);
        if (isNaN(price) || price <= 0) {
            showNotification('Цена должна быть положительным числом!', 'error');
            return;
        }

        // Подготавливаем данные для отправки
        const requestData = {
            title: taskData.title.trim(),
            description: taskData.description.trim(),
            price: price,
            category: taskData.category || 'general',
            time_to_complete: taskData.time_to_complete || '5-10 минут',
            difficulty: taskData.difficulty || 'Легкая',
            people_required: parseInt(taskData.people_required) || 1,
            task_url: taskData.task_url || '',
            created_by: currentUser.id
        };

        console.log('📤 Sending request to server:', requestData);

        const result = await makeRequest('/api/tasks', {
            method: 'POST',
            body: JSON.stringify(requestData)
        });

        console.log('📨 Server response:', result);

        if (result.success) {
            showNotification('✅ Задание успешно создано!', 'success');
            
            // Очищаем форму
            clearTaskForm();
            
            // Обновляем списки заданий
            setTimeout(() => {
                loadAdminTasks();
                loadTasks();
            }, 1000);
            
        } else {
            throw new Error(result.error || 'Unknown server error');
        }

    } catch (error) {
        console.error('💥 Error in addTask:', error);
        showNotification(`❌ Ошибка создания задания: ${error.message}`, 'error');
    }
}
// Добавьте эту функцию для отладки
function debugTaskCreation() {
    
    console.log('- currentUser:', currentUser);
    console.log('- isAdmin:', currentUser?.is_admin);
    console.log('- API_BASE_URL:', API_BASE_URL);
    
    // Проверьте значения формы
    const formData = {
        title: document.getElementById('admin-task-title').value,
        description: document.getElementById('admin-task-description').value,
        price: document.getElementById('admin-task-price').value,
        created_by: currentUser?.id
    };
    console.log('- Form data:', formData);
}

// Вызовите при создании задания
debugTaskCreation();

// Временно добавьте эту кнопку в админ-панель - УДАЛИТЬ ИЗ SERVER.JS
function addTestButton() {
    const testBtn = document.createElement('button');
    testBtn.textContent = '🧪 Test Task Creation';
    testBtn.className = 'btn btn-warning';
    testBtn.style.margin = '10px';
    testBtn.onclick = testTaskCreation;
    
    const tasksSection = document.getElementById('admin-tasks-section');
    if (tasksSection) {
        tasksSection.appendChild(testBtn);
    }
}

async function testTaskCreation() {
    console.log('🧪 Testing task creation...');
    
    // Заполняем форму тестовыми данными
    document.getElementById('admin-task-title').value = 'Тестовое задание';
    document.getElementById('admin-task-description').value = 'Это тестовое описание задания';
    document.getElementById('admin-task-price').value = '50';
    document.getElementById('admin-task-category').value = 'subscribe';
    document.getElementById('admin-task-time').value = '10 минут';
    document.getElementById('admin-task-difficulty').value = 'Легкая';
    document.getElementById('admin-task-people').value = '5';
    document.getElementById('admin-task-url').value = 'https://example.com';
    
    console.log('✅ Form filled with test data');
    debugTaskCreation();
    
    // Пробуем создать задание
    await addTask();
}



// Вызовите для тестирования
setTimeout(debugAdminForm, 2000);
// 🔧 ФУНКЦИЯ ДЛЯ ЗАГРУЗКИ ЗАДАНИЙ ПРИ ОТКРЫТИИ СЕКЦИИ
function loadAdminTasksSection() {
    console.log('🔄 Loading admin tasks section...');
    
    // Показываем секцию
    const section = document.getElementById('admin-tasks-section');
    if (section) {
        section.style.display = 'block';
        console.log('✅ Admin tasks section shown');
    }
    
    // Загружаем задания
    loadAdminTasks();
}

async function restoreDeletedTasks() {
    if (!confirm('Восстановить удаленные задания администратора?')) return;
    
    try {
        const result = await makeRequest('/api/admin/restore-tasks', {
            method: 'POST',
            body: JSON.stringify({
                adminId: currentUser.id
            })
        });
        
        if (result.success) {
            showNotification(`Восстановлено ${result.restoredCount} заданий`, 'success');
            loadAdminTasks();
        } else {
            showNotification('Ошибка восстановления: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Restore tasks error:', error);
        showNotification('Ошибка восстановления заданий', 'error');
    }
}

// Функция для создания тестового задания
async function createTestTask() {
    if (!currentUser) return;
    
    try {
        const testTask = {
            title: 'Тестовое задание ' + new Date().toLocaleTimeString(),
            description: 'Это тестовое задание создано для проверки работы системы',
            price: 50,
            category: 'general',
            created_by: currentUser.id
        };
        
        const result = await makeRequest('/api/tasks', {
            method: 'POST',
            body: JSON.stringify(testTask)
        });
        
        if (result.success) {
            showNotification('✅ Тестовое задание создано!', 'success');
            // Перезагружаем список
            loadAdminTasks();
        } else {
            showNotification('❌ Ошибка создания: ' + result.error, 'error');
        }
    } catch (error) {
        showNotification('Ошибка: ' + error.message, 'error');
    }
}
// Fallback контент
function createFallbackAdminTasks() {
    return `
        <div class="admin-stats" style="margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border);">
            <h4 style="margin-bottom: 10px;">📊 Аварийный режим</h4>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">
                Не удалось загрузить задания. Возможные причины:
            </p>
            <ul style="color: var(--text-secondary); font-size: 14px; text-align: left; padding-left: 20px;">
                <li>Проблемы с подключением к серверу</li>
                <li>Отсутствуют права администратора</li>
                <li>Нет созданных заданий</li>
            </ul>
        </div>
        
        <div class="admin-form">
            <h3>➕ Создать новое задание</h3>
            <input type="text" class="admin-input" id="emergency-task-title" placeholder="Название задания">
            <textarea class="admin-textarea" id="emergency-task-description" placeholder="Описание задания" rows="3"></textarea>
            <input type="number" class="admin-input" id="emergency-task-price" placeholder="Цена в звездах">
            <button class="admin-submit" onclick="createEmergencyTask()">
                🚀 Создать задание
            </button>
        </div>
    `;
}

async function createEmergencyTask() {
    const title = document.getElementById('emergency-task-title').value;
    const description = document.getElementById('emergency-task-description').value;
    const price = document.getElementById('emergency-task-price').value;
    
    if (!title || !description || !price) {
        showNotification('Заполните все поля!', 'error');
        return;
    }
    
    await createTestTask(); // Переиспользуем функцию
}


// Определяем медленные устройства
function isSlowDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
         && /3G|2G|slow|reduce/i.test(navigator.connection.effectiveType);
}

if (isSlowDevice()) {
  // Активируем упрощенный режим
  document.documentElement.classList.add('simplified-mode');
  
  // Отключаем тяжелые функции
  window.addEventListener('load', function() {
    const heavyElements = document.querySelectorAll('.hero-banner, .complex-animation');
    heavyElements.forEach(el => el.remove());
  });
}

// 🔧 ФУНКЦИЯ ОТОБРАЖЕНИЯ АДМИН-ЗАДАНИЙ


// В index.html добавьте функцию диагностики
async function debugAdminTasks() {
    console.log('🐛 DEBUG Admin Tasks System:');
    
    if (!currentUser) {
        console.log('❌ No current user');
        showNotification('Пользователь не авторизован', 'error');
        return;
    }
    
    try {
        // Проверяем endpoint диагностики
        const debugResult = await makeRequest(`/api/debug/admin-tasks?adminId=${currentUser.id}`);
        console.log('📊 Debug admin tasks result:', debugResult);
        
        // Показываем результаты в уведомлении
        if (debugResult.success) {
            let message = `📊 Диагностика заданий:\n`;
            message += `• Всего заданий: ${debugResult.all_tasks_count}\n`;
            message += `• Мои задания: ${debugResult.admin_tasks.length}\n`;
            
            debugResult.status_stats.forEach(stat => {
                message += `• ${stat.status}: ${stat.count}\n`;
            });
            
            showNotification(message, 'info');
        }
        
    } catch (error) {
        console.error('Debug admin tasks error:', error);
        showNotification('Ошибка диагностики: ' + error.message, 'error');
    }
}
// Обновите функцию renderAdminTasks
function renderAdminTasks(tasks) {
    const container = document.getElementById('admin-tasks-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    const filter = document.getElementById('admin-task-filter')?.value || 'all';
    
    const filteredTasks = tasks.filter(task => {
        switch (filter) {
            case 'active':
                return task.status === 'active';
            case 'completed':
                return task.status === 'completed';
            case 'my':
                return task.created_by === currentUser.id;
            default:
                return true; // 'all'
        }
    });
    
    console.log(`🎯 Rendering ${filteredTasks.length} filtered tasks (filter: ${filter})`);
    
    if (filteredTasks.length === 0) {
        container.innerHTML = `
            <div class="no-tasks" style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; margin-bottom: 16px;">🔍</div>
                <div>Заданий не найдено</div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">
                    Попробуйте изменить фильтр
                </div>
                <button class="btn btn-primary" onclick="loadAdminTasks()" style="margin-top: 16px;">
                    🔄 Обновить список
                </button>
            </div>
        `;
        return;
    }
    
    filteredTasks.forEach(task => {
        const taskElement = createAdminTaskElement(task);
        container.appendChild(taskElement);
    });
}

function createAdminTaskElement(task) {
    const taskElement = document.createElement('div');
    taskElement.className = 'admin-task-item';
    taskElement.style.cssText = `
        background: var(--card-bg);
        border: 1px solid ${task.status === 'completed' ? 'var(--success)' : 'var(--border)'};
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        opacity: ${task.status === 'completed' ? 0.8 : 1};
    `;
    
    const completedCount = task.completed_count || 0;
    const peopleRequired = task.people_required || 1;
    const progressPercentage = Math.min(100, (completedCount / peopleRequired) * 100);
    const isCompleted = task.status === 'completed';
    
    taskElement.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">
                    ${task.title}
                    ${isCompleted ? ' <span style="color: var(--success); font-size: 12px;">(Завершено)</span>' : ''}
                </div>
                <div style="color: var(--text-secondary); font-size: 14px;">${task.description}</div>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
                
                
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
            <span>📁 ${task.category || 'general'}</span>
            <span>👥 ${peopleRequired} чел.</span>
            <span>⚡ ${task.difficulty || 'Легкая'}</span>
            <span>🕒 ${task.time_to_complete || '5-10 минут'}</span>
            <span style="color: ${isCompleted ? 'var(--success)' : 'var(--accent)'};">
                ${isCompleted ? '✅ Завершено' : '🟢 Активно'}
            </span>
        </div>
        
        <!-- Прогресс выполнения -->
        <div style="margin: 10px 0;">
            <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">
                <span>Выполнено: ${completedCount}/${peopleRequired}</span>
                <span>${Math.round(progressPercentage)}%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${progressPercentage}%; background: ${isCompleted ? 'var(--success)' : 'var(--accent)'};"></div>
            </div>
        </div>
        
        <!-- Статистика по заданиям -->
        <div style="display: flex; gap: 15px; font-size: 11px; color: var(--text-secondary);">
            <span>✅ ${completedCount} выполнено</span>
            <span>❌ ${task.rejected_count || 0} отклонено</span>
            <span>⏳ ${task.pending_count || 0} на проверке</span>
            <span>🟡 ${task.active_count || 0} в процессе</span>
        </div>
        ${!isCompleted ? `
                    <button class="admin-task-delete" onclick="deleteTask(${task.id})" style="background: var(--error); color: white; border: none; padding: 6px 12px;  margin-top: 20px; border-radius: 6px; cursor: pointer;">
                        🗑️ Удалить
                    </button>
                ` : ''}
        <div style="font-size: 20px; color: var(--gold); font-weight: 600;">
                    ${task.price} ⭐
                </div>
        ${task.image_url ? `
            <div style="margin-top: 10px;">
                <img src="${task.image_url}" alt="Изображение задания" style="max-width: 200px; border-radius: 8px; border: 1px solid var(--border);">
            </div>
        ` : ''}
        
        <div style="margin-top: 8px; font-size: 11px; color: var(--text-secondary);">
            Создано: ${new Date(task.created_at).toLocaleDateString('ru-RU')}
            ${task.last_completed ? ` • Последнее выполнение: ${new Date(task.last_completed).toLocaleDateString('ru-RU')}` : ''}
        </div>
    `;
    
    return taskElement;
}

function filterAdminTasks() {
    const container = document.getElementById('admin-tasks-container');
    if (!container) return;
    
    const currentTasks = window.currentAdminTasks || [];
    if (currentTasks.length > 0) {
        renderAdminTasks(currentTasks);
    }
}

// Автоматическое обновление каждые 30 секунд
setInterval(() => {
    if (document.getElementById('admin-verification-section').style.display === 'block') {
        console.log('🔄 Auto-refreshing verification list');
        loadTaskVerifications();
    }
}, 30000);

// Принудительное обновление при открытии секции
function showAdminVerificationSection() {
    showAdminSection('verification');
    // Загружаем с небольшой задержкой чтобы интерфейс успел отобразиться
    setTimeout(() => {
        loadTaskVerifications();
    }, 100);
}

// 🔧 ПРИНУДИТЕЛЬНАЯ ИНИЦИАЛИЗАЦИЯ АДМИН-ПАНЕЛИ
function initializeAdminPanel() {
    console.log('🎯 Initializing admin panel...');
    
    // Создаем необходимые элементы если их нет
    const adminTab = document.getElementById('admin-tab');
    if (!adminTab) {
        console.error('❌ Admin tab not found!');
        return;
    }
    
    // Гарантируем что все секции созданы
    const sections = ['posts', 'tasks', 'verification', 'support', 'payments', 'admins'];
    sections.forEach(section => {
        const sectionId = `admin-${section}-section`;
        let sectionElement = document.getElementById(sectionId);
        
        if (!sectionElement) {
            console.log(`⚠️ Creating missing section: ${sectionId}`);
            sectionElement = document.createElement('div');
            sectionElement.id = sectionId;
            sectionElement.className = 'admin-section';
            sectionElement.style.display = 'none';
            sectionElement.innerHTML = `<div>Section ${section} will be loaded here</div>`;
            adminTab.appendChild(sectionElement);
        }
    });
    
    console.log('✅ Admin panel initialized');
}

// Вызовите при загрузке
setTimeout(initializeAdminPanel, 500);

        async function deletePost(postId) {
            if (!confirm('Удалить этот пост?')) return;
            
            if (!currentUser.isAdmin || parseInt(currentUser.id) !== ADMIN_ID) {
                showNotification('Только администратор может удалять посты!', 'error');
                return;
            }
            
            try {
                const result = await makeRequest(`/posts/${postId}`, {
                    method: 'DELETE',
                    body: JSON.stringify({ authorId: currentUser.id })
                });

                if (result.success) {
                    showNotification('Пост успешно удален!', 'success');
                    loadMainPagePosts();
                } else {
                    showNotification('Ошибка: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error deleting post:', error);
                showNotification('Ошибка соединения: ' + error.message, 'error');
            }
        }

        async function deleteTask(taskId) {
    if (!confirm('Удалить это задание?')) return;
    
    if (!currentUser || !currentUser.isAdmin || parseInt(currentUser.id) !== ADMIN_ID) {
        showNotification('Только администратор может удалять задания!', 'error');
        return;
    }
    
    try {
        const result = await makeRequest(`/tasks/${taskId}`, {
            method: 'DELETE',
            body: JSON.stringify({ adminId: currentUser.id })
        });

        if (result.success) {
            showNotification('Задание успешно удалено!', 'success');
            loadAdminTasks();
            loadTasks();
        } else {
            showNotification('Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error deleting task:', error);
        showNotification('Ошибка удаления задания: ' + error.message, 'error');
    }
}
     async function openAdminChat() {
    if (!currentUser) {
        showNotification('Пользователь не авторизован', 'error');
        return;
    }
    
    try {
        console.log('👤 User opening support chat, ID:', currentUser.id);
        
        // Получаем или создаем чат для пользователя
        const chatResult = await makeRequest(`/support/user-chat/${currentUser.id}`);
        
        if (chatResult.success) {
            currentChatId = chatResult.chat.id;
            console.log('✅ Chat ID:', currentChatId);
            
            // Загружаем сообщения
            try {
                const messagesResult = await makeRequest(`/support/chats/${currentChatId}/messages`);
                if (messagesResult.success) {
                    displayChatMessages(messagesResult.messages);
                }
            } catch (messagesError) {
                console.log('No messages yet or error loading messages:', messagesError);
                // Показываем пустой чат с приветствием
                displayChatMessages([]);
            }
            
            // Показываем чат
            document.getElementById('admin-chat').classList.add('active');
            
        } else {
            throw new Error(chatResult.error || 'Failed to create chat');
        }
    } catch (error) {
        console.error('❌ Error opening user chat:', error);
        showNotification('Ошибка открытия чата: ' + error.message, 'error');
    }
}
        
// 🔧 ФУНКЦИЯ ДЛЯ ОЧИСТКИ СТАРЫХ ФАЙЛОВ
async function cleanupOldFiles() {
    try {
        const uploadsDir = path.join(__dirname, 'uploads');
        
        if (!fs.existsSync(uploadsDir)) {
            return;
        }
        
        const files = fs.readdirSync(uploadsDir);
        const now = Date.now();
        const maxAge = 24 * 60 * 60 * 1000; // 24 часа
        
        for (const file of files) {
            const filePath = path.join(uploadsDir, file);
            const stats = fs.statSync(filePath);
            
            // Удаляем файлы старше 24 часов
            if (now - stats.mtime.getTime() > maxAge) {
                fs.unlinkSync(filePath);
                console.log(`🧹 Deleted old file: ${file}`);
            }
        }
    } catch (error) {
        console.error('Error cleaning up old files:', error);
    }
}

// Запускаем очистку каждые 24 часа
setInterval(cleanupOldFiles, 24 * 60 * 60 * 1000);

// Запускаем при старте сервера
cleanupOldFiles();
// Обновите функцию отправки сообщения в чат
async function sendMessageToAdmin() {
    if (!currentUser || !currentChatId) {
        showNotification('Чат не открыт', 'error');
        return;
    }
    
    const input = document.getElementById('chat-input-field');
    const message = input.value.trim();
    
    if (!message) {
        showNotification('Введите сообщение', 'error');
        return;
    }
    
    try {
        console.log(`✉️ User sending message to chat ${currentChatId}:`, message);
        
        const userFullName = currentUser.lastName ? 
            `${currentUser.firstName} ${currentUser.lastName}` : 
            currentUser.firstName;
        
        const result = await makeRequest(`/support/chats/${currentChatId}/messages`, {
            method: 'POST',
            body: JSON.stringify({
                user_id: currentUser.id,
                user_name: userFullName,
                user_username: currentUser.username,
                message: message,
                is_admin: false
            })
        });
        
        if (result.success) {
            // Добавляем сообщение в интерфейс
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message message-user';
            messageElement.innerHTML = `
                <div class="message-text">${escapeHtml(message)}</div>
                <div class="message-time">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</div>
            `;
            messagesContainer.appendChild(messageElement);
            
            input.value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            showNotification('Сообщение отправлено! Администратор ответит в ближайшее время.', 'success');
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('❌ Error sending message:', error);
        showNotification('Ошибка отправки: ' + error.message, 'error');
    }
}

// Обновите функцию отправки сообщения админом
async function sendAdminMessage() {
    if (!currentAdminChat || !currentUser) {
        console.error('No active chat or user');
        showNotification('Чат не выбран', 'error');
        return;
    }
    
    const input = document.getElementById('admin-chat-input');
    if (!input) {
        console.error('Admin chat input not found');
        return;
    }
    
    const message = input.value.trim();
    
    if (!message) {
        showNotification('Введите сообщение', 'error');
        return;
    }
    
    try {
        console.log(`✉️ Admin sending message to chat ${currentAdminChat.id}:`, message);
        
        const result = await makeRequest(`/support/chats/${currentAdminChat.id}/messages`, {
            method: 'POST',
            body: JSON.stringify({
                user_id: currentUser.id,
                user_name: 'Администратор',
                user_username: currentUser.username,
                message: message,
                is_admin: true
            })
        });
        
        if (result.success) {
            // Добавляем сообщение в интерфейс
            const messagesContainer = document.getElementById('admin-chat-messages');
            if (messagesContainer) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message message-admin';
                messageElement.innerHTML = `
                    <div class="message-text">${escapeHtml(message)}</div>
                    <div class="message-time">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</div>
                `;
                messagesContainer.appendChild(messageElement);
                
                input.value = '';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Обновляем список чатов
                loadAdminChats();
                
                console.log('✅ Admin message sent successfully');
                showNotification('Сообщение отправлено', 'success');
            }
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('❌ Error sending admin message:', error);
        showNotification('Ошибка отправки сообщения: ' + error.message, 'error');
    }
}

// 🔧 ФУНКЦИЯ ДЛЯ ПРИНУДИТЕЛЬНОГО ИСПРАВЛЕНИЯ РАЗМЕТКИ НА МОБИЛЬНЫХ
function fixMobileLayout() {
    console.log('🔧 Applying mobile layout fixes...');
    
    // Принудительно устанавливаем правильные размеры
    const tasksGrid = document.querySelector('.tasks-grid');
    if (tasksGrid) {
        tasksGrid.style.width = '100%';
        tasksGrid.style.margin = '0';
        tasksGrid.style.padding = '0';
        tasksGrid.style.overflow = 'hidden';
    }
    
    // Исправляем все карточки заданий
    const taskCards = document.querySelectorAll('.task-card');
    taskCards.forEach(card => {
        card.style.width = '100%';
        card.style.maxWidth = '100%';
        card.style.boxSizing = 'border-box';
        card.style.margin = '0 0 12px 0';
        card.style.overflow = 'hidden';
    });
    
    // Предотвращаем горизонтальную прокрутку
    document.body.style.overflowX = 'hidden';
    document.documentElement.style.overflowX = 'hidden';
    
    console.log('✅ Mobile layout fixes applied');
}

// Вызываем при загрузке и при изменении размера окна
document.addEventListener('DOMContentLoaded', fixMobileLayout);
window.addEventListener('resize', fixMobileLayout);
window.addEventListener('orientationchange', fixMobileLayout);

// Также вызываем при переключении вкладок
function showTasksTab() {
    console.log('🎯 ПЕРЕХОД НА ВКЛАДКУ ЗАДАНИЙ');
    
    // 1. Скрываем все вкладки
    hideAllTabs();
    
    // 2. Показываем вкладку заданий
    const tasksTab = document.getElementById('tasks-tab');
    if (tasksTab) {
        tasksTab.classList.add('active');
        console.log('✅ Вкладка заданий активирована');
    }
    
    // 3. Обновляем навигацию
    updateNavState('tasks');
    
    // 4. Применяем исправления для мобильных
    setTimeout(fixMobileLayout, 100);
    
    // 5. Активируем вкладку "Новые"
    setTimeout(() => {
        showTaskCategory('new');
    }, 150);
}

        function displayChatMessages(messages) {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            
            messagesContainer.innerHTML = '';
            
            // Если нет сообщений, показываем приветствие
            if (!messages || messages.length === 0) {
                const welcomeMessage = document.createElement('div');
                welcomeMessage.className = 'message message-admin';
                welcomeMessage.innerHTML = `
                    <div class="message-text">Здравствуйте! Чем могу помочь?</div>
                    <div class="message-time">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</div>
                `;
                messagesContainer.appendChild(welcomeMessage);
                return;
            }
            
            // Показываем существующие сообщения
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = message.is_admin ? 'message message-admin' : 'message message-user';
                
                messageElement.innerHTML = `
                    <div class="message-text">${escapeHtml(message.message)}</div>
                    <div class="message-time">${formatPostDate(message.sent_at)}</div>
                `;
                messagesContainer.appendChild(messageElement);
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function closeChat() {
            document.getElementById('admin-chat').classList.remove('active');
            currentChatId = null;
        }

        // 🔧 ФУНКЦИИ НАВИГАЦИИ
        function showMainTab() {
            hideAllTabs();
            document.getElementById('main-tab').classList.add('active');
            updateNavState('main');
        }

        function showTasksTab() {
            hideAllTabs();
            document.getElementById('tasks-tab').classList.add('active');
            updateNavState('tasks');
        }

        // 🔧 ОБРАБОТЧИК ПЕРЕКЛЮЧЕНИЯ НА ВКЛАДКУ ПРОФИЛЯ
function showProfileTab() {
    hideAllTabs();
    document.getElementById('profile-tab').classList.add('active');
    updateNavState('profile');
    
    // Синхронизируем данные при каждом открытии профиля
    setTimeout(() => {
        updateUserData();
        syncUserProfile();
    }, 100);
}
// 🔧 ФУНКЦИЯ УДАЛЕНИЯ ЗАДАНИЯ
async function deleteTask(taskId) {
    if (!confirm('Удалить это задание?')) return;
    
    if (!currentUser) {
        showNotification('Пользователь не авторизован', 'error');
        return;
    }
    
    try {
        const result = await makeRequest(`/tasks/${taskId}`, {
            method: 'DELETE',
            body: JSON.stringify({ adminId: currentUser.id })
        });

        if (result.success) {
            showNotification('Задание успешно удалено!', 'success');
            // Перезагружаем список заданий
            loadAdminTasks();
        } else {
            showNotification('Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error deleting task:', error);
        showNotification('Ошибка удаления задания: ' + error.message, 'error');
    }
}

// 🔧 ДИАГНОСТИКА АДМИН-ПАНЕЛИ С ЗАДАНИЯМИ
function debugAdminTasks() {
    console.log('🐛 DEBUG Admin Tasks Section:');
    
    const elements = {
        'admin-tasks-section': document.getElementById('admin-tasks-section'),
        'admin-tasks-list': document.getElementById('admin-tasks-list'),
        'admin-task-title': document.getElementById('admin-task-title'),
        'add-task-button': document.querySelector('#admin-tasks-section .admin-submit')
    };
    
    Object.keys(elements).forEach(key => {
        const element = elements[key];
        console.log(`- ${key}:`, element ? 'FOUND' : 'NOT FOUND');
        if (element) {
            console.log(`  - display: ${element.style.display}`);
            console.log(`  - visible: ${element.offsetParent !== null}`);
        }
    });
    
    // Проверяем текущего пользователя
    console.log('- currentUser:', currentUser);
    console.log('- isAdmin:', currentUser?.is_admin);
}

function addAdminDebugButton() {
    const debugBtn = document.createElement('button');
    debugBtn.textContent = '🐛 Debug Admin Tasks';
    debugBtn.style.position = 'fixed';
    debugBtn.style.top = '80px';
    debugBtn.style.right = '10px';
    debugBtn.style.zIndex = '10000';
    debugBtn.style.padding = '10px';
    debugBtn.style.background = 'red';
    debugBtn.style.color = 'white';
    debugBtn.style.border = 'none';
    debugBtn.style.borderRadius = '5px';
    debugBtn.style.fontSize = '12px';
    
    debugBtn.onclick = async function() {
        console.log('🔍 DEBUG ADMIN TASKS:');
        console.log('- Current User:', currentUser);
        console.log('- isAdmin:', currentUser?.is_admin);
        console.log('- isMainAdmin:', parseInt(currentUser?.id) === ADMIN_ID);
        
        // Проверяем существующие задания
        try {
            const result = await makeRequest('/api/admin/all-tasks?adminId=' + currentUser.id);
            console.log('- Admin tasks result:', result);
            
            if (result.success) {
                showNotification(`Найдено ${result.tasks.length} заданий`, 'success');
            } else {
                showNotification('Ошибка загрузки заданий: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Debug error:', error);
            showNotification('Ошибка диагностики: ' + error.message, 'error');
        }
    };
    
    document.body.appendChild(debugBtn);
}

// Вызовите при инициализации
setTimeout(addAdminDebugButton, 3000);
        // Функция показа вкладки админа - ИСПРАВЛЕННАЯ ВЕРСИЯ


        function showWithdrawPage() {
            hideAllTabs();
            document.getElementById('withdraw-page').classList.add('active');
            
            // Обновляем баланс на странице вывода
            updateWithdrawPage();
            loadWithdrawHistory();
        }

        function showHowItWorksPage() {
            hideAllTabs();
            document.getElementById('how-it-works-page').classList.add('active');
        }

        function showAboutPage() {
            hideAllTabs();
            document.getElementById('about-page').classList.add('active');
        }

        function goBackToProfile() {
            showProfileTab();
        }

        function hideAllTabs() {
    // Скрываем все вкладки и страницы
    const allElements = document.querySelectorAll('.tab-content, .page');
    allElements.forEach(element => {
        element.classList.remove('active');
    });
    
    // Дополнительно: сбрасываем админ-панель
    resetAdminPanel();
}
        function updateNavState(activeTab) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const navItems = document.querySelectorAll('.nav-item');
            switch(activeTab) {
                case 'main': 
                    if (navItems[0]) navItems[0].classList.add('active'); 
                    break;
                case 'tasks': 
                    if (navItems[1]) navItems[1].classList.add('active'); 
                    break;
                case 'profile': 
                    if (navItems[2]) navItems[2].classList.add('active'); 
                    break;
                case 'admin': 
                    if (navItems[3]) navItems[3].classList.add('active'); 
                    break;
            }
        }
// 🔧 ПОЛНАЯ ФУНКЦИЯ ПОКАЗА АДМИН-СЕКЦИЙ С ПРОМОКОДАМИ
// 🔧 ИСПРАВЛЕННАЯ ФУНКЦИЯ ПОКАЗА АДМИН-СЕКЦИЙ
function showAdminSection(section) {
    console.log('🔄 Switching to admin section:', section);
    
    // Скрываем ВСЕ админ секции
    const adminSections = document.querySelectorAll('.admin-section');
    adminSections.forEach(sec => {
        sec.style.display = 'none';
    });
    
    // Скрываем контейнер "Созданные задания" если он виден
    const createdTasksContainer = document.getElementById('admin-tasks-list');
    if (createdTasksContainer && createdTasksContainer.parentElement) {
        createdTasksContainer.parentElement.style.display = 'none';
    }
    
    // Скрываем форму создания задания во всех секциях, кроме tasks
    const taskForm = document.querySelector('#admin-tasks-section .admin-form');
    if (taskForm) {
        taskForm.style.display = section === 'tasks' ? 'block' : 'none';
    }
    
    // Показываем выбранную секцию
    const targetSection = document.getElementById('admin-' + section + '-section');
    if (targetSection) {
        targetSection.style.display = 'block';
        console.log(`✅ Showing: admin-${section}-section`);

        // Загружаем данные для определенных секций
        switch(section) {
            case 'posts':
                console.log('📝 Loading posts management...');
                loadAdminPosts();
                break;
                
            case 'tasks':
                console.log('📋 Loading tasks management...');
                // Показываем контейнер "Созданные задания" только для секции tasks
                const tasksContainer = document.getElementById('admin-tasks-list');
                if (tasksContainer && tasksContainer.parentElement) {
                    tasksContainer.parentElement.style.display = 'block';
                }
                // Показываем форму создания заданий
                if (taskForm) {
                    taskForm.style.display = 'block';
                }
                setTimeout(() => {
                    loadAdminTasks();
                }, 100);
                break;
                
            case 'payments':
                console.log('💳 Loading withdrawal requests...');
                loadWithdrawalRequests();
                break;
                
            case 'verification':
                console.log('✅ Loading task verifications...');
                loadTaskVerifications();
                break;
                
            case 'support':
                console.log('💬 Loading support chats...');
                loadAdminChats();
                break;
                
            case 'admins':
                console.log('👥 Loading admins list...');
                loadAdminsList();
                break;
                
            case 'promocodes':
                console.log('🎫 Loading promocodes management...');
                loadPromocodesList();
                break;
                
            default:
                console.log(`ℹ️ No specific loader for section: ${section}`);
        }
        
    } else {
        console.error(`❌ Target section not found: admin-${section}-section`);
    }
}
// 🔧 ФУНКЦИЯ ЗАГРУЗКИ СПИСКА ПРОМОКОДОВ
async function loadPromocodesList() {
    console.log('🔄 Loading promocodes list...');
    
    if (!currentUser || parseInt(currentUser.id) !== ADMIN_ID) {
        console.log('❌ User is not main admin, cannot load promocodes');
        showNotification('Только главный администратор может управлять промокодами!', 'error');
        return;
    }
    
    try {
        const result = await makeRequest(`/api/admin/promocodes/list?adminId=${currentUser.id}`);
        
        if (result.success) {
            displayPromocodesList(result.promocodes);
            console.log(`✅ Loaded ${result.promocodes?.length || 0} promocodes`);
        } else {
            console.error('❌ Error loading promocodes:', result.error);
            showNotification('Ошибка загрузки промокодов: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('❌ Load promocodes error:', error);
        showNotification('Ошибка загрузки промокодов: ' + error.message, 'error');
    }
}

// 🔧 ФУНКЦИЯ ОТОБРАЖЕНИЯ СПИСКА ПРОМОКОДОВ
function displayPromocodesList(promocodes) {
    const container = document.getElementById('promocodes-list');
    if (!container) {
        console.error('❌ Promocodes list container not found');
        return;
    }
    
    container.innerHTML = '';
    

    
    console.log(`🎨 Displaying ${promocodes.length} promocodes`);
    
    promocodes.forEach(promo => {
        const promoElement = createPromocodeElement(promo);
        container.appendChild(promoElement);
    });
}

// 🔧 ФУНКЦИЯ СОЗДАНИЯ ЭЛЕМЕНТА ПРОМОКОДА
function createPromocodeElement(promo) {
    const promoElement = document.createElement('div');
    promoElement.className = 'admin-task-item';
    
    const usedCount = promo.used_count || 0;
    const isExpired = promo.expires_at && new Date(promo.expires_at) < new Date();
    const isFullyUsed = usedCount >= promo.max_uses;
    const status = isExpired ? 'expired' : (isFullyUsed ? 'used' : 'active');
    
    const statusColors = {
        active: 'var(--success)',
        used: 'var(--warning)',
        expired: 'var(--error)'
    };
    
    const statusTexts = {
        active: '🟢 Активен',
        used: '🟡 Использован',
        expired: '🔴 Просрочен'
    };
    
    const usagePercentage = Math.round((usedCount / promo.max_uses) * 100);
    
    promoElement.innerHTML = `
        <div class="admin-task-header">
            <div class="admin-task-title">
                <span style="font-size: 20px; font-weight: 800; color: var(--gold); letter-spacing: 1px;">${promo.code}</span>
                <span style="color: ${statusColors[status]}; font-size: 12px; margin-left: 10px; font-weight: 600;">
                    ${statusTexts[status]}
                </span>
            </div>
            <div class="admin-task-actions">
                <button class="admin-task-delete" onclick="deactivatePromoCode('${promo.code}')" 
                        style="background: var(--error); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                    🗑️ Удалить
                </button>
            </div>
        </div>
        
        <div class="admin-task-description">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <div>
                    <div style="font-size: 12px; color: var(--text-secondary);">🎁 Награда</div>
                    <div style="font-size: 18px; font-weight: 700; color: var(--gold);">${promo.reward} ⭐</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: var(--text-secondary);">👥 Использовано</div>
                    <div style="font-size: 16px; font-weight: 600;">${usedCount}/${promo.max_uses}</div>
                </div>
            </div>
            
            <!-- Прогресс бар использования -->
            <div style="margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">
                    <span>Прогресс использования</span>
                    <span>${usagePercentage}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${usagePercentage}%; 
                         background: ${status === 'active' ? 'var(--success)' : status === 'used' ? 'var(--warning)' : 'var(--error)'};">
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px; color: var(--text-secondary);">
                <div>
                    <div>📅 Создан</div>
                    <div style="font-weight: 600;">${new Date(promo.created_at).toLocaleDateString('ru-RU')}</div>
                </div>
                <div>
                    <div>⏰ ${promo.expires_at ? 'Истекает' : 'Срок действия'}</div>
                    <div style="font-weight: 600;">
                        ${promo.expires_at ? 
                          new Date(promo.expires_at).toLocaleDateString('ru-RU') : 
                          'Бессрочный'}
                    </div>
                </div>
            </div>
            
            <!-- Статистика активаций -->
            ${usedCount > 0 ? `
                <div style="margin-top: 10px; padding: 8px; background: var(--bg-secondary); border-radius: 6px;">
                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">
                        📊 Статистика активаций:
                    </div>
                    <div style="font-size: 12px;">
                        Всего выдано: <strong>${usedCount * promo.reward} ⭐</strong>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
    
    return promoElement;
}

// 🔧 ФУНКЦИЯ ДЕАКТИВАЦИИ ПРОМОКОДА
async function deactivatePromoCode(code) {
    if (!confirm(`Вы уверены, что хотите удалить промокод "${code}"?\n\nЭто действие нельзя отменить.`)) {
        return;
    }
    
    if (!currentUser || parseInt(currentUser.id) !== ADMIN_ID) {
        showNotification('Только главный администратор может удалять промокоды!', 'error');
        return;
    }
    
    try {
        const result = await makeRequest('/api/admin/promocodes/deactivate', {
            method: 'POST',
            body: JSON.stringify({
                adminId: currentUser.id,
                code: code
            })
        });
        
        if (result.success) {
            showNotification(`✅ Промокод "${code}" успешно удален!`, 'success');
            // Обновляем список промокодов
            loadPromocodesList();
        } else {
            showNotification('❌ Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('❌ Deactivate promocode error:', error);
        showNotification('❌ Ошибка удаления промокода: ' + error.message, 'error');
    }
}




// 🔧 ФУНКЦИЯ ДЛЯ ИСПРАВЛЕНИЯ СТРУКТУРЫ ТАБЛИЦЫ ПРОМОКОДОВ
async function fixPromocodesTable() {
    try {
        console.log('🔧 Fixing promocodes table structure...');
        
        // Проверяем существование таблицы
        const tableExists = await pool.query(`
            SELECT EXISTS (
                SELECT FROM information_schema.tables 
                WHERE table_name = 'promocodes'
            )
        `);
        
        if (!tableExists.rows[0].exists) {
            console.log('❌ Promocodes table does not exist, creating...');
            await createPromocodesTable();
            return;
        }
        
        // Добавляем отсутствующие колонки
        const alterQueries = [
            `ALTER TABLE promocodes ADD COLUMN IF NOT EXISTS reward REAL NOT NULL DEFAULT 0`,
            `ALTER TABLE promocodes ADD COLUMN IF NOT EXISTS max_uses INTEGER NOT NULL DEFAULT 1`,
            `ALTER TABLE promocodes ADD COLUMN IF NOT EXISTS used_count INTEGER DEFAULT 0`,
            `ALTER TABLE promocodes ADD COLUMN IF NOT EXISTS expires_at TIMESTAMP`,
            `ALTER TABLE promocodes ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT true`,
            `ALTER TABLE promocodes ADD COLUMN IF NOT EXISTS created_by BIGINT NOT NULL DEFAULT ${ADMIN_ID}`,
            `ALTER TABLE promocodes ADD COLUMN IF NOT EXISTS created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP`
        ];
        
        for (const query of alterQueries) {
            try {
                await pool.query(query);
                console.log(`✅ Executed: ${query.split('ADD COLUMN IF NOT EXISTS')[1]?.split(' ')[1]}`);
            } catch (error) {
                console.log(`⚠️ Could not execute: ${query}`, error.message);
            }
        }
        
        console.log('✅ Promocodes table structure fixed');
    } catch (error) {
        console.error('❌ Error fixing promocodes table:', error);
    }
}
// 🔧 АНИМАЦИЯ УСПЕШНОЙ АКТИВАЦИИ ПРОМОКОДА
function showPromocodeSuccessAnimation(reward) {
    const animation = document.createElement('div');
    animation.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--gold-gradient);
        color: #000;
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        z-index: 10000;
        box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);
        border: 3px solid rgba(255, 255, 255, 0.3);
        animation: promocodeSuccess 1s ease-out;
    `;
    
    animation.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 15px;">🎉</div>
        <div style="font-size: 24px; font-weight: 800; margin-bottom: 10px;">
            Промокод активирован!
        </div>
        <div style="font-size: 32px; font-weight: 700; color: #000; margin: 15px 0;">
            +${reward} ⭐
        </div>
        <div style="font-size: 16px; opacity: 0.8;">
            Награда добавлена на ваш баланс
        </div>
    `;
    
    document.body.appendChild(animation);
    
    // Автоматическое скрытие через 3 секунды
    setTimeout(() => {
        animation.remove();
    }, 3000);
}

// 🔧 ДОБАВЛЕНИЕ CSS АНИМАЦИИ
const promocodeStyles = `
    <style>
        @keyframes promocodeSuccess {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        .promocode-stats {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid var(--border);
        }
        
        .promocode-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .promocode-stat:last-child {
            border-bottom: none;
        }
    </style>
`;

// Добавляем стили в документ
document.head.insertAdjacentHTML('beforeend', promocodeStyles);

// 🔧 ЭКСПОРТ ФУНКЦИЙ
window.showAdminSection = showAdminSection;
window.loadPromocodesList = loadPromocodesList;
window.createPromoCode = createPromoCode;
window.activatePromoCode = activatePromoCode;
window.deactivatePromoCode = deactivatePromoCode;
async function loadAdminPosts() {
    try {
        console.log('📝 Loading admin posts...');
        const result = await makeRequest('/posts');
        if (result.success) {
            displayAdminPosts(result.posts);
        }
    } catch (error) {
        console.error('Error loading admin posts:', error);
    }
}

function displayAdminPosts(posts) {
    const container = document.getElementById('admin-posts-list');
    if (!container) {
        console.error('❌ Admin posts container not found');
        return;
    }
    
    container.innerHTML = '';
    
    if (!posts || posts.length === 0) {
        container.innerHTML = ` `;
        return;
    }
    
    posts.forEach(post => {
        const postElement = document.createElement('div');
        postElement.className = 'admin-task-item';
        postElement.innerHTML = `
            <div class="admin-task-header">
                <div class="admin-task-title">${post.title}</div>
                <div class="admin-task-actions">
                    <button class="admin-task-delete" onclick="deletePost(${post.id})">
                        🗑️ Удалить
                    </button>
                </div>
            </div>
            <div class="admin-task-description">${post.content}</div>
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                Автор: ${post.author} • ${new Date(post.created_at).toLocaleDateString('ru-RU')}
            </div>
        `;
        container.appendChild(postElement);
    });
}

        // 🎨 ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatPostDate(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            
            // Московское время (UTC+3)
            const moscowTime = new Date(date.getTime() + (3 * 60 * 60 * 1000));
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const postDate = new Date(moscowTime.getFullYear(), moscowTime.getMonth(), moscowTime.getDate());
            
            const diffTime = now - date;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                // Сегодня
                return `Сегодня, ${moscowTime.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    timeZone: 'Europe/Moscow'
                })} (МСК)`;
            } else if (diffDays === 1) {
                // Вчера
                return `Вчера, ${moscowTime.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    timeZone: 'Europe/Moscow'
                })} (МСК)`;
            } else {
                // Раньше
                return `${moscowTime.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    timeZone: 'Europe/Moscow'
                })}, ${moscowTime.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    timeZone: 'Europe/Moscow'
                })} (МСК)`;
            }
        }

// Функция запроса вывода средств - ОБНОВЛЕННАЯ ВЕРСИЯ
async function requestWithdraw() {
    if (!currentUser) {
        showNotification('Пользователь не авторизован', 'error');
        return;
    }
    
    const currentBalance = currentUser.balance || 0;
    const MIN_WITHDRAWAL = 250; // Минимальная сумма вывода
    
    if (currentBalance < MIN_WITHDRAWAL) {
    showNotification(`Минимальная сумма для вывода: ${MIN_WITHDRAWAL} ⭐\n\nВаш баланс: ${currentBalance} ⭐`, 'error');
    return;
}
    
    if (!confirm(`Вы уверены, что хотите вывести ${currentBalance} ⭐?\n\nПосле подтверждения баланс будет обнулен и заявка отправлена администраторам.`)) {
        return;
    }
    
    try {
        console.log('🔄 Отправка запроса на вывод...');
        
        const result = await makeRequest('/withdrawal/request', {
            method: 'POST',
            body: JSON.stringify({
                user_id: currentUser.id,
                amount: currentBalance,
                username: currentUser.username,
                first_name: currentUser.firstName
            })
        });
        
        console.log('📨 Ответ сервера:', result);
        
        if (result.success) {
            // Обновляем баланс пользователя
            currentUser.balance = 0;
            
            // Обновляем отображение
            displayUserProfile();
            updateWithdrawPage();
            
            showNotification(`✅ Заявка на вывод ${currentBalance} ⭐ отправлена! Ожидайте подтверждения администратора.`, 'success');
            
            // Обновляем историю операций
            setTimeout(() => {
                loadWithdrawHistory();
            }, 1000);
            
        } else {
            showNotification('❌ Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('❌ Withdrawal error:', error);
        showNotification('❌ Ошибка при выводе средств: ' + error.message, 'error');
    }
}
// Функция загрузки истории выводов
async function loadWithdrawHistory() {
    if (!currentUser) return;
    
    try {
        const result = await makeRequest(`/withdraw/history/${currentUser.id}`);
        if (result.success) {
            displayWithdrawHistory(result.operations);
        }
    } catch (error) {
        console.error('Error loading withdrawal history:', error);
    }
}


// Функция отображения истории выводов
function displayWithdrawHistory(operations) {
    const container = document.getElementById('withdraw-history-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!operations || operations.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                <div style="font-size: 48px; margin-bottom: 16px;">💫</div>
                <div>Нет операций по выводу</div>
                <div style="font-size: 12px; margin-top: 8px;">
                    Минимальная сумма для вывода: 200 ⭐
                </div>
            </div>
        `;
        return;
    }
    
    // Сортируем по дате (новые сверху)
    operations.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    
    operations.forEach(operation => {
        const operationElement = document.createElement('div');
        operationElement.className = 'withdraw-operation';
        operationElement.style.cssText = `
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        `;
        
        const statusText = operation.status === 'completed' ? 
            '✅ Выплачено' : 
            '🔄 В обработке';
            
        const statusColor = operation.status === 'completed' ? 
            'var(--success)' : 'var(--warning)';
        
        const date = new Date(operation.created_at).toLocaleDateString('ru-RU', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
        });
        
        operationElement.innerHTML = `
            <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">
                    ${operation.amount} ⭐
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                    ${date}
                </div>
            </div>
            <div style="color: ${statusColor}; font-weight: 600; font-size: 13px; text-align: right;">
                ${statusText}
                ${operation.completed_at ? `
                    <div style="font-size: 11px; font-weight: normal; margin-top: 2px;">
                        Завершено: ${new Date(operation.completed_at).toLocaleDateString('ru-RU')}
                    </div>
                ` : ''}
            </div>
        `;
        
        container.appendChild(operationElement);
    });
}
// 🔧 ИСПРАВЛЕННАЯ функция загрузки заявок на вывод
async function loadWithdrawalRequests() {
    console.log('🔄 Loading withdrawal requests...');
    
    if (!currentUser) {
        console.log('❌ No current user');
        showNotification('Пользователь не авторизован', 'error');
        return;
    }
    
    try {
        // Сначала проверяем права
        const rightsResult = await makeRequest(`/admin/debug-rights?userId=${currentUser.id}`);
        console.log('🔍 Admin rights check:', rightsResult);
        
        if (!rightsResult.isAdmin) {
            showNotification('❌ У вас нет прав администратора!', 'error');
            return;
        }
        
        const result = await makeRequest(`/admin/withdrawal-requests?adminId=${currentUser.id}`);
        console.log('📨 Withdrawal requests response:', result);
        
        if (result.success) {
            displayWithdrawalRequests(result.requests);
        } else {
            console.error('❌ Failed to load requests:', result.error);
            showNotification('Ошибка загрузки заявок: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('❌ Load withdrawal requests error:', error);
        showNotification('Ошибка загрузки заявок: ' + error.message, 'error');
    }
}

// 🔧 ИСПРАВЛЕННАЯ функция отображения заявок
function displayWithdrawalRequests(requests) {
    const container = document.getElementById('withdrawal-requests-list');
    if (!container) {
        console.error('❌ Container not found');
        return;
    }
    
    container.innerHTML = '';
    
    // Обновляем статистику
    const activeCount = document.getElementById('active-withdrawals-count');
    const totalCount = document.getElementById('total-withdrawals-count');
    
    if (activeCount) activeCount.textContent = requests.length;
    if (totalCount) totalCount.textContent = requests.length;
    
    if (!requests || requests.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                <div style="font-size: 48px; margin-bottom: 16px;">💫</div>
                <div>Нет активных запросов на вывод</div>
                <div style="font-size: 12px; margin-top: 8px;">Новые запросы появятся здесь</div>
            </div>
        `;
        return;
    }
    
    console.log(`✅ Отображаем ${requests.length} заявок`);
    
    requests.forEach(request => {
        const requestElement = document.createElement('div');
        requestElement.className = 'admin-task-item';
        requestElement.style.marginBottom = '15px';
        
        const userName = request.first_name || request.username || `User_${request.user_id}`;
        const requestDate = new Date(request.created_at).toLocaleString('ru-RU');
        
        requestElement.innerHTML = `
            <div class="admin-task-header">
                <div class="admin-task-title">
                    ${userName}
                    ${request.username ? ` (@${request.username})` : ''}
                </div>
                <div class="admin-task-price" style="font-size: 20px; color: var(--gold);">
                    ${request.amount} ⭐
                </div>
            </div>
            <div class="admin-task-description">
                <div>ID пользователя: ${request.user_id}</div>
                <div>Запрос создан: ${requestDate}</div>
            </div>
            <div class="admin-task-actions" style="margin-top: 10px; display: flex; gap: 10px;">
                <button class="admin-task-approve" onclick="completeWithdrawal(${request.id})" 
                        style="background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; flex: 1;">
                    ✅ Перечислил средства
                </button>
            </div>
        `;
        
        container.appendChild(requestElement);
    });
}
// Замените сложные функции на более простые
function simpleShowTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    document.getElementById(tabId).style.display = 'block';
}

// Отложите не критичные операции
setTimeout(() => {
    loadNonCriticalData();
    initializeAnimations();
}, 1000);
// 🔧 ИСПРАВЛЕННАЯ функция подтверждения выплаты
async function completeWithdrawal(requestId) {
    console.log('🔧 completeWithdrawal called:', {
        requestId,
        currentUser: currentUser,
        currentUserId: currentUser?.id
    });
    
    if (!confirm('Вы уверены, что перечислили средства пользователю?')) {
        return;
    }
    
    try {
        console.log('📤 Sending complete request...');
        const result = await makeRequest(`/admin/withdrawal-requests/${requestId}/complete`, {
            method: 'POST',
            body: JSON.stringify({
                adminId: currentUser.id
            })
        });
        
        console.log('📨 Complete response:', result);
        
        if (result.success) {
            showNotification('✅ Выплата подтверждена!', 'success');
            loadWithdrawalRequests();
        } else {
            showNotification('❌ Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('❌ Complete withdrawal error:', error);
        showNotification('❌ Ошибка подтверждения выплаты: ' + error.message, 'error');
    }
}

// Тестовая функция
async function createTestWithdrawal() {
    try {
        const result = await makeRequest('/test-withdrawal', {
            method: 'POST'
        });
        
        if (result.success) {
            showNotification('✅ Тестовая заявка создана!', 'success');
            loadWithdrawalRequests();
        }
    } catch (error) {
        console.error('Test withdrawal error:', error);
    }
}

// Обновите функцию показа секции
function showAdminPaymentsSection() {
    showAdminSection('payments');
    // Загружаем с небольшой задержкой чтобы интерфейс успел отобразиться
    setTimeout(() => {
        loadWithdrawalRequests();
    }, 100);
}

// Обновите функцию показа секции оплат
function showAdminPaymentsSection() {
    showAdminSection('payments');
    loadWithdrawalRequests();
}
       // Обновление страницы вывода
function updateWithdrawPage() {
    const balanceDisplay = document.getElementById('withdraw-balance-display');
    const withdrawBtn = document.getElementById('withdraw-btn');
    const MIN_WITHDRAWAL = 250;
    
    if (balanceDisplay && currentUser) {
        balanceDisplay.textContent = `${currentUser.balance || 0} ⭐`;
    }
    
    if (withdrawBtn && currentUser) {
        const currentBalance = currentUser.balance || 0;
        
        if (currentBalance < MIN_WITHDRAWAL) {
    withdrawBtn.disabled = true;
    withdrawBtn.style.opacity = '0.5';
    withdrawBtn.textContent = `Минимум ${MIN_WITHDRAWAL} ⭐`;
} else {
            withdrawBtn.disabled = false;
            withdrawBtn.style.opacity = '1';
            withdrawBtn.textContent = `Вывести ${currentBalance} ⭐`;
        }
    }
}

        // Загрузка постов на главную
        async function loadMainPagePosts() {
            try {
                const result = await makeRequest('/posts');
                
                if (result.success && result.posts && result.posts.length > 0) {
                    displayMainPagePosts(result.posts);
                } else {
                    hidePostsSection();
                }
            } catch (error) {
                console.error('Error loading posts:', error);
                hidePostsSection();
            }
        }

        function displayMainPagePosts(posts) {
            const postsSection = document.getElementById('posts-section');
            const postsContainer = document.getElementById('posts-container');
            
            if (!postsContainer) return;
            
            if (postsSection) postsSection.style.display = 'block';
            
            postsContainer.innerHTML = '';
            
            if (!posts || posts.length === 0) {
                postsContainer.innerHTML = `
                    <div class="no-tasks" style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📝</div>
                        <div>Пока нет публикаций</div>
                        <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">
                            Следите за обновлениями
                        </div>
                    </div>
                `;
                return;
            }
            
            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'post-item fade-in';
                
                const postDate = formatPostDate(post.timestamp);
                const isAdmin = post.authorId === ADMIN_ID;
                
                postElement.innerHTML = `
                    <div class="post-header">
                        <div style="flex: 1;">
                            <div class="post-title">${escapeHtml(post.title)}</div>
                            <div class="post-author">
                                ${escapeHtml(post.author || 'Команда LinkGold')}
                            </div>
                        </div>
                        <div class="post-date">${postDate}</div>
                    </div>
                    
                    <div class="post-content">${escapeHtml(post.content)}</div>
                    
                    ${post.image_url ? `
                        <img src="${post.image_url}" alt="Изображение" class="post-image" onerror="this.style.display='none'">
                    ` : ''}
                    
                    
                    
                    ${currentUser && currentUser.isAdmin && parseInt(currentUser.id) === ADMIN_ID ? `
                        <div style="margin-top: 15px; text-align: right;">
                            <button class="admin-task-delete" onclick="deletePost(${post.id})" style="font-size: 12px; padding: 6px 12px;">
                                🗑️ Удалить пост
                            </button>
                        </div>
                    ` : ''}
                `;
                
                postsContainer.appendChild(postElement);
            });
        }

        function hidePostsSection() {
            const postsSection = document.getElementById('posts-section');
            if (postsSection) postsSection.style.display = 'none';
        }

        // Функции для лайков и дизлайков
        async function handleLike(postId, button) {
            try {
                const result = await makeRequest(`/posts/${postId}/like`, {
                    method: 'POST',
                    body: JSON.stringify({
                        userId: currentUser.id
                    })
                });

                if (result.success) {
                    const countElement = button.querySelector('.like-count');
                    countElement.textContent = result.likes;
                    
                    // Визуальная обратная связь
                    button.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        button.style.transform = 'scale(1)';
                    }, 200);
                }
            } catch (error) {
                console.error('Error liking post:', error);
                // Локальное обновление для демонстрации
                const countElement = button.querySelector('.like-count');
                countElement.textContent = parseInt(countElement.textContent) + 1;
                
                button.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    button.style.transform = 'scale(1)';
                }, 200);
            }
        }

        async function handleDislike(postId, button) {
            try {
                const result = await makeRequest(`/posts/${postId}/dislike`, {
                    method: 'POST',
                    body: JSON.stringify({
                        userId: currentUser.id
                    })
                });

                if (result.success) {
                    const countElement = button.querySelector('.dislike-count');
                    countElement.textContent = result.dislikes;
                    
                    // Визуальная обратная связь
                    button.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        button.style.transform = 'scale(1)';
                    }, 200);
                }
            } catch (error) {
                console.error('Error disliking post:', error);
                // Локальное обновление для демонстрации
                const countElement = button.querySelector('.dislike-count');
                countElement.textContent = parseInt(countElement.textContent) + 1;
                
                button.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    button.style.transform = 'scale(1)';
                }, 200);
            }
        }

        // Функция для отправки запроса на вывод
        async function submitWithdraw() {
            if (!currentUser) {
                showNotification('Пользователь не авторизован', 'error');
                return;
            }
            
            const amountInput = document.getElementById('withdraw-amount');
            const methodSelect = document.getElementById('withdraw-method');
            const detailsInput = document.getElementById('withdraw-details');
            
            const amount = parseFloat(amountInput?.value);
            const method = methodSelect?.value;
            const details = detailsInput?.value?.trim();
            
            // Валидация
            if (!amount || amount <= 0) {
                showNotification('Введите корректную сумму', 'error');
                return;
            }
            
            if (amount < 50) {
                showNotification('Минимальная сумма вывода: 150 ⭐', 'error');
                return;
            }
            
            if (amount > (currentUser.balance || 0)) {
                showNotification('Недостаточно средств на балансе', 'error');
                return;
            }
            
            if (!method) {
                showNotification('Выберите способ вывода', 'error');
                return;
            }
            
            if (!details) {
                showNotification('Введите реквизиты для вывода', 'error');
                return;
            }
            
            try {
                const result = await makeRequest('/withdrawal/request', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        amount: amount,
                        method: method,
                        details: details
                    })
                });

                if (result.success) {
                    showNotification(`Запрос на вывод ${amount}⭐ отправлен! Ожидайте обработки в течение 24 часов.`, 'success');
                    
                    // Очищаем форму
                    if (amountInput) amountInput.value = '';
                    if (methodSelect) methodSelect.value = '';
                    if (detailsInput) detailsInput.value = '';
                    
                    // Обновляем баланс пользователя
                    if (currentUser.balance) {
                        currentUser.balance -= amount;
                    }
                    
                    // Обновляем отображение баланса
                    displayUserProfile();
                    
                    // Возвращаемся в профиль
                    setTimeout(() => {
                        showProfileTab();
                    }, 2000);
                    
                } else {
                    showNotification('Ошибка: ' + (result.error || 'Неизвестная ошибка'), 'error');
                }
            } catch (error) {
                console.error('Ошибка при выводе средств:', error);
                showNotification('Ошибка соединения при отправке запроса', 'error');
            }
        }

        function showNotification(message, type = 'info') {
            // Удаляем существующие уведомления
            document.querySelectorAll('.notification').forEach(notification => {
                notification.remove();
            });
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">${message}</div>
                <button class="notification-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function copyReferralLink() {
            const referralInput = document.getElementById('referral-link');
            if (!referralInput) return;
            
            referralInput.select();
            referralInput.setSelectionRange(0, 99999);
            
            navigator.clipboard.writeText(referralInput.value).then(() => {
                showNotification('Реферальная ссылка скопирована!', 'success');
            }).catch(() => {
                document.execCommand('copy');
                showNotification('Реферальная ссылка скопирована!', 'success');
            });
        }

        function showBalanceModal() {
            document.getElementById('balance-modal').classList.add('active');
        }

        function showPrices() {
            document.getElementById('prices-modal').classList.add('active');
        }

        function openAdminChatFromPrices() {
            document.getElementById('prices-modal').classList.remove('active');
            setTimeout(() => {
                document.getElementById('admin-chat').classList.add('active');
            }, 300);
        }

        function goToProfile() {
            closeModal('balance-modal');
            showProfileTab();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

// В index.html - обновите функцию начала задания
async function startTask() {
    console.log('🎯 Starting task...', { selectedTaskId, currentUser });
    
    if (!currentUser || !selectedTaskId) {
        showNotification('Ошибка: пользователь не авторизован или задание не выбрано', 'error');
        return;
    }

    try {
        console.log('📤 Sending start task request...');
        
        const result = await makeRequest('/api/user/tasks/start', {
            method: 'POST',
            body: JSON.stringify({
                userId: currentUser.id,
                taskId: selectedTaskId
            })
        });

        console.log('📨 Start task response:', result);

        if (result.success) {
            closeModal('task-modal');
            showNotification('✅ Задание начато! Выполните его и вернитесь для подтверждения.', 'success');
            
            // НЕМЕДЛЕННО обновляем списки заданий
            setTimeout(() => {
                loadTasks(); // Обновляем новые задания (убираем начатое)
                loadUserTasksForCategory('active'); // Добавляем в активные
            }, 500);
            
        } else {
            showNotification('❌ Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('💥 Error starting task:', error);
        showNotification('❌ Ошибка начала задания: ' + error.message, 'error');
    }
}

// 🔧 ФУНКЦИЯ ДЛЯ ДИАГНОСТИКИ НАЧАЛА ЗАДАНИЯ
function debugStartTask() {
    console.log('🐛 DEBUG Start Task:');
    console.log('- currentUser:', currentUser);
    console.log('- selectedTaskId:', selectedTaskId);
    console.log('- API_BASE_URL:', API_BASE_URL);
    
    // Проверяем существование задачи
    const task = allTasks.find(t => t.id === selectedTaskId);
    console.log('- task found:', !!task);
    console.log('- task details:', task);
    
    // Проверяем модальное окно
    console.log('- task modal visible:', document.getElementById('task-modal')?.classList.contains('active'));
}

// Временно добавьте кнопку для тестирования
function addStartTaskDebugButton() {
    const debugBtn = document.createElement('button');
    debugBtn.textContent = '🐛 Debug Start Task';
    debugBtn.style.position = 'fixed';
    debugBtn.style.top = '250px';
    debugBtn.style.right = '10px';
    debugBtn.style.zIndex = '10000';
    debugBtn.style.padding = '10px';
    debugBtn.style.background = 'purple';
    debugBtn.style.color = 'white';
    debugBtn.style.border = 'none';
    debugBtn.style.borderRadius = '5px';
    debugBtn.style.fontSize = '12px';
    debugBtn.onclick = debugStartTask;
    document.body.appendChild(debugBtn);
}

// Вызовите при загрузке
setTimeout(addStartTaskDebugButton, 3000);

        async function loadAdminChats() {
    if (!currentUser) return;
    
    try {
        console.log('📥 Loading admin chats...');
        const result = await makeRequest(`/support/chats`);
        
        if (result.success) {
            console.log(`✅ Loaded ${result.chats?.length || 0} active chats`);
            displayAdminChatsList(result.chats || []);
        } else {
            console.error('❌ Failed to load chats:', result.error);
        }
    } catch (error) {
        console.error('❌ Error loading admin chats:', error);
    }
}

        // Загрузка всех чатов (включая архивные)
        async function loadAllAdminChats() {
            if (!currentUser || !currentUser.isAdmin) return;
            
            try {
                const result = await makeRequest(`/support/all-chats?adminId=${ADMIN_ID}`);
                if (result.success) {
                    displayAllAdminChats(result.chats || []);
                }
            } catch (error) {
                console.error('Error loading all chats:', error);
            }
        }

        // Загрузка архивных чатов
        async function loadArchivedAdminChats() {
            if (!currentUser || !currentUser.isAdmin) return;
            
            try {
                const result = await makeRequest(`/support/archived-chats?adminId=${ADMIN_ID}`);
                if (result.success) {
                    displayArchivedAdminChats(result.chats || []);
                }
            } catch (error) {
                console.error('Error loading archived chats:', error);
            }
        }

        // Отображение списка активных чатов
        function displayAdminChatsList(chats) {
            const container = document.getElementById('active-chats-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!chats || chats.length === 0) {
                container.innerHTML = ``;
                return;
            }
            
            // Обновляем статистику
            updateChatsStats(chats);
            
            chats.forEach(chat => {
                const chatElement = createChatElement(chat, 'active');
                container.appendChild(chatElement);
            });
        }

        // Отображение всех чатов
        function displayAllAdminChats(chats) {
            const container = document.getElementById('all-chats-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!chats || chats.length === 0) {
                container.innerHTML = ``;
                return;
            }
            
            chats.forEach(chat => {
                const chatElement = createChatElement(chat, 'all');
                container.appendChild(chatElement);
            });
        }

        // Отображение архивных чатов
        function displayArchivedAdminChats(chats) {
            const container = document.getElementById('archived-chats-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!chats || chats.length === 0) {
                container.innerHTML = `
                    <div class="no-tasks" style="text-align: center; padding: 20px;">
                        <div>Нет архивных чатов</div>
                    </div>
                `;
                return;
            }
            
            chats.forEach(chat => {
                const chatElement = createChatElement(chat, 'archived');
                container.appendChild(chatElement);
            });
        }

        // Создание элемента чата
        function createChatElement(chat, listType) {
            const chatElement = document.createElement('div');
            const isUnread = chat.unread_count > 0;
            const isArchived = !chat.is_active;
            
            chatElement.className = `chat-item ${isUnread ? 'unread' : ''} ${isArchived ? 'archived' : ''}`;
            chatElement.onclick = () => openAdminChatWindow(chat);
            
            const avatarText = chat.user_name ? chat.user_name.charAt(0).toUpperCase() : 'U';
            const displayName = chat.user_name || `User_${chat.user_id}`;
            const lastMessage = chat.last_message || 'Нет сообщений';
            
            chatElement.innerHTML = `
                <div class="chat-avatar-small">
                    ${avatarText}
                </div>
                <div class="chat-info-small">
                    <div class="chat-name-small">
                        ${displayName}
                        ${isArchived ? '<span class="archived-badge">архив</span>' : ''}
                    </div>
                    <div class="chat-last-message">${lastMessage}</div>
                </div>
                <div class="chat-meta">
                    <div class="chat-time">${chat.moscow_time || formatPostDate(chat.last_message_time)}</div>
                    ${isUnread ? `<div class="unread-badge">${chat.unread_count}</div>` : ''}
                </div>
                ${listType === 'all' || listType === 'archived' ? `
                    <div class="chat-actions">
                        ${isArchived ? `
                            <button class="chat-action-btn chat-restore-btn" onclick="event.stopPropagation(); restoreChat(${chat.id})" title="Восстановить">
                                ↻
                            </button>
                        ` : `
                            <button class="chat-action-btn chat-archive-btn" onclick="event.stopPropagation(); archiveChat(${chat.id})" title="В архив">
                                📁
                            </button>
                        `}
                        <button class="chat-action-btn chat-delete-btn" onclick="event.stopPropagation(); deleteAdminChat(${chat.id})" title="Удалить">
                            🗑️
                        </button>
                    </div>
                ` : ''}
            `;
            
            return chatElement;
        }

        // Обновление статистики чатов
        function updateChatsStats(chats) {
            const activeChats = chats.filter(chat => chat.is_active).length;
            const unreadChats = chats.filter(chat => chat.unread_count > 0).length;
            const totalChats = chats.length;
            
            const activeCount = document.getElementById('active-chats-count');
            const unreadCount = document.getElementById('unread-chats-count');
            const totalCount = document.getElementById('total-chats-count');
            
            if (activeCount) activeCount.textContent = activeChats;
            if (unreadCount) unreadCount.textContent = unreadChats;
            if (totalCount) totalCount.textContent = totalChats;
        }

        // Переключение между вкладками чатов
        function showChatTab(tab) {
            // Скрываем все списки чатов
            const activeList = document.getElementById('active-chats-list');
            const archivedList = document.getElementById('archived-chats-list');
            const allList = document.getElementById('all-chats-list');
            
            if (activeList) activeList.style.display = 'none';
            if (archivedList) archivedList.style.display = 'none';
            if (allList) allList.style.display = 'none';
            
            // Убираем активный класс со всех кнопок
            document.querySelectorAll('.chat-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Показываем выбранный список и активируем кнопку
            const buttons = document.querySelectorAll('.chat-tab-btn');
            switch(tab) {
                case 'active':
                    if (activeList) activeList.style.display = 'block';
                    buttons[0]?.classList.add('active');
                    loadAdminChats();
                    break;
                case 'archived':
                    if (archivedList) archivedList.style.display = 'block';
                    buttons[1]?.classList.add('active');
                    loadArchivedAdminChats();
                    break;
                case 'all':
                    if (allList) allList.style.display = 'block';
                    buttons[2]?.classList.add('active');
                    loadAllAdminChats();
                    break;
            }
        }

        // Открытие окна чата админа с пользователем
        async function openAdminChatWindow(chat) {
            console.log('💬 Admin opening chat:', chat);
            currentAdminChat = chat;
            
            try {
                // Загружаем сообщения
                const messagesResult = await makeRequest(`/support/chats/${chat.id}/messages`);
                if (messagesResult.success) {
                    console.log(`📨 Loaded ${messagesResult.messages.length} messages for admin chat`);
                    
                    // Помечаем как прочитанное
                    try {
                        await makeRequest(`/support/chats/${chat.id}/read`, {
                            method: 'PUT'
                        });
                        // Обновляем список чатов (убираем уведомление)
                        loadAdminChats();
                    } catch (readError) {
                        console.log('Mark as read not available');
                    }
                    
                    // Показываем окно чата
                    showAdminChatWindow(chat, messagesResult.messages);
                } else {
                    throw new Error('Failed to load messages');
                }
            } catch (error) {
                console.error('❌ Error opening admin chat:', error);
                showNotification('Ошибка открытия чата: ' + error.message, 'error');
            }
        }

        // Показать окно чата админа
        function showAdminChatWindow(chat, messages) {
            // Создаем окно чата если не существует
            let chatWindow = document.getElementById('admin-chat-window');
            if (!chatWindow) {
                createAdminChatWindow();
                chatWindow = document.getElementById('admin-chat-window');
            }
            
            // Обновляем информацию о пользователе
            const chatUserName = document.getElementById('admin-chat-user-name');
            const chatUserAvatar = document.getElementById('admin-chat-avatar');
            
            if (chatUserName) {
                chatUserName.textContent = chat.user_name || `User_${chat.user_id}`;
            }
            
            if (chatUserAvatar) {
                chatUserAvatar.textContent = chat.user_name ? chat.user_name.charAt(0).toUpperCase() : 'U';
            }
            
            // Отображаем сообщения
            displayAdminChatMessages(messages);
            
            chatWindow.classList.add('active');
        }

        // Создание окна чата админа
        function createAdminChatWindow() {
            const chatWindowHTML = `
                <div class="admin-chat-window" id="admin-chat-window">
                    <div class="admin-chat-header">
                        <div class="admin-chat-user">
                            <div class="chat-avatar-small" id="admin-chat-avatar">U</div>
                            <div class="chat-info-small">
                                <div class="chat-name-small" id="admin-chat-user-name">User</div>
                                <div class="chat-status">Онлайн</div>
                            </div>
                        </div>
                        <button class="chat-close" onclick="closeAdminChat()">×</button>
                    </div>
                    <div class="admin-chat-messages" id="admin-chat-messages">
                        <!-- Сообщения будут загружены здесь -->
                    </div>
                    <div class="admin-chat-input-container">
                        <input type="text" id="admin-chat-input" placeholder="Введите сообщение..." onkeypress="if(event.key==='Enter') sendAdminMessage()">
                        <button class="admin-chat-send" onclick="sendAdminMessage()">➤</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', chatWindowHTML);
        }
function addPromocodesTestButton() {
    const testDiv = document.createElement('div');
    testDiv.innerHTML = `
        <div style="margin: 20px 0; padding: 15px; background: var(--bg-secondary); border-radius: 10px;">
            <h4>🧪 Тестирование промокодов</h4>
            <button onclick="testPromocodesSystem()" class="btn btn-primary" style="margin: 5px;">
                Тест системы промокодов
            </button>
            <button onclick="checkPromocodesTable()" class="btn btn-warning" style="margin: 5px;">
                Проверить таблицу
            </button>
        </div>
    `;
    
    const promocodesSection = document.getElementById('admin-promocodes-section');
    if (promocodesSection) {
        promocodesSection.appendChild(testDiv);
    }
}

async function testPromocodesSystem() {
    try {
        const result = await makeRequest('/api/admin/promocodes/test');
        console.log('🧪 Promocodes test result:', result);
        showNotification(`Тест системы: ${result.message}`, result.success ? 'success' : 'error');
    } catch (error) {
        console.error('❌ Promocodes test failed:', error);
        showNotification('Ошибка тестирования: ' + error.message, 'error');
    }
}

async function checkPromocodesTable() {
    try {
        const result = await makeRequest('/api/debug/tables');
        console.log('📊 All tables:', result);
        showNotification('Проверка таблиц завершена - смотрите консоль', 'info');
    } catch (error) {
        console.error('❌ Table check failed:', error);
        showNotification('Ошибка проверки таблиц: ' + error.message, 'error');
    }
}

// Вызовите при инициализации
setTimeout(addPromocodesTestButton, 2000);
        // Отображение сообщений в чате админа
        function displayAdminChatMessages(messages) {
            const container = document.getElementById('admin-chat-messages');
            if (!container) {
                console.error('Admin chat messages container not found!');
                return;
            }
            
            container.innerHTML = '';
            
            if (!messages || messages.length === 0) {
                const welcomeMessage = document.createElement('div');
                welcomeMessage.className = 'message message-admin';
                welcomeMessage.innerHTML = `
                    <div class="message-text">Начните диалог с пользователем</div>
                    <div class="message-time">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</div>
                `;
                container.appendChild(welcomeMessage);
                return;
            }
            
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = message.is_admin ? 'message message-admin' : 'message message-user';
                
                let messageContent = '';
                if (message.image_url) {
                    messageContent = `
                        <div class="message-image">
                            <img src="${message.image_url}" alt="Фото" style="max-width: 200px; border-radius: 10px;">
                        </div>
                    `;
                } else {
                    messageContent = `<div class="message-text">${escapeHtml(message.message)}</div>`;
                }
                
                messageElement.innerHTML = `
                    ${messageContent}
                    <div class="message-time">${message.moscow_time || formatPostDate(message.sent_at)}</div>
                `;
                container.appendChild(messageElement);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        // Отправка сообщения админом
        async function sendAdminMessage() {
            if (!currentAdminChat || !currentUser) {
                console.error('No active chat or user');
                showNotification('Чат не выбран', 'error');
                return;
            }
            
            const input = document.getElementById('admin-chat-input');
            if (!input) {
                console.error('Admin chat input not found');
                return;
            }
            
            const message = input.value.trim();
            
            if (!message) {
                showNotification('Введите сообщение', 'error');
                return;
            }
            
            try {
                console.log(`✉️ Admin sending message to chat ${currentAdminChat.id}:`, message);
                
                const result = await makeRequest(`/support/chats/${currentAdminChat.id}/messages`, {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        user_name: 'Администратор',
                        message: message,
                        is_admin: true
                    })
                });
                
                if (result.success) {
                    // Добавляем сообщение в интерфейс
                    const messagesContainer = document.getElementById('admin-chat-messages');
                    if (messagesContainer) {
                        const messageElement = document.createElement('div');
                        messageElement.className = 'message message-admin';
                        messageElement.innerHTML = `
                            <div class="message-text">${escapeHtml(message)}</div>
                            <div class="message-time">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</div>
                        `;
                        messagesContainer.appendChild(messageElement);
                        
                        input.value = '';
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        
                        // Обновляем список чатов
                        loadAdminChats();
                        
                        console.log('✅ Admin message sent successfully');
                        showNotification('Сообщение отправлено', 'success');
                    }
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('❌ Error sending admin message:', error);
                showNotification('Ошибка отправки сообщения: ' + error.message, 'error');
            }
        }

        // Закрытие чата админа
        function closeAdminChat() {
            const chatWindow = document.getElementById('admin-chat-window');
            if (chatWindow) {
                chatWindow.classList.remove('active');
            }
            currentAdminChat = null;
        }
        // Временно добавьте эту функцию для тестирования
async function testPromocodeEndpoint() {
    try {
        console.log('🧪 Testing promocode endpoint...');
        const result = await makeRequest('/api/admin/promocodes/create', {
            method: 'POST',
            body: JSON.stringify({
                adminId: currentUser.id,
                code: 'TEST123',
                maxUses: 10,
                reward: 50,
                expiresAt: null
            })
        });
        console.log('✅ Test result:', result);
    } catch (error) {
        console.error('❌ Test failed:', error);
    }
}

// Вызовите для тестирования
// testPromocodeEndpoint();
// 🔧 ПРОВЕРКА СТРУКТУРЫ БАЗЫ ДАННЫХ
async function checkDatabaseStructure() {
    try {
        console.log('🔍 Checking database structure...');
        const result = await makeRequest('/debug/database');
        console.log('📊 Database structure:', result);
        showNotification('✅ Структура БД проверена', 'success');
    } catch (error) {
        console.error('❌ Database check failed:', error);
        showNotification('❌ Ошибка проверки БД', 'error');
    }
}
        // Архивация чата
        async function archiveChat(chatId) {
            if (!confirm('Переместить чат в архив?')) return;

            try {
                const result = await makeRequest(`/support/chats/${chatId}/archive`, {
                    method: 'PUT',
                    body: JSON.stringify({ adminId: currentUser.id })
                });

                if (result.success) {
                    showNotification('Чат перемещен в архив', 'success');
                    loadAdminChats();
                    loadAllAdminChats();
                } else {
                    showNotification('Ошибка: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error archiving chat:', error);
                showNotification('Ошибка архивации чата', 'error');
            }
        }



// Инициализируем тему при загрузке
initTheme();
        // Восстановление чата из архива
        async function restoreChat(chatId) {
            try {
                const result = await makeRequest(`/support/chats/${chatId}/restore`, {
                    method: 'PUT',
                    body: JSON.stringify({ adminId: currentUser.id })
                });

                if (result.success) {
                    showNotification('Чат восстановлен', 'success');
                    loadAdminChats();
                    loadAllAdminChats();
                    loadArchivedAdminChats();
                } else {
                    showNotification('Ошибка: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error restoring chat:', error);
                showNotification('Ошибка восстановления чата', 'error');
            }
        }

        // Удаление чата
        async function deleteAdminChat(chatId) {
            if (!confirm('Удалить этот чат? Все сообщения будут удалены.')) return;

            try {
                const result = await makeRequest(`/support/chats/${chatId}`, {
                    method: 'DELETE',
                    body: JSON.stringify({ adminId: currentUser.id })
                });

                if (result.success) {
                    showNotification('Чат удален', 'success');
                    // Обновляем все списки чатов
                    loadAdminChats();
                    loadAllAdminChats();
                    loadArchivedAdminChats();
                    
                    // Если удаленный чат был открыт - закрываем его
                    if (currentAdminChat && currentAdminChat.id === chatId) {
                        closeAdminChat();
                    }
                } else {
                    showNotification('Ошибка: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error deleting chat:', error);
                showNotification('Ошибка удаления чата', 'error');
            }
        }
// 🔧 ФУНКЦИЯ ДЛЯ ПОЛНОЙ ОЧИСТКИ АДМИН-ПАНЕЛИ
function resetAdminPanel() {
    console.log('🧹 Resetting admin panel display...');
    
    // Скрываем все секции
    const allSections = document.querySelectorAll('.admin-section');
    allSections.forEach(section => {
        section.style.display = 'none';
    });
    
    // Скрываем контейнер созданных заданий
    const tasksContainer = document.getElementById('admin-tasks-list-container');
    if (tasksContainer) {
        tasksContainer.style.display = 'none';
    }
    
    console.log('✅ Admin panel reset complete');
}

        // Функция для воспроизведения звука при начислении средств
        function playMoneySound() {
            try {
                // Создаем простой звук средствами браузера
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('Audio not supported');
            }
        }
// Обработчик Enter для поля ввода имени администратора
function initAdminInputHandlers() {
    const usernameInput = document.getElementById('new-admin-username');
    if (usernameInput) {
        usernameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addNewAdmin();
            }
        });
    }
}

// Инициализация после загрузки DOM
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAdminInputHandlers);
} else {
    initAdminInputHandlers();
}
        // 🔧 ЭКСПОРТ ФУНКЦИЙ
        window.showTaskCategory = showTaskCategory;
        window.loadUserTasksForCategory = loadUserTasksForCategory;
        window.displayUserTasksForCategory = displayUserTasksForCategory;
        window.openAdminChat = openAdminChat;
        window.closeChat = closeChat;
        window.sendMessageToAdmin = sendMessageToAdmin;
        window.openTaskModal = openTaskModal;
        window.startTask = startTask;
        window.closeModal = closeModal;
        window.showBalanceModal = showBalanceModal;
        window.showPrices = showPrices;
        window.openAdminChatFromPrices = openAdminChatFromPrices;
        window.goToProfile = goToProfile;
        window.copyReferralLink = copyReferralLink;
        window.submitWithdraw = submitWithdraw;
        window.showMainTab = showMainTab;
        window.showTasksTab = showTasksTab;
        window.showProfileTab = showProfileTab;
        window.showAdminTab = showAdminTab;
        window.showHowItWorksPage = showHowItWorksPage;
        window.showAboutPage = showAboutPage;
        window.showWithdrawPage = showWithdrawPage;
        window.showAdminSection = showAdminSection;
        window.addNewPost = addNewPost;
        window.addTask = addTask;
        window.deletePost = deletePost;
        window.deleteTask = deleteTask;
        window.sendAdminMessage = sendAdminMessage;
        window.closeAdminChat = closeAdminChat;
        window.submitTaskCompletion = submitScreenshot;
        window.deleteAdminChat = deleteAdminChat;
        window.archiveChat = archiveChat;
        window.restoreChat = restoreChat;
        window.showChatTab = showChatTab;
        window.handleLike = handleLike;
        window.handleDislike = handleDislike;
        window.showTaskConfirmation = showTaskConfirmation;
        window.showScreenshotUpload = showScreenshotUpload;
        window.showCancelConfirmation = showCancelConfirmation;
        window.submitScreenshot = submitScreenshot;
        window.cancelTask = cancelTask;
        window.loadTaskVerifications = loadTaskVerifications;
        window.openVerificationModal = openVerificationModal;
        window.approveVerification = approveVerification;
        window.rejectVerification = rejectVerification;
        window.goBackToProfile = goBackToProfile;
        window.loadAdminChats = loadAdminChats;
        window.loadAllAdminChats = loadAllAdminChats;
        window.loadArchivedAdminChats = loadArchivedAdminChats;
        window.openAdminChatWindow = openAdminChatWindow;
        window.requestWithdraw = requestWithdraw;
        // 🔧 ЭКСПОРТ ФУНКЦИЙ
window.showAdminAdminsSection = showAdminAdminsSection;
window.loadAdminsList = loadAdminsList;
window.addNewAdmin = addNewAdmin;
window.removeAdmin = removeAdmin;
// 🔧 ЭКСПОРТ ФУНКЦИЙ ДЛЯ УПРАВЛЕНИЯ АДМИНАМИ
window.showAdminAdminsSection = showAdminAdminsSection;
window.loadAdminsList = loadAdminsList;
window.addNewAdmin = addNewAdmin;
window.removeAdmin = removeAdmin;
window.showAdminSection = showAdminSection;
// 🔧 ЭКСПОРТ ФУНКЦИЙ ДЛЯ УПРАВЛЕНИЯ АДМИНАМИ
window.showAdminAdminsSection = showAdminAdminsSection;
window.loadAdminsList = loadAdminsList;
window.addNewAdmin = addNewAdmin;
window.removeAdmin = removeAdmin;
window.showAdminSection = showAdminSection;
window.refreshUserData = refreshUserData;
window.showAdminAdminsSection = showAdminAdminsSection;
window.loadAdminsList = loadAdminsList;
window.addNewAdmin = addNewAdmin;
window.removeAdmin = removeAdmin;
window.showAdminSection = showAdminSection;
window.refreshUserData = refreshUserData;
window.checkAdminRights = checkAdminRights;
// 🔧 ФУНКЦИИ ДЛЯ УПРАВЛЕНИЯ АДМИНАМИ
// 🔧 ЭКСПОРТ ФУНКЦИЙ ДЛЯ УПРАВЛЕНИЯ АДМИНАМИ
window.showAdminAdminsSection = showAdminAdminsSection;
window.loadAdminsList = loadAdminsList;
window.addNewAdmin = addNewAdmin;
window.removeAdmin = removeAdmin;
window.showAdminSection = showAdminSection;

// 🔧 ЭКСПОРТ НОВЫХ ФУНКЦИЙ
window.refreshAdminRights = refreshAdminRights;
window.debugAdminRights = debugAdminRights;


// Показать секцию управления админами
function showAdminAdminsSection() {
    showAdminSection('admins');
    loadAdminsList();
}

// Загрузка списка админов
async function loadAdminsList() {
    console.log('🔄 Loading admins list...');
    
    if (!currentUser || parseInt(currentUser.id) !== ADMIN_ID) {
        console.log('❌ User is not main admin');
        return;
    }
    
    try {
        const result = await makeRequest(`/admin/admins-list?adminId=${currentUser.id}`);
        
        if (result.success) {
            displayAdminsList(result.admins);
        } else {
            showNotification('Ошибка загрузки списка админов: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('❌ Error loading admins list:', error);
        showNotification('Ошибка загрузки списка админов', 'error');
    }
}

// Отображение списка админов
function displayAdminsList(admins) {
    const container = document.getElementById('admins-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!admins || admins.length === 0) {
        container.innerHTML = `
            <div class="no-tasks" style="text-align: center; padding: 30px;">
                <div style="font-size: 48px; margin-bottom: 16px;">👥</div>
                <div>Нет администраторов</div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">
                    Добавьте первого администратора
                </div>
            </div>
        `;
        return;
    }
    
    admins.forEach(admin => {
        const adminElement = document.createElement('div');
        adminElement.className = 'admin-task-item';
        
        const isMainAdmin = parseInt(admin.user_id) === ADMIN_ID;
        const joinDate = new Date(admin.created_at).toLocaleDateString('ru-RU');
        const fullName = `${admin.first_name} ${admin.last_name || ''}`.trim();
        const displayName = fullName || `Пользователь ${admin.user_id}`;
        
        adminElement.innerHTML = `
            <div class="admin-task-header">
                <div class="admin-task-title">
                    ${displayName}
                    ${isMainAdmin ? ' <span style="color: var(--gold);">(Главный админ)</span>' : ''}
                </div>
                ${!isMainAdmin ? `
                    <div class="admin-task-actions">
                        <button class="admin-task-delete" onclick="removeAdmin(${admin.user_id})">
                            🗑️ Удалить
                        </button>
                    </div>
                ` : ''}
            </div>
            <div class="admin-task-description">
                @${admin.username} • ID: ${admin.user_id} • Добавлен: ${joinDate}
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: ${admin.is_admin ? 'var(--success)' : 'var(--error)'};">
                ${admin.is_admin ? '✅ Права администратора активны' : '❌ Права администратора не активны'}
            </div>
            
            <!-- Статистика нанятого админа -->
            ${!isMainAdmin ? `
                <div style="margin-top: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                    <h5 style="margin-bottom: 8px;">📊 Статистика админа:</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                        <div>📝 Посты: <strong>${admin.posts_count || 0}</strong></div>
                        <div>📋 Задания: <strong>${admin.tasks_count || 0}</strong></div>
                        <div>✅ Проверки: <strong>${admin.verifications_count || 0}</strong></div>
                        <div>💬 Ответов: <strong>${admin.support_count || 0}</strong></div>
                        <div>💳 Выплат: <strong>${admin.payments_count || 0}</strong></div>
                    </div>
                </div>
                
                <!-- Управление правами -->
                <div style="margin-top: 10px;">
                    <h6 style="margin-bottom: 6px;">🔧 Права доступа:</h6>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        <label style="font-size: 12px;">
                            <input type="checkbox" ${admin.can_posts ? 'checked' : ''} onchange="updateAdminPermissions(${admin.user_id}, 'posts', this.checked)"> 📝 Посты
                        </label>
                        <label style="font-size: 12px;">
                            <input type="checkbox" ${admin.can_tasks ? 'checked' : ''} onchange="updateAdminPermissions(${admin.user_id}, 'tasks', this.checked)"> 📋 Задания
                        </label>
                        <label style="font-size: 12px;">
                            <input type="checkbox" ${admin.can_verification ? 'checked' : ''} onchange="updateAdminPermissions(${admin.user_id}, 'verification', this.checked)"> ✅ Проверка
                        </label>
                        <label style="font-size: 12px;">
                            <input type="checkbox" ${admin.can_support ? 'checked' : ''} onchange="updateAdminPermissions(${admin.user_id}, 'support', this.checked)"> 💬 Поддержка
                        </label>
                        <label style="font-size: 12px;">
                            <input type="checkbox" ${admin.can_payments ? 'checked' : ''} onchange="updateAdminPermissions(${admin.user_id}, 'payments', this.checked)"> 💳 Оплаты
                        </label>
                    </div>
                </div>
            ` : ''}
        `;
        
        container.appendChild(adminElement);
    });
}

async function addNewAdmin() {
    console.log('🔍 DEBUG addNewAdmin START');
    
    const usernameInput = document.getElementById('new-admin-username');
    const messageDiv = document.getElementById('admin-form-message');
    const submitBtn = document.getElementById('add-admin-btn');
    
    if (!usernameInput || !messageDiv) {
        console.error('❌ Required elements not found');
        showNotification('Ошибка: элементы формы не найдены', 'error');
        return;
    }
    
    let username = usernameInput.value.trim();
    
    // 🔧 ОЧИСТКА USERNAME: убираем @ если пользователь его ввел
    if (username.startsWith('@')) {
        username = username.substring(1);
        usernameInput.value = username; // Обновляем поле
    }
    
    console.log('👤 Processing username:', username);
    
    // Валидация
    if (!username) {
        messageDiv.innerHTML = '<span style="color: var(--error);">Введите Telegram username пользователя!</span>';
        return;
    }
    
    if (username.length < 3) {
        messageDiv.innerHTML = '<span style="color: var(--error);">Username должен содержать минимум 3 символа</span>';
        return;
    }
    
    // Проверяем права доступа
    if (!currentUser) {
        messageDiv.innerHTML = '<span style="color: var(--error);">Пользователь не авторизован</span>';
        return;
    }
    
    if (parseInt(currentUser.id) !== ADMIN_ID) {
        messageDiv.innerHTML = '<span style="color: var(--error);">Только главный администратор может добавлять админов!</span>';
        console.log('❌ Not main admin:', { currentUserId: currentUser.id, ADMIN_ID });
        return;
    }
    
    // Показываем загрузку
    submitBtn.disabled = true;
    submitBtn.textContent = 'Добавляем...';
    messageDiv.innerHTML = '<span style="color: var(--warning);">Добавляем администратора...</span>';
    
    try {
        const requestData = {
            adminId: currentUser.id,
            username: username
        };
        
        console.log('📤 Sending request:', requestData);
        
        const result = await makeRequest('/api/admin/add-admin', {
            method: 'POST',
            body: JSON.stringify(requestData)
        });
        
        console.log('📨 Server response:', result);
        
        if (result.success) {
            messageDiv.innerHTML = `<span style="color: var(--success);">${result.message}</span>`;
            usernameInput.value = ''; // Очищаем поле ввода
            
            // Обновляем список админов
            setTimeout(() => {
                loadAdminsList();
            }, 1000);
            
            showNotification(result.message, 'success');
            
        } else {
            messageDiv.innerHTML = `<span style="color: var(--error);">Ошибка: ${result.error}</span>`;
            showNotification('Ошибка: ' + result.error, 'error');
        }
        
    } catch (error) {
        console.error('💥 Error adding admin:', error);
        
        let errorMessage = 'Ошибка при добавлении админа';
        if (error.message.includes('404')) {
            errorMessage = 'Ошибка: не найден. Сервер недоступен.';
        } else if (error.message.includes('Failed to fetch')) {
            errorMessage = 'Ошибка сети. Проверьте подключение к интернету.';
        } else {
            errorMessage = error.message;
        }
        
        messageDiv.innerHTML = `<span style="color: var(--error);">${errorMessage}</span>`;
        showNotification(errorMessage, 'error');
    } finally {
        // Восстанавливаем кнопку
        submitBtn.disabled = false;
        submitBtn.textContent = '➕ Добавить администратора';
        console.log('🔍 DEBUG addNewAdmin END');
    }
}
async function checkServerConnection() {
    try {
        const response = await fetch(API_BASE_URL + '/api/health');
        if (response.ok) {
            console.log('✅ Сервер доступен');
            return true;
        }
    } catch (error) {
        console.error('❌ Сервер недоступен:', error);
        showNotification('Сервер недоступен. Проверьте подключение.', 'error');
        return false;
    }
}

// Удаление админа
async function removeAdmin(targetAdminId) {
    if (!currentUser || parseInt(currentUser.id) !== ADMIN_ID) {
        showNotification('Только главный администратор может удалять админов!', 'error');
        return;
    }
    
    if (!confirm('Вы уверены, что хотите удалить этого администратора?')) {
        return;
    }
    
    try {
        const result = await makeRequest('/admin/remove-admin', {
            method: 'POST',
            body: JSON.stringify({
                adminId: currentUser.id,
                targetAdminId: targetAdminId
            })
        });
        
        if (result.success) {
            showNotification(result.message, 'success');
            loadAdminsList();
        } else {
            showNotification('Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('❌ Error removing admin:', error);
        showNotification('Ошибка удаления админа: ' + error.message, 'error');
    }
}

// Обновление прав доступа админа
async function updateAdminPermissions(adminId, permission, enabled) {
    try {
        const result = await makeRequest('/admin/update-permissions', {
            method: 'POST',
            body: JSON.stringify({
                adminId: currentUser.id,
                targetAdminId: adminId,
                permission: permission,
                enabled: enabled
            })
        });
        
        if (result.success) {
            showNotification('Права доступа обновлены', 'success');
        } else {
            showNotification('Ошибка обновления прав: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Update permissions error:', error);
        showNotification('Ошибка обновления прав доступа', 'error');
    }
}
function setupAdminPanel() {
    if (!currentUser) return;
    
    const isMainAdmin = parseInt(currentUser.id) === ADMIN_ID;
    const adminsBtn = document.getElementById('admins-btn');
    
    if (adminsBtn) {
        adminsBtn.style.display = isMainAdmin ? 'block' : 'none';
    }
    
    console.log('✅ Admin panel setup complete');
}


// Принудительное обновление данных пользователя
async function refreshUserData() {
    if (!currentUser) return;
    
    try {
        console.log('🔄 Refreshing user data...');
        
        const result = await makeRequest('/admin/refresh-rights', {
            method: 'POST',
            body: JSON.stringify({
                userId: currentUser.id
            })
        });
        
        if (result.success) {
            // Обновляем текущего пользователя
            Object.assign(currentUser, result.user);
            
            // Обновляем отображение
            displayUserProfile();
            updateAdminPanel(); // Обновляем админ-панель
            
            console.log('✅ User data refreshed:', currentUser);
            showNotification('Права администратора обновлены!', 'success');
        }
    } catch (error) {
        console.error('❌ Error refreshing user data:', error);
    }
}

// Удаление админа
// Удаление админа - ИСПРАВЛЕННАЯ ВЕРСИЯ
async function removeAdmin(targetAdminId) {
    console.log('🗑️ Removing admin:', targetAdminId);
    
    if (!currentUser || parseInt(currentUser.id) !== ADMIN_ID) {
        showNotification('Только главный администратор может удалять админов!', 'error');
        return;
    }
    
    if (!confirm('Вы уверены, что хотите удалить этого администратора?')) {
        return;
    }
    
    try {
        const result = await makeRequest('/admin/remove-admin', {
            method: 'POST',
            body: JSON.stringify({
                adminId: currentUser.id,
                targetAdminId: targetAdminId
            })
        });
        
        if (result.success) {
            showNotification(result.message, 'success');
            loadAdminsList(); // Обновляем список админов
        } else {
            showNotification('Ошибка: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('❌ Error removing admin:', error);
        showNotification('Ошибка удаления админа: ' + error.message, 'error');
    }
}
// Обновите функцию showAdminSection чтобы включить новую секцию

// Обработчик Enter для поля ввода имени администратора
function initAdminInputHandlers() {
    const usernameInput = document.getElementById('new-admin-username');
    if (usernameInput) {
        usernameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addNewAdmin();
            }
        });
    }
}

// Инициализация после загрузки DOM
document.addEventListener('DOMContentLoaded', function() {
    initAdminInputHandlers();
});
// Принудительное обновление прав администратора
// Принудительное обновление прав администратора
// 🔧 Функция для принудительного обновления прав администратора
async function refreshAdminRights() {
    if (!currentUser) return;
    
    try {
        console.log('🔄 Refreshing admin rights for user:', currentUser.id);
        
        const result = await makeRequest('/admin/refresh-rights', {
            method: 'POST',
            body: JSON.stringify({
                userId: currentUser.id
            })
        });
        
        if (result.success) {
            // Обновляем текущего пользователя
            Object.assign(currentUser, result.user);
            
            console.log('✅ Admin rights refreshed:', {
                id: currentUser.id,
                is_admin: currentUser.is_admin,
                isMainAdmin: parseInt(currentUser.id) === ADMIN_ID
            });
            
            // Перепроверяем права администратора
            checkAdminRights();
            
        } else {
            // Если новый endpoint не работает, используем старый
            const fallbackResult = await makeRequest(`/user/${currentUser.id}`);
            if (fallbackResult.success) {
                Object.assign(currentUser, fallbackResult.profile);
                checkAdminRights();
            }
        }
    } catch (error) {
        console.error('Ошибка обновления прав администратора:', error);
        // Пробуем старый метод как запасной вариант
        try {
            const fallbackResult = await makeRequest(`/user/${currentUser.id}`);
            if (fallbackResult.success) {
                Object.assign(currentUser, fallbackResult.profile);
                checkAdminRights();
            }
        } catch (fallbackError) {
            console.error('Fallback method also failed:', fallbackError);
        }
    }
}
// Функция для отладки прав администратора
function debugAdminRights() {
    console.log('🐛 DEBUG Admin Rights:');
    console.log('- Current User:', currentUser);
    console.log('- ADMIN_ID:', ADMIN_ID);
    console.log('- is_admin:', currentUser?.is_admin);
    console.log('- isMainAdmin:', parseInt(currentUser?.id) === ADMIN_ID);
    console.log('- Admin Nav Visible:', document.getElementById('admin-nav-item')?.style.display);
}

// Вызов для отладки
setTimeout(debugAdminRights, 2000);
// Функция для тестирования прав администратора (только клиентская)
async function testAdminRights() {
    if (!currentUser) {
        console.log('❌ No current user for rights test');
        return;
    }
    
    try {
        const result = await makeRequest(`/admin/debug-rights?userId=${currentUser.id}`);
        console.log('🔍 Admin rights debug:', result);
    } catch (error) {
        console.error('Error testing admin rights:', error);
    }
}

// Вызов для отладки (только на клиенте)
setTimeout(() => {
    if (typeof currentUser !== 'undefined') {
        testAdminRights();
    }
}, 3000);


function updateLevelProgress() {
    if (!currentUser) return;
    
    const completedTasks = currentUser.tasks_completed || 0;
    const levelInfo = calculateUserLevel(completedTasks);
    
    console.log('📊 Level progress calculation:', {
        completedTasks,
        level: levelInfo.level,
        percentage: levelInfo.progressPercentage
    });
    
    const progressBar = document.getElementById('level-progress-bar');
    const levelCount = document.querySelector('.level-count');
    const levelInfoText = document.querySelector('.level-info');
    
    if (progressBar) {
        progressBar.style.width = `${levelInfo.progressPercentage}%`;
    }
    
    if (levelCount) {
        if (levelInfo.isMaxLevel) {
            levelCount.textContent = "Макс. уровень!";
        } else {
            const nextLevelRequirement = LEVEL_SYSTEM[levelInfo.level + 1].tasksRequired;
            const tasksNeeded = nextLevelRequirement - completedTasks;
            levelCount.textContent = `${completedTasks}/${nextLevelRequirement}`;
        }
    }
    
    if (levelInfoText) {
        if (levelInfo.isMaxLevel) {
            levelInfoText.innerHTML = `🎉 Поздравляем! Вы достигли максимального уровня!`;
        } else {
            const nextLevelRequirement = LEVEL_SYSTEM[levelInfo.level + 1].tasksRequired;
            const tasksNeeded = nextLevelRequirement - completedTasks;
            levelInfoText.innerHTML = 
                `Уровень <strong>${levelInfo.levelName}</strong> • ` +
                `До следующего уровня: <strong>${tasksNeeded}</strong> заданий`;
        }
    }
}

// 🔧 ОБНОВЛЕННЫЙ HTML ДЛЯ ОТОБРАЖЕНИЯ ПРОГРЕССА УРОВНЯ БЕЗ БОНУСОВ
function createLevelProgressHTML() {
    const completedTasks = currentUser?.tasks_completed || 0;
    const levelInfo = calculateUserLevel(completedTasks);
    
    const tasksForThisLevel = levelInfo.tasksForNextLevel - LEVEL_SYSTEM[levelInfo.level].tasksRequired;
    const currentProgress = levelInfo.currentLevelTasks;
    
    return `
        <div class="level-progress">
            <div class="level-header">
                <div class="level-title">Система уровней</div>
                <div class="level-badge">Уровень ${levelInfo.level}</div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="level-progress-bar" style="width: ${levelInfo.progressPercentage}%"></div>
                </div>
                <div class="progress-stats">
                    <span>${currentProgress} выполнено</span>
                    <span>${levelInfo.progressPercentage}%</span>
                    <span>${tasksForThisLevel} до след. уровня</span>
                </div>
            </div>
            
            <div class="level-info">
                ${levelInfo.isMaxLevel ? 
                    '🎉 Поздравляем! Вы достигли максимального уровня!' : 
                    `Текущий уровень: <strong>${levelInfo.levelName}</strong> • ` +
                    `Прогресс: <strong>${currentProgress}/${tasksForThisLevel}</strong> заданий`
                }
            </div>
        </div>
    `;
}

// Обновление информации об уровне в профиле
function updateProfileLevelInfo(levelInfo) {
    const levelStats = document.querySelectorAll('.profile-stat');
    if (levelStats.length >= 4) {
        // Обновляем статистику выполненных заданий
        levelStats[1].querySelector('.stat-value').textContent = levelInfo.completedTasks;
        
        // Добавляем отображение уровня если есть место
        const levelDisplay = document.getElementById('profile-level-display');
        if (!levelDisplay) {
            const levelHtml = `
                <div class="profile-stat" id="profile-level-display">
                    <div class="stat-value">${levelInfo.level}</div>
                    <div class="stat-label">Уровень</div>
                </div>
            `;
            // Вставляем перед статистикой качества
            if (levelStats[3] && levelStats[3].parentNode) {
                levelStats[3].insertAdjacentHTML('beforebegin', levelHtml);
            }
        } else {
            levelDisplay.querySelector('.stat-value').textContent = levelInfo.level;
        }
    }
}



// Уведомление о повышении уровня
function showLevelUpNotification(level, levelName, bonus) {
    const notificationHTML = `
        <div class="level-up-notification" style="
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--gold-gradient);
            color: #000;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 10000;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);
            border: 3px solid rgba(255, 255, 255, 0.3);
            animation: levelUpPop 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 300px;
            width: 90%;
        ">
            <div style="font-size: 48px; margin-bottom: 15px;">🎉</div>
            <div style="font-size: 24px; font-weight: 800; margin-bottom: 10px;">
                Новый уровень!
            </div>
            <div style="font-size: 20px; font-weight: 700; margin-bottom: 15px;">
                ${levelName}
            </div>
            <div style="font-size: 16px; margin-bottom: 20px;">
                Уровень <strong>${level}</strong> достигнут!
            </div>
            <div style="
                background: rgba(255, 255, 255, 0.3);
                padding: 10px;
                border-radius: 10px;
                font-weight: 700;
                margin-bottom: 15px;
            ">
                🎁 Бонус: +${bonus}⭐
            </div>
            <button onclick="this.parentElement.remove()" style="
                background: #000;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 10px;
                font-weight: 600;
                cursor: pointer;
            ">
                Отлично!
            </button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', notificationHTML);
    
    // Автоматическое скрытие через 5 секунд
    setTimeout(() => {
        const notification = document.querySelector('.level-up-notification');
        if (notification) {
            notification.remove();
        }
    }, 5000);
}

// CSS анимация для уведомления
const levelUpStyles = `
    <style>
        @keyframes levelUpPop {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        .level-progress {
            background: var(--card-bg);
            border-radius: 14px;
            padding: 16px;
            margin: 16px 0;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        .level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .level-title {
            font-weight: 600;
            font-size: 16px;
        }
        
        .level-badge {
            background: var(--purple-gradient);
            color: white;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .progress-container {
            margin-bottom: 8px;
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .level-rewards {
            margin-top: 12px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 3px solid var(--gold);
        }
        
        .reward-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .reward-item:last-child {
            margin-bottom: 0;
        }
    </style>
`;

// Добавляем стили в документ
document.head.insertAdjacentHTML('beforeend', levelUpStyles);

// 🔧 ОБНОВЛЕННЫЙ HTML ДЛЯ ОТОБРАЖЕНИЯ ПРОГРЕССА УРОВНЯ

function createLevelProgressHTML() {
    const completedTasks = currentUser?.tasks_completed || 0;
    const levelInfo = calculateUserLevel(completedTasks);
    
    return `
        <div class="level-progress">
            <div class="level-header">
                <div class="level-title">Система уровней</div>
                <div class="level-badge">Уровень ${levelInfo.level}</div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="level-progress-bar" style="width: ${levelInfo.progressPercentage}%"></div>
                </div>
                <div class="progress-stats">
                    <span>${levelInfo.completedTasks} выполнено</span>
                    <span>${levelInfo.progressPercentage}%</span>
                    <span>${levelInfo.tasksForNextLevel} до след. уровня</span>
                </div>
            </div>
            
            <div class="level-info">
                ${levelInfo.isMaxLevel ? 
                    '🎉 Поздравляем! Вы достигли максимального уровня!' : 
                    `Текущий уровень: <strong>${levelInfo.levelName}</strong> • ` +
                    `До уровня ${levelInfo.level + 1}: <strong>${levelInfo.tasksForNextLevel - completedTasks}</strong> заданий`
                }
            </div>
            
            ${!levelInfo.isMaxLevel ? `
                <div class="level-rewards">
                    <div class="reward-item">
                        <span>🎁</span>
                        <span>Бонус за следующий уровень: <strong>+${levelInfo.nextLevelBonus}⭐</strong></span>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}

// 🔧 ИНИЦИАЛИЗАЦИЯ СИСТЕМЫ УРОВНЕЙ

// Обновляем отображение уровня при загрузке профиля
function initializeLevelSystem() {
    updateLevelProgress();
    
    // Обновляем прогресс каждые 30 секунд
    setInterval(updateLevelProgress, 30000);
}


// 🔧 ОБНОВЛЕННАЯ ФУНКЦИЯ ПРИ ЗАВЕРШЕНИИ ЗАДАНИЯ
async function onTaskCompleted(userId, taskPrice) {
    try {
        // Получаем актуальные данные пользователя
        const result = await makeRequest(`/user/${userId}`);
        if (result.success) {
            // Обновляем текущего пользователя
            currentUser = { ...currentUser, ...result.profile };
            
            // Обновляем интерфейс
            displayUserProfile();
            
            console.log('✅ Данные пользователя обновлены после выполнения задания');
        }
    } catch (error) {
        console.error('Ошибка обновления данных после выполнения задания:', error);
    }
}

// 🔧 ЭКСПОРТ ФУНКЦИЙ
window.updateLevelProgress = updateLevelProgress;
window.calculateUserLevel = calculateUserLevel;
window.initializeLevelSystem = initializeLevelSystem;
function clearTaskImage() {
    const input = document.getElementById('task-image-input');
    const preview = document.getElementById('task-image-preview');
    const placeholder = document.querySelector('.upload-placeholder');
    
    if (input) input.value = '';
    if (preview) {
        preview.src = '';
        preview.style.display = 'none';
    }
    if (placeholder) {
        placeholder.style.display = 'block';
    }
    
    currentTaskImage = null;
    
    // Сбрасываем стили области загрузки
    const area = document.getElementById('image-upload-area');
    if (area) {
        area.style.borderColor = '';
        area.style.background = '';
    }
}

// Инициализация drag and drop
initImageUploadDragDrop();
function initImageUploadDragDrop() {
    const area = document.getElementById('image-upload-area');
    if (!area) return;
    
    area.addEventListener('dragover', function(e) {
        e.preventDefault();
        area.classList.add('dragover');
        area.style.borderColor = 'var(--accent)';
        area.style.background = 'rgba(99, 102, 241, 0.05)';
    });
    
    area.addEventListener('dragleave', function(e) {
        e.preventDefault();
        area.classList.remove('dragover');
        area.style.borderColor = '';
        area.style.background = '';
    });
    
    area.addEventListener('drop', function(e) {
        e.preventDefault();
        area.classList.remove('dragover');
        area.style.borderColor = '';
        area.style.background = '';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const fileInput = document.getElementById('task-image-input');
            if (fileInput) {
                // Создаем новый DataTransfer для установки файла
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(files[0]);
                fileInput.files = dataTransfer.files;
                
                // Запускаем превью
                previewTaskImage(fileInput);
            }
        }
    });
    
    // Обработчик клика на область загрузки
    area.addEventListener('click', function() {
        const fileInput = document.getElementById('task-image-input');
        if (fileInput) {
            fileInput.click();
        }
    });
}
    
    // Обработчик клика на область загрузки
    area.addEventListener('click', function() {
        const fileInput = document.getElementById('task-image-input');
        if (fileInput) {
            fileInput.click();
        }
    });

async function addTaskWithImage() {
    console.log('🎯 Starting add task with image...');
    
    try {
        // Получаем значения из формы
        const taskData = {
            title: document.getElementById('admin-task-title').value.trim(),
            description: document.getElementById('admin-task-description').value.trim(),
            price: document.getElementById('admin-task-price').value,
            category: document.getElementById('admin-task-category').value,
            time_to_complete: document.getElementById('admin-task-time').value || '5-10 минут',
            difficulty: document.getElementById('admin-task-difficulty').value,
            people_required: document.getElementById('admin-task-people').value || 1,
            task_url: document.getElementById('admin-task-url').value || '',
            created_by: currentUser.id
        };

        console.log('📋 Form data collected:', taskData);

        // Валидация
        if (!taskData.title.trim()) {
            showNotification('Введите название задания!', 'error');
            return;
        }
        if (!taskData.description.trim()) {
            showNotification('Введите описание задания!', 'error');
            return;
        }
        if (!taskData.price) {
            showNotification('Введите цену задания!', 'error');
            return;
        }

        const price = parseFloat(taskData.price);
        if (isNaN(price) || price <= 0) {
            showNotification('Цена должна быть положительным числом!', 'error');
            return;
        }

        // Создаем FormData для отправки с файлом
        const formData = new FormData();
        
        // Добавляем текстовые данные
        Object.keys(taskData).forEach(key => {
            formData.append(key, taskData[key]);
        });
        
        // Добавляем изображение если есть
        if (currentTaskImage) {
            formData.append('image', currentTaskImage);
            console.log('📸 Adding image to form data:', currentTaskImage.name);
        } else {
            console.log('ℹ️ No image selected');
        }

        console.log('📤 Sending task with image...');

        // Отправляем запрос
        const response = await fetch('/api/tasks-with-image', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        console.log('📨 Server response:', result);

        if (result.success) {
            showNotification('✅ Задание с фото успешно создано!', 'success');
            
            // Очищаем форму
            clearTaskForm();
            clearTaskImage();
            
            // Обновляем списки
            setTimeout(() => {
                loadAdminTasks();
                loadTasks();
            }, 1000);
            
        } else {
            throw new Error(result.error || 'Unknown server error');
        }

    } catch (error) {
        console.error('💥 Error in addTaskWithImage:', error);
        showNotification(`❌ Ошибка создания задания: ${error.message}`, 'error');
    }
}
function clearTaskForm() {
    const formFields = [
        'admin-task-title', 
        'admin-task-description', 
        'admin-task-price', 
        'admin-task-time', 
        'admin-task-people', 
        'admin-task-url'
    ];
    
    formFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) element.value = '';
    });
    
    // Сбрасываем выпадающие списки
    document.getElementById('admin-task-category').value = 'subscribe';
    document.getElementById('admin-task-difficulty').value = 'Легкая';
    
    // Очищаем изображение
    clearTaskImage();
}
function createTaskCard(task, category, index) {
    const taskElement = document.createElement('div');
    taskElement.className = 'task-card';
    taskElement.style.animationDelay = `${index * 0.1}s`;
    
    const peopleRequired = task.people_required || 1;
    const completedCount = task.completed_count || 0;
    const availableTasks = Math.max(0, peopleRequired - completedCount);
    
    // Определяем текст кнопки в зависимости от категории
    let buttonHtml = '';
    switch(category) {
        case 'new':
            buttonHtml = `<button class="task-btn" onclick="event.stopPropagation(); openTaskModal(${task.id})">
                Начать задание
            </button>`;
            break;
        case 'confirmation':
            buttonHtml = `<button class="task-btn" onclick="event.stopPropagation(); showTaskConfirmation(${task.id}, '${escapeHtml(task.title)}')">
                Отправить на проверку
            </button>`;
            break;
        case 'completed':
            buttonHtml = `<div class="task-status completed">✅ Выполнено</div>`;
            break;
        case 'rejected':
            buttonHtml = `<div class="task-status rejected">❌ Отклонено</div>`;
            break;
    }
    
    taskElement.innerHTML = `
        ${availableTasks > 0 && category === 'new' ? `<div class="task-availability">${availableTasks} осталось</div>` : ''}
        
        <div class="task-header">
            <div class="task-title">${escapeHtml(task.title)}</div>
            <div class="task-price">${task.price} ⭐</div>
        </div>
        
        <div class="task-meta">
            <div class="task-category">${formatCategory(task.category)}</div>
            ${task.difficulty ? `<div class="task-difficulty ${task.difficulty.toLowerCase()}">${task.difficulty}</div>` : ''}
        </div>
        
        <div class="task-description">
            ${escapeHtml(task.description.length > 100 ? task.description.substring(0, 100) + '...' : task.description)}
        </div>
        
        ${peopleRequired > 1 && category === 'new' ? `
            <div class="task-progress">
                <div class="task-progress-bar" style="width: ${Math.min(100, (completedCount / peopleRequired) * 100)}%"></div>
            </div>
            <div class="task-progress-text">
                Выполнено: ${completedCount}/${peopleRequired}
            </div>
        ` : ''}
        
        <div class="task-footer">
            <div class="task-time">
                ${category === 'confirmation' ? 'Ожидает подтверждения' : 
                  category === 'completed' ? 'Выполнено' :
                  category === 'rejected' ? 'Отклонено' : 
                  task.time_to_complete || '5-10 минут'}
            </div>
            ${buttonHtml}
        </div>
    `;
    
    // Добавляем обработчик клика только для новых заданий
    if (category === 'new') {
        taskElement.addEventListener('click', function(e) {
            if (!e.target.classList.contains('task-btn')) {
                openTaskModal(task.id);
            }
        });
    }
    
    return taskElement;
}
// Функция для отображения заданий с изображениями
function displayTasksWithImages(tasks, category) {
    const container = document.getElementById(category + '-tasks');
    if (!container) return;

    container.innerHTML = '';

    if (!tasks || tasks.length === 0) {
        container.innerHTML = `
            <div class="no-tasks" style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; margin-bottom: 16px;">📝</div>
                <div>Заданий пока нет</div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">
                    Новые задания появятся позже
                </div>
            </div>
        `;
        return;
    }

    tasks.forEach((task, index) => {
        const taskElement = createTaskCardWithImage(task, category, index);
        container.appendChild(taskElement);
    });
}
// В index.html - обновим функцию создания карточки задания для отклоненных
function createTaskCardWithImage(task, category, index) {
    const taskElement = document.createElement('div');
    taskElement.className = 'task-card task-card-with-image';
    if (category === 'rejected') {
        taskElement.classList.add('rejected');
    }
    taskElement.style.animationDelay = `${index * 0.1}s`;
    
    // Добавляем data-attribute для отладки
    taskElement.setAttribute('data-task-id', task.id);
    taskElement.setAttribute('data-task-title', task.title);
    
    console.log(`🎨 Creating task card: ${task.id} - "${task.title}"`);
    
    const hasImage = task.image_url && task.image_url !== '';
    const peopleRequired = task.people_required || 1;
    const completedCount = task.completed_count || 0;
    const availableTasks = Math.max(0, peopleRequired - completedCount);
    
    let imageHtml = '';
    if (hasImage) {
        imageHtml = `
            <div class="task-image-container">
                <img src="${task.image_url}" alt="${escapeHtml(task.title)}" 
                     class="task-image"
                     onerror="this.onerror=null; this.style.display='none';">
                ${availableTasks > 0 && category === 'new' ? `<div class="task-badge">${availableTasks} осталось</div>` : ''}
            </div>
        `;
    } else {
        imageHtml = `
            ${availableTasks > 0 && category === 'new' ? `<div class="task-availability">${availableTasks} осталось</div>` : ''}
        `;
    }
    
    let buttonHtml = '';
    switch(category) {
        case 'new':
            buttonHtml = `<button class="task-btn" onclick="event.stopPropagation(); openTaskModal(${task.id})">
                Начать задание
            </button>`;
            break;
        case 'confirmation':
            buttonHtml = `<button class="task-btn" onclick="event.stopPropagation(); showTaskConfirmation(${task.id}, '${escapeHtml(task.title)}')">
                Отправить на проверку
            </button>`;
            break;
        case 'completed':
            buttonHtml = `<div class="task-status completed">✅ Выполнено</div>`;
            break;
        case 'rejected':
            buttonHtml = `<div class="task-status rejected">❌ Отклонено</div>`;
            break;
    }
    
    taskElement.innerHTML = `
        ${imageHtml}
        
        <div class="task-header">
            <div class="task-title">${escapeHtml(task.title)}</div>
            <div class="task-price">${task.price} ⭐</div>
        </div>
        
        <div class="task-meta">
            <div class="task-category">${formatCategory(task.category)}</div>
            ${task.difficulty ? `<div class="task-difficulty ${task.difficulty.toLowerCase()}">${task.difficulty}</div>` : ''}
        </div>
        
        <div class="task-description">
            ${escapeHtml(task.description.length > 100 ? task.description.substring(0, 100) + '...' : task.description)}
        </div>
        
        ${peopleRequired > 1 && category === 'new' ? `
            <div class="task-progress">
                <div class="task-progress-bar" style="width: ${Math.min(100, (completedCount / peopleRequired) * 100)}%"></div>
            </div>
            <div class="task-progress-text">
                Выполнено: ${completedCount}/${peopleRequired}
            </div>
        ` : ''}
        
        <div class="task-footer">
            <div class="task-time">
                ${category === 'confirmation' ? 'Ожидает подтверждения' : 
                  category === 'completed' ? 'Выполнено' :
                  category === 'rejected' ? 'Отклонено' : 
                  task.time_to_complete || '5-10 минут'}
            </div>
            ${buttonHtml}
        </div>
    `;
    
    if (category === 'new') {
        taskElement.addEventListener('click', function(e) {
            if (!e.target.classList.contains('task-btn')) {
                openTaskModal(task.id);
            }
        });
    }
       if (category === 'rejected') {
        taskElement.innerHTML = createRejectedTaskHTML(task);
    } else {
        // ... стандартный код для других категорий ...
    }
    
    return taskElement;
}
// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    initImageUploadDragDrop();
});


// 🔧 ЭКСПОРТ НОВЫХ ФУНКЦИЙ
window.addNewPostAsAdmin = addNewPostAsAdmin;
window.deletePostAsAdmin = deletePostAsAdmin;
window.addTaskAsAdmin = addTaskAsAdmin;
window.deleteTaskAsAdmin = deleteTaskAsAdmin;
window.loadTaskVerificationsForAdmin = loadTaskVerificationsForAdmin;
window.openAdminSupportChat = openAdminSupportChat;
window.approveVerification = approveVerification;
window.rejectVerification = rejectVerification;
window.closeModal = closeModal;
// 🔧 ЭКСПОРТ НОВЫХ ФУНКЦИЙ
window.requestWithdraw = requestWithdraw;
window.loadWithdrawHistory = loadWithdrawHistory;
window.loadWithdrawalRequests = loadWithdrawalRequests;
window.completeWithdrawal = completeWithdrawal;
window.showAdminSection = showAdminSection;
// 🔧 ЭКСПОРТ НОВЫХ ФУНКЦИЙ
window.fixTasksLayout = fixTasksLayout;
window.addTask = addTask;
window.showAdminSection = showAdminSection;
window.loadAdminTasks = loadAdminTasks;
// 🔧 ЭКСПОРТ ФУНКЦИЙ
window.addTask = addTask;
// 🔧 ЭКСПОРТ ФУНКЦИЙ ДЛЯ УПРАВЛЕНИЯ АДМИНАМИ
window.showAdminAdminsSection = showAdminAdminsSection;
window.loadAdminsList = loadAdminsList;
window.addNewAdmin = addNewAdmin;
window.removeAdmin = removeAdmin;
window.updateAdminPermissions = updateAdminPermissions;
// Добавьте в конец файла
window.loadWithdrawalRequests = loadWithdrawalRequests;
window.completeWithdrawal = completeWithdrawal;
window.showAdminPaymentsSection = showAdminPaymentsSection;

// 🔧 ЭКСПОРТ НОВЫХ ФУНКЦИЙ
window.deleteVerification = deleteVerification;
</script>
</body>
</html>
