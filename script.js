window.addEventListener("load",(function(){document.querySelector(".main-content").classList.add("loaded")})),setTimeout((function(){document.querySelector(".main-content").classList.add("loaded")}),1e3);let allAdminTasks=[],currentAdminSearchTerm="";function initAdminTaskSearch(){const e=document.getElementById("admin-task-search");if(e){let t;e.addEventListener("input",(function(e){clearTimeout(t);const n=e.target.value.trim();t=setTimeout((()=>{(n.length>=2||0===n.length)&&searchAdminTasks(n)}),300)})),e.addEventListener("keypress",(function(t){"Enter"===t.key&&searchAdminTasks(e.value.trim())}))}}async function searchAdminTasks(e=""){console.log("üîç Searching admin tasks:",e),currentAdminSearchTerm=e;const t=document.querySelector(".admin-search-clear");t&&(t.style.display=e?"block":"none");try{if(!currentUser)return void showNotification("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω","error");const t=document.getElementById("admin-search-results");t&&(t.innerHTML='<span style="color: var(--warning);">‚è≥ –ò—â–µ–º –∑–∞–¥–∞–Ω–∏—è...</span>');const n=new URLSearchParams;n.append("adminId",currentUser.id),e&&n.append("search",e);const s=`/api/admin/tasks/search?${n.toString()}`;console.log("üì° Search URL:",s);const o=await makeRequest(s);if(!o.success)throw new Error(o.error||"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞");allAdminTasks=o.tasks||[],displayAdminTasks(allAdminTasks,o.statistics),updateSearchResultsInfo(e,allAdminTasks.length)}catch(e){console.error("‚ùå Search error:",e);const t=document.getElementById("admin-search-results");t&&(t.innerHTML=`<span style="color: var(--error);">‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${e.message}</span>`),showNotification("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∑–∞–¥–∞–Ω–∏–π","error")}}function updateSearchResultsInfo(e,t){const n=document.getElementById("admin-search-results");n&&(n.innerHTML=e?0===t?`\n                    <span style="color: var(--text-secondary);">\n                        üîç –ü–æ –∑–∞–ø—Ä–æ—Å—É "<strong>${escapeHtml(e)}</strong>" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ\n                    </span>\n                `:`\n                    <span style="color: var(--success);">\n                        ‚úÖ –ù–∞–π–¥–µ–Ω–æ <strong>${t}</strong> –∑–∞–¥–∞–Ω–∏–π –ø–æ –∑–∞–ø—Ä–æ—Å—É "<strong>${escapeHtml(e)}</strong>"\n                    </span>\n                `:"")}function clearAdminTaskSearch(){const e=document.getElementById("admin-task-search");e&&(e.value="",searchAdminTasks(""))}async function loadAdminTasks(){if(console.log("üéØ Loading admin tasks..."),!currentUser)return void console.log("‚ùå No user");const e=document.getElementById("admin-tasks-list");if(!e)return void console.log("‚ùå Container not found");const t=document.getElementById("admin-tasks-list-container");t&&(t.style.display="block"),e.innerHTML='\n        <div style="text-align: center; padding: 40px 20px;">\n            <div class="loading-spinner">‚è≥</div>\n            <div style="margin-top: 16px;">–ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è –∞–¥–º–∏–Ω–∞...</div>\n        </div>\n    ';try{const[e,t]=await Promise.all([makeRequest(`/api/admin/tasks-stats?adminId=${currentUser.id}`),makeRequest(`/api/admin/simple-tasks?adminId=${currentUser.id}`)]);if(console.log("üìä Stats result:",e),console.log("üìä Tasks result:",t),!t.success||!e.success)throw new Error(t.error||e.error||"Unknown error");displayAdminTasks(t.tasks||[],e.statistics)}catch(t){console.error("üí• Error:",t),e.innerHTML=`\n            <div style="text-align: center; padding: 40px 20px; color: var(--error);">\n                <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>\n                <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π</div>\n                <div style="font-size: 12px; margin-top: 8px;">${t.message}</div>\n                \n                <div style="margin-top: 20px;">\n                    <button class="btn btn-primary" onclick="loadAdminTasks()">\n                        üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞\n                    </button>\n                </div>\n            </div>\n        `}}function displayAdminTasks(e,t){const n=document.getElementById("admin-tasks-list");if(!n)return void console.error("‚ùå Admin tasks container not found!");if(console.log(`üéØ Displaying ${e?e.length:0} admin tasks`),n.innerHTML="",t){const e=t.completed_tasks||0,s=t.rejected_tasks||0,o=t.pending_tasks||0,i=(t.active_tasks,`\n            <div class="admin-stats" style="margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border);">\n                <h4 style="margin-bottom: 10px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–¥–∞–Ω–∏–π</h4>\n                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; font-size: 12px;">\n                    <div style="text-align: center;">\n                        <div style="font-size: 18px; font-weight: bold; color: var(--accent);">${t.total_tasks||0}</div>\n                        <div>–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π</div>\n                    </div>\n                    <div style="text-align: center;">\n                        <div style="font-size: 18px; font-weight: bold; color: var(--success);">${e}</div>\n                        <div>‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>\n                    </div>\n                    <div style="text-align: center;">\n                        <div style="font-size: 18px; font-weight: bold; color: var(--error);">${s}</div>\n                        <div>‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>\n                    </div>\n                    <div style="text-align: center;">\n                        <div style="font-size: 18px; font-weight: bold; color: var(--warning);">${o}</div>\n                        <div>‚è≥ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>\n                    </div>\n                </div>\n            </div>\n        `);n.innerHTML=i}if(!e||0===e.length)return void(n.innerHTML+='\n            <div class="no-tasks" style="text-align: center; padding: 40px 20px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border);">\n                <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>\n                <div style="font-size: 18px; margin-bottom: 8px;">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</div>\n                <div style="font-size: 14px; color: var(--text-secondary);">\n                    –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É –≤—ã—à–µ\n                </div>\n            </div>\n        ');n.innerHTML+='\n        <div class="task-filter" style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">\n            <label style="font-weight: 600; color: var(--text-primary);">–§–∏–ª—å—Ç—Ä:</label>\n            <select id="admin-task-filter" onchange="filterAdminTasks()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">\n                <option value="all">–í—Å–µ –∑–∞–¥–∞–Ω–∏—è</option>\n                <option value="active">–¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ</option>\n                <option value="completed">–¢–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>\n                <option value="my">–ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è</option>\n            </select>\n            <button onclick="loadAdminTasks()" class="btn btn-primary" style="padding: 8px 12px; font-size: 12px;">\n                üîÑ –û–±–Ω–æ–≤–∏—Ç—å\n            </button>\n        </div>\n    ';const s=document.createElement("div");s.id="admin-tasks-container",n.appendChild(s),window.currentAdminTasks=e,renderAdminTasks(e)}function renderAdminTasks(e){const t=document.getElementById("admin-tasks-container");if(!t)return;t.innerHTML="";const n=document.getElementById("admin-task-filter")?.value||"all",s=e.filter((e=>{switch(n){case"active":return"active"===e.status;case"completed":return"completed"===e.status;case"my":return e.created_by===currentUser.id;default:return!0}}));console.log(`üéØ Rendering ${s.length} filtered tasks (filter: ${n})`),0!==s.length?s.forEach((e=>{const n=createAdminTaskElement(e);t.appendChild(n)})):t.innerHTML='\n            <div class="no-tasks" style="text-align: center; padding: 40px 20px;">\n                <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>\n                <div>–ó–∞–¥–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>\n                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">\n                    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä\n                </div>\n            </div>\n        '}function createAdminTaskElement(e){const t=document.createElement("div");t.className="admin-task-item",t.style.cssText=`\n        background: var(--card-bg);\n        border: 1px solid ${"completed"===e.status?"var(--success)":"var(--border)"};\n        border-radius: 12px;\n        padding: 16px;\n        margin-bottom: 12px;\n        opacity: ${"completed"===e.status?.8:1};\n    `;const n=e.completed_count||0,s=e.people_required||1,o=Math.min(100,n/s*100),i="completed"===e.status;return t.innerHTML=`\n        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">\n            <div style="flex: 1;">\n                <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">\n                    ${e.title}\n                    ${i?' <span style="color: var(--success); font-size: 12px;">(–ó–∞–≤–µ—Ä—à–µ–Ω–æ)</span>':""}\n                </div>\n                <div style="color: var(--text-secondary); font-size: 14px;">${e.description}</div>\n            </div>\n            <div style="display: flex; gap: 8px; align-items: center;">\n                <div style="font-size: 20px; color: var(--gold); font-weight: 600;">\n                    ${e.price} ‚≠ê\n                </div>\n                ${i?"":`\n                    <button class="admin-task-delete" onclick="deleteTask(${e.id})" style="background: var(--error); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer;">\n                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å\n                    </button>\n                `}\n            </div>\n        </div>\n        \n        <div style="display: flex; gap: 12px; font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">\n            <span>üìÅ ${e.category||"general"}</span>\n            <span>üë• ${s} —á–µ–ª.</span>\n            <span>‚ö° ${e.difficulty||"–õ–µ–≥–∫–∞—è"}</span>\n            <span>üïí ${e.time_to_complete||"5-10 –º–∏–Ω—É—Ç"}</span>\n            <span style="color: ${i?"var(--success)":"var(--accent)"};">\n                ${i?"‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ":"üü¢ –ê–∫—Ç–∏–≤–Ω–æ"}\n            </span>\n        </div>\n        \n        \x3c!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è --\x3e\n        <div style="margin: 10px 0;">\n            <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">\n                <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${n}/${s}</span>\n                <span>${Math.round(o)}%</span>\n            </div>\n            <div class="progress-bar">\n                <div class="progress-fill" style="width: ${o}%; background: ${i?"var(--success)":"var(--accent)"};"></div>\n            </div>\n        </div>\n        \n        \x3c!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–¥–∞–Ω–∏—è–º --\x3e\n        <div style="display: flex; gap: 15px; font-size: 11px; color: var(--text-secondary);">\n            <span>‚úÖ ${n} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>\n            <span>‚ùå ${e.rejected_count||0} –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>\n            <span>‚è≥ ${e.pending_count||0} –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span>\n        </div>\n        \n        ${e.image_url?`\n            <div style="margin-top: 10px;">\n                <img src="${e.image_url}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è" style="max-width: 200px; border-radius: 8px; border: 1px solid var(--border);">\n            </div>\n        `:""}\n        \n        <div style="margin-top: 8px; font-size: 11px; color: var(--text-secondary);">\n            –°–æ–∑–¥–∞–Ω–æ: ${new Date(e.created_at).toLocaleDateString("ru-RU")}\n            ${e.last_completed?` ‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: ${new Date(e.last_completed).toLocaleDateString("ru-RU")}`:""}\n        </div>\n    `,t}function scrollToTop(){window.scrollTo({top:0,behavior:"smooth"})}function showWithdrawPage(){hideAllTabs(),document.getElementById("withdraw-page").classList.add("active"),updateWithdrawPage(),loadWithdrawHistory(),setTimeout(scrollToTop,100)}function showHowItWorksPage(){hideAllTabs(),document.getElementById("how-it-works-page").classList.add("active"),setTimeout(scrollToTop,100)}function showAboutPage(){hideAllTabs(),document.getElementById("about-page").classList.add("active"),setTimeout(scrollToTop,100)}function goBackToProfile(){showProfileTab(),setTimeout(scrollToTop,100)}function showProfileTab(){hideAllTabs(),document.getElementById("profile-tab").classList.add("active"),updateNavState("profile"),setTimeout((()=>{updateUserData(),syncUserProfile(),checkReferralEarnings()}),100)}function showMainTab(){hideAllTabs(),document.getElementById("main-tab").classList.add("active"),updateNavState("main"),setTimeout(scrollToTop,100)}function showTasksTab(){console.log("üéØ –ü–ï–†–ï–•–û–î –ù–ê –í–ö–õ–ê–î–ö–£ –ó–ê–î–ê–ù–ò–ô"),hideAllTabs();const e=document.getElementById("tasks-tab");e&&e.classList.add("active"),updateNavState("tasks"),setTimeout(fixMobileLayout,100),setTimeout((()=>{showTaskCategory("new"),scrollToTop()}),150)}function showAdminTab(){const e=parseInt(currentUser?.id)===ADMIN_ID;currentUser&&(e||!0===currentUser?.is_admin)?(hideAllTabs(),document.getElementById("admin-tab").classList.add("active"),updateNavState("admin"),resetAdminPanel(),showAdminSection("posts"),setTimeout(scrollToTop,100),e&&setTimeout((()=>{loadAdminsList()}),500)):showNotification("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!","error")}function fixMobileScroll(){"scrollRestoration"in history&&(history.scrollRestoration="manual"),window.addEventListener("load",(function(){setTimeout(scrollToTop,100)}))}document.addEventListener("DOMContentLoaded",(function(){initAdminTaskSearch()})),window.searchAdminTasks=searchAdminTasks,window.clearAdminTaskSearch=clearAdminTaskSearch,window.initAdminTaskSearch=initAdminTaskSearch,document.querySelectorAll(".profile-action").forEach((e=>{e.addEventListener("click",(function(){setTimeout(scrollToTop,50)}))})),fixMobileScroll();class PerformanceOptimizer{constructor(){this.lazyLoadObserver=null,this.init()}init(){this.setupLazyLoading(),this.debounceScrollEvents(),this.optimizeAnimations()}setupLazyLoading(){"IntersectionObserver"in window&&(this.lazyLoadObserver=new IntersectionObserver((e=>{e.forEach((e=>{if(e.isIntersecting){const t=e.target;t.src=t.dataset.src,t.classList.remove("lazy"),this.lazyLoadObserver.unobserve(t)}}))})),document.querySelectorAll("img[data-src]").forEach((e=>{this.lazyLoadObserver.observe(e)})))}debounceScrollEvents(){let e;window.addEventListener("scroll",(()=>{clearTimeout(e),e=setTimeout((()=>{}),100)}),{passive:!0})}optimizeAnimations(){document.querySelectorAll(".card, .task-card").forEach((e=>{e.style.transform="translateZ(0)"}))}}new PerformanceOptimizer,console.log("üåê Current URL:",window.location.href);const API_BASE_URL=window.location.origin;console.log("üîó API Base URL:",API_BASE_URL);const tg=window.Telegram.WebApp,ADMIN_ID=8036875641;let currentUser=null,currentChatId=null,currentAdminChat=null,selectedTaskId=null,allTasks=[],chatUpdateInterval=null,currentUserTaskId=null,currentVerificationId=null,currentTaskImage=null;const LEVEL_SYSTEM={1:{tasksRequired:10,name:"–ù–æ–≤–∏—á–æ–∫"},2:{tasksRequired:20,name:"–£—á–µ–Ω–∏–∫"},3:{tasksRequired:30,name:"–û–ø—ã—Ç–Ω—ã–π"},4:{tasksRequired:40,name:"–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª"},5:{tasksRequired:50,name:"–≠–∫—Å–ø–µ—Ä—Ç"},6:{tasksRequired:60,name:"–ú–∞—Å—Ç–µ—Ä"},7:{tasksRequired:70,name:"–ì—É—Ä—É"},8:{tasksRequired:80,name:"–õ–µ–≥–µ–Ω–¥–∞"},9:{tasksRequired:90,name:"–ò–º–ø–µ—Ä–∞—Ç–æ—Ä"},10:{tasksRequired:100,name:"–ë–æ–≥ –∑–∞–¥–∞–Ω–∏–π"}};function calculateUserLevel(e){let t=1,n=(LEVEL_SYSTEM[1].tasksRequired,0);for(let n=1;n<=Object.keys(LEVEL_SYSTEM).length&&e>=LEVEL_SYSTEM[n].tasksRequired;n++)t=n;for(let n=1;n<=Object.keys(LEVEL_SYSTEM).length&&e>=LEVEL_SYSTEM[n].tasksRequired;n++)t=n;const s=LEVEL_SYSTEM[t].tasksRequired;if(t<Object.keys(LEVEL_SYSTEM).length){const o=e-s,i=LEVEL_SYSTEM[t+1].tasksRequired-s;n=Math.min(100,Math.round(o/i*100))}else n=100;return{level:t,levelName:LEVEL_SYSTEM[t].name,completedTasks:e,progressPercentage:n,isMaxLevel:t===Object.keys(LEVEL_SYSTEM).length}}function previewTaskImage(e){if(!e.files||!e.files[0])return;const t=e.files[0],n=document.getElementById("task-image-preview"),s=document.querySelector(".upload-placeholder");if(currentTaskImage=t,!t.type.startsWith("image/"))return showNotification("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ","error"),void(currentTaskImage=null);if(t.size>5242880)return showNotification("–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB","error"),void(currentTaskImage=null);const o=new FileReader;o.onload=function(e){n.src=e.target.result,n.style.display="block",s&&(s.style.display="none")},o.onerror=function(){showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è","error"),currentTaskImage=null},o.readAsDataURL(t)}function initializePromocodes(){["promocode-code","promocode-max-uses","promocode-reward","promocode-expires","promocode-form-message","create-promocode-btn"].forEach((e=>{const t=document.getElementById(e);console.log(`üîç ${e}:`,t?"FOUND":"NOT FOUND")}))}async function makeRequest(e,t={}){const n=new AbortController,s=setTimeout((()=>n.abort()),3e4);try{let o;o=e.startsWith("http")?e:e.startsWith("/api")?API_BASE_URL+e:API_BASE_URL+"/api"+(e.startsWith("/")?e:"/"+e),console.log(`üöÄ Making ${t.method||"GET"} request to: ${o}`);const i=await fetch(o,{headers:{"Content-Type":"application/json",...t.headers},signal:n.signal,...t});if(clearTimeout(s),!i.ok){const e=await i.text();throw console.error(`‚ùå HTTP ${i.status}: ${e}`),403===i.status?new Error("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤."):404===i.status?new Error("–†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω."):500===i.status?new Error("–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."):502===i.status?new Error("–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º. –°–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."):new Error(`HTTP ${i.status}: ${i.statusText}`)}const a=await i.json();return console.log("üì® Response received:",a),a}catch(e){throw clearTimeout(s),console.error("üí• Request failed:",e),"AbortError"===e.name?new Error("–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞. –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç."):"TypeError"===e.name?new Error("–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É."):e.message.includes("Failed to fetch")?new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ."):e}}async function debugAdminEndpoints(){console.log("üîç Debugging admin endpoints...");try{const e=await makeRequest("/api/health");console.log("‚úÖ Health endpoint:",e);const t={adminId:currentUser.id,username:"testuser"};console.log("üß™ Testing admin endpoint with:",t);const n=await fetch(API_BASE_URL+"/api/admin/add-admin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(console.log("üì° Endpoint response status:",n.status),console.log("üì° Endpoint response ok:",n.ok),!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`)}catch(e){console.error("‚ùå Endpoint debug failed:",e)}}async function testEndpoints(){if(currentUser&&parseInt(currentUser.id)===ADMIN_ID)try{console.log("üß™ Testing endpoints...");const e=await makeRequest("/health");console.log("‚úÖ Health endpoint:",e);const t=await makeRequest("/debug/endpoints");console.log("‚úÖ Debug endpoints:",t);const n=await makeRequest(`/admin/admins-list?adminId=${currentUser.id}`);console.log("‚úÖ Admins list endpoint:",n)}catch(e){console.error("‚ùå Endpoint test failed:",e)}}async function initializeTelegramUser(){try{if(tg.initDataUnsafe&&tg.initDataUnsafe.user){const e=tg.initDataUnsafe.user;currentUser={id:e.id,firstName:e.first_name||"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",lastName:e.last_name||"",username:e.username||`user_${e.id}`,photoUrl:e.photo_url||"",isAdmin:parseInt(e.id)===ADMIN_ID};try{const e=await makeRequest("/user/auth",{method:"POST",body:JSON.stringify({user:currentUser})});e.success&&Object.assign(currentUser,e.user)}catch(e){console.log("Auth endpoint not available, continuing with basic user data")}initializeApp()}else console.log("Telegram user data not available"),initializeTestUser()}catch(e){console.error("Error initializing Telegram user:",e),initializeTestUser()}}function debugWithdrawalSystem(){console.log("üêõ DEBUG Withdrawal System:"),console.log("- currentUser:",currentUser),console.log("- isAdmin:",currentUser?.is_admin),loadWithdrawalRequests().then((()=>{console.log("‚úÖ Withdrawal requests loaded")})).catch((e=>{console.error("‚ùå Error loading withdrawal requests:",e)}))}function updateVerificationInterface(){"block"===document.getElementById("admin-verification-section").style.display&&loadTaskVerifications()}async function addNewPostAsAdmin(){if(!currentUser)return;const e=prompt("–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞:");if(!e)return;const t=prompt("–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞:");if(!t)return;if(await checkAdminAccess(currentUser.id))try{const n=await makeRequest("/posts",{method:"POST",body:JSON.stringify({title:e,content:t,author:currentUser.firstName,authorId:currentUser.id})});n.success?(showNotification("–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!","success"),loadMainPagePosts()):showNotification("–û—à–∏–±–∫–∞: "+n.error,"error")}catch(e){console.error("Error adding post:",e),showNotification("–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞","error")}else showNotification("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç—ã!","error")}async function deletePostAsAdmin(e){if(!currentUser)return;if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?"))return;if(await checkAdminAccess(currentUser.id))try{const t=await makeRequest(`/posts/${e}`,{method:"DELETE",body:JSON.stringify({authorId:currentUser.id})});t.success?(showNotification("–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!","success"),loadMainPagePosts()):showNotification("–û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("Error deleting post:",e),showNotification("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞","error")}else showNotification("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –ø–æ—Å—Ç—ã!","error")}async function addTaskAsAdmin(){if(!currentUser)return;const e=prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:");if(!e)return;const t=prompt("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:");if(!t)return;const n=prompt("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –∑–∞–¥–∞–Ω–∏—è (–≤ —Ä—É–±–ª—è—Ö):");if(!n)return;if(await checkAdminAccess(currentUser.id))try{const s=await makeRequest("/tasks",{method:"POST",body:JSON.stringify({title:e,description:t,price:parseFloat(n),created_by:currentUser.id})});s.success?(showNotification("–ó–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!","success"),loadTasks()):showNotification("–û—à–∏–±–∫–∞: "+s.error,"error")}catch(e){console.error("Error adding task:",e),showNotification("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è","error")}else showNotification("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è!","error")}async function deleteTaskAsAdmin(e){if(!currentUser)return;if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ?"))return;if(await checkAdminAccess(currentUser.id))try{const t=await makeRequest(`/tasks/${e}`,{method:"DELETE",body:JSON.stringify({adminId:currentUser.id})});t.success?(showNotification("–ó–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!","success"),loadTasks()):showNotification("–û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("Error deleting task:",e),showNotification("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è","error")}else showNotification("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –∑–∞–¥–∞–Ω–∏—è!","error")}async function loadTaskVerificationsForAdmin(){if(!currentUser)return;if(await checkAdminAccess(currentUser.id))try{const e=await makeRequest(`/admin/task-verifications?adminId=${currentUser.id}`);e.success&&showVerificationsModal(e.verifications)}catch(e){console.error("Error loading verifications:",e)}}function showVerificationsModal(e){let t='\n        <div class="modal active" id="verifications-modal">\n            <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">\n                <div class="modal-header">\n                    <div class="modal-title">‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏–π</div>\n                    <button class="modal-close" onclick="closeModal(\'verifications-modal\')">√ó</button>\n                </div>\n                <div class="modal-body">\n    ';e&&0!==e.length?e.forEach((e=>{t+=`\n                <div class="verification-item" style="margin-bottom: 16px; padding: 16px; border: 1px solid var(--border); border-radius: 12px;">\n                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 12px;">\n                        <div style="flex: 1;">\n                            <div style="font-weight: 600;">${e.user_name}</div>\n                            <div style="color: var(--text-secondary); font-size: 14px;">${e.task_title}</div>\n                        </div>\n                        <div style="font-weight: 700; color: var(--gold);">${e.task_price} ‚≠ê</div>\n                    </div>\n                    <div style="margin-bottom: 12px;">\n                        <img src="${e.screenshot_url}" alt="–°–∫—Ä–∏–Ω—à–æ—Ç" style="width: 100%; border-radius: 8px;">\n                    </div>\n                    <div style="display: flex; gap: 8px;">\n                        <button class="btn btn-success" style="flex: 1;" onclick="approveVerification(${e.id})">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>\n                        <button class="btn btn-error" style="flex: 1;" onclick="rejectVerification(${e.id})">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>\n                    </div>\n                </div>\n            `})):t+="",t+="\n                </div>\n            </div>\n        </div>\n    ",document.body.insertAdjacentHTML("beforeend",t)}function optimizeImages(){document.querySelectorAll("img").forEach((e=>{e.loading="lazy",e.width>300&&(e.style.maxWidth="100%",e.style.height="auto")}))}function compressImage(e,t=5e4){return new Promise((n=>{if(e.size<=t)return void n(e);const s=document.createElement("canvas"),o=s.getContext("2d"),i=new Image;i.onload=()=>{const a=Math.sqrt(t/e.size);s.width=i.width*a,s.height=i.height*a,o.drawImage(i,0,0,s.width,s.height),s.toBlob(n,"image/jpeg",.7)},i.src=URL.createObjectURL(e)}))}document.addEventListener("DOMContentLoaded",(function(){console.log("‚úÖ DOM loaded, initializing promocodes..."),initializePromocodes()})),setTimeout((()=>{currentUser&&parseInt(currentUser.id)===ADMIN_ID&&testEndpoints()}),5e3),document.addEventListener("DOMContentLoaded",(function(){console.log("Initializing LinkGold app..."),void 0!==tg?(tg.expand(),tg.ready(),initializeTelegramUser()):(console.log("Telegram Web App context not available"),initializeTestUser())})),setInterval(updateVerificationInterface,3e4);class DOMOptimizer{constructor(){this.updateQueue=[],this.batchTimeout=null}batchUpdate(e){this.updateQueue.push(e),this.batchTimeout||(this.batchTimeout=setTimeout((()=>{this.flushUpdates()}),16))}flushUpdates(){const e=document.createDocumentFragment();this.updateQueue.forEach((t=>{t(e)})),document.getElementById("tasks-container").appendChild(e),this.updateQueue=[],this.batchTimeout=null}createElement(e,t={}){const n=document.createElement(e);return Object.keys(t).forEach((e=>{n[e]=t[e]})),n}}const apiCache=new Map;async function cachedRequest(e,t={}){const n=JSON.stringify({url:e,options:t});if(apiCache.has(n))return apiCache.get(n);const s=await fetch(e,t),o=await s.json();return apiCache.set(n,o),setTimeout((()=>apiCache.delete(n)),3e4),o}function memoize(e){const t=new Map;return function(...n){const s=JSON.stringify(n);if(t.has(s))return t.get(s);const o=e.apply(this,n);return t.set(s,o),o}}class PriorityLoader{constructor(){this.priorityQueue=[]}addCritical(e,t=0){this.priorityQueue.push({resource:e,priority:t}),this.priorityQueue.sort(((e,t)=>t.priority-e.priority))}async load(){for(const e of this.priorityQueue)await this.loadResource(e.resource)}async loadResource(e){"script"===e.type?await this.loadScript(e.url):"data"===e.type&&await this.loadData(e.url)}}async function openAdminSupportChat(){if(!currentUser)return;if(await checkAdminAccess(currentUser.id))try{const e=await makeRequest(`/support/chats?adminId=${currentUser.id}`);e.success&&showAdminChatsModal(e.chats)}catch(e){console.error("Error loading admin chats:",e)}else showNotification("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –≤ —á–∞—Ç–µ!","error")}function showAdminChatsModal(e){let t='\n        <div class="modal active" id="admin-chats-modal">\n            <div class="modal-content" style="max-width: 500px;">\n                <div class="modal-header">\n                    <div class="modal-title">üí¨ –ß–∞—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</div>\n                    <button class="modal-close" onclick="closeModal(\'admin-chats-modal\')">√ó</button>\n                </div>\n                <div class="modal-body">\n    ';e&&0!==e.length?e.forEach((e=>{t+=`\n                <div class="chat-item" style="display: flex; align-items: center; padding: 12px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 8px; cursor: pointer;" onclick="openChatWithUser(${e.id})">\n                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--purple-gradient); display: flex; align-items: center; justify-content: center; margin-right: 12px; color: white; font-weight: 600;">\n                        ${e.user_name?e.user_name.charAt(0).toUpperCase():"U"}\n                    </div>\n                    <div style="flex: 1;">\n                        <div style="font-weight: 600;">${e.user_name}</div>\n                        <div style="color: var(--text-secondary); font-size: 12px;">${e.last_message||"–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"}</div>\n                    </div>\n                </div>\n            `})):t+='\n            <div style="text-align: center; padding: 40px;">\n                <div style="font-size: 48px; margin-bottom: 16px;">üí¨</div>\n                <div>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</div>\n            </div>\n        ',t+="\n                </div>\n            </div>\n        </div>\n    ",document.body.insertAdjacentHTML("beforeend",t)}function updateAdminInterface(){currentUser&&checkAdminAccess(currentUser.id).then((e=>{e&&addAdminButtonsToMainPage()}))}function addAdminButtonsToMainPage(){if(document.getElementById("admin-buttons-container"))return;const e=document.getElementById("main-tab");e&&e.insertAdjacentHTML("beforeend",'\n        <div id="admin-buttons-container" class="card fade-in" style="margin-top: 20px;">\n            <h3 style="margin-bottom: 16px; text-align: center;">‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>\n            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">\n                <button class="btn btn-primary" onclick="addNewPostAsAdmin()">üìù –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç</button>\n                <button class="btn btn-primary" onclick="addTaskAsAdmin()">üìã –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>\n                <button class="btn btn-warning" onclick="loadTaskVerificationsForAdmin()">‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è</button>\n                <button class="btn btn-success" onclick="openAdminSupportChat()">üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å –≤ —á–∞—Ç–∞—Ö</button>\n            </div>\n        </div>\n    ')}async function isUserAdmin(e){try{const t=await pool.query("SELECT is_admin FROM user_profiles WHERE user_id = $1",[e]);return t.rows.length>0&&!0===t.rows[0].is_admin||parseInt(e)===ADMIN_ID}catch(t){return parseInt(e)===ADMIN_ID}}function debugTasksLoading(){console.log("üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò –ó–ê–î–ê–ù–ò–ô:");const e=document.getElementById("tasks-tab"),t=document.getElementById("new-tasks"),n=document.querySelector("#new-tasks.active");if(console.log("- tasks-tab exists:",!!e),console.log("- tasks-tab active:",e?.classList.contains("active")),console.log("- new-tasks container exists:",!!t),console.log("- new-tasks container active:",!!n),console.log("- new-tasks display:",t?.style.display),console.log("- currentUser exists:",!!currentUser),console.log("- allTasks count:",allTasks?.length||0),t){const e=t.getBoundingClientRect();console.log("- new-tasks visible:",e.width>0&&e.height>0)}}async function checkUserIsAdmin(e){try{const t=await makeRequest(`/user/${e}`);return!!t.success&&(!0===t.profile.is_admin||parseInt(e)===ADMIN_ID)}catch(e){return console.error("Admin check error:",e),!1}}function filterTasks(e){console.log("üéØ Filtering tasks by category:",e),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.remove("active")})),event.target.classList.add("active");const t=document.getElementById("task-search").value.trim();loadTasks(t,e)}async function loadTasks(e="",t="all"){try{if(console.log("üéØ START loadTasks with filter:",{search:e,category:t,userId:currentUser?.id,hasUser:!!currentUser}),!currentUser)return console.log("‚ùå No current user, aborting loadTasks"),void showNotification("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω","error");const n=document.getElementById("new-tasks");if(!n)return void console.log("‚ùå new-tasks container not found");n.innerHTML=`\n            <div class="no-tasks" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center;">\n                <div class="loading-spinner">‚è≥</div>\n                <div style="margin-top: 16px;">–ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è...</div>\n                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">\n                    ID: ${currentUser.id}\n                </div>\n            </div>\n        `;const s=new URLSearchParams;s.append("userId",currentUser.id),e&&s.append("search",e),t&&"all"!==t&&s.append("category",t);const o=`/api/tasks?${s.toString()}`;console.log("üì° Request URL:",o);const i=await fetch(API_BASE_URL+o);if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);const a=await i.json();if(console.log("üì® Server response:",a),!a.success)throw new Error(a.error||"Unknown server error");allTasks=a.tasks||[],console.log(`‚úÖ Loaded ${allTasks.length} tasks:`,allTasks.map((e=>({id:e.id,title:e.title})))),displayTasks(allTasks,"new")}catch(e){console.error("üí• loadTasks error:",e);const t=document.getElementById("new-tasks");t&&(t.innerHTML=`\n                <div class="no-tasks" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center;">\n                    <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>\n                    <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π</div>\n                    <div style="font-size: 12px; color: var(--text-secondary); margin: 8px 0;">\n                        ${e.message}\n                    </div>\n                    <button class="btn btn-primary" onclick="loadTasks()" style="margin-top: 16px;">\n                        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞\n                    </button>\n                </div>\n            `),showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π: ${e.message}`,"error")}}async function getUserActiveTasks(){if(!currentUser)return[];try{const e=await fetch(`${API_BASE_URL}/api/user/${currentUser.id}/tasks/active-ids`);if(e.ok){const t=await e.json();if(t.success)return t.taskIds||[]}}catch(e){console.error("Error getting user active tasks:",e)}return[]}function displayFilteredTasks(e,t,n){const s=document.getElementById("new-tasks");if(!s)return void console.error("‚ùå Container not found");s.innerHTML="";let o=e;if(n){const t=n.toLowerCase();o=e.filter((e=>e.title.toLowerCase().includes(t)||e.description.toLowerCase().includes(t)||e.category&&e.category.toLowerCase().includes(t)))}if(!o||0===o.length){let e="–ó–∞–¥–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";return n&&"all"!==t?e=`–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${getCategoryDisplayName(t)}" –ø–æ –∑–∞–ø—Ä–æ—Å—É "${n}"`:n?e=`–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –ø–æ –∑–∞–ø—Ä–æ—Å—É "${n}"`:"all"!==t&&(e=`–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${getCategoryDisplayName(t)}"`),void(s.innerHTML=`\n            <div class="no-tasks" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center;">\n                <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>\n                <div style="font-size: 18px; margin-bottom: 8px;">${e}</div>\n                <div style="font-size: 14px; color: var(--text-secondary);">\n                    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é\n                </div>\n                <button class="btn btn-primary" onclick="clearFilters()" style="margin-top: 16px;">\n                    –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã\n                </button>\n            </div>\n        `)}console.log(`üé® Rendering ${o.length} filtered tasks...`),o.forEach(((e,t)=>{const n=createTaskCardWithImage(e,"new",t);s.appendChild(n)})),showFilterInfo(t,n,o.length)}function showFilterInfo(e,t,n){let s=document.getElementById("filter-info");if(!s){s=document.createElement("div"),s.id="filter-info",s.style.cssText="\n            margin: 10px 0;\n            padding: 10px;\n            background: var(--bg-secondary);\n            border-radius: 8px;\n            font-size: 14px;\n            color: var(--text-secondary);\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        ";const e=document.getElementById("new-tasks");e&&e.parentNode.insertBefore(s,e)}let o="";o="all"!==e&&t?`–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${getCategoryDisplayName(e)} ‚Ä¢ –ü–æ–∏—Å–∫: "${t}"`:"all"!==e?`–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${getCategoryDisplayName(e)}`:t?`–ü–æ–∏—Å–∫: "${t}"`:"–í—Å–µ –∑–∞–¥–∞–Ω–∏—è",s.innerHTML=`\n        <span>${o} ‚Ä¢ –ù–∞–π–¥–µ–Ω–æ: ${n}</span>\n        ${"all"!==e||t?'\n            <button class="btn btn-secondary" onclick="clearFilters()" style="padding: 4px 8px; font-size: 12px;">\n                ‚úï –°–±—Ä–æ—Å–∏—Ç—å\n            </button>\n        ':""}\n    `}function clearFilters(){console.log("üîÑ Clearing all filters");const e=document.getElementById("task-search");e&&(e.value=""),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.remove("active")})),document.querySelector('.filter-btn[data-filter="all"]').classList.add("active");const t=document.getElementById("filter-info");t&&t.remove(),loadTasks()}function getCategoryDisplayName(e){return{all:"–í—Å–µ",social:"–°–æ—Ü—Å–µ—Ç–∏",subscribe:"–ü–æ–¥–ø–∏—Å–∫–∏",view:"–ü—Ä–æ—Å–º–æ—Ç—Ä—ã",comment:"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏",repost:"–†–µ–ø–æ—Å—Ç—ã",other:"–î—Ä—É–≥–æ–µ"}[e]||e}function initializeSearch(){const e=document.getElementById("task-search");if(e){let t;e.addEventListener("input",(function(e){clearTimeout(t);const n=e.target.value.trim();t=setTimeout((()=>{const e=document.querySelector(".filter-btn.active"),t=e?e.getAttribute("data-filter"):"all";loadTasks(n,t)}),300)}))}console.log("‚úÖ Search and filters initialized")}function showTaskCategory(e){console.log("üîÑ Switching to category:",e);const t=document.querySelectorAll(".task-tab"),n=document.querySelectorAll(".tasks-grid");t.forEach((e=>e.classList.remove("active"))),n.forEach((e=>{e.classList.remove("active"),e.style.display="none"}));const s=Array.from(t).find((t=>t.textContent.toLowerCase().includes(getCategoryName(e))));s&&s.classList.add("active");const o=document.getElementById(`${e}-tasks`);if(o)if(o.classList.add("active"),o.style.display="block",console.log(`‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ${e}-tasks –ø–æ–∫–∞–∑–∞–Ω`),"new"===e){const e=document.getElementById("task-search").value.trim(),t=document.querySelector(".filter-btn.active"),n=t?t.getAttribute("data-filter"):"all";loadTasks(e,n)}else loadTasksForCategory(e);else console.error(`‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ${e}-tasks –Ω–µ –Ω–∞–π–¥–µ–Ω`)}async function addNewPostAsAdmin(){if(!currentUser)return void showNotification("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω","error");if(!await checkUserIsAdmin(currentUser.id))return void showNotification("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç—ã!","error");const e=prompt("–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞:");if(!e)return;const t=prompt("–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞:");if(t)try{const n=await makeRequest("/posts",{method:"POST",body:JSON.stringify({title:e,content:t,author:currentUser.firstName,authorId:currentUser.id})});n.success?(showNotification("–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!","success"),loadMainPagePosts()):showNotification("–û—à–∏–±–∫–∞: "+n.error,"error")}catch(e){console.error("Error adding post:",e),showNotification("–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞","error")}}function simpleShowTab(e){document.querySelectorAll(".tab-content").forEach((e=>{e.style.display="none"})),document.getElementById(e).style.display="block"}async function loadEssentialData(){try{const[e,t]=await Promise.all([fetch("/api/user-data").then((e=>e.json())),fetch("/api/essential-tasks").then((e=>e.json()))]);return{userData:e,tasks:t}}catch(e){console.error("Load error:",e)}}async function addTaskAsAdmin(){if(!currentUser)return void showNotification("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω","error");if(!await checkUserIsAdmin(currentUser.id))return void showNotification("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è!","error");const e=prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:");if(!e)return;const t=prompt("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:");if(!t)return;const n=prompt("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –∑–∞–¥–∞–Ω–∏—è (–≤ —Ä—É–±–ª—è—Ö):");if(n)try{const s=await makeRequest("/tasks",{method:"POST",body:JSON.stringify({title:e,description:t,price:parseFloat(n),created_by:currentUser.id})});s.success?(showNotification("–ó–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!","success"),loadTasks()):showNotification("–û—à–∏–±–∫–∞: "+s.error,"error")}catch(e){console.error("Error adding task:",e),showNotification("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è","error")}}function debugAdminRights(){console.log("üêõ DEBUG Admin Rights:"),console.log("- Current User:",currentUser),console.log("- ADMIN_ID:",ADMIN_ID),console.log("- is_admin:",currentUser?.is_admin),console.log("- isMainAdmin:",currentUser?.id===ADMIN_ID.toString()),console.log("- Admin Nav Visible:",document.getElementById("admin-nav-item")?.style.display),console.log("- Admin Panel Visible:",document.getElementById("admin-panel")?.style.display)}function showRetryButton(){const e=document.createElement("button");e.textContent="üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞",e.className="btn btn-primary",e.style.margin="20px auto",e.style.display="block",e.onclick=function(){e.remove(),initializeApp()},document.body.appendChild(e)}function startUserDataAutoUpdate(){if(void 0===currentUser||!currentUser)return console.log("‚ùå currentUser –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"),void setTimeout(startUserDataAutoUpdate,5e3);setInterval((async()=>{if(void 0!==currentUser&&currentUser)try{const e=await makeRequest(`/user/${currentUser.id}`);if(e.success){currentUser.level,currentUser.tasks_completed;currentUser={...currentUser,...e.profile},displayUserProfile(),updateLevelProgress(),console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω—ã")}}catch(e){console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:",e)}else console.log("‚ùå currentUser –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ")}),3e4)}async function updateUserData(){if(currentUser)try{const e=await makeRequest(`/user/${currentUser.id}`);e.success&&(currentUser={...currentUser,...e.profile},displayUserProfile(),console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã:",currentUser.balance))}catch(e){console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:",e)}}function displayUserProfile(){if(!currentUser)return;const e=document.getElementById("user-first-name"),t=document.getElementById("user-username"),n=document.getElementById("user-level"),s=document.getElementById("user-balance-main");if(e){const t=currentUser.lastName?`${currentUser.firstName} ${currentUser.lastName}`:currentUser.firstName;e.textContent=t}t&&(t.textContent=currentUser.username||"username"),n&&(n.textContent=currentUser.level||1);const o=currentUser.balance||0;s&&(s.textContent=`${o} ‚≠ê`);const i=document.getElementById("user-photo");i&&currentUser.photoUrl?(i.src=currentUser.photoUrl,i.alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è",i.style.display="block"):i&&(i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.backgroundColor="#6366f1",i.style.color="white",i.style.fontWeight="bold",i.style.borderRadius="50%",i.textContent=currentUser.firstName?currentUser.firstName.charAt(0).toUpperCase():"U"),updateProfileStats(),updateReferralSystem(),updateLevelProgress();const a=document.getElementById("referral-info");a&&currentUser&&(currentUser.referred_by?a.innerHTML='\n                <div style="background: var(--success-light); padding: 10px; border-radius: 8px; margin: 10px 0;">\n                    <div style="font-size: 14px; color: var(--success);">\n                        üë• –í—ã –ø—Ä–∏—à–ª–∏ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ\n                    </div>\n                    <div style="font-size: 12px; color: var(--text-secondary);">\n                        –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 90% –æ—Ç –∑–∞—Ä–∞–±–æ—Ç–∫–∞, –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π - 10%\n                    </div>\n                </div>\n            ':a.innerHTML='\n                <div style="background: var(--bg-secondary); padding: 10px; border-radius: 8px; margin: 10px 0;">\n                    <div style="font-size: 14px;">\n                        üîó –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ 10% –æ—Ç –∏—Ö –∑–∞—Ä–∞–±–æ—Ç–∫–∞!\n                    </div>\n                </div>\n            ')}function updateProfileStats(){if(!currentUser)return;const e=document.querySelectorAll(".profile-stat .stat-value");e.length>=4&&(e[0].textContent=`${currentUser.balance||0} ‚≠ê`,e[1].textContent=currentUser.tasks_completed||0,e[2].textContent=currentUser.active_tasks||0,e[3].textContent=`${calculateQualityRate()||0}%`)}function calculateQualityRate(){if(!currentUser)return 0;const e=currentUser.tasks_completed||0,t=e+(currentUser.tasks_rejected||0);return 0===t?0:Math.round(e/t*100)}async function updateActiveTasksCount(){if(currentUser)try{const e=await makeRequest(`/user/${currentUser.id}/tasks/active-count`);e.success&&(currentUser.active_tasks=e.count,updateProfileStats())}catch(e){console.error("Error loading active tasks count:",e)}}function updateReferralSystem(){if(!currentUser)return;const e=`https://t.me/LinkGoldMoney_bot?start=${currentUser.referral_code||`ref_${currentUser.id}`}`,t=document.getElementById("referral-link");t&&(t.value=e);const n=document.getElementById("ref-invited"),s=document.getElementById("ref-earned");n&&(n.textContent=currentUser.referral_count||0),s&&(s.textContent=`${currentUser.referral_earned||0} ‚≠ê`);const o=document.querySelector(".referral-info");o&&(o.innerHTML=`\n            üéÅ <strong>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:</strong><br>\n            ‚Ä¢ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç <strong>2‚≠ê</strong> –∑–∞ –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ<br>\n            ‚Ä¢ –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ <strong>90%</strong> –æ—Ç —Å–≤–æ–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∫–∞<br>\n            ‚Ä¢ –ü—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π –ø–æ–ª—É—á–∞–µ—Ç <strong>10%</strong> –æ—Ç –≤–∞—à–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∫–∞<br>\n            ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –∫–∞–∂–¥–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è<br>\n            ‚Ä¢ –í–∞—à –∑–∞—Ä–∞–±–æ—Ç–æ–∫ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: <strong>${currentUser.referral_earned||0} ‚≠ê</strong><br>\n            ‚Ä¢ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –¥—Ä—É–∑–µ–π: <strong>${currentUser.referral_count||0}</strong><br><br>\n            üîó –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É —ç—Ç—É —Å—Å—ã–ª–∫—É –≤ Telegram\n        `)}async function checkReferralEarnings(){if(currentUser)try{const e=await makeRequest(`/api/user/${currentUser.id}/referral-earnings`);e.success&&e.earnings&&(currentUser.referral_earned=e.earnings.total_earned||0,currentUser.referral_count=e.earnings.referral_count||0,updateReferralSystem())}catch(e){console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π:",e)}}async function loadDetailedReferralStats(){if(currentUser)try{const e=await makeRequest(`/api/user/${currentUser.id}/referrals/detailed`);e.success&&displayDetailedReferralStats(e.referrals)}catch(e){console.error("Error loading detailed referral stats:",e)}}function displayDetailedReferralStats(e){const t=document.getElementById("detailed-referrals-list");t&&(t.innerHTML="",e&&0!==e.length?e.forEach((e=>{const n=document.createElement("div");n.className="referral-item",n.style.cssText="\n            background: var(--card-bg);\n            border: 1px solid var(--border);\n            border-radius: 12px;\n            padding: 16px;\n            margin-bottom: 12px;\n        ",n.innerHTML=`\n            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">\n                <div style="font-weight: 600;">${e.first_name||"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"}</div>\n                <div style="color: ${"active"===e.status?"var(--success)":"var(--warning)"}; font-size: 12px;">\n                    ${"active"===e.status?"‚úÖ –ê–∫—Ç–∏–≤–µ–Ω":"‚è≥ –û–∂–∏–¥–∞–µ—Ç"}\n                </div>\n            </div>\n            <div style="display: flex; justify-content: space-between; font-size: 14px; color: var(--text-secondary);">\n                <div>@${e.username||"–±–µ–∑ username"}</div>\n                <div>–ë–∞–ª–∞–Ω—Å: ${e.friend_balance||0}‚≠ê</div>\n            </div>\n            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">\n                –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${new Date(e.created_at).toLocaleDateString("ru-RU")}\n            </div>\n        `,t.appendChild(n)})):t.innerHTML='\n            <div class="no-referrals" style="text-align: center; padding: 20px; color: var(--text-secondary);">\n                <div style="font-size: 48px; margin-bottom: 16px;">üë•</div>\n                <div>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π</div>\n                <div style="font-size: 14px; margin-top: 8px;">\n                    –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ 10% –æ—Ç –∏—Ö –∑–∞—Ä–∞–±–æ—Ç–∫–∞!\n                </div>\n            </div>\n        ')}function updateLevelProgress(){if(!currentUser)return;const e=currentUser.tasks_completed||0,t=calculateUserLevel(e);console.log("üìä Level progress calculation:",{completedTasks:e,level:t.level,percentage:t.progressPercentage});const n=document.getElementById("level-progress-bar"),s=document.querySelector(".level-count"),o=document.querySelector(".level-info");if(n&&(n.style.width=`${t.progressPercentage}%`),s)if(t.isMaxLevel)s.textContent="–ú–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å!";else{const n=LEVEL_SYSTEM[t.level+1].tasksRequired;s.textContent=`${e}/${n}`}if(o)if(t.isMaxLevel)o.innerHTML="üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è!";else{const n=LEVEL_SYSTEM[t.level+1].tasksRequired-e;o.innerHTML=`–£—Ä–æ–≤–µ–Ω—å <strong>${t.levelName}</strong> ‚Ä¢ –î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è: <strong>${n}</strong> –∑–∞–¥–∞–Ω–∏–π`}}async function syncUserProfile(){if(currentUser&&window.Telegram?.WebApp)try{const e=window.Telegram.WebApp,t=e.initDataUnsafe?.user;if(t){const e={...currentUser,firstName:t.first_name||currentUser.firstName,lastName:t.last_name||currentUser.lastName,username:t.username||currentUser.username,photoUrl:t.photo_url||currentUser.photoUrl};currentUser=e,displayUserProfile(),console.log("‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å Telegram")}}catch(e){console.error("‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è:",e)}}function checkAdminRights(){const e=document.getElementById("admin-nav-item"),t=parseInt(currentUser?.id)===ADMIN_ID;currentUser&&(t||!0===currentUser?.is_admin)?e&&(e.style.display="flex",console.log("‚úÖ Admin nav item shown - user is admin")):e&&(e.style.display="none",console.log("‚ùå Admin nav item hidden - user is not admin"))}if(app.post("/api/posts",(async(e,t)=>{const{title:n,content:s,author:o,authorId:i}=e.body;if(!n||!s||!o)return t.status(400).json({success:!1,error:"–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è"});if(!await isUserAdmin(i))return t.status(403).json({success:!1,error:"–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç—ã!"});try{const e=await pool.query("\n            INSERT INTO posts (title, content, author, author_id) \n            VALUES ($1, $2, $3, $4)\n            RETURNING *\n        ",[n,s,o,i]);t.json({success:!0,message:"–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!",post:e.rows[0]})}catch(e){console.error("Create post error:",e),t.status(500).json({success:!1,error:"–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"})}})),window.filterTasks=filterTasks,window.clearFilters=clearFilters,window.loadTasks=loadTasks,document.addEventListener("DOMContentLoaded",(function(){const e=[].slice.call(document.querySelectorAll("img[data-src]"));if("IntersectionObserver"in window){let t=new IntersectionObserver((function(e,n){e.forEach((function(e){if(e.isIntersecting){let n=e.target;n.src=n.dataset.src,n.classList.remove("lazy"),t.unobserve(n)}}))}));e.forEach((function(e){t.observe(e)}))}})),setTimeout(debugAdminRights,2e3),app.get("/api/user/:userId/referrals/detailed",(async(e,t)=>{const n=e.params.userId;try{const e=await pool.query("\n            SELECT \n                u.user_id,\n                u.first_name,\n                u.username,\n                u.created_at,\n                u.balance as friend_balance,\n                CASE \n                    WHEN u.is_first_login = false THEN 'active'\n                    ELSE 'pending'\n                END as status\n            FROM user_profiles u\n            WHERE u.referred_by = $1\n            ORDER BY u.created_at DESC\n        ",[n]);t.json({success:!0,referrals:e.rows})}catch(e){console.error("Get detailed referrals error:",e),t.status(500).json({success:!1,error:"Database error: "+e.message})}})),parseInt(currentUser.id)===ADMIN_ID){const e=document.querySelector(".admin-buttons");e&&(e.innerHTML+='\n            <button class="admin-btn" onclick="showAdminSection(\'admins\')">üë• –ê–¥–º–∏–Ω—ã</button>\n        ')}function showTaskCategory(e){console.log("üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",e);const t=document.querySelectorAll(".task-tab"),n=document.querySelectorAll(".tasks-grid");t.forEach((e=>e.classList.remove("active"))),n.forEach((e=>{e.classList.remove("active"),e.style.display="none"}));const s=Array.from(t).find((t=>t.textContent.toLowerCase().includes(getCategoryName(e))));s&&s.classList.add("active");const o=document.getElementById(`${e}-tasks`);o?(o.classList.add("active"),o.style.display="block",console.log(`‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ${e}-tasks –ø–æ–∫–∞–∑–∞–Ω`),loadTasksForCategory(e)):console.error(`‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ${e}-tasks –Ω–µ –Ω–∞–π–¥–µ–Ω`)}function getCategoryName(e){return{new:"–Ω–æ–≤—ã–µ",confirmation:"–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",completed:"–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ",rejected:"–æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ"}[e]||e}async function loadTasksForCategory(e){try{if(console.log(`üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${e} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:`,currentUser?.id),!currentUser)return void console.log("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");let t="",n=new URLSearchParams;switch(e){case"new":t="/api/tasks",n.append("userId",currentUser.id);break;case"confirmation":t=`/api/user/${currentUser.id}/tasks/active`;break;case"completed":t=`/api/user/${currentUser.id}/tasks?status=completed`;break;case"rejected":t=`/api/user/${currentUser.id}/tasks?status=rejected`}const s=t+(n.toString()?`?${n.toString()}`:"");console.log("üì° Request URL:",s);const o=await makeRequest(s);o.success?displayTasksForCategory(o.tasks||[],e):(console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${e} –∑–∞–¥–∞–Ω–∏–π:`,o.error),showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${e} –∑–∞–¥–∞–Ω–∏–π`,"error"))}catch(t){console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${e} –∑–∞–¥–∞–Ω–∏–π:`,t),showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${e} –∑–∞–¥–∞–Ω–∏–π`,"error")}}function displayTasksForCategory(e,t){const n=document.getElementById(`${t}-tasks`);if(n)if(n.innerHTML="",e&&0!==e.length)console.log(`üéØ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º ${e.length} –∑–∞–¥–∞–Ω–∏–π –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${t}`),e.forEach(((e,s)=>{const o=createTaskCardWithImage(e,t,s);n.appendChild(o)}));else{let e="";switch(t){case"new":e="–ù–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç";break;case"confirmation":e="–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏";break;case"completed":e="–ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π";break;case"rejected":e="–ù–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π"}n.innerHTML=`\n            <div class="no-tasks" style="text-align: center; padding: 40px 20px;">\n                <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>\n                <div style="font-size: 18px; margin-bottom: 8px;">${e}</div>\n                <div style="font-size: 14px; color: var(--text-secondary);">\n                    ${"new"===t?"–ù–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –ø–æ–∑–∂–µ":"–°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏"}\n                </div>\n            </div>\n        `}else console.error(`‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ${t}-tasks –Ω–µ –Ω–∞–π–¥–µ–Ω`)}function createTaskElement(e,t,n){const s=document.createElement("div");s.className="task-card",s.style.animationDelay=.1*n+"s";let o="";switch(t){case"new":o=createNewTaskHTML(e);break;case"confirmation":o=createConfirmationTaskHTML(e);break;case"completed":o=createCompletedTaskHTML(e);break;case"rejected":o=createRejectedTaskHTML(e)}return s.innerHTML=o,"new"===t&&s.addEventListener("click",(function(t){t.target.classList.contains("task-btn")||openTaskModal(e.id)})),s}function smoothShowTab(e){return new Promise((t=>{document.querySelectorAll(".tab-content, .page");const n=document.querySelector(".tab-content.active, .page.active");n&&(n.style.opacity="0",n.style.transform="translateY(10px)",setTimeout((()=>{n.classList.remove("active");const s=document.getElementById(e);s&&(s.classList.add("active"),requestAnimationFrame((()=>{s.style.opacity="0",s.style.transform="translateY(-10px)",requestAnimationFrame((()=>{s.style.transition="all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)",s.style.opacity="1",s.style.transform="translateY(0)",setTimeout((()=>{s.style.transition="",t()}),400)}))})))}),50))}))}function enhancedShowTab(e){requestAnimationFrame((()=>{hideAllTabs();const t=document.getElementById(e);t&&(t.classList.add("active"),updateNavState(e.replace("-tab","")),setTimeout((()=>{t.offsetHeight}),10))}))}function smoothOpenModal(e){const t=document.getElementById(e);t&&(t.style.display="flex",requestAnimationFrame((()=>{t.classList.add("active")})))}function smoothCloseModal(e){const t=document.getElementById(e);t&&(t.classList.remove("active"),setTimeout((()=>{t.style.display="none"}),300))}function createRipple(e){const t=e.currentTarget,n=document.createElement("span"),s=Math.max(t.clientWidth,t.clientHeight),o=s/2,i=t.getBoundingClientRect();n.style.width=n.style.height=`${s}px`,n.style.left=e.clientX-i.left-o+"px",n.style.top=e.clientY-i.top-o+"px",n.classList.add("ripple");const a=t.getElementsByClassName("ripple")[0];a&&a.remove(),t.appendChild(n)}function initializeRippleEffects(){document.querySelectorAll(".btn, .task-btn, .nav-item").forEach((e=>{e.addEventListener("click",createRipple)}))}function smoothScrollTo(e,t=500){const n="string"==typeof e?document.querySelector(e):e;if(!n)return;const s=n.getBoundingClientRect().top+window.pageYOffset,o=window.pageYOffset,i=s-o;let a=null;requestAnimationFrame((function e(n){null===a&&(a=n);const s=n-a,r=(c=s,d=o,l=i,(c/=t/2)<1?l/2*c*c+d:(c--,-l/2*(c*(c-2)-1)+d));var c,d,l;window.scrollTo(0,r),s<t&&requestAnimationFrame(e)}))}function preloadResources(){["free-icon-home-7102764.png","free-icon-task-list-4173330.png","free-icon-profile-4042565.png"].forEach((e=>{(new Image).src=e}))}function optimizeAnimations(){const e=document.querySelectorAll(".task-card, .card, .modal-content"),t=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting?e.target.style.willChange="transform, opacity":setTimeout((()=>{e.target.style.willChange="auto"}),300)}))}));e.forEach((e=>t.observe(e)))}function lazyLoadImages(){const e=document.querySelectorAll("img[data-src]"),t=new IntersectionObserver(((e,n)=>{e.forEach((e=>{if(e.isIntersecting){const n=e.target;n.src=n.dataset.src,n.classList.remove("lazy-load"),n.classList.add("loaded"),t.unobserve(n)}}))}));e.forEach((e=>t.observe(e)))}function smoothShowMainTab(){smoothShowTab("main-tab")}function smoothShowTasksTab(){smoothShowTab("tasks-tab").then((()=>{loadTasksForCategory("new")}))}function smoothShowProfileTab(){smoothShowTab("profile-tab")}function smoothShowAdminTab(){smoothShowTab("admin-tab")}function debounce(e,t,n){let s;return function(...o){const i=n&&!s;clearTimeout(s),s=setTimeout((()=>{s=null,n||e(...o)}),t),i&&e(...o)}}function throttle(e,t){let n;return function(...s){n||(e.apply(this,s),n=!0,setTimeout((()=>n=!1),t))}}function createNewTaskHTML(e){const t=formatCategory(e.category),n=e.description.length>120?e.description.substring(0,120)+"...":e.description,s=e.people_required||1,o=e.completed_count||0,i=Math.max(0,s-o),a=Math.min(100,o/s*100);return`\n        ${i>0?`<div class="task-availability">${i} –æ—Å—Ç–∞–ª–æ—Å—å</div>`:""}\n        \n        <div class="task-header">\n            <div class="task-title">${escapeHtml(e.title)}</div>\n            <div class="task-price">${e.price} ‚≠ê</div>\n        </div>\n        \n        <div class="task-meta">\n            <div class="task-category">${t}</div>\n            ${e.difficulty?`<div class="task-difficulty ${e.difficulty.toLowerCase()}">${e.difficulty}</div>`:""}\n        </div>\n        \n        <div class="task-description">${escapeHtml(n)}</div>\n        \n        \x3c!-- üî• –ü–†–û–ì–†–ï–°–°-–ë–ê–† –í–´–ü–û–õ–ù–ï–ù–ò–Ø –ó–ê–î–ê–ù–ò–Ø --\x3e\n        <div class="task-progress-container" style="margin: 10px 0;">\n            <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">\n                <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${o}/${s}</span>\n                <span>${Math.round(a)}%</span>\n            </div>\n            <div class="progress-bar">\n                <div class="progress-fill" style="width: ${a}%"></div>\n            </div>\n        </div>\n        \n        <div class="task-footer">\n            <div class="task-time">${e.time_to_complete||"5-10 –º–∏–Ω—É—Ç"}</div>\n            <button class="task-btn" onclick="event.stopPropagation(); openTaskModal(${e.id})">\n                –ù–∞—á–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ\n            </button>\n        </div>\n    `}function createConfirmationTaskHTML(e){return`\n                <div class="task-header">\n                    <div style="flex: 1;">\n                        <div class="task-title">${escapeHtml(e.title)}</div>\n                        <div class="task-category">${e.category||"–û–±—â–µ–µ"}</div>\n                    </div>\n                    <div class="task-price">${e.price} ‚≠ê</div>\n                </div>\n                <div class="task-description">${escapeHtml(e.description)}</div>\n                <div class="task-footer">\n                    <div class="task-time">–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</div>\n                    <button class="task-btn" onclick="event.stopPropagation(); showTaskConfirmation(${e.id}, '${escapeHtml(e.title)}')">\n                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ\n                    </button>\n                </div>\n            `}function createCompletedTaskHTML(e){return`\n                <div class="task-header">\n                    <div style="flex: 1;">\n                        <div class="task-title">${escapeHtml(e.title)}</div>\n                        <div class="task-category">${e.category||"–û–±—â–µ–µ"}</div>\n                    </div>\n                    <div class="task-price">${e.price} ‚≠ê</div>\n                </div>\n                <div class="task-description">${escapeHtml(e.description)}</div>\n                <div class="task-footer">\n                    <div class="task-time">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>\n                    <div class="task-status completed">‚úÖ</div>\n                </div>\n            `}function createRejectedTaskHTML(e){return`\n        <div class="task-header">\n            <div style="flex: 1;">\n                <div class="task-title">${escapeHtml(e.title)}</div>\n                <div class="task-category">${e.category||"–û–±—â–µ–µ"}</div>\n            </div>\n            <div class="task-price">${e.price} ‚≠ê</div>\n        </div>\n        <div class="task-description">${escapeHtml(e.description)}</div>\n        \n        \x3c!-- –ë–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ --\x3e\n        <div class="rejection-info" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 10px; margin: 10px 0;">\n            <div style="color: var(--error); font-size: 12px; font-weight: 600; margin-bottom: 5px;">\n                ‚ùå –ó–∞–¥–∞–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º\n            </div>\n            <div style="color: var(--text-secondary); font-size: 11px;">\n                –ï—Å–ª–∏ –≤—ã —Å—á–∏—Ç–∞–µ—Ç–µ, —á—Ç–æ —ç—Ç–æ –æ—à–∏–±–∫–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É\n            </div>\n        </div>\n        \n        <div class="task-footer">\n            <div class="task-time">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>\n            <button class="support-btn" onclick="openAdminChat()" style="background: var(--accent); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">\n                –ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É\n            </button>\n        </div>\n    `}function openSupportChatForTask(e){const t={id:e.id,title:e.title,price:e.price,category:e.category};localStorage.setItem("supportTaskContext",JSON.stringify(t)),openAdminChat(),setTimeout((()=>{const t=document.getElementById("chat-input-field");t&&(t.placeholder=`–í–æ–ø—Ä–æ—Å –ø–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω–æ–º—É –∑–∞–¥–∞–Ω–∏—é: "${e.title}"...`)}),500)}async function openAdminChat(){if(currentUser)try{console.log("üë§ User opening support chat, ID:",currentUser.id);const e=await makeRequest(`/support/user-chat/${currentUser.id}`);if(!e.success)throw new Error(e.error||"Failed to create chat");{currentChatId=e.chat.id,console.log("‚úÖ Chat ID:",currentChatId);const t=localStorage.getItem("supportTaskContext");if(t){const e=JSON.parse(t),n=`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –£ –º–µ–Ω—è –≤–æ–ø—Ä–æ—Å –ø–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω–æ–º—É –∑–∞–¥–∞–Ω–∏—é: "${e.title}" (${e.price}‚≠ê). `,s=document.getElementById("chat-input-field");s&&(s.value=n),localStorage.removeItem("supportTaskContext")}try{const e=await makeRequest(`/support/chats/${currentChatId}/messages`);e.success&&displayChatMessages(e.messages)}catch(e){console.log("No messages yet or error loading messages:",e),displayChatMessages([])}document.getElementById("admin-chat").classList.add("active")}}catch(e){console.error("‚ùå Error opening user chat:",e),showNotification("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞: "+e.message,"error")}else showNotification("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω","error")}function debugTaskConfirmation(){console.log("- currentUser:",currentUser),console.log("- currentUserTaskId:",currentUserTaskId),console.log("- confirmation-modal:",document.getElementById("confirmation-modal")),console.log("- screenshot-modal:",document.getElementById("screenshot-modal")),loadUserTasksForCategory("active").then((()=>{console.log("‚úÖ Active tasks loaded for debugging")}))}function addConfirmationDebugButton(){const e=document.createElement("button");e.textContent="üêõ Debug Confirmation",e.style.position="fixed",e.style.top="200px",e.style.right="10px",e.style.zIndex="10000",e.style.padding="10px",e.style.background="orange",e.style.color="white",e.style.border="none",e.style.borderRadius="5px",e.style.fontSize="12px",e.onclick=debugTaskConfirmation,document.body.appendChild(e)}function addConfirmationDebugButton(){const e=document.createElement("button");e.textContent="üêõ Debug Confirmation",e.style.position="fixed",e.style.top="200px",e.style.right="10px",e.style.zIndex="10000",e.style.padding="10px",e.style.background="orange",e.style.color="white",e.style.border="none",e.style.borderRadius="5px",e.style.fontSize="12px",e.onclick=debugTaskConfirmation,document.body.appendChild(e)}function checkAdminPanelLoaded(){const e=document.getElementById("admin-tasks-section"),t=document.querySelector("#admin-tasks-section .admin-submit");console.log("üîç Checking admin panel:"),console.log("- Admin tasks section:",!!e),console.log("- Add task button:",!!t),e&&t?console.log("‚úÖ Admin panel is properly loaded"):(console.log("‚ùå Admin panel elements missing"),setTimeout((()=>{showAdminSection("tasks")}),1e3))}function debugAdminPanelFull(){console.log("üîç FULL ADMIN PANEL DEBUG:"),console.log("1. DOM STRUCTURE:");const e=document.getElementById("admin-tab");console.log("- admin-tab:",e),console.log("- admin-tab active:",e?.classList.contains("active")),console.log("2. ADMIN SECTIONS:");["posts","tasks","verification","support","payments","admins"].forEach((e=>{const t=document.getElementById(`admin-${e}-section`);console.log(`- admin-${e}-section:`,t),console.log(`  display: ${t?.style.display}`),console.log(`  classList: ${t?.classList}`)})),console.log("3. ADMIN BUTTONS:");document.querySelectorAll(".admin-btn").forEach(((e,t)=>{console.log(`- Button ${t}:`,e.textContent),console.log("  onclick:",e.getAttribute("onclick"))})),console.log("4. CURRENT USER:"),console.log("- currentUser:",currentUser),console.log("- isAdmin:",currentUser?.is_admin),console.log("- isMainAdmin:",parseInt(currentUser?.id)===ADMIN_ID)}function emergencyFixAdminPanel(){console.log("üîß Applying emergency fixes...");let e=document.getElementById("admin-tab");e||(console.log("‚ùå Admin tab not found, creating..."),e=document.createElement("div"),e.id="admin-tab",e.className="tab-content",document.querySelector(".main-content").appendChild(e));let t=document.getElementById("admin-tasks-section");t||(console.log("‚ùå Tasks section not found, creating..."),t=document.createElement("div"),t.id="admin-tasks-section",t.className="admin-section",t.style.display="none",e.appendChild(t),t.innerHTML='\n            <div class="admin-form">\n                <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ (EMERGENCY)</h3>\n                <p>–°–µ–∫—Ü–∏—è –±—ã–ª–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∞–≤–∞—Ä–∏–π–Ω–æ</p>\n                <button class="admin-submit" onclick="testAddTask()">‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞</button>\n            </div>\n        '),t.style.display="block",t.style.opacity="1",t.style.visibility="visible",console.log("‚úÖ Emergency fixes applied")}function addTestButtons(){const e=document.createElement("div");e.innerHTML='\n        <div style="margin: 20px 0; padding: 15px; background: var(--bg-secondary); border-radius: 10px;">\n            <h4>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ endpoints</h4>\n            <button onclick="testAdminEndpoints()" class="btn btn-primary" style="margin: 5px;">\n                –¢–µ—Å—Ç endpoints\n            </button>\n            <button onclick="testSimpleAdd()" class="btn btn-warning" style="margin: 5px;">\n                –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç\n            </button>\n            <button onclick="checkServerHealth()" class="btn btn-success" style="margin: 5px;">\n                –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä\n            </button>\n        </div>\n    ';const t=document.getElementById("admin-admins-section");t&&t.appendChild(e)}async function testAdminEndpoints(){console.log("üß™ Testing admin endpoints...");try{const e=await makeRequest("/api/health");console.log("‚úÖ Health:",e);const t=await makeRequest("/api/admin/debug");console.log("‚úÖ Debug:",t);const n=await makeRequest("/api/admin/endpoints-check");console.log("‚úÖ Endpoints:",n),showNotification("–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å","success")}catch(e){console.error("‚ùå Test failed:",e),showNotification("–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: "+e.message,"error")}}async function testSimpleAdd(){console.log("üß™ Testing simple add...");try{const e=await makeRequest("/api/admin/test-add",{method:"POST",body:JSON.stringify({adminId:currentUser.id,username:"testuser"})});console.log("‚úÖ Simple test result:",e),showNotification("–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω!","success")}catch(e){console.error("‚ùå Simple test failed:",e),showNotification("–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω: "+e.message,"error")}}async function checkServerHealth(){console.log("üîç Checking server health...");try{const e=await fetch(API_BASE_URL+"/api/health");if(console.log("üìä Server response:",{status:e.status,ok:e.ok,url:e.url}),!e.ok)throw new Error(`HTTP ${e.status}`);{const t=await e.json();console.log("‚úÖ Server health:",t),showNotification("–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ","success")}}catch(e){console.error("‚ùå Server health check failed:",e),showNotification("–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ä–≤–µ—Ä–æ–º: "+e.message,"error")}}function fixTasksLayout(){const e=document.getElementById("tasks-tab");if(!e)return;e.style.minHeight="500px";["new-tasks","confirmation-tasks","completed-tasks","rejected-tasks"].forEach((e=>{const t=document.getElementById(e);t&&(t.style.position="relative",t.style.minHeight="300px",t.style.transition="none")})),console.log("‚úÖ Tasks layout fixed")}function showTasksTab(){console.log("üéØ –ü–ï–†–ï–•–û–î –ù–ê –í–ö–õ–ê–î–ö–£ –ó–ê–î–ê–ù–ò–ô"),hideAllTabs();const e=document.getElementById("tasks-tab");e&&(e.classList.add("active"),console.log("‚úÖ –í–∫–ª–∞–¥–∫–∞ –∑–∞–¥–∞–Ω–∏–π –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞")),updateNavState("tasks"),setTimeout((()=>{initializeTaskTabs()}),50)}function initializeTaskTabHandlers(){document.querySelectorAll(".task-tab").forEach((e=>{e.addEventListener("click",(function(){const e=getCategoryFromTab(this.textContent);e&&showTaskCategory(e)}))}))}function getCategoryFromTab(e){const t=e.toLowerCase();return t.includes("–Ω–æ–≤—ã–µ")?"new":t.includes("–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ")?"confirmation":t.includes("–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ")?"completed":t.includes("–æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ")?"rejected":null}function showTasksTab(){console.log("üéØ –ü–ï–†–ï–•–û–î –ù–ê –í–ö–õ–ê–î–ö–£ –ó–ê–î–ê–ù–ò–ô - –ù–ê–ß–ê–õ–û"),hideAllTabs();const e=document.getElementById("tasks-tab");e&&(e.classList.add("active"),console.log("‚úÖ –í–∫–ª–∞–¥–∫–∞ –∑–∞–¥–∞–Ω–∏–π –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞")),updateNavState("tasks"),setTimeout((()=>{console.log('üîÑ –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫—É "–ù–æ–≤—ã–µ"'),document.querySelectorAll(".task-tab").forEach((e=>{e.classList.remove("active")}));["new-tasks","confirmation-tasks","completed-tasks","rejected-tasks"].forEach((e=>{const t=document.getElementById(e);t&&(t.style.display="none",t.classList.remove("active"))}));const e=document.querySelector(".task-tab:nth-child(1)"),t=document.getElementById("new-tasks");e&&t&&(e.classList.add("active"),t.style.display="block",t.classList.add("active"),console.log('‚úÖ –í–∫–ª–∞–¥–∫–∞ "–ù–æ–≤—ã–µ" –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞'),console.log("üöÄ –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ó–ê–î–ê–ù–ò–ô"),loadTasks()),debugTasksLoading()}),50)}async function loadTasks(e="",t="all"){try{if(console.log("üéØ START loadTasks:",{search:e,category:t,userId:currentUser?.id,hasUser:!!currentUser}),!currentUser)return console.log("‚ùå No current user, aborting loadTasks"),void showNotification("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω","error");const n=document.getElementById("new-tasks");if(!n)return void console.log("‚ùå new-tasks container not found");n.innerHTML=`\n            <div class="no-tasks" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center;">\n                <div class="loading-spinner">‚è≥</div>\n                <div style="margin-top: 16px;">–ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è...</div>\n                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">\n                    ID: ${currentUser.id}\n                </div>\n            </div>\n        `;const s=new URLSearchParams;s.append("userId",currentUser.id),e&&s.append("search",e),t&&"all"!==t&&s.append("category",t);const o=`/api/tasks?${s.toString()}`;console.log("üì° Request URL:",o);const i=await fetch(API_BASE_URL+o);if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);const a=await i.json();if(console.log("üì® Server response:",a),!a.success)throw new Error(a.error||"Unknown server error");allTasks=a.tasks||[],console.log(`‚úÖ Loaded ${allTasks.length} tasks:`,allTasks),displayTasks(allTasks,"new")}catch(e){console.error("üí• loadTasks error:",e);const t=document.getElementById("new-tasks");t&&(t.innerHTML=`\n                <div class="no-tasks" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center;">\n                    <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>\n                    <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π</div>\n                    <div style="font-size: 12px; color: var(--text-secondary); margin: 8px 0;">\n                        ${e.message}\n                    </div>\n                    <button class="btn btn-primary" onclick="loadTasks()" style="margin-top: 16px;">\n                        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞\n                    </button>\n                </div>\n            `),showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π: ${e.message}`,"error")}}function updateTaskInterfaces(){if(document.getElementById("tasks-tab").classList.contains("active")){const e=document.querySelector(".task-tab.active");if(e){const t=getActiveCategoryName(e);"new"===t?loadTasks():loadTasksForCategory(t)}}}function showTasksTab(){console.log("üéØ –ü–ï–†–ï–•–û–î –ù–ê –í–ö–õ–ê–î–ö–£ –ó–ê–î–ê–ù–ò–ô"),hideAllTabs();const e=document.getElementById("tasks-tab");e&&(e.classList.add("active"),console.log("‚úÖ –í–∫–ª–∞–¥–∫–∞ –∑–∞–¥–∞–Ω–∏–π –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞")),updateNavState("tasks"),setTimeout(fixMobileLayout,100),setTimeout((()=>{showTaskCategory("new"),loadTasks()}),150)}function getActiveCategoryName(e){const t=e.textContent.toLowerCase();return t.includes("–Ω–æ–≤—ã–µ")?"new":t.includes("–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ")?"confirmation":t.includes("–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ")?"completed":t.includes("–æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ")?"rejected":"new"}function displayTasks(e,t){console.log(`üéØ START displayTasks: ${e?.length} tasks for ${t}`);const n=document.getElementById(t+"-tasks");if(n){if(console.log("üì¶ Container found, clearing..."),n.innerHTML="",!e||0===e.length)return console.log("üì≠ No tasks to display"),void(n.innerHTML='\n            <div class="no-tasks" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center;">\n                <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>\n                <div style="font-size: 18px; margin-bottom: 8px;">–ó–∞–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>\n                <div style="font-size: 14px; color: var(--text-secondary);">\n                    –ù–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –ø–æ–∑–∂–µ<br>\n                    <small>–°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏</small>\n                </div>\n            </div>\n        ');console.log(`üé® Rendering ${e.length} tasks...`),e.forEach(((e,s)=>{console.log(`üìã Task ${s}:`,e);const o=createTaskCardWithImage(e,t,s);n.appendChild(o)})),console.log("‚úÖ Tasks displayed successfully")}else console.error("‚ùå Container not found:",t+"-tasks")}function addMobileFixButton(){const e=document.createElement("button");e.textContent="üì± FIX MOBILE",e.style.position="fixed",e.style.top="120px",e.style.right="10px",e.style.zIndex="10000",e.style.padding="10px",e.style.background="green",e.style.color="white",e.style.border="none",e.style.borderRadius="5px",e.style.fontSize="12px",e.onclick=function(){console.log("üö® APPLYING MOBILE FIXES"),emergencyMobileFix()},document.body.appendChild(e)}function emergencyMobileFix(){document.querySelectorAll("*").forEach((e=>{e.style.maxWidth="100%",e.style.boxSizing="border-box"})),document.body.style.overflowX="hidden",document.documentElement.style.overflowX="hidden",console.log("‚úÖ Emergency mobile fixes applied")}function formatCategory(e){return{social:"üë• –°–æ—Ü—Å–µ—Ç–∏ ",subscribe:"üì± –ü–æ–¥–ø–∏—Å–∫–∏",view:"üëÄ –ü—Ä–æ—Å–º–æ—Ç—Ä—ã",comment:"üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏",repost:"üîÑ –†–µ–ø–æ—Å—Ç—ã",general:"üìã –û–±—â–µ–µ",other:"üéØ –î—Ä—É–≥–æ–µ"}[e]||e}async function initializeApp(){console.log("üéÆ Initializing LinkGold app..."),fixLayoutIssues(),fixLayoutIssues(),currentUser&&(currentUser.is_admin||parseInt(currentUser.id)===ADMIN_ID)&&setTimeout((()=>{loadReferralLinksList()}),1e3),console.log("üöÄ FORCE loading tasks on app start..."),setTimeout((()=>{currentUser?(console.log("üë§ User authenticated, loading tasks..."),loadTasksForCategory("new")):console.log("‚ùå No user for task loading")}),1e3),initializeTaskTabHandlers();try{console.log("üîç Testing API connection...");const e=await makeRequest("/api/health");console.log("‚úÖ API connection successful:",e)}catch(e){return console.error("‚ùå API connection failed:",e),showNotification("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è","error"),void showRetryButton()}await refreshAdminRights(),setupAdminPanel(),displayUserProfile(),checkAdminRights(),loadMainPagePosts(),console.log("üöÄ Pre-loading tasks on app start..."),loadTasks(),initializeSearch(),loadUserTasks(),startUserDataAutoUpdate(),currentUser&&(currentUser.is_admin||parseInt(currentUser.id)===ADMIN_ID)&&(loadAdminChats(),loadAdminTasks(),loadTaskVerifications(),parseInt(currentUser.id)===ADMIN_ID&&setTimeout((()=>{loadAdminsList()}),500)),setTimeout(fixLayoutIssues,2e3),await syncUserProfile(),displayUserProfile(),checkAdminRights(),loadMainPagePosts(),checkPageVisibility(),loadTasks(),updateProfileStats(),updateActiveTasksCount(),startUserDataAutoUpdate(),console.log("üéâ App initialized successfully"),setInterval(updateActiveTasksCount,3e4)}function checkPageVisibility(){document.getElementById("admin-tab").classList.contains("active")||resetAdminPanel()}async function loadUserTasksForCategory(e){if(currentUser)try{console.log(`üîÑ Loading user tasks for category: ${e}`);let t="";switch(e){case"active":t=`/api/user/${currentUser.id}/tasks/active`;break;case"completed":t=`/api/user/${currentUser.id}/tasks?status=completed`;break;case"rejected":t=`/api/user/${currentUser.id}/tasks?status=rejected`;break;default:return}const n=await makeRequest(t);if(n.success){displayUserTasksForCategory(n.tasks.map((e=>({...e,id:e.id}))),e)}else console.error("‚ùå Error loading user tasks:",n.error)}catch(t){console.error(`‚ùå Error loading ${e} tasks:`,t)}}function fixLayoutIssues(){console.log("üîß Applying layout fixes...");document.querySelectorAll("*").forEach((e=>{e.style.maxWidth="100%",e.style.boxSizing="border-box"}));const e=document.querySelector(".tasks-grid");e&&(e.style.width="100%",e.style.margin="0",e.style.padding="0",e.style.overflow="hidden");document.querySelectorAll(".task-card").forEach((e=>{e.style.width="100%",e.style.maxWidth="100%",e.style.boxSizing="border-box",e.style.margin="0 0 12px 0",e.style.overflow="hidden"})),document.body.style.overflowX="hidden",document.documentElement.style.overflowX="hidden",console.log("‚úÖ Layout fixes applied")}function updateLayoutOnResize(){fixLayoutIssues()}function showTasksTab(){console.log("üéØ –ü–ï–†–ï–•–û–î –ù–ê –í–ö–õ–ê–î–ö–£ –ó–ê–î–ê–ù–ò–ô"),hideAllTabs();const e=document.getElementById("tasks-tab");e&&e.classList.add("active"),updateNavState("tasks"),setTimeout(fixLayoutIssues,100),setTimeout((()=>{showTaskCategory("new")}),150)}function displayUserTasksForCategory(e,t){let n=null;switch(t){case"active":n=document.getElementById("confirmation-tasks");break;case"completed":n=document.getElementById("completed-tasks");break;case"rejected":n=document.getElementById("rejected-tasks")}if(n)if(n.innerHTML="",e&&0!==e.length)console.log(`üéØ Displaying ${e.length} tasks for ${t} category`),e.forEach(((e,s)=>{const o=createTaskCardWithImage(e,t,s);n.appendChild(o)}));else{let e="";switch(t){case"active":e="–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ";break;case"completed":e="–ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π";break;case"rejected":e="–ù–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π"}n.innerHTML=`\n            <div class="no-tasks" style="text-align: center; padding: 40px 20px;">\n                <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>\n                <div style="font-size: 18px; margin-bottom: 8px;">${e}</div>\n                <div style="font-size: 14px; color: var(--text-secondary);">\n                    ${"active"===t?"–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å":"–°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏"}\n                </div>\n            </div>\n        `}else console.error(`‚ùå Container not found for status: ${t}`)}async function loadUserTasks(){if(currentUser)try{const e=await makeRequest(`/user/${currentUser.id}/tasks?status=active`);e.success&&displayUserTasksForCategory(e.tasks,"active");const t=await makeRequest(`/user/${currentUser.id}/tasks?status=completed`);t.success&&displayUserTasksForCategory(t.tasks,"completed");const n=await makeRequest(`/user/${currentUser.id}/tasks?status=rejected`);n.success&&displayUserTasksForCategory(n.tasks,"rejected")}catch(e){console.error("Error loading user tasks:",e)}}function initializeSearch(){const e=document.getElementById("task-search");if(e){let t;e.addEventListener("input",(function(e){clearTimeout(t);const n=e.target.value.trim();t=setTimeout((()=>{(n.length>=2||0===n.length)&&loadTasks(n,getActiveFilter())}),300)}))}const t=document.querySelectorAll(".filter-btn");t.forEach((e=>{e.addEventListener("click",(function(){const e=this.getAttribute("data-filter");loadTasks("",e),t.forEach((e=>e.classList.remove("active"))),this.classList.add("active")}))}))}function getActiveFilter(){const e=document.querySelector(".filter-btn.active");return e?e.getAttribute("data-filter"):"all"}function getTabIndex(e){switch(e){case"new":default:return 1;case"confirmation":return 2;case"completed":return 3;case"rejected":return 4}}function openTaskModal(e){console.log("üìñ Opening task modal for task:",e),console.log("üìã All available tasks:",allTasks),selectedTaskId=e;const t=allTasks.find((t=>t.id===e));if(t){console.log("‚úÖ Task found:",t),document.getElementById("task-modal-title").textContent=t.title,document.getElementById("task-modal-category").textContent=t.category||"–û–±—â–µ–µ",document.getElementById("task-modal-price").textContent=`${t.price} ‚≠ê`,document.getElementById("task-modal-description").textContent=t.description;const e=document.getElementById("task-modal-image-container");e&&(t.image_url?e.innerHTML='\n                    <div class="task-image-placeholder">\n                        <div style="text-align: center;">\n                            <div style="font-size: 32px; margin-bottom: 8px;">üìã</div>\n                            <div style="font-size: 12px;">–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</div>\n                        </div>\n                    </div>\n                ':e.innerHTML='\n                    <div class="task-image-placeholder" style="aspect-ratio: 16/9;">\n                        <div style="text-align: center; padding: 40px;">\n                            <div style="font-size: 32px; margin-bottom: 8px;">üìã</div>\n                            <div>–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</div>\n                        </div>\n                    </div>\n                '),document.getElementById("task-modal-time").textContent=t.time_to_complete||"5 –º–∏–Ω—É—Ç",document.getElementById("task-modal-difficulty").textContent=t.difficulty||"–õ–µ–≥–∫–∞—è";const n=t.people_required||1,s=t.completed_count||0,o=Math.max(0,n-s);document.getElementById("task-modal-available").textContent=`${o} –∑–∞–¥–∞–Ω–∏–π`;const i=t.task_url,a=document.querySelector(".task-modal-start");i&&i.startsWith("http")?(a.textContent="üîó –ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–¥–∞–Ω–∏—é",a.onclick=function(){console.log("üîó Opening task URL:",i),window.open(i,"_blank"),closeModal("task-modal"),startTask()}):(a.textContent="–ù–∞—á–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ",a.onclick=startTask),document.getElementById("task-modal").classList.add("active"),console.log("‚úÖ Task modal opened successfully")}else console.error("‚ùå Task not found in allTasks array"),console.error("‚ùå Available task IDs:",allTasks.map((e=>e.id))),showNotification("–û—à–∏–±–∫–∞: –∑–∞–¥–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π.","error"),setTimeout((()=>{loadTasks()}),2e3)}async function fixExistingTaskImages(){try{console.log("üîß Fixing existing task images...");const e=await pool.query("\n            SELECT id, image_url FROM tasks \n            WHERE image_url IS NOT NULL AND image_url != ''\n        ");let t=0;for(const n of e.rows)if(n.image_url&&!n.image_url.startsWith("http")){const e=`${APP_URL}${n.image_url}`;await pool.query("UPDATE tasks SET image_url = $1 WHERE id = $2",[e,n.id]),t++,console.log(`‚úÖ Fixed image URL for task ${n.id}: ${e}`)}console.log(`‚úÖ Fixed ${t} task images`)}catch(e){console.error("‚ùå Error fixing task images:",e)}}function showTaskConfirmation(e,t){if(console.log("üîç Confirming task:",{userTaskId:e,taskName:t}),!e)return void showNotification("–û—à–∏–±–∫–∞: ID –∑–∞–¥–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω","error");const n=parseInt(e);if(isNaN(n))return void showNotification("–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π ID –∑–∞–¥–∞–Ω–∏—è","error");currentUserTaskId=n;const s=document.getElementById("confirmation-task-name"),o=document.getElementById("confirmation-task-text");s&&(s.textContent=t),o&&(o.textContent=`–í—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –∑–∞–¥–∞–Ω–∏–µ "${t}"?`);const i=document.getElementById("confirmation-modal");i?(i.classList.add("active"),console.log("‚úÖ Confirmation modal opened for task:",t)):(console.error("‚ùå Confirmation modal not found"),showNotification("–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ","error"))}function showScreenshotUpload(){closeModal("confirmation-modal"),closeModal("cancel-confirmation-modal"),document.getElementById("screenshot-file").value="",document.getElementById("screenshot-preview").style.display="none",document.getElementById("file-name").textContent="";const e=document.getElementById("submit-screenshot-btn");e&&(e.disabled=!0,e.textContent="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É"),document.getElementById("screenshot-file").onchange=function(e){const t=e.target.files[0];if(t){document.getElementById("file-name").textContent=t.name,document.getElementById("submit-screenshot-btn").disabled=!1;const e=new FileReader;e.onload=function(e){const t=document.getElementById("screenshot-preview");t.src=e.target.result,t.style.display="block"},e.readAsDataURL(t)}},document.getElementById("screenshot-modal").classList.add("active")}function showCancelConfirmation(){closeModal("confirmation-modal"),document.getElementById("cancel-confirmation-modal").classList.add("active")}async function submitScreenshot(){const e=document.getElementById("screenshot-file");if(!e.files[0])return void showNotification("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å–∫—Ä–∏–Ω—à–æ—Ç–∞","error");const t=new FormData;t.append("screenshot",e.files[0]),t.append("userId",currentUser.id);try{const e=await fetch(`${API_BASE_URL}/api/user/tasks/${currentUserTaskId}/submit`,{method:"POST",body:t}),n=await e.json();n.success?(showNotification("–°–∫—Ä–∏–Ω—à–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!","success"),closeModal("screenshot-modal"),loadUserTasks()):showNotification("–û—à–∏–±–∫–∞: "+n.error,"error")}catch(e){console.error("Error submitting screenshot:",e),showNotification("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞","error")}}async function cancelTask(){if(currentUserTaskId)try{const e=await makeRequest(`/user/tasks/${currentUserTaskId}/cancel`,{method:"POST",body:JSON.stringify({userId:currentUser.id})});e.success?(showNotification("–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ","success"),closeModal("cancel-confirmation-modal"),setTimeout((()=>{loadTasks(),loadUserTasks()}),500)):showNotification("–û—à–∏–±–∫–∞: "+e.error,"error")}catch(e){console.error("Error cancelling task:",e),showNotification("–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞–Ω–∏—è","error")}}async function loadTaskVerifications(){if(currentUser)try{console.log("üîÑ Loading task verifications...");const e=await makeRequest(`/api/admin/task-verifications?adminId=${currentUser.id}`);console.log("üì® Verifications response:",e),e.success?(console.log(`‚úÖ Loaded ${e.verifications?.length||0} verifications`),displayTaskVerifications(e.verifications)):console.error("‚ùå Failed to load verifications:",e.error)}catch(e){console.error("‚ùå Error loading task verifications:",e)}}function debugVerificationClick(){console.log("üîç Debug verification click:");const e=document.querySelectorAll(".verification-item");console.log(`Found ${e.length} verification items`),e.forEach(((e,t)=>{console.log(`Item ${t}:`,{hasClickListener:!!e.onclick,textContent:e.textContent})}))}function displayTaskVerifications(e){const t=document.getElementById("admin-verification-list");t&&(t.innerHTML="",e&&0!==e.length?e.forEach((e=>{const n=document.createElement("div");n.className="verification-item",n.style.cssText="\n            background: var(--card-bg);\n            border: 1px solid var(--border);\n            border-radius: 12px;\n            padding: 16px;\n            margin-bottom: 12px;\n            cursor: pointer;\n            transition: all 0.3s ease;\n        ",n.onmouseover=function(){this.style.transform="translateY(-2px)",this.style.boxShadow="0 4px 12px rgba(0,0,0,0.1)"},n.onmouseout=function(){this.style.transform="translateY(0)",this.style.boxShadow="none"},n.onclick=()=>openVerificationModal(e);const s=e.user_name?e.user_name.charAt(0).toUpperCase():"U",o=formatPostDate(e.submitted_at);n.innerHTML=`\n            <div class="verification-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">\n                <div style="display: flex; align-items: center; gap: 12px;">\n                    <div class="verification-avatar" style="width: 40px; height: 40px; border-radius: 50%; background: var(--purple-gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">\n                        ${s}\n                    </div>\n                    <div class="verification-user-info">\n                        <div class="verification-user-name" style="font-weight: 600; margin-bottom: 4px;">\n                            ${e.user_name}\n                            ${e.username?`(@${e.username})`:""}\n                        </div>\n                        <div class="verification-task-title" style="color: var(--text-secondary); font-size: 14px;">\n                            ${e.task_title}\n                        </div>\n                    </div>\n                </div>\n                <div class="verification-price" style="font-size: 18px; font-weight: 700; color: var(--gold);">\n                    ${e.task_price} ‚≠ê\n                </div>\n            </div>\n            <div class="verification-time" style="color: var(--text-secondary); font-size: 12px;">\n                –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${o}\n            </div>\n            \n            \x3c!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è --\x3e\n            <div style="margin-top: 10px; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border-left: 3px solid var(--accent);">\n                <div style="font-size: 12px; color: var(--accent); font-weight: 600;">\n                    üì∏ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏\n                </div>\n            </div>\n        `,t.appendChild(n)})):t.innerHTML='\n            <div class="no-tasks" style="text-align: center; padding: 40px 20px;">\n                <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>\n                <div>–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>\n                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">\n                    –ù–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏\n                </div>\n            </div>\n        ')}function showPromocodesSection(){showAdminSection("promocodes"),loadPromocodesList()}async function createPromoCode(){try{if(console.log("üé´ START: createPromoCode"),!currentUser)throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");if(parseInt(currentUser.id)!==ADMIN_ID)throw new Error("–¢–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã!");const e=document.getElementById("promocode-code"),t=document.getElementById("promocode-max-uses"),n=document.getElementById("promocode-reward"),s=document.getElementById("promocode-expires"),o=document.getElementById("promocode-form-message"),i=document.getElementById("create-promocode-btn");if(!(e&&t&&n&&o&&i))throw console.error("‚ùå Missing form elements:",{codeInput:!!e,maxUsesInput:!!t,rewardInput:!!n,messageDiv:!!o,submitBtn:!!i}),new Error("–≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");const a=e?.value?.trim().toUpperCase()||"",r=t?.value?parseInt(t.value):0,c=n?.value?parseFloat(n.value):0,d=s?.value?new Date(s.value).toISOString():null;if(console.log("üìä Form data:",{code:a,maxUses:r,reward:c,expiresAt:d}),!a)throw new Error("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞!");if(!/^[A-Z0-9]+$/.test(a))throw new Error("–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã!");if(a.length<3||a.length>20)throw new Error("–î–ª–∏–Ω–∞ –∫–æ–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 3 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤!");if(!r||r<1||r>1e4)throw new Error("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π (1-10000)!");if(!c||c<1||c>1e5)throw new Error("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –Ω–∞–≥—Ä–∞–¥—É (1-100000 –∑–≤–µ–∑–¥)!");i.disabled=!0,i.textContent="–°–æ–∑–¥–∞–µ–º...",showMessage("‚è≥ –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–æ–∫–æ–¥...","loading",o),console.log("üì§ Sending request to server...");const l=await makeRequest("/api/admin/promocodes/create",{method:"POST",body:JSON.stringify({adminId:currentUser.id,code:a,maxUses:r,reward:c,expiresAt:d})});if(console.log("üì® Server response:",l),!l.success)throw new Error(l.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");showMessage(`‚úÖ ${l.message}`,"success",o),e.value="",t.value="10",n.value="50",s.value="",loadPromocodesList()}catch(e){console.error("‚ùå createPromoCode error:",e);const t=document.getElementById("promocode-form-message");showMessage(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`,"error",t),showNotification(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞: ${e.message}`,"error")}finally{const e=document.getElementById("create-promocode-btn");e&&(e.disabled=!1,e.textContent="üé´ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥")}}function showMessage(e,t,n){if(!n)return;const s={success:"var(--success)",error:"var(--error)",loading:"var(--warning)",info:"var(--text-primary)"};n.innerHTML=`<span style="color: ${s[t]||s.info};">${e}</span>`}async function loadPromocodesList(){if(currentUser&&parseInt(currentUser.id)===ADMIN_ID)try{const e=await makeRequest(`/api/admin/promocodes/list?adminId=${currentUser.id}`);e.success?displayPromocodesList(e.promocodes):console.error("Error loading promocodes:",e.error)}catch(e){console.error("Load promocodes error:",e)}}function displayPromocodesList(e){const t=document.getElementById("promocodes-list");t?(t.innerHTML="",console.log(`üé® Displaying ${e.length} promocodes`),e.forEach((n=>{const s=document.createElement("div");s.className="admin-task-item";const o=n.used_count||0,i=n.expires_at&&new Date(n.expires_at)<new Date,a=o>=n.max_uses,r=i?"expired":a?"used":"active";s.innerHTML=`\n            <div class="admin-task-header">\n                <div class="admin-task-title">\n                    <span style="font-size: 18px; font-weight: 800; color: var(--gold);">${n.code}</span>\n                    <span style="color: ${{active:"var(--success)",used:"var(--warning)",expired:"var(--error)"}[r]}; font-size: 12px; margin-left: 10px;">\n                        ${{active:"–ê–∫—Ç–∏–≤–µ–Ω",used:"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω",expired:"–ü—Ä–æ—Å—Ä–æ—á–µ–Ω"}[r]}\n                    </span>\n                </div>\n                <div class="admin-task-actions">\n                    <button class="admin-task-delete" onclick="deactivatePromoCode('${n.code}')">\n                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å\n                    </button>\n                </div>\n            </div>\n            <div class="admin-task-description">\n                <div>üéÅ –ù–∞–≥—Ä–∞–¥–∞: <strong>${n.reward} ‚≠ê</strong></div>\n                <div>üë• –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: <strong>${o}/${n.max_uses}</strong></div>\n                <div>üìÖ –°–æ–∑–¥–∞–Ω: ${new Date(n.created_at).toLocaleDateString("ru-RU")}</div>\n                ${n.expires_at?`\n                    <div>‚è∞ –ò—Å—Ç–µ–∫–∞–µ—Ç: ${new Date(n.expires_at).toLocaleDateString("ru-RU")}</div>\n                `:""}\n            </div>\n        `,e.forEach((e=>{const n=createPromocodeElement(e);t.appendChild(n)}))}))):console.error("‚ùå Promocodes list container not found")}async function deactivatePromoCode(e){if(confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ ${e}?`))if(currentUser&&parseInt(currentUser.id)===ADMIN_ID)try{const t=await makeRequest("/api/admin/promocodes/deactivate",{method:"POST",body:JSON.stringify({adminId:currentUser.id,code:e})});t.success?(showNotification(t.message,"success"),loadPromocodesList()):showNotification("–û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("Deactivate promocode error:",e),showNotification("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞","error")}else showNotification("–¢–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã!","error")}async function activatePromoCode(){const e=document.getElementById("promocode-input"),t=document.getElementById("promocode-message"),n=e.value.trim().toUpperCase();if(n)if(currentUser){t.innerHTML='<span style="color: var(--warning);">‚è≥ –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø—Ä–æ–º–æ–∫–æ–¥...</span>',e.disabled=!0;try{const s=await makeRequest("/api/promocodes/activate",{method:"POST",body:JSON.stringify({userId:currentUser.id,code:n})});s.success?(t.innerHTML=`<span style="color: var(--success);">‚úÖ ${s.message}</span>`,e.value="",await updateUserData(),s.reward&&showPromocodeSuccessAnimation(s.reward)):t.innerHTML=`<span style="color: var(--error);">‚ùå ${s.error}</span>`}catch(e){console.error("‚ùå Activate promocode error:",e),t.innerHTML=`<span style="color: var(--error);">‚ùå –û—à–∏–±–∫–∞: ${e.message}</span>`}finally{e.disabled=!1}}else t.innerHTML='<span style="color: var(--error);">‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω!</span>';else t.innerHTML='<span style="color: var(--error);">‚ùå –í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥!</span>'}function openVerificationModal(e){if(console.log("üìñ Opening verification modal:",e),!e)return console.error("‚ùå No verification data provided"),void showNotification("–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã","error");currentVerificationId=e.id;const t=document.getElementById("verification-user-avatar"),n=document.getElementById("verification-user-name"),s=document.getElementById("verification-task-title"),o=document.getElementById("verification-task-price"),i=document.getElementById("verification-screenshot");t&&(t.textContent=e.user_name?e.user_name.charAt(0).toUpperCase():"U"),n&&(n.textContent=e.user_name||"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"),s&&(s.textContent=e.task_title||"–ó–∞–¥–∞–Ω–∏–µ"),o&&(o.textContent=`${e.task_price||0} ‚≠ê`),i&&(e.screenshot_url?(i.src=e.screenshot_url,i.style.display="block",i.onerror=function(){console.error("‚ùå Failed to load screenshot"),this.style.display="none",showScreenshotErrorWarning()}):(i.style.display="none",showScreenshotErrorWarning()));const a=document.getElementById("verification-modal");a?(a.classList.add("active"),console.log("‚úÖ Verification modal opened")):(console.error("‚ùå Verification modal not found"),showNotification("–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ","error"))}function showScreenshotErrorWarning(){const e=document.querySelector(".verification-modal-content .modal-body");if(!e)return;const t=document.getElementById("screenshot-warning");t&&t.remove();const n=e.querySelector(".verification-modal-actions");n&&n.insertAdjacentHTML("beforebegin",'\n        <div id="screenshot-warning" style="\n            background: rgba(255, 152, 0, 0.1);\n            border: 1px solid #ff9800;\n            border-radius: 8px;\n            padding: 12px;\n            margin: 10px 0;\n            text-align: center;\n        ">\n            <div style="color: #ff9800; font-weight: 600; margin-bottom: 5px;">\n                ‚ö†Ô∏è –°–∫—Ä–∏–Ω—à–æ—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω\n            </div>\n            <div style="font-size: 12px; color: var(--text-secondary);">\n                –í—ã –≤—Å–µ —Ä–∞–≤–Ω–æ –º–æ–∂–µ—Ç–µ –æ–¥–æ–±—Ä–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ, –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ\n            </div>\n        </div>\n    ')}function setupSingleSubmission(){const e=document.getElementById("submit-screenshot-btn");if(e){let t=!1;const n=e.onclick;e.onclick=function(s){if(t)return s.preventDefault(),s.stopPropagation(),showNotification("‚è≥ –ó–∞–¥–∞–Ω–∏–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...","warning"),!1;if(t=!0,e.disabled=!0,e.textContent="‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º...",n){const o=n.call(this,s);return setTimeout((()=>{t=!1,e.disabled=!1,e.textContent="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É"}),5e3),o}}}}async function submitScreenshot(){const e=document.getElementById("screenshot-file"),t=document.getElementById("submit-screenshot-btn");if(e.files[0])try{const t=new FormData;t.append("screenshot",e.files[0]),t.append("userId",currentUser.id);const n=await fetch(`${API_BASE_URL}/api/user/tasks/${currentUserTaskId}/submit`,{method:"POST",body:t}),s=await n.json();s.success?(showNotification("–°–∫—Ä–∏–Ω—à–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!","success"),closeModal("screenshot-modal"),loadUserTasks()):showNotification("–û—à–∏–±–∫–∞: "+s.error,"error")}catch(e){console.error("Error submitting screenshot:",e),showNotification("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞","error")}finally{t&&(t.disabled=!1,t.textContent="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É")}else showNotification("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å–∫—Ä–∏–Ω—à–æ—Ç–∞","error")}async function deleteVerification(){if(currentVerificationId){if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—Ä–æ–≤–µ—Ä–∫—É?\n\n–ó–∞–¥–∞–Ω–∏–µ –≤–µ—Ä–Ω–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞."))try{console.log("üóëÔ∏è Deleting verification:",{verificationId:currentVerificationId,adminId:currentUser.id});const e=await makeRequest(`/api/admin/task-verifications/${currentVerificationId}/delete`,{method:"POST",body:JSON.stringify({adminId:currentUser.id})});if(console.log("üì® Delete verification response:",e),!e.success)throw new Error(e.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");showNotification("‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–∞! –ó–∞–¥–∞–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.","success"),closeModal("verification-modal"),setTimeout((()=>{loadTaskVerifications(),console.log("‚úÖ –°–ø–∏—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏")}),500)}catch(e){console.error("‚ùå Delete verification error:",e);let t="–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏";e.message.includes("Failed to fetch")?t="‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.":e.message.includes("404")?t="‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.":e.message.includes("403")&&(t="‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω."),showNotification(t,"error")}}else showNotification("‚ùå ID –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω","error")}async function monitorReferralSystem(){console.log("üîç Monitoring referral system...");try{const e=(await pool.query("\n            SELECT \n                COUNT(*) as total_referrals,\n                SUM(CASE WHEN balance >= 2 THEN 1 ELSE 0 END) as users_with_bonus,\n                AVG(balance) as avg_balance\n            FROM user_profiles \n            WHERE referred_by IS NOT NULL\n        ")).rows[0];console.log("üìä Referral system stats:",{totalReferrals:e.total_referrals,usersWithBonus:e.users_with_bonus,avgBalance:e.avg_balance})}catch(e){console.error("Error monitoring referral system:",e)}}async function approveVerification(){if(currentVerificationId)if(currentUser)try{console.log("üîÑ –ù–∞—á–∏–Ω–∞–µ–º –æ–¥–æ–±—Ä–µ–Ω–∏–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏:",{verificationId:currentVerificationId,adminId:currentUser.id}),console.log("üí∞ Income distribution:",{taskPrice:taskPrice,userReward:userReward,referralBonus:referralBonusAmount,calculation:`User: ${userReward} (90%), Referrer: ${referralBonusAmount} (10%)`});const e=document.querySelector(".btn-success");e&&(e.disabled=!0,e.textContent="–û–¥–æ–±—Ä—è–µ–º...");const t=await makeRequest(`/api/admin/task-verifications/${currentVerificationId}/approve`,{method:"POST",body:JSON.stringify({adminId:currentUser.id,forceApprove:!0})});if(console.log("üì® –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏:",t),t.success){let e=`‚úÖ –ó–∞–¥–∞–Ω–∏–µ –æ–¥–æ–±—Ä–µ–Ω–æ! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª ${t.amountAdded||t.task_price}‚≠ê`;t.referralBonus&&(e+=`\n\nüë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å: ${t.referralBonus.referrerName} –ø–æ–ª—É—á–∏–ª ${t.referralBonus.bonusAmount}‚≠ê (10%)`,showReferralBonusAnimation(t.referralBonus.referrerName,t.referralBonus.bonusAmount)),(t.taskRemoved||t.taskCompleted)&&(e+="\n\nüéØ –ó–∞–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–µ–Ω–æ - –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π!"),showNotification(e,"success"),closeModal("verification-modal"),setTimeout((()=>{loadTaskVerifications(),loadAdminTasks(),updateUserData(),console.log("‚úÖ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è")}),500)}else{if(!t.error||!t.error.includes("—Å–∫—Ä–∏–Ω—à–æ—Ç")&&!t.error.includes("–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"))throw new Error(t.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");console.log("‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–º, –ø—Ä–æ–±—É–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ..."),await forceApproveVerification()}}catch(e){console.error("‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏:",e),console.log("üö® –ê–≤–∞—Ä–∏–π–Ω—ã–π —Ä–µ–∂–∏–º: –ø—Ä–æ–±—É–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ..."),await forceApproveVerification()}else showNotification("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω","error");else showNotification("‚ùå ID –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω","error")}async function forceApproveVerification(){try{console.log("üîß –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏:",currentVerificationId);const e=await makeRequest(`/api/admin/task-verifications/${currentVerificationId}/force-approve`,{method:"POST",body:JSON.stringify({adminId:currentUser.id,reason:"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞"})});if(!e.success)throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ: "+e.error);showNotification("‚úÖ –ó–∞–¥–∞–Ω–∏–µ –æ–¥–æ–±—Ä–µ–Ω–æ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º)!","success"),closeModal("verification-modal"),setTimeout((()=>{loadTaskVerifications(),loadAdminTasks(),updateUserData()}),500)}catch(e){console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è:",e),showNotification("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: "+e.message,"error");const t=document.querySelector(".btn-success");t&&(t.disabled=!1,t.textContent="‚úÖ –û–¥–æ–±—Ä–∏—Ç—å")}}function showReferralBonusAnimation(e,t){const n=document.createElement("div");n.style.cssText="\n        position: fixed;\n        top: 20%;\n        left: 50%;\n        transform: translateX(-50%);\n        background: var(--success);\n        color: white;\n        padding: 20px 30px;\n        border-radius: 15px;\n        text-align: center;\n        z-index: 10001;\n        box-shadow: 0 10px 25px rgba(34, 197, 94, 0.3);\n        border: 2px solid rgba(255, 255, 255, 0.3);\n        animation: referralBonusSlide 3s ease-in-out;\n        max-width: 300px;\n        width: 90%;\n    ",n.innerHTML=`\n        <div style="font-size: 32px; margin-bottom: 10px;">üë•</div>\n        <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">\n            –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å!\n        </div>\n        <div style="font-size: 14px; margin-bottom: 5px;">\n            ${e}\n        </div>\n        <div style="font-size: 20px; font-weight: 800; color: var(--gold);">\n            +${t} ‚≠ê\n        </div>\n        <div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">\n            (10% –æ—Ç –∑–∞—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞)\n        </div>\n    `,document.body.appendChild(n),setTimeout((()=>{n.remove()}),4e3)}window.showMainTab=smoothShowMainTab,window.showTasksTab=smoothShowTasksTab,window.showProfileTab=smoothShowProfileTab,window.showAdminTab=smoothShowAdminTab,window.openTaskModal=function(e){smoothOpenModal("task-modal")},window.closeModal=function(e){smoothCloseModal(e)},document.addEventListener("DOMContentLoaded",(function(){initializeRippleEffects(),optimizeAnimations(),lazyLoadImages(),preloadResources(),"ontouchstart"in window&&document.body.classList.add("touch-device"),console.log("üöÄ Smooth animations initialized")})),window.addEventListener("scroll",throttle((function(){}),100)),window.addEventListener("resize",debounce((function(){}),250)),/iPad|iPhone|iPod/.test(navigator.userAgent)&&(document.body.style["-webkit-overflow-scrolling"]="touch"),document.addEventListener("DOMContentLoaded",(function(){setTimeout((()=>{const e=document.getElementById("new-tasks");e&&(e.classList.add("active"),e.style.display="block"),loadTasksForCategory("new")}),500)})),window.showTaskCategory=showTaskCategory,window.loadTasksForCategory=loadTasksForCategory,window.displayTasksForCategory=displayTasksForCategory,setTimeout(addConfirmationDebugButton,3e3),setTimeout(addConfirmationDebugButton,3e3),setTimeout(addTestButtons,2e3),setInterval(updateTaskInterfaces,3e4),setTimeout(addMobileFixButton,2e3),document.addEventListener("DOMContentLoaded",fixLayoutIssues),window.addEventListener("resize",updateLayoutOnResize),window.addEventListener("orientationchange",updateLayoutOnResize),fixExistingTaskImages(),setTimeout(debugVerificationClick,3e3),app.get("/api/admin/promocodes/test",(async(e,t)=>{try{await pool.query("SELECT 1");const e=await pool.query("\n            SELECT EXISTS (\n                SELECT FROM information_schema.tables \n                WHERE table_name = 'promocodes'\n            ) as table_exists\n        "),n=await pool.query("SELECT COUNT(*) FROM promocodes");t.json({success:!0,message:"Promocodes system test",database:"Connected",table_exists:e.rows[0].table_exists,promocodes_count:parseInt(n.rows[0].count),timestamp:(new Date).toISOString()})}catch(e){console.error("Promocodes test error:",e),t.status(500).json({success:!1,error:e.message})}})),window.showPromocodesSection=showPromocodesSection,window.createPromoCode=createPromoCode,window.activatePromoCode=activatePromoCode,window.deactivatePromoCode=deactivatePromoCode,document.addEventListener("DOMContentLoaded",(function(){setupSingleSubmission()})),setInterval(monitorReferralSystem,6e4);const referralBonusStyles="\n    <style>\n        @keyframes referralBonusSlide {\n            0% {\n                transform: translateX(-50%) translateY(-20px);\n                opacity: 0;\n            }\n            20% {\n                transform: translateX(-50%) translateY(0);\n                opacity: 1;\n            }\n            80% {\n                transform: translateX(-50%) translateY(0);\n                opacity: 1;\n            }\n            100% {\n                transform: translateX(-50%) translateY(-20px);\n                opacity: 0;\n            }\n        }\n    </style>\n";async function debugApprovalIssue(){if(console.log("üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã –æ–¥–æ–±—Ä–µ–Ω–∏—è:"),currentVerificationId)if(currentUser){console.log("üìä –î–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞:",{verificationId:currentVerificationId,adminId:currentUser.id,API_BASE_URL:API_BASE_URL});try{const e=await fetch(`${API_BASE_URL}/api/health`);console.log("‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω:",e.status)}catch(e){console.error("‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:",e)}}else console.log("‚ùå currentUser –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");else console.log("‚ùå currentVerificationId –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")}function addApprovalDebugButton(){const e=document.createElement("button");e.textContent="üêõ Debug Approval",e.style.position="fixed",e.style.top="300px",e.style.right="10px",e.style.zIndex="10000",e.style.padding="10px",e.style.background="orange",e.style.color="white",e.style.border="none",e.style.borderRadius="5px",e.style.fontSize="12px",e.onclick=debugApprovalIssue,document.body.appendChild(e)}async function rejectVerification(){if(currentVerificationId)try{const e=await makeRequest(`/api/admin/task-verifications/${currentVerificationId}/reject`,{method:"POST",body:JSON.stringify({adminId:currentUser.id})});e.success?(showNotification("–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ","success"),closeModal("verification-modal"),loadTaskVerifications(),setTimeout((()=>{loadTasks(),loadUserTasks()}),500)):showNotification("–û—à–∏–±–∫–∞: "+e.error,"error")}catch(e){console.error("Error rejecting verification:",e),showNotification("–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è","error")}}async function addNewPost(){const e=document.getElementById("admin-post-title").value,t=document.getElementById("admin-post-content").value;if(e&&t)if(currentUser.isAdmin&&parseInt(currentUser.id)===ADMIN_ID)try{const n=await makeRequest("/posts",{method:"POST",body:JSON.stringify({title:e,content:t,author:currentUser.firstName,authorId:currentUser.id})});n.success?(showNotification("–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!","success"),document.getElementById("admin-post-title").value="",document.getElementById("admin-post-content").value="",loadMainPagePosts()):showNotification("–û—à–∏–±–∫–∞: "+n.error,"error")}catch(e){console.error("Error adding post:",e),showNotification("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: "+e.message,"error")}else showNotification("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç—ã!","error");else showNotification("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞!","error")}async function addTask(){console.log("üéØ Starting add task function...");try{const e={title:document.getElementById("admin-task-title").value.trim(),description:document.getElementById("admin-task-description").value.trim(),price:document.getElementById("admin-task-price").value,category:document.getElementById("admin-task-category").value,time_to_complete:document.getElementById("admin-task-time").value||"5-10 –º–∏–Ω—É—Ç",difficulty:document.getElementById("admin-task-difficulty").value,people_required:document.getElementById("admin-task-people").value||1,task_url:document.getElementById("admin-task-url").value||"",created_by:currentUser.id};if(console.log("üìã Form data collected:",e),!e.title.trim())return void showNotification("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è!","error");if(!e.description.trim())return void showNotification("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è!","error");if(!e.price)return void showNotification("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –∑–∞–¥–∞–Ω–∏—è!","error");const t=parseFloat(e.price);if(isNaN(t)||t<=0)return void showNotification("–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º!","error");const n={title:e.title.trim(),description:e.description.trim(),price:t,category:e.category||"general",time_to_complete:e.time_to_complete||"5-10 –º–∏–Ω—É—Ç",difficulty:e.difficulty||"–õ–µ–≥–∫–∞—è",people_required:parseInt(e.people_required)||1,task_url:e.task_url||"",created_by:currentUser.id};console.log("üì§ Sending request to server:",n);const s=await makeRequest("/api/tasks",{method:"POST",body:JSON.stringify(n)});if(console.log("üì® Server response:",s),!s.success)throw new Error(s.error||"Unknown server error");showNotification("‚úÖ –ó–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!","success"),clearTaskForm(),setTimeout((()=>{loadAdminTasks(),loadTasks()}),1e3)}catch(e){console.error("üí• Error in addTask:",e),showNotification(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è: ${e.message}`,"error")}}function debugTaskCreation(){console.log("- currentUser:",currentUser),console.log("- isAdmin:",currentUser?.is_admin),console.log("- API_BASE_URL:",API_BASE_URL);const e={title:document.getElementById("admin-task-title").value,description:document.getElementById("admin-task-description").value,price:document.getElementById("admin-task-price").value,created_by:currentUser?.id};console.log("- Form data:",e)}function addTestButton(){const e=document.createElement("button");e.textContent="üß™ Test Task Creation",e.className="btn btn-warning",e.style.margin="10px",e.onclick=testTaskCreation;const t=document.getElementById("admin-tasks-section");t&&t.appendChild(e)}async function testTaskCreation(){console.log("üß™ Testing task creation..."),document.getElementById("admin-task-title").value="–¢–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ",document.getElementById("admin-task-description").value="–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è",document.getElementById("admin-task-price").value="50",document.getElementById("admin-task-category").value="subscribe",document.getElementById("admin-task-time").value="10 –º–∏–Ω—É—Ç",document.getElementById("admin-task-difficulty").value="–õ–µ–≥–∫–∞—è",document.getElementById("admin-task-people").value="5",document.getElementById("admin-task-url").value="https://example.com",console.log("‚úÖ Form filled with test data"),debugTaskCreation(),await addTask()}function loadAdminTasksSection(){console.log("üîÑ Loading admin tasks section...");const e=document.getElementById("admin-tasks-section");e&&(e.style.display="block",console.log("‚úÖ Admin tasks section shown")),loadAdminTasks()}async function restoreDeletedTasks(){if(confirm("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?"))try{const e=await makeRequest("/api/admin/restore-tasks",{method:"POST",body:JSON.stringify({adminId:currentUser.id})});e.success?(showNotification(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ${e.restoredCount} –∑–∞–¥–∞–Ω–∏–π`,"success"),loadAdminTasks()):showNotification("–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: "+e.error,"error")}catch(e){console.error("Restore tasks error:",e),showNotification("–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π","error")}}async function createTestTask(){if(currentUser)try{const e={title:"–¢–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ "+(new Date).toLocaleTimeString(),description:"–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã",price:50,category:"general",created_by:currentUser.id},t=await makeRequest("/api/tasks",{method:"POST",body:JSON.stringify(e)});t.success?(showNotification("‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!","success"),loadAdminTasks()):showNotification("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: "+t.error,"error")}catch(e){showNotification("–û—à–∏–±–∫–∞: "+e.message,"error")}}function createFallbackAdminTasks(){return'\n        <div class="admin-stats" style="margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border);">\n            <h4 style="margin-bottom: 10px;">üìä –ê–≤–∞—Ä–∏–π–Ω—ã–π —Ä–µ–∂–∏–º</h4>\n            <p style="color: var(--text-secondary); margin-bottom: 15px;">\n                –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n            </p>\n            <ul style="color: var(--text-secondary); font-size: 14px; text-align: left; padding-left: 20px;">\n                <li>–ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ —Å–µ—Ä–≤–µ—Ä—É</li>\n                <li>–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</li>\n                <li>–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</li>\n            </ul>\n        </div>\n        \n        <div class="admin-form">\n            <h3>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>\n            <input type="text" class="admin-input" id="emergency-task-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è">\n            <textarea class="admin-textarea" id="emergency-task-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è" rows="3"></textarea>\n            <input type="number" class="admin-input" id="emergency-task-price" placeholder="–¶–µ–Ω–∞ –≤ –∑–≤–µ–∑–¥–∞—Ö">\n            <button class="admin-submit" onclick="createEmergencyTask()">\n                üöÄ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ\n            </button>\n        </div>\n    '}async function createEmergencyTask(){const e=document.getElementById("emergency-task-title").value,t=document.getElementById("emergency-task-description").value,n=document.getElementById("emergency-task-price").value;e&&t&&n?await createTestTask():showNotification("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!","error")}function isSlowDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&/3G|2G|slow|reduce/i.test(navigator.connection.effectiveType)}async function debugAdminTasks(){if(console.log("üêõ DEBUG Admin Tasks System:"),!currentUser)return console.log("‚ùå No current user"),void showNotification("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω","error");try{const e=await makeRequest(`/api/debug/admin-tasks?adminId=${currentUser.id}`);if(console.log("üìä Debug admin tasks result:",e),e.success){let t="üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–¥–∞–Ω–∏–π:\n";t+=`‚Ä¢ –í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π: ${e.all_tasks_count}\n`,t+=`‚Ä¢ –ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è: ${e.admin_tasks.length}\n`,e.status_stats.forEach((e=>{t+=`‚Ä¢ ${e.status}: ${e.count}\n`})),showNotification(t,"info")}}catch(e){console.error("Debug admin tasks error:",e),showNotification("–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: "+e.message,"error")}}function renderAdminTasks(e){const t=document.getElementById("admin-tasks-container");if(!t)return;t.innerHTML="";const n=document.getElementById("admin-task-filter")?.value||"all",s=e.filter((e=>{switch(n){case"active":return"active"===e.status;case"completed":return"completed"===e.status;case"my":return e.created_by===currentUser.id;default:return!0}}));console.log(`üéØ Rendering ${s.length} filtered tasks (filter: ${n})`),0!==s.length?s.forEach((e=>{const n=createAdminTaskElement(e);t.appendChild(n)})):t.innerHTML='\n            <div class="no-tasks" style="text-align: center; padding: 40px 20px;">\n                <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>\n                <div>–ó–∞–¥–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>\n                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">\n                    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä\n                </div>\n                <button class="btn btn-primary" onclick="loadAdminTasks()" style="margin-top: 16px;">\n                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫\n                </button>\n            </div>\n        '}function createAdminTaskElement(e){const t=document.createElement("div");t.className="admin-task-item",t.style.cssText=`\n        background: var(--card-bg);\n        border: 1px solid ${"completed"===e.status?"var(--success)":"var(--border)"};\n        border-radius: 12px;\n        padding: 16px;\n        margin-bottom: 12px;\n        opacity: ${"completed"===e.status?.8:1};\n    `;const n=e.completed_count||0,s=e.people_required||1,o=Math.min(100,n/s*100),i="completed"===e.status;return t.innerHTML=`\n        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">\n            <div style="flex: 1;">\n                <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">\n                    ${e.title}\n                    ${i?' <span style="color: var(--success); font-size: 12px;">(–ó–∞–≤–µ—Ä—à–µ–Ω–æ)</span>':""}\n                </div>\n                <div style="color: var(--text-secondary); font-size: 14px;">${e.description}</div>\n            </div>\n            <div style="display: flex; gap: 8px; align-items: center;">\n                \n                \n            </div>\n        </div>\n        \n        <div style="display: flex; gap: 12px; font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">\n            <span>üìÅ ${e.category||"general"}</span>\n            <span>üë• ${s} —á–µ–ª.</span>\n            <span>‚ö° ${e.difficulty||"–õ–µ–≥–∫–∞—è"}</span>\n            <span>üïí ${e.time_to_complete||"5-10 –º–∏–Ω—É—Ç"}</span>\n            <span style="color: ${i?"var(--success)":"var(--accent)"};">\n                ${i?"‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ":"üü¢ –ê–∫—Ç–∏–≤–Ω–æ"}\n            </span>\n        </div>\n        \n        \x3c!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è --\x3e\n        <div style="margin: 10px 0;">\n            <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">\n                <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${n}/${s}</span>\n                <span>${Math.round(o)}%</span>\n            </div>\n            <div class="progress-bar">\n                <div class="progress-fill" style="width: ${o}%; background: ${i?"var(--success)":"var(--accent)"};"></div>\n            </div>\n        </div>\n        \n        \x3c!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–¥–∞–Ω–∏—è–º --\x3e\n        <div style="display: flex; gap: 15px; font-size: 11px; color: var(--text-secondary);">\n            <span>‚úÖ ${n} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>\n            <span>‚ùå ${e.rejected_count||0} –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>\n            <span>‚è≥ ${e.pending_count||0} –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span>\n            <span>üü° ${e.active_count||0} –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ</span>\n        </div>\n        ${i?"":`\n                    <button class="admin-task-delete" onclick="deleteTask(${e.id})" style="background: var(--error); color: white; border: none; padding: 6px 12px;  margin-top: 20px; border-radius: 6px; cursor: pointer;">\n                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å\n                    </button>\n                `}\n        <div style="font-size: 20px; color: var(--gold); font-weight: 600;">\n                    ${e.price} ‚≠ê\n                </div>\n        ${e.image_url?`\n            <div style="margin-top: 10px;">\n                <img src="${e.image_url}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è" style="max-width: 200px; border-radius: 8px; border: 1px solid var(--border);">\n            </div>\n        `:""}\n        \n        <div style="margin-top: 8px; font-size: 11px; color: var(--text-secondary);">\n            –°–æ–∑–¥–∞–Ω–æ: ${new Date(e.created_at).toLocaleDateString("ru-RU")}\n            ${e.last_completed?` ‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: ${new Date(e.last_completed).toLocaleDateString("ru-RU")}`:""}\n        </div>\n    `,t}function filterAdminTasks(){if(!document.getElementById("admin-tasks-container"))return;const e=window.currentAdminTasks||[];e.length>0&&renderAdminTasks(e)}function showAdminVerificationSection(){showAdminSection("verification"),setTimeout((()=>{loadTaskVerifications()}),100)}function initializeAdminPanel(){console.log("üéØ Initializing admin panel...");const e=document.getElementById("admin-tab");if(!e)return void console.error("‚ùå Admin tab not found!");["posts","tasks","verification","support","payments","admins"].forEach((t=>{const n=`admin-${t}-section`;let s=document.getElementById(n);s||(console.log(`‚ö†Ô∏è Creating missing section: ${n}`),s=document.createElement("div"),s.id=n,s.className="admin-section",s.style.display="none",s.innerHTML=`<div>Section ${t} will be loaded here</div>`,e.appendChild(s))})),console.log("‚úÖ Admin panel initialized")}async function deletePost(e){if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?"))if(currentUser.isAdmin&&parseInt(currentUser.id)===ADMIN_ID)try{const t=await makeRequest(`/posts/${e}`,{method:"DELETE",body:JSON.stringify({authorId:currentUser.id})});t.success?(showNotification("–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!","success"),loadMainPagePosts()):showNotification("–û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("Error deleting post:",e),showNotification("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: "+e.message,"error")}else showNotification("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –ø–æ—Å—Ç—ã!","error")}async function deleteTask(e){if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ?"))if(currentUser&&currentUser.isAdmin&&parseInt(currentUser.id)===ADMIN_ID)try{const t=await makeRequest(`/tasks/${e}`,{method:"DELETE",body:JSON.stringify({adminId:currentUser.id})});t.success?(showNotification("–ó–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!","success"),loadAdminTasks(),loadTasks()):showNotification("–û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("Error deleting task:",e),showNotification("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è: "+e.message,"error")}else showNotification("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –∑–∞–¥–∞–Ω–∏—è!","error")}async function openAdminChat(){if(currentUser)try{console.log("üë§ User opening support chat, ID:",currentUser.id);const e=await makeRequest(`/support/user-chat/${currentUser.id}`);if(!e.success)throw new Error(e.error||"Failed to create chat");currentChatId=e.chat.id,console.log("‚úÖ Chat ID:",currentChatId);try{const e=await makeRequest(`/support/chats/${currentChatId}/messages`);e.success&&displayChatMessages(e.messages)}catch(e){console.log("No messages yet or error loading messages:",e),displayChatMessages([])}document.getElementById("admin-chat").classList.add("active")}catch(e){console.error("‚ùå Error opening user chat:",e),showNotification("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞: "+e.message,"error")}else showNotification("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω","error")}async function cleanupOldFiles(){try{const e=path.join(__dirname,"uploads");if(!fs.existsSync(e))return;const t=fs.readdirSync(e),n=Date.now(),s=864e5;for(const o of t){const t=path.join(e,o);n-fs.statSync(t).mtime.getTime()>s&&(fs.unlinkSync(t),console.log(`üßπ Deleted old file: ${o}`))}}catch(e){console.error("Error cleaning up old files:",e)}}async function sendMessageToAdmin(){if(!currentUser||!currentChatId)return void showNotification("–ß–∞—Ç –Ω–µ –æ—Ç–∫—Ä—ã—Ç","error");const e=document.getElementById("chat-input-field"),t=e.value.trim();if(t)try{console.log(`‚úâÔ∏è User sending message to chat ${currentChatId}:`,t);const n=currentUser.lastName?`${currentUser.firstName} ${currentUser.lastName}`:currentUser.firstName,s=await makeRequest(`/support/chats/${currentChatId}/messages`,{method:"POST",body:JSON.stringify({user_id:currentUser.id,user_name:n,user_username:currentUser.username,message:t,is_admin:!1})});if(!s.success)throw new Error(s.error);{const n=document.getElementById("chat-messages"),s=document.createElement("div");s.className="message message-user",s.innerHTML=`\n                <div class="message-text">${escapeHtml(t)}</div>\n                <div class="message-time">${(new Date).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}</div>\n            `,n.appendChild(s),e.value="",n.scrollTop=n.scrollHeight,showNotification("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.","success")}}catch(e){console.error("‚ùå Error sending message:",e),showNotification("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: "+e.message,"error")}else showNotification("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ","error")}async function sendAdminMessage(){if(!currentAdminChat||!currentUser)return console.error("No active chat or user"),void showNotification("–ß–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω","error");const e=document.getElementById("admin-chat-input");if(!e)return void console.error("Admin chat input not found");const t=e.value.trim();if(t)try{console.log(`‚úâÔ∏è Admin sending message to chat ${currentAdminChat.id}:`,t);const n=await makeRequest(`/support/chats/${currentAdminChat.id}/messages`,{method:"POST",body:JSON.stringify({user_id:currentUser.id,user_name:"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",user_username:currentUser.username,message:t,is_admin:!0})});if(!n.success)throw new Error(n.error);{const n=document.getElementById("admin-chat-messages");if(n){const s=document.createElement("div");s.className="message message-admin",s.innerHTML=`\n                    <div class="message-text">${escapeHtml(t)}</div>\n                    <div class="message-time">${(new Date).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}</div>\n                `,n.appendChild(s),e.value="",n.scrollTop=n.scrollHeight,loadAdminChats(),console.log("‚úÖ Admin message sent successfully"),showNotification("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ","success")}}}catch(e){console.error("‚ùå Error sending admin message:",e),showNotification("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: "+e.message,"error")}else showNotification("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ","error")}function fixMobileLayout(){console.log("üîß Applying mobile layout fixes...");const e=document.querySelector(".tasks-grid");e&&(e.style.width="100%",e.style.margin="0",e.style.padding="0",e.style.overflow="hidden");document.querySelectorAll(".task-card").forEach((e=>{e.style.width="100%",e.style.maxWidth="100%",e.style.boxSizing="border-box",e.style.margin="0 0 12px 0",e.style.overflow="hidden"})),document.body.style.overflowX="hidden",document.documentElement.style.overflowX="hidden",console.log("‚úÖ Mobile layout fixes applied")}function showTasksTab(){console.log("üéØ –ü–ï–†–ï–•–û–î –ù–ê –í–ö–õ–ê–î–ö–£ –ó–ê–î–ê–ù–ò–ô"),hideAllTabs();const e=document.getElementById("tasks-tab");e&&(e.classList.add("active"),console.log("‚úÖ –í–∫–ª–∞–¥–∫–∞ –∑–∞–¥–∞–Ω–∏–π –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞")),updateNavState("tasks"),setTimeout(fixMobileLayout,100),setTimeout((()=>{showTaskCategory("new")}),150)}function displayChatMessages(e){const t=document.getElementById("chat-messages");if(t){if(t.innerHTML="",!e||0===e.length){const e=document.createElement("div");return e.className="message message-admin",e.innerHTML=`\n                    <div class="message-text">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>\n                    <div class="message-time">${(new Date).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}</div>\n                `,void t.appendChild(e)}e.forEach((e=>{const n=document.createElement("div");n.className=e.is_admin?"message message-admin":"message message-user",n.innerHTML=`\n                    <div class="message-text">${escapeHtml(e.message)}</div>\n                    <div class="message-time">${formatPostDate(e.sent_at)}</div>\n                `,t.appendChild(n)})),t.scrollTop=t.scrollHeight}}function closeChat(){document.getElementById("admin-chat").classList.remove("active"),currentChatId=null}function showMainTab(){hideAllTabs(),document.getElementById("main-tab").classList.add("active"),updateNavState("main")}function showTasksTab(){hideAllTabs(),document.getElementById("tasks-tab").classList.add("active"),updateNavState("tasks")}async function deleteTask(e){if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ?"))if(currentUser)try{const t=await makeRequest(`/tasks/${e}`,{method:"DELETE",body:JSON.stringify({adminId:currentUser.id})});t.success?(showNotification("–ó–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!","success"),loadAdminTasks()):showNotification("–û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("Error deleting task:",e),showNotification("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è: "+e.message,"error")}else showNotification("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω","error")}function debugAdminTasks(){console.log("üêõ DEBUG Admin Tasks Section:");const e={"admin-tasks-section":document.getElementById("admin-tasks-section"),"admin-tasks-list":document.getElementById("admin-tasks-list"),"admin-task-title":document.getElementById("admin-task-title"),"add-task-button":document.querySelector("#admin-tasks-section .admin-submit")};Object.keys(e).forEach((t=>{const n=e[t];console.log(`- ${t}:`,n?"FOUND":"NOT FOUND"),n&&(console.log(`  - display: ${n.style.display}`),console.log(`  - visible: ${null!==n.offsetParent}`))})),console.log("- currentUser:",currentUser),console.log("- isAdmin:",currentUser?.is_admin)}function addAdminDebugButton(){const e=document.createElement("button");e.textContent="üêõ Debug Admin Tasks",e.style.position="fixed",e.style.top="80px",e.style.right="10px",e.style.zIndex="10000",e.style.padding="10px",e.style.background="red",e.style.color="white",e.style.border="none",e.style.borderRadius="5px",e.style.fontSize="12px",e.onclick=async function(){console.log("üîç DEBUG ADMIN TASKS:"),console.log("- Current User:",currentUser),console.log("- isAdmin:",currentUser?.is_admin),console.log("- isMainAdmin:",parseInt(currentUser?.id)===ADMIN_ID);try{const e=await makeRequest("/api/admin/all-tasks?adminId="+currentUser.id);console.log("- Admin tasks result:",e),e.success?showNotification(`–ù–∞–π–¥–µ–Ω–æ ${e.tasks.length} –∑–∞–¥–∞–Ω–∏–π`,"success"):showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π: "+e.error,"error")}catch(e){console.error("Debug error:",e),showNotification("–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: "+e.message,"error")}},document.body.appendChild(e)}function showWithdrawPage(){hideAllTabs(),document.getElementById("withdraw-page").classList.add("active"),updateWithdrawPage(),loadWithdrawHistory()}function showHowItWorksPage(){hideAllTabs(),document.getElementById("how-it-works-page").classList.add("active")}function showAboutPage(){hideAllTabs(),document.getElementById("about-page").classList.add("active")}function goBackToProfile(){showProfileTab()}function hideAllTabs(){document.querySelectorAll(".tab-content, .page").forEach((e=>{e.classList.remove("active")})),resetAdminPanel()}function updateNavState(e){document.querySelectorAll(".nav-item").forEach((e=>{e.classList.remove("active")}));const t=document.querySelectorAll(".nav-item");switch(e){case"main":t[0]&&t[0].classList.add("active");break;case"tasks":t[1]&&t[1].classList.add("active");break;case"profile":t[2]&&t[2].classList.add("active");break;case"admin":t[3]&&t[3].classList.add("active")}}function showAdminSection(e){console.log("üîÑ Switching to admin section:",e);document.querySelectorAll(".admin-section").forEach((e=>{e.style.display="none"}));const t=document.getElementById("admin-tasks-list");t&&t.parentElement&&(t.parentElement.style.display="none");const n=document.getElementById("admin-"+e+"-section");if(n){if(n.style.display="block",console.log(`‚úÖ Showing: admin-${e}-section`),"tasks"===e){const e=document.getElementById("admin-tasks-list-container");e&&(e.style.display="block"),setTimeout((()=>{loadAdminTasks()}),100)}switch(e){case"posts":loadAdminPosts();break;case"payments":loadWithdrawalRequests();break;case"verification":loadTaskVerifications();break;case"support":loadAdminChats();break;case"admins":loadAdminsList();break;case"promocodes":loadPromocodesList()}}else console.error(`‚ùå Target section not found: admin-${e}-section`)}async function loadPromocodesList(){if(console.log("üîÑ Loading promocodes list..."),!currentUser||parseInt(currentUser.id)!==ADMIN_ID)return console.log("‚ùå User is not main admin, cannot load promocodes"),void showNotification("–¢–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏!","error");try{const e=await makeRequest(`/api/admin/promocodes/list?adminId=${currentUser.id}`);e.success?(displayPromocodesList(e.promocodes),console.log(`‚úÖ Loaded ${e.promocodes?.length||0} promocodes`)):(console.error("‚ùå Error loading promocodes:",e.error),showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤: "+e.error,"error"))}catch(e){console.error("‚ùå Load promocodes error:",e),showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤: "+e.message,"error")}}async function checkNetworkConnection(){try{return(await fetch("/api/health",{method:"HEAD",timeout:5e3})).ok}catch(e){return console.error("‚ùå Network connection failed:",e),!1}}async function retryApproval(e=3){let t;for(let n=1;n<=e;n++)try{console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è ${n}/${e}`);const s=await makeRequest(`/api/admin/task-verifications/${currentVerificationId}/approve`,{method:"POST",body:JSON.stringify({adminId:currentUser.id,retryAttempt:n})});if(s.success)return s;t=new Error(s.error)}catch(s){t=s,console.error(`‚ùå –ü–æ–ø—ã—Ç–∫–∞ ${n} –Ω–µ —É–¥–∞–ª–∞—Å—å:`,s),n<e&&await new Promise((e=>setTimeout(e,1e3*n)))}throw t}function updateApprovalButtonOnError(){const e=document.querySelector(".btn-success"),t=document.getElementById("emergency-approve-btn");e&&(e.disabled=!1,e.textContent="üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É",e.onclick=retryApproval),t&&(t.style.display="block")}function displayPromocodesList(e){const t=document.getElementById("promocodes-list");t?(t.innerHTML="",console.log(`üé® Displaying ${e.length} promocodes`),e.forEach((e=>{const n=createPromocodeElement(e);t.appendChild(n)}))):console.error("‚ùå Promocodes list container not found")}function createPromocodeElement(e){const t=document.createElement("div");t.className="admin-task-item";const n=e.used_count||0,s=e.expires_at&&new Date(e.expires_at)<new Date,o=n>=e.max_uses,i=s?"expired":o?"used":"active",a=Math.round(n/e.max_uses*100);return t.innerHTML=`\n        <div class="admin-task-header">\n            <div class="admin-task-title">\n                <span style="font-size: 20px; font-weight: 800; color: var(--gold); letter-spacing: 1px;">${e.code}</span>\n                <span style="color: ${{active:"var(--success)",used:"var(--warning)",expired:"var(--error)"}[i]}; font-size: 12px; margin-left: 10px; font-weight: 600;">\n                    ${{active:"üü¢ –ê–∫—Ç–∏–≤–µ–Ω",used:"üü° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω",expired:"üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω"}[i]}\n                </span>\n            </div>\n            <div class="admin-task-actions">\n                <button class="admin-task-delete" onclick="deactivatePromoCode('${e.code}')" \n                        style="background: var(--error); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">\n                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å\n                </button>\n            </div>\n        </div>\n        \n        <div class="admin-task-description">\n            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">\n                <div>\n                    <div style="font-size: 12px; color: var(--text-secondary);">üéÅ –ù–∞–≥—Ä–∞–¥–∞</div>\n                    <div style="font-size: 18px; font-weight: 700; color: var(--gold);">${e.reward} ‚≠ê</div>\n                </div>\n                <div>\n                    <div style="font-size: 12px; color: var(--text-secondary);">üë• –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</div>\n                    <div style="font-size: 16px; font-weight: 600;">${n}/${e.max_uses}</div>\n                </div>\n            </div>\n            \n            \x3c!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è --\x3e\n            <div style="margin: 10px 0;">\n                <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">\n                    <span>–ü—Ä–æ–≥—Ä–µ—Å—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</span>\n                    <span>${a}%</span>\n                </div>\n                <div class="progress-bar">\n                    <div class="progress-fill" style="width: ${a}%; \n                         background: ${"active"===i?"var(--success)":"used"===i?"var(--warning)":"var(--error)"};">\n                    </div>\n                </div>\n            </div>\n            \n            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px; color: var(--text-secondary);">\n                <div>\n                    <div>üìÖ –°–æ–∑–¥–∞–Ω</div>\n                    <div style="font-weight: 600;">${new Date(e.created_at).toLocaleDateString("ru-RU")}</div>\n                </div>\n                <div>\n                    <div>‚è∞ ${e.expires_at?"–ò—Å—Ç–µ–∫–∞–µ—Ç":"–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è"}</div>\n                    <div style="font-weight: 600;">\n                        ${e.expires_at?new Date(e.expires_at).toLocaleDateString("ru-RU"):"–ë–µ—Å—Å—Ä–æ—á–Ω—ã–π"}\n                    </div>\n                </div>\n            </div>\n            \n            \x3c!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–π --\x3e\n            ${n>0?`\n                <div style="margin-top: 10px; padding: 8px; background: var(--bg-secondary); border-radius: 6px;">\n                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">\n                        üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–π:\n                    </div>\n                    <div style="font-size: 12px;">\n                        –í—Å–µ–≥–æ –≤—ã–¥–∞–Ω–æ: <strong>${n*e.reward} ‚≠ê</strong>\n                    </div>\n                </div>\n            `:""}\n        </div>\n    `,t}async function deactivatePromoCode(e){if(confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ "${e}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`))if(currentUser&&parseInt(currentUser.id)===ADMIN_ID)try{const t=await makeRequest("/api/admin/promocodes/deactivate",{method:"POST",body:JSON.stringify({adminId:currentUser.id,code:e})});t.success?(showNotification(`‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ "${e}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!`,"success"),loadPromocodesList()):showNotification("‚ùå –û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("‚ùå Deactivate promocode error:",e),showNotification("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞: "+e.message,"error")}else showNotification("–¢–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã!","error")}async function fixPromocodesTable(){try{console.log("üîß Fixing promocodes table structure...");if(!(await pool.query("\n            SELECT EXISTS (\n                SELECT FROM information_schema.tables \n                WHERE table_name = 'promocodes'\n            )\n        ")).rows[0].exists)return console.log("‚ùå Promocodes table does not exist, creating..."),void await createPromocodesTable();const e=["ALTER TABLE promocodes ADD COLUMN IF NOT EXISTS reward REAL NOT NULL DEFAULT 0","ALTER TABLE promocodes ADD COLUMN IF NOT EXISTS max_uses INTEGER NOT NULL DEFAULT 1","ALTER TABLE promocodes ADD COLUMN IF NOT EXISTS used_count INTEGER DEFAULT 0","ALTER TABLE promocodes ADD COLUMN IF NOT EXISTS expires_at TIMESTAMP","ALTER TABLE promocodes ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT true",`ALTER TABLE promocodes ADD COLUMN IF NOT EXISTS created_by BIGINT NOT NULL DEFAULT ${ADMIN_ID}`,"ALTER TABLE promocodes ADD COLUMN IF NOT EXISTS created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP"];for(const t of e)try{await pool.query(t),console.log(`‚úÖ Executed: ${t.split("ADD COLUMN IF NOT EXISTS")[1]?.split(" ")[1]}`)}catch(e){console.log(`‚ö†Ô∏è Could not execute: ${t}`,e.message)}console.log("‚úÖ Promocodes table structure fixed")}catch(e){console.error("‚ùå Error fixing promocodes table:",e)}}function showPromocodeSuccessAnimation(e){const t=document.createElement("div");t.style.cssText="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: var(--gold-gradient);\n        color: #000;\n        padding: 30px;\n        border-radius: 20px;\n        text-align: center;\n        z-index: 10000;\n        box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);\n        border: 3px solid rgba(255, 255, 255, 0.3);\n        animation: promocodeSuccess 1s ease-out;\n    ",t.innerHTML=`\n        <div style="font-size: 48px; margin-bottom: 15px;">üéâ</div>\n        <div style="font-size: 24px; font-weight: 800; margin-bottom: 10px;">\n            –ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!\n        </div>\n        <div style="font-size: 32px; font-weight: 700; color: #000; margin: 15px 0;">\n            +${e} ‚≠ê\n        </div>\n        <div style="font-size: 16px; opacity: 0.8;">\n            –ù–∞–≥—Ä–∞–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å\n        </div>\n    `,document.body.appendChild(t),setTimeout((()=>{t.remove()}),3e3)}document.head.insertAdjacentHTML("beforeend",referralBonusStyles),setTimeout(addApprovalDebugButton,3e3),addDebugButton(),debugTaskCreation(),setTimeout(debugAdminForm,2e3),isSlowDevice()&&(document.documentElement.classList.add("simplified-mode"),window.addEventListener("load",(function(){document.querySelectorAll(".hero-banner, .complex-animation").forEach((e=>e.remove()))}))),setInterval((()=>{"block"===document.getElementById("admin-verification-section").style.display&&(console.log("üîÑ Auto-refreshing verification list"),loadTaskVerifications())}),3e4),setTimeout(initializeAdminPanel,500),setInterval(cleanupOldFiles,864e5),cleanupOldFiles(),document.addEventListener("DOMContentLoaded",fixMobileLayout),window.addEventListener("resize",fixMobileLayout),window.addEventListener("orientationchange",fixMobileLayout),setTimeout(addAdminDebugButton,3e3);const promocodeStyles="\n    <style>\n        @keyframes promocodeSuccess {\n            0% {\n                transform: translate(-50%, -50%) scale(0.5);\n                opacity: 0;\n            }\n            50% {\n                transform: translate(-50%, -50%) scale(1.1);\n            }\n            100% {\n                transform: translate(-50%, -50%) scale(1);\n                opacity: 1;\n            }\n        }\n        \n        .promocode-stats {\n            background: var(--card-bg);\n            border-radius: 12px;\n            padding: 15px;\n            margin: 15px 0;\n            border: 1px solid var(--border);\n        }\n        \n        .promocode-stat {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 8px 0;\n            border-bottom: 1px solid var(--border-light);\n        }\n        \n        .promocode-stat:last-child {\n            border-bottom: none;\n        }\n    </style>\n";async function loadAdminPosts(){try{console.log("üìù Loading admin posts...");const e=await makeRequest("/api/posts");e.success?displayAdminPosts(e.posts):console.error("Error loading posts:",e.error)}catch(e){console.error("Error loading admin posts:",e)}}function displayAdminPosts(e){const t=document.getElementById("admin-posts-list");t?(t.innerHTML="",e&&0!==e.length?e.forEach((e=>{const n=document.createElement("div");n.className="admin-task-item",n.innerHTML=`\n            <div class="admin-task-header">\n                <div class="admin-task-title">${escapeHtml(e.title)}</div>\n                <div class="admin-task-actions">\n                    <button class="admin-task-delete" onclick="deletePost(${e.id})">\n                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å\n                    </button>\n                </div>\n            </div>\n            <div class="admin-task-description">${escapeHtml(e.content)}</div>\n            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">\n                –ê–≤—Ç–æ—Ä: ${e.author} ‚Ä¢ ${new Date(e.created_at).toLocaleDateString("ru-RU")}\n            </div>\n        `,t.appendChild(n)})):t.innerHTML='\n            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">\n                <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>\n                <div>–ù–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤</div>\n                <div style="font-size: 14px; margin-top: 8px;">\n                    –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ø–æ—Å—Ç –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É –≤—ã—à–µ\n                </div>\n            </div>\n        '):console.error("‚ùå Admin posts container not found")}function emergencyRestoreAdminPanel(){console.log("üö® EMERGENCY RESTORE ADMIN PANEL");const e=document.getElementById("admin-tasks-section");e&&(e.style.display="block",e.style.opacity="1",e.style.visibility="visible");const t=document.getElementById("admin-tasks-list-container");t&&(t.style.display="block"),setTimeout((()=>{loadAdminTasks(),loadAdminPosts()}),500),console.log("‚úÖ Emergency restore complete")}function addEmergencyButton(){const e=document.createElement("button");e.textContent="üö® –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å",e.style.position="fixed",e.style.top="150px",e.style.right="10px",e.style.zIndex="10000",e.style.padding="10px",e.style.background="red",e.style.color="white",e.style.border="none",e.style.borderRadius="5px",e.style.fontSize="12px",e.onclick=emergencyRestoreAdminPanel,document.body.appendChild(e)}function escapeHtml(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function formatPostDate(e){if(!e)return"";const t=new Date(e),n=new Date(t.getTime()+108e5),s=new Date,o=(new Date(s.getFullYear(),s.getMonth(),s.getDate()),new Date(n.getFullYear(),n.getMonth(),n.getDate()),s-t),i=Math.floor(o/864e5);return 0===i?`–°–µ–≥–æ–¥–Ω—è, ${n.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit",timeZone:"Europe/Moscow"})} (–ú–°–ö)`:1===i?`–í—á–µ—Ä–∞, ${n.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit",timeZone:"Europe/Moscow"})} (–ú–°–ö)`:`${n.toLocaleDateString("ru-RU",{day:"numeric",month:"long",timeZone:"Europe/Moscow"})}, ${n.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit",timeZone:"Europe/Moscow"})} (–ú–°–ö)`}async function requestWithdraw(){if(!currentUser)return void showNotification("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω","error");const e=currentUser.balance||0;if(e<250)showNotification(`–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞: 250 ‚≠ê\n\n–í–∞—à –±–∞–ª–∞–Ω—Å: ${e} ‚≠ê`,"error");else if(confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–≤–µ—Å—Ç–∏ ${e} ‚≠ê?\n\n–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –æ–±–Ω—É–ª–µ–Ω –∏ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.`))try{console.log("üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—ã–≤–æ–¥...");const t=await makeRequest("/withdrawal/request",{method:"POST",body:JSON.stringify({user_id:currentUser.id,amount:e,username:currentUser.username,first_name:currentUser.firstName})});console.log("üì® –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:",t),t.success?(currentUser.balance=0,displayUserProfile(),updateWithdrawPage(),showNotification(`‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ ${e} ‚≠ê –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.`,"success"),setTimeout((()=>{loadWithdrawHistory()}),1e3)):showNotification("‚ùå –û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("‚ùå Withdrawal error:",e),showNotification("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ —Å—Ä–µ–¥—Å—Ç–≤: "+e.message,"error")}}async function loadWithdrawHistory(){if(currentUser)try{const e=await makeRequest(`/withdraw/history/${currentUser.id}`);e.success&&displayWithdrawHistory(e.operations)}catch(e){console.error("Error loading withdrawal history:",e)}}function displayWithdrawHistory(e){const t=document.getElementById("withdraw-history-list");t&&(t.innerHTML="",e&&0!==e.length?(e.sort(((e,t)=>new Date(t.created_at)-new Date(e.created_at))),e.forEach((e=>{const n=document.createElement("div");n.className="withdraw-operation",n.style.cssText="\n            background: var(--card-bg);\n            border: 1px solid var(--border);\n            border-radius: 12px;\n            padding: 16px;\n            margin-bottom: 12px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            transition: all 0.3s ease;\n        ";const s="completed"===e.status?"‚úÖ –í—ã–ø–ª–∞—á–µ–Ω–æ":"üîÑ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ",o="completed"===e.status?"var(--success)":"var(--warning)",i=new Date(e.created_at).toLocaleDateString("ru-RU",{day:"numeric",month:"short",year:"numeric"});n.innerHTML=`\n            <div style="flex: 1;">\n                <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">\n                    ${e.amount} ‚≠ê\n                </div>\n                <div style="font-size: 12px; color: var(--text-secondary);">\n                    ${i}\n                </div>\n            </div>\n            <div style="color: ${o}; font-weight: 600; font-size: 13px; text-align: right;">\n                ${s}\n                ${e.completed_at?`\n                    <div style="font-size: 11px; font-weight: normal; margin-top: 2px;">\n                        –ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${new Date(e.completed_at).toLocaleDateString("ru-RU")}\n                    </div>\n                `:""}\n            </div>\n        `,t.appendChild(n)}))):t.innerHTML='\n            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">\n                <div style="font-size: 48px; margin-bottom: 16px;">üí´</div>\n                <div>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –≤—ã–≤–æ–¥—É</div>\n                <div style="font-size: 12px; margin-top: 8px;">\n                    –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞: 200 ‚≠ê\n                </div>\n            </div>\n        ')}async function loadWithdrawalRequests(){if(console.log("üîÑ Loading withdrawal requests..."),!currentUser)return console.log("‚ùå No current user"),void showNotification("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω","error");try{const e=await makeRequest(`/admin/debug-rights?userId=${currentUser.id}`);if(console.log("üîç Admin rights check:",e),!e.isAdmin)return void showNotification("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!","error");const t=await makeRequest(`/admin/withdrawal-requests?adminId=${currentUser.id}`);console.log("üì® Withdrawal requests response:",t),t.success?displayWithdrawalRequests(t.requests):(console.error("‚ùå Failed to load requests:",t.error),showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫: "+t.error,"error"))}catch(e){console.error("‚ùå Load withdrawal requests error:",e),showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫: "+e.message,"error")}}function displayWithdrawalRequests(e){const t=document.getElementById("withdrawal-requests-list");if(!t)return void console.error("‚ùå Container not found");t.innerHTML="";const n=document.getElementById("active-withdrawals-count"),s=document.getElementById("total-withdrawals-count");n&&(n.textContent=e.length),s&&(s.textContent=e.length),e&&0!==e.length?(console.log(`‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º ${e.length} –∑–∞—è–≤–æ–∫`),e.forEach((e=>{const n=document.createElement("div");n.className="admin-task-item",n.style.marginBottom="15px";const s=e.first_name||e.username||`User_${e.user_id}`,o=new Date(e.created_at).toLocaleString("ru-RU");n.innerHTML=`\n            <div class="admin-task-header">\n                <div class="admin-task-title">\n                    ${s}\n                    ${e.username?` (@${e.username})`:""}\n                </div>\n                <div class="admin-task-price" style="font-size: 20px; color: var(--gold);">\n                    ${e.amount} ‚≠ê\n                </div>\n            </div>\n            <div class="admin-task-description">\n                <div>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${e.user_id}</div>\n                <div>–ó–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–Ω: ${o}</div>\n            </div>\n<div class="admin-task-actions" style="margin-top: 10px; display: flex; gap: 10px;">\n    <button class="admin-task-approve" onclick="completeWithdrawal(${e.id})" \n            style="background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; flex: 1;">\n        ‚úÖ –ü–µ—Ä–µ—á–∏—Å–ª–∏–ª —Å—Ä–µ–¥—Å—Ç–≤–∞\n    </button>\n    <button class="admin-task-cancel" onclick="cancelWithdrawal(${e.id})" \n            style="background: var(--error); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; flex: 1;">\n        ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É\n    </button>\n</div>\n        `,t.appendChild(n)}))):t.innerHTML='\n            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">\n                <div style="font-size: 48px; margin-bottom: 16px;">üí´</div>\n                <div>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤—ã–≤–æ–¥</div>\n                <div style="font-size: 12px; margin-top: 8px;">–ù–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div>\n            </div>\n        '}async function cancelWithdrawal(e){if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç—É –≤—ã–ø–ª–∞—Ç—É?\n\n–°—Ä–µ–¥—Å—Ç–≤–∞ –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –Ω–∞ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."))try{console.log("üîÑ Cancelling withdrawal:",e);const t=await makeRequest(`/api/admin/withdrawal-requests/${e}/cancel`,{method:"POST",body:JSON.stringify({adminId:currentUser.id})});console.log("üì® Cancel response:",t),t.success?(showNotification(`‚úÖ ${t.message}`,"success"),loadWithdrawalRequests()):showNotification("‚ùå –û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("‚ùå Cancel withdrawal error:",e),showNotification("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –≤—ã–ø–ª–∞—Ç—ã: "+e.message,"error")}}async function showCancelledWithdrawals(){try{const e=await makeRequest(`/api/admin/cancelled-withdrawals?adminId=${currentUser.id}`);e.success?displayCancelledWithdrawals(e.cancelledWithdrawals):showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–º–µ–Ω: "+e.error,"error")}catch(e){console.error("Error loading cancelled withdrawals:",e),showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –≤—ã–ø–ª–∞—Ç","error")}}function displayCancelledWithdrawals(e){const t=`\n        <div class="modal active" id="cancelled-withdrawals-modal">\n            <div class="modal-content" style="max-width: 800px; max-height: 80vh;">\n                <div class="modal-header">\n                    <div class="modal-title">‚ùå –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –≤—ã–ø–ª–∞—Ç</div>\n                    <button class="modal-close" onclick="closeModal('cancelled-withdrawals-modal')">√ó</button>\n                </div>\n                <div class="modal-body">\n                    <div id="cancelled-withdrawals-list">\n                        ${0===e.length?'<div style="text-align: center; padding: 40px; color: var(--text-secondary);">–ù–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –≤—ã–ø–ª–∞—Ç</div>':e.map((e=>`\n                                <div class="admin-task-item" style="margin-bottom: 12px;">\n                                    <div class="admin-task-header">\n                                        <div class="admin-task-title">\n                                            ${e.first_name||e.username||`User_${e.user_id}`}\n                                            ${e.username?` (@${e.username})`:""}\n                                        </div>\n                                        <div class="admin-task-price" style="color: var(--error);">\n                                            ${e.amount} ‚≠ê\n                                        </div>\n                                    </div>\n                                    <div class="admin-task-description">\n                                        <div>–û—Ç–º–µ–Ω–µ–Ω–æ: ${new Date(e.completed_at).toLocaleString("ru-RU")}</div>\n                                        <div>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º: ${e.admin_name||`ID: ${e.completed_by}`}</div>\n                                        <div>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${e.user_id}</div>\n                                    </div>\n                                </div>\n                            `)).join("")}\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;document.body.insertAdjacentHTML("beforeend",t)}function simpleShowTab(e){document.querySelectorAll(".tab-content").forEach((e=>{e.style.display="none"})),document.getElementById(e).style.display="block"}async function completeWithdrawal(e){if(console.log("üîß completeWithdrawal called:",{requestId:e,currentUser:currentUser,currentUserId:currentUser?.id}),confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –ø–µ—Ä–µ—á–∏—Å–ª–∏–ª–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?"))try{console.log("üì§ Sending complete request...");const t=await makeRequest(`/admin/withdrawal-requests/${e}/complete`,{method:"POST",body:JSON.stringify({adminId:currentUser.id})});console.log("üì® Complete response:",t),t.success?(showNotification("‚úÖ –í—ã–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!","success"),loadWithdrawalRequests()):showNotification("‚ùå –û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("‚ùå Complete withdrawal error:",e),showNotification("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã–ø–ª–∞—Ç—ã: "+e.message,"error")}}async function createTestWithdrawal(){try{(await makeRequest("/test-withdrawal",{method:"POST"})).success&&(showNotification("‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!","success"),loadWithdrawalRequests())}catch(e){console.error("Test withdrawal error:",e)}}function showAdminPaymentsSection(){showAdminSection("payments"),setTimeout((()=>{loadWithdrawalRequests()}),100)}async function loadLinkAccessSettings(){try{const e=await makeRequest("/api/admin/links/settings?adminId="+currentUser.id);e.success&&(document.getElementById("allow-admins-links").checked=e.allowAdminsLinks||!1)}catch(e){console.error("Error loading link settings:",e)}}async function createReferralLink(){const e=document.getElementById("link-name"),t=document.getElementById("link-description"),n=document.getElementById("link-form-message"),s=document.getElementById("create-link-btn"),o=e.value.trim(),i=t.value.trim();if(o)if(currentUser){s.disabled=!0,s.textContent="–°–æ–∑–¥–∞–µ–º...",n.innerHTML='<span style="color: var(--warning);">–°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É...</span>';try{const s=await makeRequest("/api/admin/links/create",{method:"POST",body:JSON.stringify({adminId:currentUser.id,name:o,description:i,createdBy:currentUser.id})});if(!s.success)throw new Error(s.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");n.innerHTML=`<span style="color: var(--success);">${s.message}</span>`,e.value="",t.value="",loadReferralLinksList(),showNotification("‚úÖ –°—Å—ã–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!","success")}catch(e){console.error("‚ùå Create link error:",e),n.innerHTML=`<span style="color: var(--error);">–û—à–∏–±–∫–∞: ${e.message}</span>`,showNotification("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏: "+e.message,"error")}finally{s.disabled=!1,s.textContent="üîó –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É"}}else n.innerHTML='<span style="color: var(--error);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>';else n.innerHTML='<span style="color: var(--error);">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏!</span>'}async function loadReferralLinksList(){if(currentUser)try{const e=await makeRequest(`/api/admin/links/list?adminId=${currentUser.id}`);e.success?displayReferralLinksList(e.links):console.error("Error loading links:",e.error)}catch(e){console.error("Load links error:",e)}}function displayReferralLinksList(e){const t=document.getElementById("links-list");t&&(t.innerHTML="",e&&0!==e.length?e.forEach((e=>{const n=createSimplifiedLinkElement(e);t.appendChild(n)})):t.innerHTML='\n            <div class="no-tasks" style="text-align: center; padding: 40px 20px;">\n                <div style="font-size: 48px; margin-bottom: 16px;">üîó</div>\n                <div>–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫</div>\n                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">\n                    –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Å—Å—ã–ª–∫—É –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É –≤—ã—à–µ\n                </div>\n            </div>\n        ')}function createSimplifiedLinkElement(e){const t=document.createElement("div");t.className="admin-task-item";const n=e.referral_url||`https://t.me/LinkGoldMoney_bot?start=${e.code}`,s=e.created_by===currentUser.id,o=parseInt(currentUser.id)===ADMIN_ID;return t.innerHTML=`\n        <div class="admin-task-header">\n            <div class="admin-task-title">\n                <span style="font-weight: 600;">${escapeHtml(e.name)}</span>\n                ${e.description?`\n                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">\n                        ${escapeHtml(e.description)}\n                    </div>\n                `:""}\n            </div>\n            <div class="admin-task-actions">\n                ${s||o?`\n                    <button class="admin-task-delete" onclick="deleteReferralLink('${e.code}')">\n                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å\n                    </button>\n                `:""}\n            </div>\n        </div>\n        \n        <div class="admin-task-description">\n            \x3c!-- –°—Å—ã–ª–∫–∞ --\x3e\n            <div style="margin-bottom: 10px;">\n                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">–°—Å—ã–ª–∫–∞:</div>\n                <div style="display: flex; gap: 8px; align-items: center;">\n                    <input type="text" value="${n}" readonly \n                           style="flex: 1; padding: 8px; background: var(--bg-primary); \n                                  border: 1px solid var(--border); border-radius: 6px; \n                                  color: var(--text-primary); font-size: 12px;">\n                    <button class="copy-btn" onclick="copyLink('${n}')" \n                            style="background: var(--accent); color: white; border: none; \n                                   padding: 8px 12px; border-radius: 6px; cursor: pointer; \n                                   font-size: 12px;">\n                        –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å\n                    </button>\n                </div>\n            </div>\n            \n            \x3c!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –¢–û–õ–¨–ö–û –ü–û–î–°–ß–ï–¢ –ü–†–ò–ì–õ–ê–®–ï–ù–ù–´–• --\x3e\n            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;">\n                <div style="text-align: center;">\n                    <div style="font-size: 18px; font-weight: 700; color: var(--accent);">${e.referral_count||0}</div>\n                    <div style="font-size: 11px; color: var(--text-secondary);">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div>\n                </div>\n            </div>\n            \n            \x3c!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è --\x3e\n            <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-top: 8px;">\n                <div>–°–æ–∑–¥–∞–Ω–∞: ${new Date(e.created_at).toLocaleDateString("ru-RU")}</div>\n                <div>–ö–æ–¥: ${e.code}</div>\n            </div>\n            \n            \x3c!-- –í–ª–∞–¥–µ–ª–µ—Ü --\x3e\n            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">\n                –°–æ–∑–¥–∞–ª: ${e.creator_name||"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"}\n            </div>\n        </div>\n    `,t}function copyLink(e){navigator.clipboard.writeText(e).then((()=>{showNotification("‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!","success")})).catch((()=>{const t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),showNotification("‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!","success")}))}function showAdminLinksSection(){showAdminSection("links"),loadReferralLinksList()}async function loadReferralLinksList(){if(currentUser)try{const e=await makeRequest(`/api/admin/links/list?adminId=${currentUser.id}`);e.success?displayReferralLinksList(e.links):console.error("Error loading links:",e.error)}catch(e){console.error("Load links error:",e)}}function displayReferralLinksList(e){const t=document.getElementById("links-list");t&&(t.innerHTML="",e&&0!==e.length?e.forEach((e=>{const n=createDetailedLinkElement(e);t.appendChild(n)})):t.innerHTML='\n            <div class="no-tasks" style="text-align: center; padding: 40px 20px;">\n                <div style="font-size: 48px; margin-bottom: 16px;">üîó</div>\n                <div>–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫</div>\n                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">\n                    –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Å—Å—ã–ª–∫—É –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É –≤—ã—à–µ\n                </div>\n            </div>\n        ')}function createDetailedLinkElement(e){const t=document.createElement("div");t.className="admin-task-item";const n=e.referral_url||`https://t.me/LinkGoldMoney_bot?start=${e.code}`,s=e.created_by===currentUser.id,o=parseInt(currentUser.id)===ADMIN_ID,i=e.total_clicks||0,a=e.unique_clicks||0,r=e.conversions||0,c=i>0?(r/i*100).toFixed(1):0;return t.innerHTML=`\n        <div class="admin-task-header">\n            <div class="admin-task-title">\n                <span style="font-weight: 600;">${escapeHtml(e.name)}</span>\n                ${e.description?`\n                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">\n                        ${escapeHtml(e.description)}\n                    </div>\n                `:""}\n            </div>\n            <div class="admin-task-actions">\n                ${s||o?`\n                    <button class="admin-task-delete" onclick="deleteReferralLink('${e.code}')">\n                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å\n                    </button>\n                `:""}\n            </div>\n        </div>\n        \n        <div class="admin-task-description">\n            \x3c!-- –°—Å—ã–ª–∫–∞ --\x3e\n            <div style="margin-bottom: 10px;">\n                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">–°—Å—ã–ª–∫–∞:</div>\n                <div style="display: flex; gap: 8px; align-items: center;">\n                    <input type="text" value="${n}" readonly \n                           style="flex: 1; padding: 8px; background: var(--bg-primary); \n                                  border: 1px solid var(--border); border-radius: 6px; \n                                  color: var(--text-primary); font-size: 12px;">\n                    <button class="copy-btn" onclick="copyLink('${n}')" \n                            style="background: var(--accent); color: white; border: none; \n                                   padding: 8px 12px; border-radius: 6px; cursor: pointer; \n                                   font-size: 12px;">\n                        –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å\n                    </button>\n                </div>\n            </div>\n            \n            \x3c!-- –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ --\x3e\n            <div style="margin-top: 15px;">\n                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">\n                    üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤:\n                </div>\n                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">\n                    <div style="text-align: center;">\n                        <div style="font-size: 18px; font-weight: 700; color: var(--accent);">${i}</div>\n                        <div style="font-size: 11px; color: var(--text-secondary);">–í—Å–µ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</div>\n                    </div>\n                    <div style="text-align: center;">\n                        <div style="font-size: 18px; font-weight: 700; color: var(--success);">${a}</div>\n                        <div style="font-size: 11px; color: var(--text-secondary);">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö</div>\n                    </div>\n                    <div style="text-align: center;">\n                        <div style="font-size: 18px; font-weight: 700; color: var(--gold);">${r}</div>\n                        <div style="font-size: 11px; color: var(--text-secondary);">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π</div>\n                    </div>\n                    <div style="text-align: center;">\n                        <div style="font-size: 18px; font-weight: 700; color: var(--purple);">${c}%</div>\n                        <div style="font-size: 11px; color: var(--text-secondary);">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>\n                    </div>\n                </div>\n            </div>\n            \n            \x3c!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö --\x3e\n            ${i>0?`\n                <div style="margin-top: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">\n                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">\n                        üìà –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n                    </div>\n                    <div style="display: flex; justify-content: space-between; font-size: 11px;">\n                        <span>–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–ª–∏–∫–æ–≤:</span>\n                        <span><strong>${Math.round(a/i*100)}%</strong></span>\n                    </div>\n                    <div style="display: flex; justify-content: space-between; font-size: 11px; margin-top: 4px;">\n                        <span>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å—Å—ã–ª–∫–∏:</span>\n                        <span><strong>${c}%</strong></span>\n                    </div>\n                </div>\n            `:""}\n            \n            \x3c!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è --\x3e\n            <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-top: 12px;">\n                <div>–°–æ–∑–¥–∞–Ω–∞: ${new Date(e.created_at).toLocaleDateString("ru-RU")}</div>\n                <div>–ö–æ–¥: ${e.code}</div>\n            </div>\n            \n            \x3c!-- –í–ª–∞–¥–µ–ª–µ—Ü --\x3e\n            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">\n                –°–æ–∑–¥–∞–ª: ${e.creator_name||"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"}\n            </div>\n        </div>\n    `,t}async function createReferralLink(){const e=document.getElementById("link-name"),t=document.getElementById("link-description"),n=document.getElementById("link-form-message"),s=document.getElementById("create-link-btn"),o=e.value.trim(),i=t.value.trim();if(o)if(currentUser){s.disabled=!0,s.textContent="–°–æ–∑–¥–∞–µ–º...",n.innerHTML='<span style="color: var(--warning);">–°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É...</span>';try{const s=await makeRequest("/api/admin/links/create",{method:"POST",body:JSON.stringify({adminId:currentUser.id,name:o,description:i,createdBy:currentUser.id})});if(!s.success)throw new Error(s.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");n.innerHTML=`<span style="color: var(--success);">${s.message}</span>`,e.value="",t.value="",loadReferralLinksList(),showNotification("‚úÖ –°—Å—ã–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!","success")}catch(e){console.error("‚ùå Create link error:",e),n.innerHTML=`<span style="color: var(--error);">–û—à–∏–±–∫–∞: ${e.message}</span>`,showNotification("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏: "+e.message,"error")}finally{s.disabled=!1,s.textContent="üîó –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É"}}else n.innerHTML='<span style="color: var(--error);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>';else n.innerHTML='<span style="color: var(--error);">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏!</span>'}function copyLink(e){navigator.clipboard.writeText(e).then((()=>{showNotification("‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!","success")})).catch((()=>{const t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),showNotification("‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!","success")}))}async function deleteReferralLink(e){if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Å—ã–ª–∫—É? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã."))try{const t=await makeRequest("/api/admin/links/delete",{method:"POST",body:JSON.stringify({adminId:currentUser.id,code:e})});t.success?(showNotification("‚úÖ –°—Å—ã–ª–∫–∞ —É–¥–∞–ª–µ–Ω–∞!","success"),loadReferralLinksList()):showNotification("‚ùå –û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("Delete link error:",e),showNotification("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏: "+e.message,"error")}}async function saveLinkAccessSettings(){if(parseInt(currentUser.id)!==ADMIN_ID)return;const e=document.getElementById("allow-admins-links").checked;try{(await makeRequest("/api/admin/links/settings",{method:"POST",body:JSON.stringify({adminId:currentUser.id,allowAdminsLinks:e})})).success&&showNotification("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!","success")}catch(e){console.error("Save settings error:",e),showNotification("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫","error")}}document.head.insertAdjacentHTML("beforeend",promocodeStyles),window.showAdminSection=showAdminSection,window.loadPromocodesList=loadPromocodesList,window.createPromoCode=createPromoCode,window.activatePromoCode=activatePromoCode,window.deactivatePromoCode=deactivatePromoCode,setTimeout(addEmergencyButton,2e3),setTimeout((()=>{loadNonCriticalData(),initializeAnimations()}),1e3),window.showAdminLinksSection=showAdminLinksSection,window.createReferralLink=createReferralLink,window.copyLink=copyLink,window.deleteReferralLink=deleteReferralLink,window.showAdminLinksSection=showAdminLinksSection,window.createReferralLink=createReferralLink,window.copyLink=copyLink,window.deleteReferralLink=deleteReferralLink,window.showAdminLinksSection=showAdminLinksSection,window.createReferralLink=createReferralLink,window.copyLink=copyLink,window.deleteReferralLink=deleteReferralLink,window.saveLinkAccessSettings=saveLinkAccessSettings;const allowAdminsCheckbox=document.getElementById("allow-admins-links");function showAdminPaymentsSection(){showAdminSection("payments"),loadWithdrawalRequests()}function updateWithdrawPage(){const e=document.getElementById("withdraw-balance-display"),t=document.getElementById("withdraw-btn");if(e&&currentUser&&(e.textContent=`${currentUser.balance||0} ‚≠ê`),t&&currentUser){const e=currentUser.balance||0;e<250?(t.disabled=!0,t.style.opacity="0.5",t.textContent="–ú–∏–Ω–∏–º—É–º 250 ‚≠ê"):(t.disabled=!1,t.style.opacity="1",t.textContent=`–í—ã–≤–µ—Å—Ç–∏ ${e} ‚≠ê`)}}async function loadMainPagePosts(){try{const e=await makeRequest("/posts");e.success&&e.posts&&e.posts.length>0?displayMainPagePosts(e.posts):hidePostsSection()}catch(e){console.error("Error loading posts:",e),hidePostsSection()}}function displayMainPagePosts(e){const t=document.getElementById("posts-section"),n=document.getElementById("posts-container");n&&(t&&(t.style.display="block"),n.innerHTML="",e&&0!==e.length?e.forEach((e=>{const t=document.createElement("div");t.className="post-item fade-in";const s=formatPostDate(e.timestamp);e.authorId;t.innerHTML=`\n                    <div class="post-header">\n                        <div style="flex: 1;">\n                            <div class="post-title">${escapeHtml(e.title)}</div>\n                            <div class="post-author">\n                                ${escapeHtml(e.author||"–ö–æ–º–∞–Ω–¥–∞ LinkGold")}\n                            </div>\n                        </div>\n                        <div class="post-date">${s}</div>\n                    </div>\n                    \n                    <div class="post-content">${escapeHtml(e.content)}</div>\n                    \n                    ${e.image_url?`\n                        <img src="${e.image_url}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" class="post-image" onerror="this.style.display='none'">\n                    `:""}\n                    \n                    \n                    \n                    ${currentUser&&currentUser.isAdmin&&parseInt(currentUser.id)===ADMIN_ID?`\n                        <div style="margin-top: 15px; text-align: right;">\n                            <button class="admin-task-delete" onclick="deletePost(${e.id})" style="font-size: 12px; padding: 6px 12px;">\n                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç\n                            </button>\n                        </div>\n                    `:""}\n                `,n.appendChild(t)})):n.innerHTML='\n                    <div class="no-tasks" style="text-align: center; padding: 40px 20px;">\n                        <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>\n                        <div>–ü–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π</div>\n                        <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">\n                            –°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏\n                        </div>\n                    </div>\n                ')}function hidePostsSection(){const e=document.getElementById("posts-section");e&&(e.style.display="none")}async function handleLike(e,t){try{const n=await makeRequest(`/posts/${e}/like`,{method:"POST",body:JSON.stringify({userId:currentUser.id})});if(n.success){t.querySelector(".like-count").textContent=n.likes,t.style.transform="scale(1.1)",setTimeout((()=>{t.style.transform="scale(1)"}),200)}}catch(e){console.error("Error liking post:",e);const n=t.querySelector(".like-count");n.textContent=parseInt(n.textContent)+1,t.style.transform="scale(1.1)",setTimeout((()=>{t.style.transform="scale(1)"}),200)}}async function handleDislike(e,t){try{const n=await makeRequest(`/posts/${e}/dislike`,{method:"POST",body:JSON.stringify({userId:currentUser.id})});if(n.success){t.querySelector(".dislike-count").textContent=n.dislikes,t.style.transform="scale(1.1)",setTimeout((()=>{t.style.transform="scale(1)"}),200)}}catch(e){console.error("Error disliking post:",e);const n=t.querySelector(".dislike-count");n.textContent=parseInt(n.textContent)+1,t.style.transform="scale(1.1)",setTimeout((()=>{t.style.transform="scale(1)"}),200)}}async function submitWithdraw(){if(!currentUser)return void showNotification("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω","error");const e=document.getElementById("withdraw-amount"),t=document.getElementById("withdraw-method"),n=document.getElementById("withdraw-details"),s=parseFloat(e?.value),o=t?.value,i=n?.value?.trim();if(!s||s<=0)showNotification("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É","error");else if(s<50)showNotification("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: 150 ‚≠ê","error");else if(s>(currentUser.balance||0))showNotification("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ","error");else if(o)if(i)try{const a=await makeRequest("/withdrawal/request",{method:"POST",body:JSON.stringify({user_id:currentUser.id,amount:s,method:o,details:i})});a.success?(showNotification(`–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ ${s}‚≠ê –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –û–∂–∏–¥–∞–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.`,"success"),e&&(e.value=""),t&&(t.value=""),n&&(n.value=""),currentUser.balance&&(currentUser.balance-=s),displayUserProfile(),setTimeout((()=>{showProfileTab()}),2e3)):showNotification("–û—à–∏–±–∫–∞: "+(a.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"),"error")}catch(e){console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ —Å—Ä–µ–¥—Å—Ç–≤:",e),showNotification("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞","error")}else showNotification("–í–≤–µ–¥–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –≤—ã–≤–æ–¥–∞","error");else showNotification("–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞","error")}function showNotification(e,t="info"){document.querySelectorAll(".notification").forEach((e=>{e.remove()}));const n=document.createElement("div");n.className=`notification notification-${t}`,n.innerHTML=`\n                <div class="notification-content">${e}</div>\n                <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>\n            `,document.body.appendChild(n),setTimeout((()=>{n.parentElement&&n.remove()}),5e3)}function copyReferralLink(){const e=document.getElementById("referral-link");e&&(e.select(),e.setSelectionRange(0,99999),navigator.clipboard.writeText(e.value).then((()=>{showNotification("–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!","success")})).catch((()=>{document.execCommand("copy"),showNotification("–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!","success")})))}function showBalanceModal(){document.getElementById("balance-modal").classList.add("active")}function showPrices(){document.getElementById("prices-modal").classList.add("active")}function openAdminChatFromPrices(){document.getElementById("prices-modal").classList.remove("active"),setTimeout((()=>{document.getElementById("admin-chat").classList.add("active")}),300)}function goToProfile(){closeModal("balance-modal"),showProfileTab()}function closeModal(e){document.getElementById(e).classList.remove("active")}async function startTask(){if(console.log("üéØ Starting task...",{selectedTaskId:selectedTaskId,currentUser:currentUser}),currentUser&&selectedTaskId)try{console.log("üì§ Sending start task request...");const e=await makeRequest("/api/user/tasks/start",{method:"POST",body:JSON.stringify({userId:currentUser.id,taskId:selectedTaskId})});console.log("üì® Start task response:",e),e.success?(closeModal("task-modal"),showNotification("‚úÖ –ó–∞–¥–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ! –í—ã–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ –∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.","success"),setTimeout((()=>{loadTasks(),loadUserTasksForCategory("active")}),500)):showNotification("‚ùå –û—à–∏–±–∫–∞: "+e.error,"error")}catch(e){console.error("üí• Error starting task:",e),showNotification("‚ùå –û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–Ω–∏—è: "+e.message,"error")}else showNotification("–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏–ª–∏ –∑–∞–¥–∞–Ω–∏–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ","error")}function debugStartTask(){console.log("üêõ DEBUG Start Task:"),console.log("- currentUser:",currentUser),console.log("- selectedTaskId:",selectedTaskId),console.log("- API_BASE_URL:",API_BASE_URL);const e=allTasks.find((e=>e.id===selectedTaskId));console.log("- task found:",!!e),console.log("- task details:",e),console.log("- task modal visible:",document.getElementById("task-modal")?.classList.contains("active"))}function addStartTaskDebugButton(){const e=document.createElement("button");e.textContent="üêõ Debug Start Task",e.style.position="fixed",e.style.top="250px",e.style.right="10px",e.style.zIndex="10000",e.style.padding="10px",e.style.background="purple",e.style.color="white",e.style.border="none",e.style.borderRadius="5px",e.style.fontSize="12px",e.onclick=debugStartTask,document.body.appendChild(e)}async function loadAdminChats(){if(currentUser)try{console.log("üì• Loading admin chats...");const e=await makeRequest("/support/chats");e.success?(console.log(`‚úÖ Loaded ${e.chats?.length||0} active chats`),displayAdminChatsList(e.chats||[])):console.error("‚ùå Failed to load chats:",e.error)}catch(e){console.error("‚ùå Error loading admin chats:",e)}}async function loadAllAdminChats(){if(currentUser&&currentUser.isAdmin)try{const e=await makeRequest(`/support/all-chats?adminId=${ADMIN_ID}`);e.success&&displayAllAdminChats(e.chats||[])}catch(e){console.error("Error loading all chats:",e)}}async function loadArchivedAdminChats(){if(currentUser&&currentUser.isAdmin)try{const e=await makeRequest(`/support/archived-chats?adminId=${ADMIN_ID}`);e.success&&displayArchivedAdminChats(e.chats||[])}catch(e){console.error("Error loading archived chats:",e)}}function displayAdminChatsList(e){const t=document.getElementById("active-chats-list");t&&(t.innerHTML="",e&&0!==e.length?(updateChatsStats(e),e.forEach((e=>{const n=createChatElement(e,"active");t.appendChild(n)}))):t.innerHTML="")}function displayAllAdminChats(e){const t=document.getElementById("all-chats-list");t&&(t.innerHTML="",e&&0!==e.length?e.forEach((e=>{const n=createChatElement(e,"all");t.appendChild(n)})):t.innerHTML="")}function displayArchivedAdminChats(e){const t=document.getElementById("archived-chats-list");t&&(t.innerHTML="",e&&0!==e.length?e.forEach((e=>{const n=createChatElement(e,"archived");t.appendChild(n)})):t.innerHTML='\n                    <div class="no-tasks" style="text-align: center; padding: 20px;">\n                        <div>–ù–µ—Ç –∞—Ä—Ö–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</div>\n                    </div>\n                ')}function createChatElement(e,t){const n=document.createElement("div"),s=e.unread_count>0,o=!e.is_active;n.className=`chat-item ${s?"unread":""} ${o?"archived":""}`,n.onclick=()=>openAdminChatWindow(e);const i=e.user_name?e.user_name.charAt(0).toUpperCase():"U",a=e.user_name||`User_${e.user_id}`,r=e.last_message||"–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π";return n.innerHTML=`\n                <div class="chat-avatar-small">\n                    ${i}\n                </div>\n                <div class="chat-info-small">\n                    <div class="chat-name-small">\n                        ${a}\n                        ${o?'<span class="archived-badge">–∞—Ä—Ö–∏–≤</span>':""}\n                    </div>\n                    <div class="chat-last-message">${r}</div>\n                </div>\n                <div class="chat-meta">\n                    <div class="chat-time">${e.moscow_time||formatPostDate(e.last_message_time)}</div>\n                    ${s?`<div class="unread-badge">${e.unread_count}</div>`:""}\n                </div>\n                ${"all"===t||"archived"===t?`\n                    <div class="chat-actions">\n                        ${o?`\n                            <button class="chat-action-btn chat-restore-btn" onclick="event.stopPropagation(); restoreChat(${e.id})" title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">\n                                ‚Üª\n                            </button>\n                        `:`\n                            <button class="chat-action-btn chat-archive-btn" onclick="event.stopPropagation(); archiveChat(${e.id})" title="–í –∞—Ä—Ö–∏–≤">\n                                üìÅ\n                            </button>\n                        `}\n                        <button class="chat-action-btn chat-delete-btn" onclick="event.stopPropagation(); deleteAdminChat(${e.id})" title="–£–¥–∞–ª–∏—Ç—å">\n                            üóëÔ∏è\n                        </button>\n                    </div>\n                `:""}\n            `,n}function updateChatsStats(e){const t=e.filter((e=>e.is_active)).length,n=e.filter((e=>e.unread_count>0)).length,s=e.length,o=document.getElementById("active-chats-count"),i=document.getElementById("unread-chats-count"),a=document.getElementById("total-chats-count");o&&(o.textContent=t),i&&(i.textContent=n),a&&(a.textContent=s)}function showChatTab(e){const t=document.getElementById("active-chats-list"),n=document.getElementById("archived-chats-list"),s=document.getElementById("all-chats-list");t&&(t.style.display="none"),n&&(n.style.display="none"),s&&(s.style.display="none"),document.querySelectorAll(".chat-tab-btn").forEach((e=>{e.classList.remove("active")}));const o=document.querySelectorAll(".chat-tab-btn");switch(e){case"active":t&&(t.style.display="block"),o[0]?.classList.add("active"),loadAdminChats();break;case"archived":n&&(n.style.display="block"),o[1]?.classList.add("active"),loadArchivedAdminChats();break;case"all":s&&(s.style.display="block"),o[2]?.classList.add("active"),loadAllAdminChats()}}async function openAdminChatWindow(e){console.log("üí¨ Admin opening chat:",e),currentAdminChat=e;try{const t=await makeRequest(`/support/chats/${e.id}/messages`);if(!t.success)throw new Error("Failed to load messages");console.log(`üì® Loaded ${t.messages.length} messages for admin chat`);try{await makeRequest(`/support/chats/${e.id}/read`,{method:"PUT"}),loadAdminChats()}catch(e){console.log("Mark as read not available")}showAdminChatWindow(e,t.messages)}catch(e){console.error("‚ùå Error opening admin chat:",e),showNotification("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞: "+e.message,"error")}}function showAdminChatWindow(e,t){let n=document.getElementById("admin-chat-window");n||(createAdminChatWindow(),n=document.getElementById("admin-chat-window"));const s=document.getElementById("admin-chat-user-name"),o=document.getElementById("admin-chat-avatar");s&&(s.textContent=e.user_name||`User_${e.user_id}`),o&&(o.textContent=e.user_name?e.user_name.charAt(0).toUpperCase():"U"),displayAdminChatMessages(t),n.classList.add("active")}function createAdminChatWindow(){document.body.insertAdjacentHTML("beforeend",'\n                <div class="admin-chat-window" id="admin-chat-window">\n                    <div class="admin-chat-header">\n                        <div class="admin-chat-user">\n                            <div class="chat-avatar-small" id="admin-chat-avatar">U</div>\n                            <div class="chat-info-small">\n                                <div class="chat-name-small" id="admin-chat-user-name">User</div>\n                                <div class="chat-status">–û–Ω–ª–∞–π–Ω</div>\n                            </div>\n                        </div>\n                        <button class="chat-close" onclick="closeAdminChat()">√ó</button>\n                    </div>\n                    <div class="admin-chat-messages" id="admin-chat-messages">\n                        \x3c!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å --\x3e\n                    </div>\n                    <div class="admin-chat-input-container">\n                        <input type="text" id="admin-chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key===\'Enter\') sendAdminMessage()">\n                        <button class="admin-chat-send" onclick="sendAdminMessage()">‚û§</button>\n                    </div>\n                </div>\n            ')}function addPromocodesTestButton(){const e=document.createElement("div");e.innerHTML='\n        <div style="margin: 20px 0; padding: 15px; background: var(--bg-secondary); border-radius: 10px;">\n            <h4>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</h4>\n            <button onclick="testPromocodesSystem()" class="btn btn-primary" style="margin: 5px;">\n                –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤\n            </button>\n            <button onclick="checkPromocodesTable()" class="btn btn-warning" style="margin: 5px;">\n                –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É\n            </button>\n        </div>\n    ';const t=document.getElementById("admin-promocodes-section");t&&t.appendChild(e)}async function testPromocodesSystem(){try{const e=await makeRequest("/api/admin/promocodes/test");console.log("üß™ Promocodes test result:",e),showNotification(`–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã: ${e.message}`,e.success?"success":"error")}catch(e){console.error("‚ùå Promocodes test failed:",e),showNotification("–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: "+e.message,"error")}}async function checkPromocodesTable(){try{const e=await makeRequest("/api/debug/tables");console.log("üìä All tables:",e),showNotification("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü –∑–∞–≤–µ—Ä—à–µ–Ω–∞ - —Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å","info")}catch(e){console.error("‚ùå Table check failed:",e),showNotification("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–±–ª–∏—Ü: "+e.message,"error")}}function displayAdminChatMessages(e){const t=document.getElementById("admin-chat-messages");if(t){if(t.innerHTML="",!e||0===e.length){const e=document.createElement("div");return e.className="message message-admin",e.innerHTML=`\n                    <div class="message-text">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</div>\n                    <div class="message-time">${(new Date).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}</div>\n                `,void t.appendChild(e)}e.forEach((e=>{const n=document.createElement("div");n.className=e.is_admin?"message message-admin":"message message-user";let s="";s=e.image_url?`\n                        <div class="message-image">\n                            <img src="${e.image_url}" alt="–§–æ—Ç–æ" style="max-width: 200px; border-radius: 10px;">\n                        </div>\n                    `:`<div class="message-text">${escapeHtml(e.message)}</div>`,n.innerHTML=`\n                    ${s}\n                    <div class="message-time">${e.moscow_time||formatPostDate(e.sent_at)}</div>\n                `,t.appendChild(n)})),t.scrollTop=t.scrollHeight}else console.error("Admin chat messages container not found!")}async function sendAdminMessage(){if(!currentAdminChat||!currentUser)return console.error("No active chat or user"),void showNotification("–ß–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω","error");const e=document.getElementById("admin-chat-input");if(!e)return void console.error("Admin chat input not found");const t=e.value.trim();if(t)try{console.log(`‚úâÔ∏è Admin sending message to chat ${currentAdminChat.id}:`,t);const n=await makeRequest(`/support/chats/${currentAdminChat.id}/messages`,{method:"POST",body:JSON.stringify({user_id:currentUser.id,user_name:"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",message:t,is_admin:!0})});if(!n.success)throw new Error(n.error);{const n=document.getElementById("admin-chat-messages");if(n){const s=document.createElement("div");s.className="message message-admin",s.innerHTML=`\n                            <div class="message-text">${escapeHtml(t)}</div>\n                            <div class="message-time">${(new Date).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}</div>\n                        `,n.appendChild(s),e.value="",n.scrollTop=n.scrollHeight,loadAdminChats(),console.log("‚úÖ Admin message sent successfully"),showNotification("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ","success")}}}catch(e){console.error("‚ùå Error sending admin message:",e),showNotification("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: "+e.message,"error")}else showNotification("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ","error")}function closeAdminChat(){const e=document.getElementById("admin-chat-window");e&&e.classList.remove("active"),currentAdminChat=null}async function testPromocodeEndpoint(){try{console.log("üß™ Testing promocode endpoint...");const e=await makeRequest("/api/admin/promocodes/create",{method:"POST",body:JSON.stringify({adminId:currentUser.id,code:"TEST123",maxUses:10,reward:50,expiresAt:null})});console.log("‚úÖ Test result:",e)}catch(e){console.error("‚ùå Test failed:",e)}}async function checkDatabaseStructure(){try{console.log("üîç Checking database structure...");const e=await makeRequest("/debug/database");console.log("üìä Database structure:",e),showNotification("‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞","success")}catch(e){console.error("‚ùå Database check failed:",e),showNotification("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ë–î","error")}}async function archiveChat(e){if(confirm("–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —á–∞—Ç –≤ –∞—Ä—Ö–∏–≤?"))try{const t=await makeRequest(`/support/chats/${e}/archive`,{method:"PUT",body:JSON.stringify({adminId:currentUser.id})});t.success?(showNotification("–ß–∞—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ –∞—Ä—Ö–∏–≤","success"),loadAdminChats(),loadAllAdminChats()):showNotification("–û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("Error archiving chat:",e),showNotification("–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ —á–∞—Ç–∞","error")}}async function restoreChat(e){try{const t=await makeRequest(`/support/chats/${e}/restore`,{method:"PUT",body:JSON.stringify({adminId:currentUser.id})});t.success?(showNotification("–ß–∞—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω","success"),loadAdminChats(),loadAllAdminChats(),loadArchivedAdminChats()):showNotification("–û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("Error restoring chat:",e),showNotification("–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞","error")}}async function deleteAdminChat(e){if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç? –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã."))try{const t=await makeRequest(`/support/chats/${e}`,{method:"DELETE",body:JSON.stringify({adminId:currentUser.id})});t.success?(showNotification("–ß–∞—Ç —É–¥–∞–ª–µ–Ω","success"),loadAdminChats(),loadAllAdminChats(),loadArchivedAdminChats(),currentAdminChat&&currentAdminChat.id===e&&closeAdminChat()):showNotification("–û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("Error deleting chat:",e),showNotification("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞","error")}}function resetAdminPanel(){console.log("üßπ Resetting admin panel display...");document.querySelectorAll(".admin-section").forEach((e=>{e.style.display="none"}));const e=document.getElementById("admin-tasks-list-container");e&&(e.style.display="none"),console.log("‚úÖ Admin panel reset complete")}function playMoneySound(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.value=800,t.type="sine",n.gain.setValueAtTime(.3,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.5),t.start(e.currentTime),t.stop(e.currentTime+.5)}catch(e){console.log("Audio not supported")}}function initAdminInputHandlers(){const e=document.getElementById("new-admin-username");e&&e.addEventListener("keypress",(function(e){"Enter"===e.key&&addNewAdmin()}))}function showAdminAdminsSection(){showAdminSection("admins"),loadAdminsList()}async function loadAdminsList(){if(console.log("üîÑ Loading admins list..."),currentUser&&parseInt(currentUser.id)===ADMIN_ID)try{const e=await makeRequest(`/admin/admins-list?adminId=${currentUser.id}`);e.success?displayAdminsList(e.admins):showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–æ–≤: "+e.error,"error")}catch(e){console.error("‚ùå Error loading admins list:",e),showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–æ–≤","error")}else console.log("‚ùå User is not main admin")}function displayAdminsList(e){const t=document.getElementById("admins-list");t&&(t.innerHTML="",e&&0!==e.length?e.forEach((e=>{const n=document.createElement("div");n.className="admin-task-item";const s=parseInt(e.user_id)===ADMIN_ID,o=new Date(e.created_at).toLocaleDateString("ru-RU"),i=`${e.first_name} ${e.last_name||""}`.trim()||`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${e.user_id}`;n.innerHTML=`\n            <div class="admin-task-header">\n                <div class="admin-task-title">\n                    ${i}\n                    ${s?' <span style="color: var(--gold);">(–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω)</span>':""}\n                </div>\n                ${s?"":`\n                    <div class="admin-task-actions">\n                        <button class="admin-task-delete" onclick="removeAdmin(${e.user_id})">\n                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å\n                        </button>\n                    </div>\n                `}\n            </div>\n            <div class="admin-task-description">\n                @${e.username} ‚Ä¢ ID: ${e.user_id} ‚Ä¢ –î–æ–±–∞–≤–ª–µ–Ω: ${o}\n            </div>\n            <div style="margin-top: 8px; font-size: 12px; color: ${e.is_admin?"var(--success)":"var(--error)"};">\n                ${e.is_admin?"‚úÖ –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∞–∫—Ç–∏–≤–Ω—ã":"‚ùå –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω—ã"}\n            </div>\n            \n            \x3c!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞–Ω—è—Ç–æ–≥–æ –∞–¥–º–∏–Ω–∞ --\x3e\n            ${s?"":`\n                <div style="margin-top: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">\n                    <h5 style="margin-bottom: 8px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–¥–º–∏–Ω–∞:</h5>\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">\n                        <div>üìù –ü–æ—Å—Ç—ã: <strong>${e.posts_count||0}</strong></div>\n                        <div>üìã –ó–∞–¥–∞–Ω–∏—è: <strong>${e.tasks_count||0}</strong></div>\n                        <div>‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏: <strong>${e.verifications_count||0}</strong></div>\n                        <div>üí¨ –û—Ç–≤–µ—Ç–æ–≤: <strong>${e.support_count||0}</strong></div>\n                        <div>üí≥ –í—ã–ø–ª–∞—Ç: <strong>${e.payments_count||0}</strong></div>\n                    </div>\n                </div>\n                \n                \x3c!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ --\x3e\n                <div style="margin-top: 10px;">\n                    <h6 style="margin-bottom: 6px;">üîß –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:</h6>\n                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">\n                        <label style="font-size: 12px;">\n                            <input type="checkbox" ${e.can_posts?"checked":""} onchange="updateAdminPermissions(${e.user_id}, 'posts', this.checked)"> üìù –ü–æ—Å—Ç—ã\n                        </label>\n                        <label style="font-size: 12px;">\n                            <input type="checkbox" ${e.can_tasks?"checked":""} onchange="updateAdminPermissions(${e.user_id}, 'tasks', this.checked)"> üìã –ó–∞–¥–∞–Ω–∏—è\n                        </label>\n                        <label style="font-size: 12px;">\n                            <input type="checkbox" ${e.can_verification?"checked":""} onchange="updateAdminPermissions(${e.user_id}, 'verification', this.checked)"> ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞\n                        </label>\n                        <label style="font-size: 12px;">\n                            <input type="checkbox" ${e.can_support?"checked":""} onchange="updateAdminPermissions(${e.user_id}, 'support', this.checked)"> üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞\n                        </label>\n                        <label style="font-size: 12px;">\n                            <input type="checkbox" ${e.can_payments?"checked":""} onchange="updateAdminPermissions(${e.user_id}, 'payments', this.checked)"> üí≥ –û–ø–ª–∞—Ç—ã\n                        </label>\n                    </div>\n                </div>\n            `}\n        `,t.appendChild(n)})):t.innerHTML='\n            <div class="no-tasks" style="text-align: center; padding: 30px;">\n                <div style="font-size: 48px; margin-bottom: 16px;">üë•</div>\n                <div>–ù–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</div>\n                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">\n                    –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n                </div>\n            </div>\n        ')}async function addNewAdmin(){console.log("üîç DEBUG addNewAdmin START");const e=document.getElementById("new-admin-username"),t=document.getElementById("admin-form-message"),n=document.getElementById("add-admin-btn");if(!e||!t)return console.error("‚ùå Required elements not found"),void showNotification("–û—à–∏–±–∫–∞: —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã","error");let s=e.value.trim();if(s.startsWith("@")&&(s=s.substring(1),e.value=s),console.log("üë§ Processing username:",s),s)if(s.length<3)t.innerHTML='<span style="color: var(--error);">Username –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞</span>';else if(currentUser){if(parseInt(currentUser.id)!==ADMIN_ID)return t.innerHTML='<span style="color: var(--error);">–¢–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –∞–¥–º–∏–Ω–æ–≤!</span>',void console.log("‚ùå Not main admin:",{currentUserId:currentUser.id,ADMIN_ID:ADMIN_ID});n.disabled=!0,n.textContent="–î–æ–±–∞–≤–ª—è–µ–º...",t.innerHTML='<span style="color: var(--warning);">–î–æ–±–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...</span>';try{const n={adminId:currentUser.id,username:s};console.log("üì§ Sending request:",n);const o=await makeRequest("/api/admin/add-admin",{method:"POST",body:JSON.stringify(n)});console.log("üì® Server response:",o),o.success?(t.innerHTML=`<span style="color: var(--success);">${o.message}</span>`,e.value="",setTimeout((()=>{loadAdminsList()}),1e3),showNotification(o.message,"success")):(t.innerHTML=`<span style="color: var(--error);">–û—à–∏–±–∫–∞: ${o.error}</span>`,showNotification("–û—à–∏–±–∫–∞: "+o.error,"error"))}catch(e){console.error("üí• Error adding admin:",e);let n="–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∞–¥–º–∏–Ω–∞";n=e.message.includes("404")?"–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.":e.message.includes("Failed to fetch")?"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.":e.message,t.innerHTML=`<span style="color: var(--error);">${n}</span>`,showNotification(n,"error")}finally{n.disabled=!1,n.textContent="‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞",console.log("üîç DEBUG addNewAdmin END")}}else t.innerHTML='<span style="color: var(--error);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>';else t.innerHTML='<span style="color: var(--error);">–í–≤–µ–¥–∏—Ç–µ Telegram username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!</span>'}async function checkServerConnection(){try{if((await fetch(API_BASE_URL+"/api/health")).ok)return console.log("‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω"),!0}catch(e){return console.error("‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:",e),showNotification("–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.","error"),!1}}async function removeAdmin(e){if(currentUser&&parseInt(currentUser.id)===ADMIN_ID){if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?"))try{const t=await makeRequest("/admin/remove-admin",{method:"POST",body:JSON.stringify({adminId:currentUser.id,targetAdminId:e})});t.success?(showNotification(t.message,"success"),loadAdminsList()):showNotification("–û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("‚ùå Error removing admin:",e),showNotification("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞: "+e.message,"error")}}else showNotification("–¢–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –∞–¥–º–∏–Ω–æ–≤!","error")}async function updateAdminPermissions(e,t,n){try{const s=await makeRequest("/admin/update-permissions",{method:"POST",body:JSON.stringify({adminId:currentUser.id,targetAdminId:e,permission:t,enabled:n})});s.success?showNotification("–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã","success"):showNotification("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤: "+s.error,"error")}catch(e){console.error("Update permissions error:",e),showNotification("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞","error")}}function setupAdminPanel(){if(!currentUser)return;const e=document.querySelector(".admin-buttons");e&&(e.innerHTML+='\n            <button class="admin-btn" onclick="showAdminLinksSection()">üîó –°—Å—ã–ª–∫–∏</button>\n        ')}async function refreshUserData(){if(currentUser)try{console.log("üîÑ Refreshing user data...");const e=await makeRequest("/admin/refresh-rights",{method:"POST",body:JSON.stringify({userId:currentUser.id})});e.success&&(Object.assign(currentUser,e.user),displayUserProfile(),updateAdminPanel(),console.log("‚úÖ User data refreshed:",currentUser),showNotification("–ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!","success"))}catch(e){console.error("‚ùå Error refreshing user data:",e)}}async function removeAdmin(e){if(console.log("üóëÔ∏è Removing admin:",e),currentUser&&parseInt(currentUser.id)===ADMIN_ID){if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?"))try{const t=await makeRequest("/admin/remove-admin",{method:"POST",body:JSON.stringify({adminId:currentUser.id,targetAdminId:e})});t.success?(showNotification(t.message,"success"),loadAdminsList()):showNotification("–û—à–∏–±–∫–∞: "+t.error,"error")}catch(e){console.error("‚ùå Error removing admin:",e),showNotification("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞: "+e.message,"error")}}else showNotification("–¢–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –∞–¥–º–∏–Ω–æ–≤!","error")}function initAdminInputHandlers(){const e=document.getElementById("new-admin-username");e&&e.addEventListener("keypress",(function(e){"Enter"===e.key&&addNewAdmin()}))}async function refreshAdminRights(){if(currentUser)try{console.log("üîÑ Refreshing admin rights for user:",currentUser.id);const e=await makeRequest("/admin/refresh-rights",{method:"POST",body:JSON.stringify({userId:currentUser.id})});if(e.success)Object.assign(currentUser,e.user),console.log("‚úÖ Admin rights refreshed:",{id:currentUser.id,is_admin:currentUser.is_admin,isMainAdmin:parseInt(currentUser.id)===ADMIN_ID}),checkAdminRights();else{const e=await makeRequest(`/user/${currentUser.id}`);e.success&&(Object.assign(currentUser,e.profile),checkAdminRights())}}catch(e){console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:",e);try{const e=await makeRequest(`/user/${currentUser.id}`);e.success&&(Object.assign(currentUser,e.profile),checkAdminRights())}catch(e){console.error("Fallback method also failed:",e)}}}function debugAdminRights(){console.log("üêõ DEBUG Admin Rights:"),console.log("- Current User:",currentUser),console.log("- ADMIN_ID:",ADMIN_ID),console.log("- is_admin:",currentUser?.is_admin),console.log("- isMainAdmin:",parseInt(currentUser?.id)===ADMIN_ID),console.log("- Admin Nav Visible:",document.getElementById("admin-nav-item")?.style.display)}async function testAdminRights(){if(currentUser)try{const e=await makeRequest(`/admin/debug-rights?userId=${currentUser.id}`);console.log("üîç Admin rights debug:",e)}catch(e){console.error("Error testing admin rights:",e)}else console.log("‚ùå No current user for rights test")}function updateLevelProgress(){if(!currentUser)return;const e=currentUser.tasks_completed||0,t=calculateUserLevel(e);console.log("üìä Level progress calculation:",{completedTasks:e,level:t.level,percentage:t.progressPercentage});const n=document.getElementById("level-progress-bar"),s=document.querySelector(".level-count"),o=document.querySelector(".level-info");if(n&&(n.style.width=`${t.progressPercentage}%`),s)if(t.isMaxLevel)s.textContent="–ú–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å!";else{const n=LEVEL_SYSTEM[t.level+1].tasksRequired;s.textContent=`${e}/${n}`}if(o)if(t.isMaxLevel)o.innerHTML="üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è!";else{const n=LEVEL_SYSTEM[t.level+1].tasksRequired-e;o.innerHTML=`–£—Ä–æ–≤–µ–Ω—å <strong>${t.levelName}</strong> ‚Ä¢ –î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è: <strong>${n}</strong> –∑–∞–¥–∞–Ω–∏–π`}}function createLevelProgressHTML(){const e=calculateUserLevel(currentUser?.tasks_completed||0),t=e.tasksForNextLevel-LEVEL_SYSTEM[e.level].tasksRequired,n=e.currentLevelTasks;return`\n        <div class="level-progress">\n            <div class="level-header">\n                <div class="level-title">–°–∏—Å—Ç–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π</div>\n                <div class="level-badge">–£—Ä–æ–≤–µ–Ω—å ${e.level}</div>\n            </div>\n            \n            <div class="progress-container">\n                <div class="progress-bar">\n                    <div class="progress-fill" id="level-progress-bar" style="width: ${e.progressPercentage}%"></div>\n                </div>\n                <div class="progress-stats">\n                    <span>${n} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>\n                    <span>${e.progressPercentage}%</span>\n                    <span>${t} –¥–æ —Å–ª–µ–¥. —É—Ä–æ–≤–Ω—è</span>\n                </div>\n            </div>\n            \n            <div class="level-info">\n                ${e.isMaxLevel?"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è!":`–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å: <strong>${e.levelName}</strong> ‚Ä¢ –ü—Ä–æ–≥—Ä–µ—Å—Å: <strong>${n}/${t}</strong> –∑–∞–¥–∞–Ω–∏–π`}\n            </div>\n        </div>\n    `}function updateProfileLevelInfo(e){const t=document.querySelectorAll(".profile-stat");if(t.length>=4){t[1].querySelector(".stat-value").textContent=e.completedTasks;const n=document.getElementById("profile-level-display");if(n)n.querySelector(".stat-value").textContent=e.level;else{const n=`\n                <div class="profile-stat" id="profile-level-display">\n                    <div class="stat-value">${e.level}</div>\n                    <div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div>\n                </div>\n            `;t[3]&&t[3].parentNode&&t[3].insertAdjacentHTML("beforebegin",n)}}}function showLevelUpNotification(e,t,n){const s=`\n        <div class="level-up-notification" style="\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background: var(--gold-gradient);\n            color: #000;\n            padding: 30px;\n            border-radius: 20px;\n            text-align: center;\n            z-index: 10000;\n            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);\n            border: 3px solid rgba(255, 255, 255, 0.3);\n            animation: levelUpPop 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);\n            max-width: 300px;\n            width: 90%;\n        ">\n            <div style="font-size: 48px; margin-bottom: 15px;">üéâ</div>\n            <div style="font-size: 24px; font-weight: 800; margin-bottom: 10px;">\n                –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å!\n            </div>\n            <div style="font-size: 20px; font-weight: 700; margin-bottom: 15px;">\n                ${t}\n            </div>\n            <div style="font-size: 16px; margin-bottom: 20px;">\n                –£—Ä–æ–≤–µ–Ω—å <strong>${e}</strong> –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!\n            </div>\n            <div style="\n                background: rgba(255, 255, 255, 0.3);\n                padding: 10px;\n                border-radius: 10px;\n                font-weight: 700;\n                margin-bottom: 15px;\n            ">\n                üéÅ –ë–æ–Ω—É—Å: +${n}‚≠ê\n            </div>\n            <button onclick="this.parentElement.remove()" style="\n                background: #000;\n                color: white;\n                border: none;\n                padding: 10px 20px;\n                border-radius: 10px;\n                font-weight: 600;\n                cursor: pointer;\n            ">\n                –û—Ç–ª–∏—á–Ω–æ!\n            </button>\n        </div>\n    `;document.body.insertAdjacentHTML("beforeend",s),setTimeout((()=>{const e=document.querySelector(".level-up-notification");e&&e.remove()}),5e3)}allowAdminsCheckbox&&allowAdminsCheckbox.addEventListener("change",saveLinkAccessSettings),setTimeout(addStartTaskDebugButton,3e3),setTimeout(addPromocodesTestButton,2e3),initTheme(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initAdminInputHandlers):initAdminInputHandlers(),window.showTaskCategory=showTaskCategory,window.loadUserTasksForCategory=loadUserTasksForCategory,window.displayUserTasksForCategory=displayUserTasksForCategory,window.openAdminChat=openAdminChat,window.closeChat=closeChat,window.sendMessageToAdmin=sendMessageToAdmin,window.openTaskModal=openTaskModal,window.startTask=startTask,window.closeModal=closeModal,window.showBalanceModal=showBalanceModal,window.showPrices=showPrices,window.openAdminChatFromPrices=openAdminChatFromPrices,window.goToProfile=goToProfile,window.copyReferralLink=copyReferralLink,window.submitWithdraw=submitWithdraw,window.showMainTab=showMainTab,window.showTasksTab=showTasksTab,window.showProfileTab=showProfileTab,window.showAdminTab=showAdminTab,window.showHowItWorksPage=showHowItWorksPage,window.showAboutPage=showAboutPage,window.showWithdrawPage=showWithdrawPage,window.showAdminSection=showAdminSection,window.addNewPost=addNewPost,window.addTask=addTask,window.deletePost=deletePost,window.deleteTask=deleteTask,window.sendAdminMessage=sendAdminMessage,window.closeAdminChat=closeAdminChat,window.submitTaskCompletion=submitScreenshot,window.deleteAdminChat=deleteAdminChat,window.archiveChat=archiveChat,window.restoreChat=restoreChat,window.showChatTab=showChatTab,window.handleLike=handleLike,window.handleDislike=handleDislike,window.showTaskConfirmation=showTaskConfirmation,window.showScreenshotUpload=showScreenshotUpload,window.showCancelConfirmation=showCancelConfirmation,window.submitScreenshot=submitScreenshot,window.cancelTask=cancelTask,window.loadTaskVerifications=loadTaskVerifications,window.openVerificationModal=openVerificationModal,window.approveVerification=approveVerification,window.rejectVerification=rejectVerification,window.goBackToProfile=goBackToProfile,window.loadAdminChats=loadAdminChats,window.loadAllAdminChats=loadAllAdminChats,window.loadArchivedAdminChats=loadArchivedAdminChats,window.openAdminChatWindow=openAdminChatWindow,window.requestWithdraw=requestWithdraw,window.showAdminAdminsSection=showAdminAdminsSection,window.loadAdminsList=loadAdminsList,window.addNewAdmin=addNewAdmin,window.removeAdmin=removeAdmin,window.showAdminAdminsSection=showAdminAdminsSection,window.loadAdminsList=loadAdminsList,window.addNewAdmin=addNewAdmin,window.removeAdmin=removeAdmin,window.showAdminSection=showAdminSection,window.showAdminAdminsSection=showAdminAdminsSection,window.loadAdminsList=loadAdminsList,window.addNewAdmin=addNewAdmin,window.removeAdmin=removeAdmin,window.showAdminSection=showAdminSection,window.refreshUserData=refreshUserData,window.showAdminAdminsSection=showAdminAdminsSection,window.loadAdminsList=loadAdminsList,window.addNewAdmin=addNewAdmin,window.removeAdmin=removeAdmin,window.showAdminSection=showAdminSection,window.refreshUserData=refreshUserData,window.checkAdminRights=checkAdminRights,window.showAdminAdminsSection=showAdminAdminsSection,window.loadAdminsList=loadAdminsList,window.addNewAdmin=addNewAdmin,window.removeAdmin=removeAdmin,window.showAdminSection=showAdminSection,window.refreshAdminRights=refreshAdminRights,window.debugAdminRights=debugAdminRights,document.addEventListener("DOMContentLoaded",(function(){initAdminInputHandlers()})),setTimeout(debugAdminRights,2e3),setTimeout((()=>{void 0!==currentUser&&testAdminRights()}),3e3);const levelUpStyles="\n    <style>\n        @keyframes levelUpPop {\n            0% {\n                transform: translate(-50%, -50%) scale(0.5);\n                opacity: 0;\n            }\n            50% {\n                transform: translate(-50%, -50%) scale(1.1);\n            }\n            100% {\n                transform: translate(-50%, -50%) scale(1);\n                opacity: 1;\n            }\n        }\n        \n        .level-progress {\n            background: var(--card-bg);\n            border-radius: 14px;\n            padding: 16px;\n            margin: 16px 0;\n            border: 1px solid var(--border);\n            position: relative;\n            overflow: hidden;\n        }\n        \n        .level-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 12px;\n        }\n        \n        .level-title {\n            font-weight: 600;\n            font-size: 16px;\n        }\n        \n        .level-badge {\n            background: var(--purple-gradient);\n            color: white;\n            padding: 4px 10px;\n            border-radius: 10px;\n            font-size: 12px;\n            font-weight: 600;\n        }\n        \n        .progress-container {\n            margin-bottom: 8px;\n        }\n        \n        .progress-stats {\n            display: flex;\n            justify-content: space-between;\n            font-size: 12px;\n            color: var(--text-secondary);\n        }\n        \n        .level-rewards {\n            margin-top: 12px;\n            padding: 10px;\n            background: var(--bg-secondary);\n            border-radius: 8px;\n            border-left: 3px solid var(--gold);\n        }\n        \n        .reward-item {\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            font-size: 12px;\n            margin-bottom: 4px;\n        }\n        \n        .reward-item:last-child {\n            margin-bottom: 0;\n        }\n    </style>\n";function createLevelProgressHTML(){const e=currentUser?.tasks_completed||0,t=calculateUserLevel(e);return`\n        <div class="level-progress">\n            <div class="level-header">\n                <div class="level-title">–°–∏—Å—Ç–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π</div>\n                <div class="level-badge">–£—Ä–æ–≤–µ–Ω—å ${t.level}</div>\n            </div>\n            \n            <div class="progress-container">\n                <div class="progress-bar">\n                    <div class="progress-fill" id="level-progress-bar" style="width: ${t.progressPercentage}%"></div>\n                </div>\n                <div class="progress-stats">\n                    <span>${t.completedTasks} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>\n                    <span>${t.progressPercentage}%</span>\n                    <span>${t.tasksForNextLevel} –¥–æ —Å–ª–µ–¥. —É—Ä–æ–≤–Ω—è</span>\n                </div>\n            </div>\n            \n            <div class="level-info">\n                ${t.isMaxLevel?"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è!":`–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å: <strong>${t.levelName}</strong> ‚Ä¢ –î–æ —É—Ä–æ–≤–Ω—è ${t.level+1}: <strong>${t.tasksForNextLevel-e}</strong> –∑–∞–¥–∞–Ω–∏–π`}\n            </div>\n            \n            ${t.isMaxLevel?"":`\n                <div class="level-rewards">\n                    <div class="reward-item">\n                        <span>üéÅ</span>\n                        <span>–ë–æ–Ω—É—Å –∑–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å: <strong>+${t.nextLevelBonus}‚≠ê</strong></span>\n                    </div>\n                </div>\n            `}\n        </div>\n    `}function initializeLevelSystem(){updateLevelProgress(),setInterval(updateLevelProgress,3e4)}async function onTaskCompleted(e,t){try{const t=await makeRequest(`/user/${e}`);t.success&&(currentUser={...currentUser,...t.profile},displayUserProfile(),console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è"))}catch(e){console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è:",e)}}function clearTaskImage(){const e=document.getElementById("task-image-input"),t=document.getElementById("task-image-preview"),n=document.querySelector(".upload-placeholder");e&&(e.value=""),t&&(t.src="",t.style.display="none"),n&&(n.style.display="block"),currentTaskImage=null;const s=document.getElementById("image-upload-area");s&&(s.style.borderColor="",s.style.background="")}function initImageUploadDragDrop(){const e=document.getElementById("image-upload-area");e&&(e.addEventListener("dragover",(function(t){t.preventDefault(),e.classList.add("dragover"),e.style.borderColor="var(--accent)",e.style.background="rgba(99, 102, 241, 0.05)"})),e.addEventListener("dragleave",(function(t){t.preventDefault(),e.classList.remove("dragover"),e.style.borderColor="",e.style.background=""})),e.addEventListener("drop",(function(t){t.preventDefault(),e.classList.remove("dragover"),e.style.borderColor="",e.style.background="";const n=t.dataTransfer.files;if(n.length>0){const e=document.getElementById("task-image-input");if(e){const t=new DataTransfer;t.items.add(n[0]),e.files=t.files,previewTaskImage(e)}}})),e.addEventListener("click",(function(){const e=document.getElementById("task-image-input");e&&e.click()})))}async function addTaskWithImage(){console.log("üéØ Starting add task with image...");try{const e={title:document.getElementById("admin-task-title").value.trim(),description:document.getElementById("admin-task-description").value.trim(),price:document.getElementById("admin-task-price").value,category:document.getElementById("admin-task-category").value,time_to_complete:document.getElementById("admin-task-time").value||"5-10 –º–∏–Ω—É—Ç",difficulty:document.getElementById("admin-task-difficulty").value,people_required:document.getElementById("admin-task-people").value||1,task_url:document.getElementById("admin-task-url").value||"",created_by:currentUser.id};if(console.log("üìã Form data collected:",e),!e.title.trim())return void showNotification("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è!","error");if(!e.description.trim())return void showNotification("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è!","error");if(!e.price)return void showNotification("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –∑–∞–¥–∞–Ω–∏—è!","error");const t=parseFloat(e.price);if(isNaN(t)||t<=0)return void showNotification("–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º!","error");const n=new FormData;Object.keys(e).forEach((t=>{n.append(t,e[t])})),currentTaskImage?(n.append("image",currentTaskImage),console.log("üì∏ Adding image to form data:",currentTaskImage.name)):console.log("‚ÑπÔ∏è No image selected"),console.log("üì§ Sending task with image...");const s=await fetch("/api/tasks-with-image",{method:"POST",body:n}),o=await s.json();if(console.log("üì® Server response:",o),!o.success)throw new Error(o.error||"Unknown server error");showNotification("‚úÖ –ó–∞–¥–∞–Ω–∏–µ —Å —Ñ–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!","success"),clearTaskForm(),clearTaskImage(),setTimeout((()=>{loadAdminTasks(),loadTasks()}),1e3)}catch(e){console.error("üí• Error in addTaskWithImage:",e),showNotification(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è: ${e.message}`,"error")}}function clearTaskForm(){["admin-task-title","admin-task-description","admin-task-price","admin-task-time","admin-task-people","admin-task-url"].forEach((e=>{const t=document.getElementById(e);t&&(t.value="")})),document.getElementById("admin-task-category").value="subscribe",document.getElementById("admin-task-difficulty").value="–õ–µ–≥–∫–∞—è",clearTaskImage()}function createTaskCard(e,t,n){const s=document.createElement("div");s.className="task-card",s.style.animationDelay=.1*n+"s";const o=e.people_required||1,i=e.completed_count||0,a=Math.max(0,o-i);let r="";switch(t){case"new":r=`<button class="task-btn" onclick="event.stopPropagation(); openTaskModal(${e.id})">\n                –ù–∞—á–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ\n            </button>`;break;case"confirmation":r=`<button class="task-btn" onclick="event.stopPropagation(); showTaskConfirmation(${e.id}, '${escapeHtml(e.title)}')">\n                –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É\n            </button>`;break;case"completed":r='<div class="task-status completed">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>';break;case"rejected":r='<div class="task-status rejected">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>'}return s.innerHTML=`\n        ${a>0&&"new"===t?`<div class="task-availability">${a} –æ—Å—Ç–∞–ª–æ—Å—å</div>`:""}\n        \n        <div class="task-header">\n            <div class="task-title">${escapeHtml(e.title)}</div>\n            <div class="task-price">${e.price} ‚≠ê</div>\n        </div>\n        \n        <div class="task-meta">\n            <div class="task-category">${formatCategory(e.category)}</div>\n            ${e.difficulty?`<div class="task-difficulty ${e.difficulty.toLowerCase()}">${e.difficulty}</div>`:""}\n        </div>\n        \n        <div class="task-description">\n            ${escapeHtml(e.description.length>100?e.description.substring(0,100)+"...":e.description)}\n        </div>\n        \n        ${o>1&&"new"===t?`\n            <div class="task-progress">\n                <div class="task-progress-bar" style="width: ${Math.min(100,i/o*100)}%"></div>\n            </div>\n            <div class="task-progress-text">\n                –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${i}/${o}\n            </div>\n        `:""}\n        \n        <div class="task-footer">\n            <div class="task-time">\n                ${"confirmation"===t?"–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è":"completed"===t?"–í—ã–ø–æ–ª–Ω–µ–Ω–æ":"rejected"===t?"–û—Ç–∫–ª–æ–Ω–µ–Ω–æ":e.time_to_complete||"5-10 –º–∏–Ω—É—Ç"}\n            </div>\n            ${r}\n        </div>\n    `,"new"===t&&s.addEventListener("click",(function(t){t.target.classList.contains("task-btn")||openTaskModal(e.id)})),s}function displayTasksWithImages(e,t){const n=document.getElementById(t+"-tasks");n&&(n.innerHTML="",e&&0!==e.length?e.forEach(((e,s)=>{const o=createTaskCardWithImage(e,t,s);n.appendChild(o)})):n.innerHTML='\n            <div class="no-tasks" style="text-align: center; padding: 40px 20px;">\n                <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>\n                <div>–ó–∞–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>\n                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">\n                    –ù–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –ø–æ–∑–∂–µ\n                </div>\n            </div>\n        ')}function createTaskCardWithImage(e,t,n){const s=document.createElement("div");s.className="task-card task-card-with-image","rejected"===t&&s.classList.add("rejected"),s.style.animationDelay=.1*n+"s",s.setAttribute("data-task-id",e.id),s.setAttribute("data-task-title",e.title),console.log(`üé® Creating task card: ${e.id} - "${e.title}"`);const o=e.image_url&&""!==e.image_url,i=e.people_required||1,a=e.completed_count||0,r=Math.max(0,i-a);let c="";c=o?`\n            <div class="task-image-container">\n                <img src="${e.image_url}" alt="${escapeHtml(e.title)}" \n                     class="task-image"\n                     onerror="this.onerror=null; this.style.display='none';">\n                ${r>0&&"new"===t?`<div class="task-badge">${r} –æ—Å—Ç–∞–ª–æ—Å—å</div>`:""}\n            </div>\n        `:`\n            ${r>0&&"new"===t?`<div class="task-availability">${r} –æ—Å—Ç–∞–ª–æ—Å—å</div>`:""}\n        `;let d="";switch(t){case"new":d=`<button class="task-btn" onclick="event.stopPropagation(); openTaskModal(${e.id})">\n                –ù–∞—á–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ\n            </button>`;break;case"confirmation":d=`<button class="task-btn" onclick="event.stopPropagation(); showTaskConfirmation(${e.id}, '${escapeHtml(e.title)}')">\n                –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É\n            </button>`;break;case"completed":d='<div class="task-status completed">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>';break;case"rejected":d='<div class="task-status rejected">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>'}return s.innerHTML=`\n        ${c}\n        \n        <div class="task-header">\n            <div class="task-title">${escapeHtml(e.title)}</div>\n            <div class="task-price">${e.price} ‚≠ê</div>\n        </div>\n        \n        <div class="task-meta">\n            <div class="task-category">${formatCategory(e.category)}</div>\n            ${e.difficulty?`<div class="task-difficulty ${e.difficulty.toLowerCase()}">${e.difficulty}</div>`:""}\n        </div>\n        \n        <div class="task-description">\n            ${escapeHtml(e.description.length>100?e.description.substring(0,100)+"...":e.description)}\n        </div>\n        \n        ${i>1&&"new"===t?`\n            <div class="task-progress">\n                <div class="task-progress-bar" style="width: ${Math.min(100,a/i*100)}%"></div>\n            </div>\n            <div class="task-progress-text">\n                –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${a}/${i}\n            </div>\n        `:""}\n        \n        <div class="task-footer">\n            <div class="task-time">\n                ${"confirmation"===t?"–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è":"completed"===t?"–í—ã–ø–æ–ª–Ω–µ–Ω–æ":"rejected"===t?"–û—Ç–∫–ª–æ–Ω–µ–Ω–æ":e.time_to_complete||"5-10 –º–∏–Ω—É—Ç"}\n            </div>\n            ${d}\n        </div>\n    `,"new"===t&&s.addEventListener("click",(function(t){t.target.classList.contains("task-btn")||openTaskModal(e.id)})),"rejected"===t&&(s.innerHTML=createRejectedTaskHTML(e)),s}document.head.insertAdjacentHTML("beforeend",levelUpStyles),window.updateLevelProgress=updateLevelProgress,window.calculateUserLevel=calculateUserLevel,window.initializeLevelSystem=initializeLevelSystem,initImageUploadDragDrop(),area.addEventListener("click",(function(){const e=document.getElementById("task-image-input");e&&e.click()})),document.addEventListener("DOMContentLoaded",(function(){initImageUploadDragDrop()})),window.addNewPostAsAdmin=addNewPostAsAdmin,window.deletePostAsAdmin=deletePostAsAdmin,window.addTaskAsAdmin=addTaskAsAdmin,window.deleteTaskAsAdmin=deleteTaskAsAdmin,window.loadTaskVerificationsForAdmin=loadTaskVerificationsForAdmin,window.openAdminSupportChat=openAdminSupportChat,window.approveVerification=approveVerification,window.rejectVerification=rejectVerification,window.closeModal=closeModal,window.requestWithdraw=requestWithdraw,window.loadWithdrawHistory=loadWithdrawHistory,window.loadWithdrawalRequests=loadWithdrawalRequests,window.completeWithdrawal=completeWithdrawal,window.showAdminSection=showAdminSection,window.fixTasksLayout=fixTasksLayout,window.addTask=addTask,window.showAdminSection=showAdminSection,window.loadAdminTasks=loadAdminTasks,window.addTask=addTask,window.showAdminAdminsSection=showAdminAdminsSection,window.loadAdminsList=loadAdminsList,window.addNewAdmin=addNewAdmin,window.removeAdmin=removeAdmin,window.updateAdminPermissions=updateAdminPermissions,window.loadWithdrawalRequests=loadWithdrawalRequests,window.completeWithdrawal=completeWithdrawal,window.showAdminPaymentsSection=showAdminPaymentsSection,window.deleteVerification=deleteVerification;